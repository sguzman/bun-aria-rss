{
  "id": "tag:blogger.com,1999:blog-5825758052688213474.post-5882522097717497514",
  "published": "2016-08-31T23:24:00.000-07:00",
  "updated": "2017-02-01T19:35:56.972-08:00",
  "title": "Next generation tools for data science",
  "content": "By DAVID ADAMS<br /><br /><i>Since inception, <a href=\"http://www.unofficialgoogledatascience.com/2015/08/welcome-to-unofficial-google-data.html\">this blog has defined “data science”</a> as inference derived from data too big to fit on a single computer. Thus the ability to manipulate big data is essential to our notion of data science. While MapReduce remains a fundamental tool, many interesting analyses require more than it can offer. For instance, the well-known Mantel-Haenszel estimator cannot be implemented in a single MapReduce. <b>Apache Spark</b> and <b>Google Cloud Dataflow</b> represent two alternatives as “next generation” data processing frameworks. This post compares the two, relying on the author’s first-hand experience and subsequent background research.</i><br /><br /><h2>Introduction</h2><br /><div>That MapReduce was <b>the</b> solution to write data processing pipelines scalable to hundreds of terabytes (or more) is evidenced by the massive uptake. This was true within Google as well as outside of Google in the form of Hadoop/MapReduce (for some “Hadoop” and “data science” are synonyms). However, it didn’t take long for the pain of writing and running many-stage MapReduce programs to become apparent. MapReduce’s limitations motivated two different groups, AMPLab (Apache Spark) and Google (Cloud Dataflow), to write next-generation data processing frameworks. The two groups came at the problem from different vantage points and this can be seen in both obvious and subtle differences in the end-products. Dataflow was designed as a marriage of Google frameworks for expressing complex batch pipelines (FlumeJava) and streaming (MillWheel) pipelines.  Spark was developed <a href=\"http://blog.madhukaraphatak.com/history-of-spark/\">at UC Berkeley to enable exploratory analysis and ML at scale</a>.<br /><br />Six months ago, <a href=\"https://cloud.google.com/blog/big-data/2016/08/cloud-dataflow-apache-beam-and-you\">Google donated the Cloud Dataflow programming model and SDKs to the Apache Software Foundation</a>, resulting in the incubating project <a href=\"http://beam.incubator.apache.org/\"><i>Apache Beam</i></a>. Going forward, <i>Apache Beam</i> will become the way to express data processing pipelines, while <a href=\"https://cloud.google.com/dataflow/\"><i>Cloud Dataflow</i></a> remains as a fully managed service for executing these pipelines. Similarly, I’ll refer to the programming model and API as <i>Beam</i> and the service that runs on GCP as <i>Dataflow</i>. Example code in this post uses the current Dataflow SDK, but similar concepts and programming patterns hold in Apache Beam.<br /><br />In this post, I’m going to shed light on the similarities and differences of Spark and Beam/Dataflow. For framing purposes, <b>Spark’s sweet spot is quickly developing exploratory/interactive analysis and iterative algorithms</b>, e.g., gradient descent and MCMC, whereas <b>Dataflow’s sweet spot is processing streaming data and highly-optimized, robust, fixed pipelines</b>.<br /><br />The rest of the post is organized as follows: the most important difference between the two, a motivating example with implementations in Spark and Beam/Dataflow, an example of an clustering algorithm written in Spark, examples of streaming processing in Spark and Dataflow, and finally, other major differences between the frameworks.<br /><br /><h2>When MapReduce is not enough</h2>MapReduce is a great tool for single-stage parallel data processing. A few pain points emerge when trying to use MapReduce beyond small pipelines:<br /><ul><li>Expressing complex pipelines requires significant boilerplate, separate programs, and the “interface” between stages to be files.</li><li>Writing intermediate results to disk between stages of pipelines is a serious bottleneck and forces the user to hand-optimize the placement of these divisions</li><li>Performing exploratory analysis requires reading and writing to disk, which is slow</li><li>Expressing streaming pipelines (low-latency and infinite data sources) is not supported,</li><li>Writing multi-stage pipelines are easily to stumble upon, take for example trying to measure the effects of a randomized experiment on ratios of metrics using Mantel-Haenszel (see more below).</li></ul>Both Beam and Spark solve most of these problems storing results of MapReduce steps in by optimizing away many steps and storing necessary intermediate results in memory, <i>PCollections</i> for Dataflow and <i>resilient distributed dataset</i> (RDD) for Spark, instead of writing to disk just to load back into memory again.</div><div><br /></div><h2>The core difference: graph evaluation</h2>The fundamental and enduring difference between Spark and Beam is that Spark only builds as much of the computation graph as needed (for lazy evaluation on actions) whereas Dataflow builds the entire computation graph before it is optimized and sent to the service or cluster to be executed.  Many significant differences between the two are a consequence of this distinction. Thus it is easy to use Spark for interactive analysis (from a python or scala shell) and to prototype ML algorithms but harder to do so in Dataflow. To be clear, it isn’t that one cannot do ML with Dataflow — single pass, streaming algorithms are fine. But many ML algorithms, such as basic gradient descent and MCMC, make data-driven decisions of how many iterations they need to run until convergence. Spark provides the user with greater flexibility.<br /><br />On the other hand, the benefits of requiring a complete computation graph are that it allows systems that execute Beam pipelines, like Dataflow to optimize <b>the complete graph</b>. More importantly, decoupling graph construction from execution lets Beam create a language-agnostic representation of the computation graph. Thus, Dataflow graphs can be executed on other distributed processing back-ends, even including Spark. This property is what enabled the creation of the <a href=\"http://beam.incubator.apache.org/\">Apache Beam project</a>.<br /><br />Another consequence of Beam’s decision to require specification of the full computation graph is that Dataflow may be offered as a service. This <i>running-a-pipeline-job-as-a-service</i> takes a graph specification and data inputs and produces outputs. The <a href=\"https://cloud.google.com/dataflow/\">Cloud Dataflow Service</a> can be thought of as a black box where details such as the number of VMs to use, overall or per stage, or distribution of work can all be left up to the service. Of course, most of these details can be specified if desired, <a href=\"https://cloud.google.com/blog/big-data/2016/03/comparing-cloud-dataflow-autoscaling-to-spark-and-hadoop\">see here</a> for a more expansive discussion. This is in stark comparison to Spark, which is cluster-oriented instead of job-oriented. To run a fixed pipeline in Spark requires spinning up a Spark cluster, running the pipeline and tearing the cluster down. Even though there are tools to make this process easier (see <a href=\"https://cloud.google.com/dataproc/\">Cloud Dataproc</a> on GCP or <a href=\"https://databricks.com/\">Databricks</a> on AWS) cluster management remains the responsibility of the user.<br /><div><br /><h2>A motivating example for going beyond Hadoop/MapReduce</h2>To compare the two frameworks, I’m going to solve the same problem twice then highlight key differences. Suppose we have on an online auction site with a wide variety of products for sale. Users browse the images and specifications of products in the inventory and may choose to bid on them. Because it is an auction site, prices for any item vary all the time. Products range in value from a few dollars (emoji eraser kits) to thousands (nitro coffee kits) so an important way we track them is by product category.<br /><br />We want to run a randomized control experiment to determine the effect of high-resolution images on our sales. Say, we wish to determine the impact of the experiment on average sell price. The naive thing to do would be simply to compare the average selling price of treatment to that of control. However this could be misleading — this measure will show a difference even if the price for each individual item remained constant and only the mix of products sold was affected. To be concrete, imagine the experiment caused us to sell relatively more nitro coffee kits than emoji kits. The <b>Mantel-Haenszel estimator</b> (also known as Cochran-Mantel-Haenszel) is meant precisely to address this problem by adjusting for the mix of items being compared between treatment and control. The basic idea is first to compute the average price separately in treatment and control for each individual stratum (aka \"slice\") and then to take the ratio of weighted combination of prices in treatment to that of control. The key is that the combination weights are the same for treatment and control, and these are chosen in some way to minimize estimator variance.<br /><br />Widely used in medicine for count data, the MH estimator and its generalizations are ubiquitous within data science at Google. In a future post we will cover applications and extensions of MH to analytic problems at Google. For now, we'll just go ahead and compute point MH estimates for this (non-count) price data, using product categories as our slices. Let's say in product category $i$ we sell $n_{t,i}$ and $n_{c,i}$ items in treatment and control respectively for a total sale value of $X_{t,i}$ and $X_{c,i}$. The MH estimate for the (mix-adjusted) ratio of prices between treatment and control is<br />$$<br />MH(t,c)=\\frac{\\sum_i w_i \\frac{X_{t,i}}{n_{t,i}}} {\\sum_i w_i \\frac{X_{c,i}}{n_{c,i}}}<br />$$ where the weights $w_i$ is the harmonic mean of $n_{t,i}$ and $n_{c,i}$. To facilitate computation, we will rewrite the formula as<br />$$<br />MH(t,c)=\\frac{\\sum_i&nbsp;X_{t,i} \\left(\\frac{n_{c,i}}{n_{t,i} + n_{c,i}}\\right)}<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{\\sum_i&nbsp;X_{c,i} \\left(\\frac{n_{t,i}}{n_{t,i}&nbsp;+ n_{c,i}}\\right)}<br />$$ taking care to omit terms where $n_{t,i}&nbsp;+ n_{c,i} = 0$. Let's start with a csv of the following schema:</div><div><span style=\"font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\"><experiment_id><product_id><selling_price>&nbsp;exp_id, product_id, price, sale_count <count></count></selling_price></product_id></experiment_id></span><br />If I wrote a MapReduce pipeline to calculate the MH ratio of prices, it would require three MapReduce programs:<br /><ol><li><b>Map</b> (if header skip else <product_id exp_id=\"\"> value <price clicks=\"\">) → Reduce (sum reducer)</price></product_id></li><li><b>Map</b> (key <product_id> value <exp_id clicks=\"\" price=\"\">) → Reduce (no-op -- value is iter<exp_id clicks=\"\" price=\"\">)</exp_id></exp_id></product_id></li><li><b>Map</b> (key &lt;&gt; value <numerator denominator=\"\">) → Reduce (sum reducer)</numerator></li></ol>The net result would be a significant amount of code, considering a trivial word-count MapReduce requires roughly <a href=\"https://hadoop.apache.org/docs/r1.2.1/mapred_tutorial.html\">60 lines of mostly boilerplate Java code</a>. That’s a lot of code that I’m not going to write. For the curious reader, much has been written about Hadoop/Mapreduce versus Spark, such as&nbsp;<a href=\"http://www.dattamsha.com/2014/09/hadoop-mr-vs-spark-rdd-wordcount-program/\">this post at Dattamsha</a>.</div><div><br /></div><table align=\"center\" cellpadding=\"0\" cellspacing=\"0\" class=\"tr-caption-container\" style=\"margin-left: auto; margin-right: auto; text-align: center;\"><tbody><tr><td style=\"text-align: center;\"><img alt=\"Compare Spark vs. Google Dataflow/Beam\" height=\"329\" src=\"https://lh4.googleusercontent.com/OlvW6SskdqiFWmJeucVj-ESXH7c_GR_0af4Rdo0vDi78eVKVbusCTlbs7UouymD-cfxszDarNsIUexlyuInZ15Wgm6hTGpPVzo7spMvv1mNsf95qlxP5kEKjGMBtPfeyUB-E1qYU\" style=\"border: none; margin-left: auto; margin-right: auto; transform: rotate(0rad);\" title=\"\" width=\"640\" /></td></tr><tr><td class=\"tr-caption\">A mashup of Apache Spark and Dataflow/Beam</td></tr></tbody></table><div><h2>MH in python</h2>Readers who prefer Python to prose can see the full Jupyter notebook solution in my <a href=\"https://github.com/davidadamsphd/spark-vs-dataflow\">Spark vs Dataflow</a> github project. To make the comparison easier, I separate the business logic from parallelized code. There are two business logic functions, <span style=\"font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\">calc_numerator</span> and <span style=\"font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\">calc_denominator</span>, that take all of count and price data for a particular product and calculate the numerator (and denominator) of the above formula.</div><div><h4>MH in Apache Spark</h4>The first thing to do for Spark is start the Spark shell, which involves adding the a few things to the PATH and running execfile on pyspark/shell.py (see the notebook for details).&nbsp;Next comes the Spark code:<br /><div dir=\"ltr\" style=\"line-height: 1.4571514285714287; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"background-color: white;\"><span style=\"color: green; font-family: &quot;courier new&quot;; font-size: 14px; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;\"><br /></span></span><span id=\"docs-internal-guid-70f625c1-e499-b463-fa8e-c4933f8d3367\" style=\"background-color: white;\"><span style=\"color: green; font-family: &quot;courier new&quot;; font-size: 14px; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;\">  from</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> </span><span style=\"color: blue; font-family: &quot;courier new&quot;; font-size: 14px; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;\">operator</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> </span><span style=\"color: green; font-family: &quot;courier new&quot;; font-size: 14px; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;\">import</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> add</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #408080; font-family: &quot;courier new&quot;; font-size: 14px; font-style: italic; vertical-align: baseline; white-space: pre-wrap;\">  # We want to calculate MH(v_{t,i},n_{t,i},v_{c,i},n_{c,i}), where t and c are treatment </span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #408080; font-family: &quot;courier new&quot;; font-size: 14px; font-style: italic; vertical-align: baseline; white-space: pre-wrap;\">  # </span></span><span style=\"background-color: white; color: #408080; font-family: &quot;courier new&quot;; font-size: 14px; font-style: italic; line-height: 20.4001px; white-space: pre-wrap;\">and control.</span><span style=\"background-color: white; color: #408080; font-family: &quot;courier new&quot;; font-size: 14px; font-style: italic; line-height: 1.45715; white-space: pre-wrap;\"> v and n in our cases are value of the sale prices and sale_count.</span></div><div dir=\"ltr\" style=\"line-height: 1.4571514285714287; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"background-color: white;\"><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">  input_rdd </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">=</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> sc</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">textFile(</span><span style=\"color: #ba2121; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">'sim_data_{0}_{1}.csv'</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">format(NUM_LE, NUM_HE))</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">  header </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">=</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> input_rdd</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">first() </span><span style=\"color: #408080; font-family: &quot;courier new&quot;; font-size: 14px; font-style: italic; vertical-align: baseline; white-space: pre-wrap;\"># Remove the first line.</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">  parsed_input_rdd </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">=</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> input_rdd</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">filter(</span><span style=\"color: green; font-family: &quot;courier new&quot;; font-size: 14px; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;\">lambda</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> x: x </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">!=</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">header)</span></span></div><div dir=\"ltr\" style=\"line-height: 1.4571514285714287; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"background-color: white;\"><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">                              .</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">map(</span><span style=\"color: green; font-family: &quot;courier new&quot;; font-size: 14px; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;\">lambda</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> x: convert_line(x</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">split(</span><span style=\"color: #ba2121; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">','</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">)))</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">  transformed </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">=</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> parsed_input_rdd</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">map(</span><span style=\"color: green; font-family: &quot;courier new&quot;; font-size: 14px; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;\">lambda</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> x: ((x[exp], x[prod]),</span></span></div><div dir=\"ltr\" style=\"line-height: 1.4571514285714287; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"background-color: white;\"><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">                                                (x[sale_count]</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">*</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">x[price], x[sale_count])))</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"><br /></span></span></div><div dir=\"ltr\" style=\"line-height: 1.4571514285714287; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"background-color: white;\"><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">  (sp, clks) </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">=</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> (</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">0</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">, </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">1</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">) </span><span style=\"color: #408080; font-family: &quot;courier new&quot;; font-size: 14px; font-style: italic; vertical-align: baseline; white-space: pre-wrap;\"># sale price and sale_count</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">  (ep, spc) </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">=</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> (</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">0</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">, </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">1</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">) </span><span style=\"color: #408080; font-family: &quot;courier new&quot;; font-size: 14px; font-style: italic; vertical-align: baseline; white-space: pre-wrap;\"># exp_id&amp;product_id, sp&amp;sale_count</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">  (exp2, prod2) </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">=</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> (</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">0</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">, </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">1</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">) </span><span style=\"color: #408080; font-family: &quot;courier new&quot;; font-size: 14px; font-style: italic; vertical-align: baseline; white-space: pre-wrap;\"># exp_id, product_id</span></span><br /><span style=\"background-color: white;\"><span style=\"font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"><span style=\"color: #408080;\"><i><br class=\"kix-line-break\" /></i></span></span><span style=\"color: #408080; font-family: &quot;courier new&quot;; font-size: 14px; font-style: italic; vertical-align: baseline; white-space: pre-wrap;\">  # For each product cross exp_id, sum the sale prices and sale_count</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">  grouped_result </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">=</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> transformed</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">reduceByKey(</span><span style=\"color: green; font-family: &quot;courier new&quot;; font-size: 14px; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;\">lambda</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> x,y: (x[sp]</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">+</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">y[sp], x[clks]</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">+</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">y[clks]))</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">  grouped_by_product </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">=</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> grouped_result</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">map(</span><span style=\"color: green; font-family: &quot;courier new&quot;; font-size: 14px; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;\">lambda</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> x: ((x[ep][prod2]), (x[ep][exp2], x[spc][sp], x[spc][clks])))</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">groupByKey()</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span></span><span id=\"docs-internal-guid-70f625c1-e644-8f9c-7969-e79933367c86\"></span></div><div><span style=\"background-color: white;\"><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"><br /></span></span></div><div dir=\"ltr\" style=\"line-height: 1.4571514285714287; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"background-color: white;\"><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">  numerator_sum </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">=</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> grouped_by_product</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">map(</span><span style=\"color: green; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 700; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">lambda</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> x: calc_numerator(x))</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">reduce(add)</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">  denominator_sum </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">=</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> grouped_by_product</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">map(</span><span style=\"color: green; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 700; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">lambda</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> x: calc_denominator(x))</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">reduce(add)</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">  effect </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">=</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> numerator_sum </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">/</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> denominator_sum</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: green; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 700; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">  print</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">(numerator_sum, denominator_sum, effect)</span></span></div><div dir=\"ltr\" style=\"line-height: 1.4571514285714287; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"background-color: #f7f7f7; color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-variant: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br /></span></div></div><div><div dir=\"ltr\" style=\"line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;\">Spark functions fall into two categories: <b>transformations</b> that manipulate the data record by record (e.g., map and filter), and <b>actions</b> that cause the data to be reorganized (e.g., <span style=\"font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\">groupByKey</span>, <span style=\"font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\">reduceByKey</span>). The significance of the distinction is that transformations have no immediate effect and are only acted upon when an action is reached, that is, Spark does lazy evaluation.&nbsp;</div><div dir=\"ltr\" style=\"margin-bottom: 0pt; margin-top: 0pt;\"><br />Excluding business-logic, the program is only a handful of lines of code.</div><ul><li><span style=\"font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\">sc.textFile(...)</span> transforms a file on disk into an RDD (the distributed data structure in Spark)</li><li><span style=\"font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\">input_rdd.first()&nbsp;</span>acts on the RDD returning first, header, element to the driver (my notebook).</li><li><span style=\"font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\">input_rdd.filter(...).map(...)</span> transforms <span style=\"font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\">input_rdd</span> removing the header then converts each csv line into floats and ints.</li><li><span style=\"font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\">parsed_input_rdd.map(...)</span> transforms records into key-value tuples <span style=\"font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\">((exp_id, product_id), (cost, clicks))</span></li><li><span style=\"font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\">transformed.reduceByKey(...)</span> acts on transformed causing <span style=\"font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\">input_rdd.filter(...).map(...)</span> and <span style=\"font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\">parsed_input_rdd.map(...)</span> to be executed and produces the total clicks and cost by <span style=\"font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\">(exp_id, product_id)</span></li><li><span style=\"font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\">grouped_result.map(...).groupByKey()&nbsp;</span>acts to produce the same data, only grouped by <span style=\"font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\">product_id</span> instead of <span style=\"font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\">product_id</span> and <span style=\"font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\">experiment_id</span>.&nbsp;</li><li><span style=\"font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\">grouped_by_product.map(...).reduce(add)</span> transforms the data per <span style=\"font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\">product_id</span> into the numerator and denominator of the MH calculation and then performs the action of summing the results using the <span style=\"font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\">add</span> function.</li></ul><div dir=\"ltr\" style=\"margin-bottom: 0pt; margin-top: 0pt;\"></div><h4><span style=\"vertical-align: baseline;\">MH in Apache Beam</span></h4><span style=\"vertical-align: baseline;\">The organization of the Dataflow code is rather similar to Spark overall, with a handful of subtle, but important distinctions. One of the less interesting differences is that Dataflow doesn’t yet have a sum function for the reduce, so I have to write my own (<span style=\"font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\">t_sum</span>). Note that this code is using the Dataflow SDK (not the new <a href=\"https://github.com/apache/incubator-beam/tree/python-sdk/sdks/python\">Beam SDK</a>).</span><br /><div dir=\"ltr\" style=\"line-height: 1.4571514285714287; margin-bottom: 0pt; margin-top: 0pt;\"><span id=\"docs-internal-guid-70f625c1-e651-fd73-b71c-3e6ecef5983d\" style=\"background-color: white;\"></span><br /><div dir=\"ltr\" style=\"line-height: 1.4571514285714287; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"background-color: white;\"><span style=\"color: green; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 700; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">  import</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> </span><span style=\"color: blue; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 700; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">apache_beam</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> </span><span style=\"color: green; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 700; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">as</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> </span><span style=\"color: blue; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 700; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">beam</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: green; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 700; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">  def</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> </span><span style=\"color: blue; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">t_sum</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">(values):</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;&nbsp;&nbsp;result </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">=</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> [</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">0</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">,</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">0</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">]</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;&nbsp;&nbsp;</span><span style=\"color: green; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 700; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">for</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> v </span><span style=\"color: #aa22ff; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 700; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">in</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> values:</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result[</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">0</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">] </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">+=</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> v[</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">0</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">]</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result[</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">1</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">] </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">+=</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> v[</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">1</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">]</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;&nbsp;&nbsp;</span><span style=\"color: green; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 700; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">return</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> (result[</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">0</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">], result[</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">1</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">])</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #408080; font-family: &quot;courier new&quot;; font-size: 14px; font-style: italic; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">  # Create a pipeline executing on a direct runner (local, non-cloud).</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #408080; font-family: &quot;courier new&quot;; font-size: 14px; font-style: italic; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">  # DirectPipelineRunner is the default runner, I'm setting it here to show how one</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #408080; font-family: &quot;courier new&quot;; font-size: 14px; font-style: italic; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">  # would change it to run on the Dataflow Service.</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">  pipeline_options </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">=</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> beam</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">utils</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">options</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">PipelineOptions([</span><span style=\"color: #ba2121; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">'--runner=DirectPipelineRunner'</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">])</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">  p </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">=</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> beam</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">Pipeline(options</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">=</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">pipeline_options)</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">  parsed_input_rdd </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">=</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> (p</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">   </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">|</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> </span><span style=\"color: #ba2121; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">'load records'</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">&gt;&gt;</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> </span></span></div><div dir=\"ltr\" style=\"line-height: 1.4571514285714287; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"background-color: white;\"><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">     beam</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">io</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">Read(beam</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">io</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">TextFileSource(</span><span style=\"color: #ba2121; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">'sim_data_{0}_{1}.csv'</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">format(NUM_LE, NUM_HE)))</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">   </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">|</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> </span><span style=\"color: #ba2121; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">'filter header'</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">&gt;&gt;</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> beam</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">Filter(</span><span style=\"color: green; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 700; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">lambda</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> x: x[</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">0</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">] </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">!=</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> </span><span style=\"color: #ba2121; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">'#'</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">)</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">   </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">|</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> </span><span style=\"color: #ba2121; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">'split line'</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">&gt;&gt;</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> beam</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">Map(</span><span style=\"color: green; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 700; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">lambda</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> x: convert_line(x</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">split(</span><span style=\"color: #ba2121; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">','</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">))))</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">  transformed </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">=</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> (parsed_input_rdd</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">   </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">|</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> </span><span style=\"color: #ba2121; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">'reshape'</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">&gt;&gt;</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> beam</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">Map((</span><span style=\"color: green; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 700; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">lambda</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> x: ((x[exp], x[prod]),</span></span></div><div dir=\"ltr\" style=\"line-height: 1.4571514285714287; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"background-color: white;\"><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">                                       (x[price]</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">*</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">x[sale_count], x[sale_count])))))</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">  (sp, clks) </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">=</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> (</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">0</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">, </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">1</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">) </span><span style=\"color: #408080; font-family: &quot;courier new&quot;; font-size: 14px; font-style: italic; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"># sale price and sale_count</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">  (ep, spc) </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">=</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> (</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">0</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">, </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">1</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">) </span><span style=\"color: #408080; font-family: &quot;courier new&quot;; font-size: 14px; font-style: italic; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"># exp_id&amp;product_id, sp&amp;sale_count</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">  (exp2, prod2) </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">=</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> (</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">0</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">, </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">1</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">) </span><span style=\"color: #408080; font-family: &quot;courier new&quot;; font-size: 14px; font-style: italic; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"># exp_id, product_id</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #408080; font-family: &quot;courier new&quot;; font-size: 14px; font-style: italic; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">  # For each product cross exp_id, sum the sale prices and sale_count</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">  grouped_result </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">=</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> (transformed</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">   </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">|</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> </span><span style=\"color: #ba2121; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">'combine per product/id'</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">&gt;&gt;</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> beam</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">CombinePerKey(t_sum))</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">  grouped_by_product </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">=</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> (grouped_result</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">   </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">|</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> </span><span style=\"color: #ba2121; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">'keyByExpProduct'</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">&gt;&gt;</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> beam</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">Map(</span><span style=\"color: green; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 700; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">lambda</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> x: ((x[ep][prod2]),</span></span></div><div dir=\"ltr\" style=\"line-height: 1.4571514285714287; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"background-color: white;\"><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">                                              (x[ep][exp2], x[spc][sp], x[spc][clks])))</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">   </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">|</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> </span><span style=\"color: #ba2121; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">'group'</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">&gt;&gt;</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> beam</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">GroupByKey())</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">  numerator_sum </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">=</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> (grouped_by_product</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">   </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">|</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> </span><span style=\"color: #ba2121; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">'MapForNum'</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">&gt;&gt;</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> beam</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">Map(</span><span style=\"color: green; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 700; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">lambda</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> x: calc_numerator(x))</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">   </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">|</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> </span><span style=\"color: #ba2121; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">'CombineNum'</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">&gt;&gt;</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> beam</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">CombineGlobally(</span><span style=\"color: green; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">sum</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">))</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">  numerator_sum </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">|</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> </span><span style=\"color: #ba2121; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">'save numerator'</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">&gt;&gt;</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> beam</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">io</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">Write(beam</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">io</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">TextFileSink(</span><span style=\"color: #ba2121; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">'./numerator_sum'</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">))</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">  denominator_sum </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">=</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> (grouped_by_product</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">   </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">|</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> </span><span style=\"color: #ba2121; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">'MapForDenom'</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">&gt;&gt;</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> beam</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">Map(</span><span style=\"color: green; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 700; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">lambda</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> x: calc_denominator(x))</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">   </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">|</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> </span><span style=\"color: #ba2121; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">'CombineDenom'</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">&gt;&gt;</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> beam</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">CombineGlobally(</span><span style=\"color: green; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">sum</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">))</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">  denominator_sum </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">|</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> </span><span style=\"color: #ba2121; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">'save denominator'</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> </span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">&gt;&gt;</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"> </span></span></div><div dir=\"ltr\" style=\"line-height: 1.4571514285714287; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"background-color: white;\"><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">     beam</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">io</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">Write(beam</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">io</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">TextFileSink(</span><span style=\"color: #ba2121; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">'./denominator_sum'</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">))</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">  p</span><span style=\"color: #666666; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-family: &quot;courier new&quot;; font-size: 14px; font-style: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;\">run()</span></span></div></div><br />Beam is conceptually two pieces: pipeline construction and pipeline execution. <span style=\"font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\">beam.Pipeline()</span> returns a pipeline, say <span style=\"font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\">p</span>, on which to build (using <span style=\"font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\">beam.Map</span>, <span style=\"font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\">beam.GroupByKey,</span> etc.) and <span style=\"font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\">p.run()</span> executes the pipeline on a cluster, by the Dataflow Service, or in our case, locally.<br /><ul><li><span style=\"font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\">beam.Pipeline(options=pipeline_options)</span> begins constructing a pipeline to run locally.&nbsp;</li><li><span style=\"font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\">p | beam.io.Read(...) | beam.Filter(...) | beam.Map(...) </span>add reading the file, filtering lines that look like the header (starting with ‘#’), converting each line into floats and ints to the graph.</li><li><span style=\"font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\">parsed_input_rdd | beam.Map(...)</span> adds mapping each record to be keyed by <span style=\"font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\">exp_id, product_id</span> to the graph</li><li><span style=\"font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\">transformed | beam.CombinePerKey(...) | beam.Map(...) | beam.GroupByKey()&nbsp;</span>adds summing clicks and cost by <span style=\"font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\">exp_id, product_id</span> and regrouping by <span style=\"font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\">product_id</span> to the graph</li><li><span style=\"font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\">grouped_by_product | beam.Map(...) | beam.CombineGlobally(...)</span> adds calculating the numerator/denominator values and the global sum to the graph</li><li><span style=\"font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\">numerator_sum | beam.Write(...)</span> adds a sync for the numerator (there is a matching output for the denominator).</li><li><span style=\"font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\">p.run()</span> optimizes constructed graph and ships the result to be executed (in our case the local machine)</li></ul><h4>Comparison of implementations</h4>At a high-level, both implementations look similar and use the same basic parallel operations. The first difference to point out is that Spark <b>executes</b> the graph only on <b>actions</b>, e.g., <span style=\"font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\">reduceByKey</span>, whereas the runner executing Beam, e.g., Cloud Dataflow, executes the complete graph (when run is invoked). Another difference is that Dataflow graphs require <b>sources</b> and <b>sinks</b>, which means results must be <b>piped</b> to files and cannot be returned to the calling program (with the exception of using the local runner).<br /><br /></div><div><h2>Spark’s sweet-spot: iterative algorithms</h2>Spark started as a <a href=\"http://blog.madhukaraphatak.com/history-of-spark/\">solution for doing exploratory analysis and Machine Learning</a>. One of the simplest ways to show this off is the clustering technique <a href=\"https://en.wikipedia.org/wiki/K-means_clustering\">k-means clustering</a>. K-means works by repeatedly applying two steps, assigning points to clusters and updating cluster centers, until the location of the cluster centers have stabilized. Below is the core of the algorithm written in Spark.<br /><div dir=\"ltr\" style=\"line-height: 1.4571514285714287; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"background-color: #f7f7f7; color: #408080; font-family: &quot;arial&quot;; font-size: 14px; font-style: italic; vertical-align: baseline; white-space: pre-wrap;\"></span></div><div dir=\"ltr\" style=\"line-height: 1.4571514285714287; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"background-color: white; font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\"><span style=\"color: #408080; font-size: 14px; font-style: italic; vertical-align: baseline; white-space: pre-wrap;\">  # Load the data, remove the first line, and pick initial locations for the clusters.</span></span></div><div dir=\"ltr\" style=\"line-height: 1.4571514285714287; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"background-color: white; font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\"><span style=\"color: #408080; font-size: 14px; font-style: italic; vertical-align: baseline; white-space: pre-wrap;\">  # We put the x,y points in pt_rdd, and RDD of PtAgg (a class containing x, y,</span></span></div><div dir=\"ltr\" style=\"line-height: 1.4571514285714287; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"background-color: white; font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\"><span style=\"color: #408080; font-size: 14px; font-style: italic; vertical-align: baseline; white-space: pre-wrap;\">  # and count).</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">  pt_rdd </span><span style=\"color: #666666; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">=</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> parsed_input_rdd</span><span style=\"color: #666666; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">map(</span><span style=\"color: green; font-size: 14px; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;\">lambda</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> x: PtAgg(x[</span><span style=\"color: #666666; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">0</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">], x[</span><span style=\"color: #666666; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">1</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">], </span><span style=\"color: #666666; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">1</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">))</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">  MAX_STEPS </span><span style=\"color: #666666; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">=</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> </span><span style=\"color: #666666; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">100; </span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">&nbsp;MIN_DELTA </span><span style=\"color: #666666; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">=</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> </span><span style=\"color: #666666; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">0.001</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">; delta </span><span style=\"color: #666666; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">=</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> </span><span style=\"color: #666666; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">1.0</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">; step </span><span style=\"color: #666666; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">=</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> </span><span style=\"color: #666666; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">0</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: green; font-size: 14px; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;\">  while</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> delta </span><span style=\"color: #666666; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">&gt;</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> MIN_DELTA </span><span style=\"color: #aa22ff; font-size: 14px; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;\">and</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> step </span><span style=\"color: #666666; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">&lt;</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> MAX_STEPS:</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;&nbsp;&nbsp;step </span><span style=\"color: #666666; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">+=</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> </span><span style=\"color: #666666; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">1</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;&nbsp;&nbsp;c_centers_old </span><span style=\"color: #666666; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">=</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> copy</span><span style=\"color: #666666; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">deepcopy(c_centers)</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;&nbsp;&nbsp;b_c_centers </span><span style=\"color: #666666; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">=</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> sc</span><span style=\"color: #666666; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">broadcast(c_centers_old)</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;&nbsp;&nbsp;</span><span style=\"color: #408080; font-size: 14px; font-style: italic; vertical-align: baseline; white-space: pre-wrap;\"># For every point, find the cluster its closer to and add to its total x, y, and count</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;&nbsp;&nbsp;totals </span><span style=\"color: #666666; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">=</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> pt_rdd</span><span style=\"color: #666666; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">map(</span><span style=\"color: green; font-size: 14px; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;\">lambda</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> x: pick_closest_center(x, b_c_centers</span><span style=\"color: #666666; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">value))</span><span style=\"color: #666666; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">reduce(</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=\"color: green; font-size: 14px; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;\">lambda</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> a,b: center_reduce(a,b))</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;&nbsp;&nbsp;</span><span style=\"color: #408080; font-size: 14px; font-style: italic; vertical-align: baseline; white-space: pre-wrap;\"># Now update the location of the centers as the mean of all of the points closest to it</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;&nbsp;&nbsp;</span><span style=\"color: #408080; font-size: 14px; font-style: italic; vertical-align: baseline; white-space: pre-wrap;\"># (unless there are none, in which case pick a new random spot).</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;&nbsp;&nbsp;c_centers </span><span style=\"color: #666666; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">=</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> [t</span><span style=\"color: #666666; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">Normalize() </span><span style=\"color: green; font-size: 14px; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;\">if</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> t</span><span style=\"color: #666666; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">cnt </span><span style=\"color: #666666; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">!=</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> </span><span style=\"color: #666666; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">0</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> </span><span style=\"color: green; font-size: 14px; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;\">else</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> random_point_location() </span><span style=\"color: green; font-size: 14px; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;\">for</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> t </span><span style=\"color: #aa22ff; font-size: 14px; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;\">in</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> totals]</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;&nbsp;&nbsp;</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;&nbsp;&nbsp;</span><span style=\"color: #408080; font-size: 14px; font-style: italic; vertical-align: baseline; white-space: pre-wrap;\"># compute the distance that each cluster center moves, the set the max of those as</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;&nbsp;&nbsp;</span><span style=\"color: #408080; font-size: 14px; font-style: italic; vertical-align: baseline; white-space: pre-wrap;\"># the delta used to the stop condition.</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;&nbsp;&nbsp;deltas </span><span style=\"color: #666666; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">=</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> [math</span><span style=\"color: #666666; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">sqrt(c</span><span style=\"color: #666666; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">DistSqr(c_old)) </span><span style=\"color: green; font-size: 14px; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;\">for</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> c, c_old </span><span style=\"color: #aa22ff; font-size: 14px; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;\">in</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> </span><span style=\"color: green; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">zip</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">(c_centers, c_centers_old)]</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;&nbsp;&nbsp;delta </span><span style=\"color: #666666; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">=</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> </span><span style=\"color: green; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">max</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">(deltas)</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">  s </span><span style=\"color: #666666; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">=</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> </span><span style=\"color: #ba2121; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">' '</span><span style=\"color: #666666; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">join([</span><span style=\"color: green; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">str</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">(x) </span><span style=\"color: green; font-size: 14px; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;\">for</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> x </span><span style=\"color: #aa22ff; font-size: 14px; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;\">in</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"> c_centers])</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\"><br class=\"kix-line-break\" /></span><span style=\"color: green; font-size: 14px; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;\">  print</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">(</span><span style=\"color: #ba2121; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">'final centers: {0}'</span><span style=\"color: #666666; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">.</span><span style=\"color: #333333; font-size: 14px; vertical-align: baseline; white-space: pre-wrap;\">format(s))</span></span></div><ul><li><span style=\"font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\">parsed_input_rdd.map(...)</span> maps the raw into into the <span style=\"font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\">PtAgg</span> class we use to represent points</li><li><span style=\"font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\">sc.broadcast(c_centers_old)</span> sends the locations of the cluster centers to all machines holding RDDs</li><li><span style=\"font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\">pt_rdd.map(...).reduce(...)</span> maps each point to the center it’s closest to and then reduces to produce the average location of the points that are closest to each center (the result is in the driver script)</li><li><span style=\"font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;\">[t.Normalize() if t.cnt != 0 else random_point_location() for t in totals]</span> updates the new cluster locations.</li></ul><div dir=\"ltr\" style=\"margin-bottom: 0pt; margin-top: 0pt;\">As it happens, I didn’t actually need to write that code because Spark has an ML library (mllib) containing many algorithms including k-means.  In practice, k-means is a just a few functions calls, <a href=\"http://spark.apache.org/docs/latest/mllib-clustering.html\">details are here</a>.<br /><br />Here is where the difference between Spark and Beam is most apparent&nbsp;—&nbsp;<b>no iterative algorithm that can stop early, including k-means, can be expressed in Beam</b>. This is because Beam builds the computation graph, then optimizes and ships it to be executed. With iterative algorithms, the complete graph structure cannot be known before hand (don’t know how many loops will be done), so it can’t be expressed in Beam. It is possible to express “loops” in Dataflow, but only a fixed number of loops can be added.</div><div dir=\"ltr\" style=\"margin-bottom: 0pt; margin-top: 0pt;\"><br /></div><h2>Beam/Dataflow’s sweet spot: streaming processing</h2>Streaming processing is an ever-increasingly important topic for data science. After all, who among us really wants to wait for a daily batch pipeline to tell us how our live traffic experiments are doing? For a great introduction to streaming processing, I highly encourage reading Tyler Akidau’s two blog posts on the topic, <a href=\"https://www.oreilly.com/ideas/the-world-beyond-batch-streaming-101\">The world beyond batch: Streaming 101</a> and <a href=\"https://www.oreilly.com/ideas/the-world-beyond-batch-streaming-102\">102</a>.<br /><br />When Dataflow was released, its strongest selling point was streaming (just read the <a href=\"http://static.googleusercontent.com/media/research.google.com/en//pubs/archive/43864.pdf\">paper</a>). That’s not to say that Spark doesn’t support streaming process or that it lacks a unified engine for batch and streaming. The significant step Dataflow initially made was (1) a truly unified batch and streaming API and (2) support for event time processing of data, that is, analysis of the results windowed by <b>when they happened not when they reached the analysis machine</b>, (3) and a focus on watermarks (a method for tracking collection progress on unbounded data) and window completeness (has all of the data for this time period been collected). More practically, Dataflow, now Beam, has a streaming API that cleanly separates the important questions of streaming processing: what, where, when, how). It’s worth noting that different runners currently have different levels of support, e.g., Dataflow supports streaming for Java, but not yet for Python.<br /><br />All this is easiest to show using the examples the Dataflow team used in their<a href=\"https://cloud.google.com/dataflow/blog/dataflow-beam-and-spark-comparison\"> recent blog post</a>, which is also a good read. The starkest contrast between the two is shown by their example of calculating hourly team scores for an online game.</div><div><br /><h2>Other differences in framework “philosophy”</h2>There are several design decisions to show that Spark favors fast development by default and requires users to opt-in to performance whereas Dataflow favors high performance by default with the cost of slower development time.</div><div><h4>Caching</h4>Dataflow avoids the need for caching results by “fusing” sibling stages that would need the same input. Fusion comes with the limitation that mutable types should not be used. This is because the values are shared among fused sibling and modification would cause invalid results (this is verified against at run-time). This means writing correct Beam code with mutable types requires significantly more care. Spark re-computes by default, which can be much slower but doesn’t come with correctness issues. Spark does allow for many different caching methods, <a href=\"http://spark.apache.org/docs/latest/programming-guide.html#which-storage-level-to-choose\">should caching be desired</a>.<br /><h4>Equality</h4>Dataflow uses a fast, language agnostic, serialized byte-level equality for comparing classes in GroupByKey and other steps. This becomes a huge issue if the program uses grouping operations on classes that contain hashmaps, sets, or anything that causes semantic equality to differ from byte equality. Spark deserializes classes and uses the class’s comparison operator for grouping by default and allows user to opt-into byte-level equality making the opposite tradeoff.<br /><h4>Overall performance</h4>Unfortunately, we currently can’t make any definitive statements about which framework has better overall performance. The <a href=\"http://mammothdata.com/wp-content/uploads/2016/04/GoogleCloudDataflow.Benchmark.pdf\">only study</a> that compared Beam on the Dataflow Service to Spark used an older version of Spark (1.3). Given the significant performance increases with Spark 2.0, it’s unclear which framework has better performance at present.</div><br /><h2>Conclusion</h2><div>Spark and Dataflow both solve the limitations of MapReduce with different viewpoints. Which tool is most appropriate will depend on the project. If the focus is interactivity, data exploration or algorithm development, Spark is probably the better option. If the focus is complex streaming processing (especially event time) then Beam would seem a better fit. For running scalable production pipelines, Beam on Cloud Dataflow is likely the better choice.</div><div><br /></div>",
  "link": [
    "",
    "",
    ""
  ],
  "author": {
    "name": "Amir Najmi",
    "uri": "http://www.blogger.com/profile/18174523203317227640",
    "email": "noreply@blogger.com",
    "gd:image": ""
  },
  "media:thumbnail": ""
}