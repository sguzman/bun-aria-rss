{
  "title": "Thread First Pattern",
  "link": "",
  "updated": "2013-08-30T00:00:00+00:00",
  "id": "https://mrocklin.github.io/blog/work/2013/08/30/Thread-First",
  "content": "<p>My physics colleague is learning Python and asked me for a simple way to parse\nthe following file header</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>CPMD CUBE FILE.\nOUTER LOOP: X, MIDDLE LOOP: Y, INNER LOOP: Z\n   3    0.000000    0.000000    0.000000\n  40    0.283459    0.000000    0.000000\n  40    0.000000    0.283459    0.000000\n  40    0.000000    0.000000    0.283459\n   8    0.000000    5.570575    5.669178    5.593517\n   1    0.000000    5.562867    5.669178    7.428055\n   1    0.000000    7.340606    5.669178    5.111259\n-0.25568E-04  0.59213E-05  0.81068E-05  0.10868E-04  0.11313E-04  0.35999E-05\n     :             :             :           :            :            :\n     :             :             :           :            :            :\n     :             :             :           :            :            :\n       In this case there will be 40 x 40 x 40 floating point values\n     :             :             :           :            :            :\n     :             :             :           :            :            :\n     :             :             :           :            :            :\n</code></pre></div></div>\n\n<p>Normally for tabular data I would just point him towards <code class=\"language-plaintext highlighter-rouge\">numpy.loadtxt</code> or the <code class=\"language-plaintext highlighter-rouge\">csv</code> module.  This particular dataset is a tad annoying though, look closely for the following complications</p>\n\n<ol>\n  <li>There are three separate numerical tables\n    <ul>\n      <li>Lines 2-5 are three lines with four columns</li>\n      <li>Lines 6-9 are three lines with five columns</li>\n      <li>Lines 11 onward is a traditional table with many float columns</li>\n    </ul>\n  </li>\n  <li>The first column to the first two sections contains integers instead of floating point numbers</li>\n</ol>\n\n<p>Neither the <code class=\"language-plaintext highlighter-rouge\">csv</code> module nor the <code class=\"language-plaintext highlighter-rouge\">numpy.loadtxt/genfromtext</code> functions are capable of wrapping this complexity.  This is commonplace, we often have data that doesn’t quite fit our module’s expectations.  At this point we often fall back to traditional programming.</p>\n\n<p>My colleague’s solution was a sequence of for loops, appending data onto a set of lists.</p>\n\n<figure class=\"highlight\">\n  <pre><code class=\"language-python\" data-lang=\"python\"><span class=\"k\">with</span> <span class=\"nb\">open</span><span class=\"p\">(</span><span class=\"n\">filename</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n    <span class=\"n\">lines</span> <span class=\"o\">=</span> <span class=\"n\">f</span><span class=\"p\">.</span><span class=\"n\">readlines</span><span class=\"p\">()</span>\n\n<span class=\"c1\"># First table\n</span><span class=\"n\">int_column</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n<span class=\"n\">float_columns</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n<span class=\"k\">for</span> <span class=\"n\">line</span> <span class=\"ow\">in</span> <span class=\"n\">lines</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">:</span><span class=\"mi\">5</span><span class=\"p\">]:</span>\n    <span class=\"n\">tokens</span> <span class=\"o\">=</span> <span class=\"n\">line</span><span class=\"p\">.</span><span class=\"n\">split</span><span class=\"p\">()</span>\n    <span class=\"n\">int_columns</span><span class=\"p\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"n\">tokens</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]))</span>\n    <span class=\"n\">float_columns</span><span class=\"p\">.</span><span class=\"n\">append</span><span class=\"p\">([</span><span class=\"nb\">float</span><span class=\"p\">(</span><span class=\"n\">tok</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">tok</span> <span class=\"ow\">in</span> <span class=\"n\">tokens</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">:]])</span>\n\n<span class=\"c1\"># Second table\n</span><span class=\"p\">....</span></code></pre>\n</figure>\n\n<p>This solution is standard but, in my colleague’s words, not particularity “cute”.  He wanted to know if there was a “cute” language idiom to handle tasks like these.  I’ve been programming in a functional style for a while now and decided to see if that paradigm could offer a better option.  After some back and forth with him I stabilized on the following solution.</p>\n\n<figure class=\"highlight\">\n  <pre><code class=\"language-python\" data-lang=\"python\"><span class=\"kn\">from</span> <span class=\"nn\">functoolz</span> <span class=\"kn\">import</span> <span class=\"n\">thread_first</span>\n<span class=\"kn\">from</span> <span class=\"nn\">itertools</span> <span class=\"kn\">import</span> <span class=\"n\">islice</span>\n<span class=\"kn\">import</span> <span class=\"nn\">StringIO</span>\n<span class=\"kn\">import</span> <span class=\"nn\">numpy</span>\n\n<span class=\"c1\"># First table\n</span><span class=\"n\">int_column</span><span class=\"p\">,</span> <span class=\"n\">float_columns</span> <span class=\"o\">=</span> \\\n    <span class=\"n\">thread_first</span><span class=\"p\">(</span><span class=\"n\">filename</span><span class=\"p\">,</span>\n                 <span class=\"nb\">open</span><span class=\"p\">,</span>\n                 <span class=\"p\">(</span><span class=\"n\">islice</span><span class=\"p\">,</span> <span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"mi\">5</span><span class=\"p\">),</span>\n                 <span class=\"s\">''</span><span class=\"p\">.</span><span class=\"n\">join</span><span class=\"p\">,</span>\n                 <span class=\"n\">StringIO</span><span class=\"p\">.</span><span class=\"n\">StringIO</span><span class=\"p\">,</span>\n                 <span class=\"n\">numpy</span><span class=\"p\">.</span><span class=\"n\">genfromtxt</span><span class=\"p\">,</span>\n                 <span class=\"k\">lambda</span> <span class=\"n\">X</span><span class=\"p\">:</span> <span class=\"p\">(</span><span class=\"n\">X</span><span class=\"p\">[:,</span><span class=\"mi\">0</span><span class=\"p\">].</span><span class=\"n\">astype</span><span class=\"p\">(</span><span class=\"nb\">int</span><span class=\"p\">),</span> <span class=\"n\">X</span><span class=\"p\">[:,</span> <span class=\"mi\">1</span><span class=\"p\">:])))</span>\n<span class=\"c1\"># Second table\n</span><span class=\"p\">....</span></code></pre>\n</figure>\n\n<p>This solution is very different from my colleague’s.  Rather than provide explicit instructions on how to manipulate the data at a low-level (for loop with list appends) it describes a sequence of high-level transformations.  The <code class=\"language-plaintext highlighter-rouge\">thread_first</code> function takes the first argument (the data) and runs it through the following functions sequentially.  I’ll describe those functions below:</p>\n\n<hr />\n\n<table>\n  <thead>\n    <tr>\n      <th style=\"text-align: left\">Transformation</th>\n      <th style=\"text-align: left\">Explanation</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td style=\"text-align: left\"><code class=\"language-plaintext highlighter-rouge\">filename</code></td>\n      <td style=\"text-align: left\">Our original input, a filename like ‘file.txt’</td>\n    </tr>\n    <tr>\n      <td style=\"text-align: left\"><code class=\"language-plaintext highlighter-rouge\">open</code></td>\n      <td style=\"text-align: left\">Open the file for reading</td>\n    </tr>\n    <tr>\n      <td style=\"text-align: left\"><code class=\"language-plaintext highlighter-rouge\">(islice, 2, 5)</code></td>\n      <td style=\"text-align: left\">Take lines 2:5</td>\n    </tr>\n    <tr>\n      <td style=\"text-align: left\"><code class=\"language-plaintext highlighter-rouge\">''.join</code></td>\n      <td style=\"text-align: left\">Join them together into a single string</td>\n    </tr>\n    <tr>\n      <td style=\"text-align: left\"><code class=\"language-plaintext highlighter-rouge\">StringIO.StringIO</code></td>\n      <td style=\"text-align: left\">Turn that string into a file-like object</td>\n    </tr>\n    <tr>\n      <td style=\"text-align: left\"><code class=\"language-plaintext highlighter-rouge\">numpy.genfromtxt</code></td>\n      <td style=\"text-align: left\">Parse into an array</td>\n    </tr>\n    <tr>\n      <td style=\"text-align: left\"><code class=\"language-plaintext highlighter-rouge\">lambda X: (X[:,0].astype(int), X[:, 1:]))</code></td>\n      <td style=\"text-align: left\">Separate array into first and all other columns</td>\n    </tr>\n  </tbody>\n</table>\n\n<hr />\n\n<p>It is equivalent to the following lines:</p>\n\n<figure class=\"highlight\">\n  <pre><code class=\"language-python\" data-lang=\"python\"><span class=\"n\">X</span> <span class=\"o\">=</span> <span class=\"n\">numpy</span><span class=\"p\">.</span><span class=\"n\">genfromtxt</span><span class=\"p\">(</span><span class=\"s\">''</span><span class=\"p\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"n\">StringIO</span><span class=\"p\">.</span><span class=\"n\">StringIO</span><span class=\"p\">(</span><span class=\"n\">islice</span><span class=\"p\">(</span><span class=\"nb\">open</span><span class=\"p\">(</span><span class=\"s\">'file.txt'</span><span class=\"p\">),</span> <span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"mi\">5</span><span class=\"p\">))))</span>\n<span class=\"n\">X</span><span class=\"p\">[:,</span><span class=\"mi\">0</span><span class=\"p\">].</span><span class=\"n\">astype</span><span class=\"p\">(</span><span class=\"nb\">int</span><span class=\"p\">),</span> <span class=\"n\">X</span><span class=\"p\">[:,</span> <span class=\"mi\">1</span><span class=\"p\">:]</span></code></pre>\n</figure>\n\n<h3 id=\"why-this-solution-is-worse\">Why this Solution is Worse</h3>\n\n<p>Here are my thoughts on why the functional solution is worse.  If you have other thoughts please list them in the comments:</p>\n\n<ol>\n  <li>It’s weird and the current base of programmers will be put off</li>\n  <li>It uses functions that are not commonly known like <code class=\"language-plaintext highlighter-rouge\">StringIO</code>, <code class=\"language-plaintext highlighter-rouge\">islice</code>, and <code class=\"language-plaintext highlighter-rouge\">numpy.genfromtxt</code>.  It demands a richer vocabulary.</li>\n  <li>It is inefficient because it opens and reads the file for each section.  It does not optimally manage state.</li>\n</ol>\n\n<h3 id=\"why-this-solution-is-better\">Why this Solution is Better</h3>\n\n<p>Here are my thoughts on why the functional solution is better.  Again, if you have other thoughts please do list them in the comments:</p>\n\n<ol>\n  <li>The intent of the operation is more explicit.</li>\n  <li>The component functions used are well tested.  There are fewer opportunities for bugs.</li>\n  <li>The information content of each term is high.  This solution reinvents the minimum amount of technology.</li>\n</ol>\n\n<h3 id=\"thoughts\">Thoughts</h3>\n\n<p>Today I wouldn’t use this solution in production code mainly because my usual colleagues aren’t familiar with it.  However I do think that the ideas behind the solution do have substantial merit.  In particular</p>\n\n<ul>\n  <li>Function reuse:  Reinventing wheels is both wasteful to the programmer and harmful to the longevity the code.</li>\n  <li>Standard library - The use of standard library functions supports more rapid understanding of your code.</li>\n  <li>Composition - Mechanisms for function composition and encapsulation (like <code class=\"language-plaintext highlighter-rouge\">thread_first</code>) promote rapid development of novel and robust solutions.</li>\n</ul>\n\n<p>In general I think that while for loops and low-level code are globally accessible they also demand significant investment to understand their particular role in a certain application.  High-level/broad vocabulary solutions more directly present their intent but are limited to those programmers who understand them.</p>\n\n<h3 id=\"references\">References</h3>\n\n<ul>\n  <li><a href=\"http://github.com/mrocklin/functoolz/\"><code class=\"language-plaintext highlighter-rouge\">functoolz</code></a>: The functional solution uses <code class=\"language-plaintext highlighter-rouge\">thread_first</code>, a function from the non-standard <code class=\"language-plaintext highlighter-rouge\">functoolz</code> library.</li>\n</ul>"
}