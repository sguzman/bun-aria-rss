{
  "title": "A glass shattering book draw with gganimate",
  "link": "https://itsalocke.com/blog/a-glass-shattering-book-draw-with-gganimate/",
  "pubDate": "Wed, 01 Aug 2018 00:00:00 +0000",
  "guid": "https://itsalocke.com/blog/a-glass-shattering-book-draw-with-gganimate/",
  "description": "<p>It&rsquo;s time for a Twitter book draw again: every month, a random Locke Data Twitter follower wins an excellent data science book! This month&rsquo;s book was <a href=\"http://geni.us/mathdestruction\">Weapons of Math Destruction : How Big Data Increases Inequality and Threatens Democracy</a>. The animation I chose to create was inspired by the idea of <em>destruction</em> and by my wanting to try out the fantastic new API of the <code>gganimate</code> package, and a very fast new gif encoder, <code>gifski</code>.</p>\n\n<h1 id=\"choosing-an-animation-concept\">Choosing an animation concept</h1>\n\n<p>I am not a designer nor an artist, but I like imagining new animations to announce the book winner, that I want to be <strong>fun</strong>, and <strong>useful</strong> by illustrating the use of some nifty R tools. That&rsquo;s a good way for me and you to learn new R skills! I&rsquo;ve reported on <a href=\"https://itsalocke.com/blog/a-crystal-clear-book-draw/\">my efforts with <code>magick</code> to create a crystal ball for chibi Steph</a>, R package for image manipulation, and <a href=\"https://itsalocke.com/blog/a-particles-arly-fun-book-draw/\">with <code>particles</code>, R package for simulating, well, <em>particles</em>, to move followers&rsquo; names around!</a>.</p>\n\n<p>This month I thought about what destruction meant to me, and got the rather simple idea to have glass shatter, thus revealing the winner&rsquo;s name.</p>\n\n<h1 id=\"planning-the-my-animation-implementation\">Planning the my animation implementation</h1>\n\n<p>Feel free to skip over this section and go to the code directly, unless you want to know more about my search and process to write said code!</p>\n\n<p>I wondered how I could shatter glass, i.e. cut a blue square in small pieces and make these pieces fall and somehow ended up thinking that I could draw random points and then use their <a href=\"https://en.wikipedia.org/wiki/Voronoi_diagram\">Voronoi tiles</a> as fragments. I&rsquo;m not sure glass shattering really looks like this but I decided against experimenting with my windows.</p>\n\n<p>I wasn&rsquo;t too sure how to make and use the fragments though. I re-read <a href=\"https://www.data-imaginist.com/2016/data-driven-x-mas-card/\">Thomas Lin Pedersen&rsquo;s excellent post about making a Christmas card using Voronoi tesselation</a> but as nice and well-explained as it was, it wasn&rsquo;t exactly what I was after. I set out to find a way to create Voronoi tiles as polygons and then to shift at least some of them downwards to create the animation.</p>\n\n<p>I tried using the <a href=\"https://cran.r-project.org/web/packages/deldir/index.html\"><code>deldir</code> package</a> a bit to create Voronoi tesselation out of random points but its output didn&rsquo;t make me too happy since it was <em>segments</em> rather than polygons. Re-creating polygons from them didn&rsquo;t sound too easy. I ditched this idea and googled keywords such as Voronoi and polygons and R and then <code>sf</code> the geospatial package since the first results indicated Voronoi tesselation was well supported for mapping stuff, and found this very useful <a href=\"https://stackoverflow.com/questions/45719790/create-voronoi-polygon-with-simple-feature-in-r\">Stack Overflow post</a> that made me <a href=\"https://r-spatial.github.io/sf/reference/geos_unary.html\">adapt an example from <code>sf</code> documentation</a>.</p>\n\n<p>Once I had the polygons, the rest was animation as usual, well not really, since <code>gganimate</code> new API by Thomas Lin Pedersen is different, and so powerful! I haven&rsquo;t watched <a href=\"https://www.youtube.com/watch?v=21ZWDrTukEs\">Thomas&rsquo; useR! keynote talk about The Grammar of animation</a> yet, but I look forward to it since I both admire his packages, and his <a href=\"https://www.data-imaginist.com/\">blog writing</a>. I only use very basic <code>gganimate</code> stuff here. A good intro to its grammar can be found at <a href=\"https://github.com/thomasp85/gganimate/tree/master#gganimate-\">https://github.com/thomasp85/gganimate/tree/master#gganimate-</a> .</p>\n\n<p>I was also glad to read that  <code>gifski</code> is now on CRAN for all your gif making needs (it&rsquo;s actually the default gif renderer of <code>gganimate</code>). This package by <a href=\"https://github.com/jeroen\">Jeroen Ooms</a> is not only a wrapper to the fastest gif renderer around which is cool enough in itself, but also the first CRAN package that interfaces a Rust library! Read more <a href=\"https://ropensci.org/technotes/2018/07/23/gifski-release/\">about <code>gifski</code> in this tech note</a>.</p>\n\n<h1 id=\"writing-the-actual-animation-code\">Writing the actual animation code</h1>\n\n<p>The first part of the code consisted of drawing random points and using them as a basis for a Voronoi tesselation inside a box.</p>\n<div class=\"highlight\"><pre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"><code class=\"language-r\" data-lang=\"r\"><span style=\"color:#75715e\"># adapted from https://r-spatial.github.io/sf/reference/geos_unary.html</span>\nlims <span style=\"color:#f92672\">&lt;-</span> <span style=\"color:#66d9ef\">c</span>(<span style=\"color:#ae81ff\">0</span>, <span style=\"color:#ae81ff\">10</span>)\n<span style=\"color:#75715e\"># sample 200 points inside an environment</span>\n<span style=\"color:#75715e\"># with a fix seed</span>\n<span style=\"color:#66d9ef\">with</span>(<span style=\"color:#66d9ef\">set.seed</span>(<span style=\"color:#ae81ff\">42</span>),\n     points <span style=\"color:#f92672\">&lt;-</span> sf<span style=\"color:#f92672\">::</span>st_multipoint(<span style=\"color:#66d9ef\">matrix</span>(runif(n <span style=\"color:#f92672\">=</span> <span style=\"color:#ae81ff\">400</span>, lims[<span style=\"color:#ae81ff\">1</span>],\n                                              lims[<span style=\"color:#ae81ff\">2</span>]),,<span style=\"color:#ae81ff\">2</span>)))\n\n<span style=\"color:#75715e\"># get a square box that&#39;ll be the area of our animation </span>\nbox <span style=\"color:#f92672\">&lt;-</span> sf<span style=\"color:#f92672\">::</span>st_polygon(<span style=\"color:#66d9ef\">list</span>(<span style=\"color:#66d9ef\">rbind</span>(<span style=\"color:#66d9ef\">c</span>(lims[<span style=\"color:#ae81ff\">1</span>], lims[<span style=\"color:#ae81ff\">1</span>]),\n                             <span style=\"color:#66d9ef\">c</span>(lims[<span style=\"color:#ae81ff\">2</span>], lims[<span style=\"color:#ae81ff\">1</span>]),\n                             <span style=\"color:#66d9ef\">c</span>(lims[<span style=\"color:#ae81ff\">2</span>], lims[<span style=\"color:#ae81ff\">2</span>]),\n                             <span style=\"color:#66d9ef\">c</span>(lims[<span style=\"color:#ae81ff\">1</span>], lims[<span style=\"color:#ae81ff\">2</span>]),\n                             <span style=\"color:#66d9ef\">c</span>(lims[<span style=\"color:#ae81ff\">1</span>], lims[<span style=\"color:#ae81ff\">1</span>]))))\n\n<span style=\"color:#75715e\"># Get the Voronoi polygons of the points</span>\nv <span style=\"color:#f92672\">&lt;-</span> sf<span style=\"color:#f92672\">::</span>st_sfc(sf<span style=\"color:#f92672\">::</span>st_voronoi(points, sf<span style=\"color:#f92672\">::</span>st_sfc(box)))\n<span style=\"color:#75715e\"># Keep only the part of them inside the box</span>\nvoronoi <span style=\"color:#f92672\">&lt;-</span> sf<span style=\"color:#f92672\">::</span>st_intersection(sf<span style=\"color:#f92672\">::</span>st_cast(v), box)\n\n<span style=\"color:#75715e\"># Get a data.frame with the polygons</span>\nget_df_from_polygon <span style=\"color:#f92672\">&lt;-</span> <span style=\"color:#66d9ef\">function</span>(polygon, index){\n  mat <span style=\"color:#f92672\">&lt;-</span> <span style=\"color:#66d9ef\">as.matrix</span>(polygon)\n  tibble<span style=\"color:#f92672\">::</span>tibble(x <span style=\"color:#f92672\">=</span> mat[,<span style=\"color:#ae81ff\">1</span>],\n                 y <span style=\"color:#f92672\">=</span> mat[,<span style=\"color:#ae81ff\">2</span>],\n                 tile <span style=\"color:#f92672\">=</span> index)\n}\n\ndf <span style=\"color:#f92672\">&lt;-</span> purrr<span style=\"color:#f92672\">::</span>map2_df(voronoi, <span style=\"color:#ae81ff\">1</span><span style=\"color:#f92672\">:</span><span style=\"color:#66d9ef\">length</span>(voronoi),\n                     get_df_from_polygon)</code></pre></div>\n<p>The animation will consist of two parts:</p>\n\n<ul>\n<li><p>The fragments appearing by drawing their borders with different shades from blue like the background to white.</p></li>\n\n<li><p>The fragments falling.</p></li>\n</ul>\n\n<p>The code below creates the PNGs corresponding to the first part of the animation.</p>\n<div class=\"highlight\"><pre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"><code class=\"language-r\" data-lang=\"r\">fs<span style=\"color:#f92672\">::</span>dir_create(<span style=\"color:#e6db74\">&#34;august_frames&#34;</span>)\n\nplot_one <span style=\"color:#f92672\">&lt;-</span> <span style=\"color:#66d9ef\">function</span>(step, df){\n  cols <span style=\"color:#f92672\">&lt;-</span> colorRampPalette(<span style=\"color:#66d9ef\">c</span>(<span style=\"color:#e6db74\">&#34;#2165B6&#34;</span>, <span style=\"color:#e6db74\">&#34;white&#34;</span>))(<span style=\"color:#ae81ff\">10</span>)\n  ggplot(df)  <span style=\"color:#f92672\">+</span>\n    geom_polygon(aes(x <span style=\"color:#f92672\">=</span> x, y <span style=\"color:#f92672\">=</span> y, group <span style=\"color:#f92672\">=</span> tile),\n                 fill <span style=\"color:#f92672\">=</span> <span style=\"color:#e6db74\">&#34;#2165B6&#34;</span>, col <span style=\"color:#f92672\">=</span> cols[step]) <span style=\"color:#f92672\">+</span>\n    theme_void()\n\n  outfil <span style=\"color:#f92672\">&lt;-</span> <span style=\"color:#66d9ef\">file.path</span>(<span style=\"color:#e6db74\">&#34;august_frames&#34;</span>,\n                      <span style=\"color:#66d9ef\">sprintf</span>(<span style=\"color:#e6db74\">&#34;plot1_%02d.png&#34;</span>, step))\n  ggsave(outfil, width <span style=\"color:#f92672\">=</span> <span style=\"color:#ae81ff\">6.7</span>, height <span style=\"color:#f92672\">=</span> <span style=\"color:#ae81ff\">6.7</span>)\n  magick<span style=\"color:#f92672\">::</span>image_read(outfil) <span style=\"color:#f92672\">%&gt;%</span>\n    magick<span style=\"color:#f92672\">::</span>image_resize(<span style=\"color:#e6db74\">&#34;480x480&#34;</span>) <span style=\"color:#f92672\">%&gt;%</span>\n    magick<span style=\"color:#f92672\">::</span>image_write(outfil)\n\n\n}\n\n\npurrr<span style=\"color:#f92672\">::</span>walk(<span style=\"color:#ae81ff\">1</span><span style=\"color:#f92672\">:</span><span style=\"color:#ae81ff\">10</span>, plot_one, df)</code></pre></div>\n<p>Then I made the <code>data.frame</code> a bit bigger by adding a second state with most tiles fallen at the bottom. I first create a variable <code>border</code> that indicates if the tile pertains to the sides or top because magically these tiles won&rsquo;t fall.</p>\n<div class=\"highlight\"><pre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"><code class=\"language-r\" data-lang=\"r\">df <span style=\"color:#f92672\">&lt;-</span> dplyr<span style=\"color:#f92672\">::</span>group_by(df, tile) <span style=\"color:#f92672\">%&gt;%</span>\n  dplyr<span style=\"color:#f92672\">::</span>mutate(border <span style=\"color:#f92672\">=</span> <span style=\"color:#66d9ef\">any</span>(x <span style=\"color:#f92672\">%in%</span> lims) <span style=\"color:#f92672\">|</span>\n                  <span style=\"color:#66d9ef\">any</span>(y <span style=\"color:#f92672\">==</span> lims[<span style=\"color:#ae81ff\">2</span>]))\n\n<span style=\"color:#75715e\"># Define the second state with tiles fallen</span>\ndf2  <span style=\"color:#f92672\">&lt;-</span> df\n<span style=\"color:#75715e\"># a bit random but it does look ok!</span>\n\ndf2 <span style=\"color:#f92672\">&lt;-</span> dplyr<span style=\"color:#f92672\">::</span>group_by(df2, tile) <span style=\"color:#f92672\">%&gt;%</span>\n  dplyr<span style=\"color:#f92672\">::</span>mutate(y <span style=\"color:#f92672\">=</span> <span style=\"color:#66d9ef\">ifelse</span>(<span style=\"color:#f92672\">!</span>border,\n                           <span style=\"color:#ae81ff\">-2</span> <span style=\"color:#f92672\">-</span> <span style=\"color:#66d9ef\">min</span>(y) <span style=\"color:#f92672\">+</span> y,\n                           y)) <span style=\"color:#f92672\">%&gt;%</span>\n dplyr<span style=\"color:#f92672\">::</span>ungroup()\n\ndf<span style=\"color:#f92672\">$</span>frame <span style=\"color:#f92672\">&lt;-</span> <span style=\"color:#ae81ff\">1</span>\ndf2<span style=\"color:#f92672\">$</span>frame <span style=\"color:#f92672\">&lt;-</span> <span style=\"color:#ae81ff\">2</span>\ndfall <span style=\"color:#f92672\">&lt;-</span> dplyr<span style=\"color:#f92672\">::</span>bind_rows(df, df2)</code></pre></div>\n<p>This was followed by the animating of the second part with <code>gganimate</code>, here after creating a fake winner (sorry Steph, you won&rsquo;t get to gift yourself the book). Because we&rsquo;ll need to use PNGs from the first part, we don&rsquo;t use <code>gganimate</code>&rsquo;s built-in gif or video renderers, but instead save PNGs.</p>\n\n<p>Important note: <code>gganimate</code> latest version isn&rsquo;t on CRAN yet, follow the instructions in its <a href=\"https://github.com/thomasp85/gganimate\">GitHub repository</a> or download a built source version of the package <a href=\"https://ci.appveyor.com/project/thomasp85/gganimate/build/artifacts\">from Appveyor</a>.</p>\n<div class=\"highlight\"><pre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"><code class=\"language-r\" data-lang=\"r\">winner <span style=\"color:#f92672\">&lt;-</span> <span style=\"color:#66d9ef\">list</span>(name <span style=\"color:#f92672\">=</span> <span style=\"color:#66d9ef\">c</span>(<span style=\"color:#e6db74\">&#34;Steph Locke&#34;</span>))\np <span style=\"color:#f92672\">&lt;-</span> ggplot(dfall) <span style=\"color:#f92672\">+</span>\n    annotate(<span style=\"color:#e6db74\">&#34;text&#34;</span>, label <span style=\"color:#f92672\">=</span> winner<span style=\"color:#f92672\">$</span>name,\n             x <span style=\"color:#f92672\">=</span> <span style=\"color:#ae81ff\">5</span>, y <span style=\"color:#f92672\">=</span> <span style=\"color:#ae81ff\">5</span>,\n             size <span style=\"color:#f92672\">=</span> <span style=\"color:#ae81ff\">12</span>, family <span style=\"color:#f92672\">=</span> <span style=\"color:#e6db74\">&#34;Roboto&#34;</span>,\n             col <span style=\"color:#f92672\">=</span> <span style=\"color:#e6db74\">&#34;#E8830C&#34;</span>) <span style=\"color:#f92672\">+</span>\n    geom_polygon(aes(x <span style=\"color:#f92672\">=</span> x, y <span style=\"color:#f92672\">=</span> y, group <span style=\"color:#f92672\">=</span> tile),\n                 fill <span style=\"color:#f92672\">=</span> <span style=\"color:#e6db74\">&#34;#2165B6&#34;</span>, col <span style=\"color:#f92672\">=</span> <span style=\"color:#e6db74\">&#34;white&#34;</span>) <span style=\"color:#f92672\">+</span>\n    <span style=\"color:#75715e\"># Here comes the gganimate code</span>\n    <span style=\"color:#75715e\"># create transition, with the variable frame</span>\n    transition_states(\n      frame,\n      transition_length <span style=\"color:#f92672\">=</span> <span style=\"color:#ae81ff\">1</span>,\n      state_length <span style=\"color:#f92672\">=</span> <span style=\"color:#ae81ff\">1</span>,\n      wrap <span style=\"color:#f92672\">=</span> <span style=\"color:#66d9ef\">FALSE</span>\n    ) <span style=\"color:#f92672\">+</span>\n    <span style=\"color:#75715e\"># use an ease that makes tiles fall faster</span>\n    <span style=\"color:#75715e\"># at the end of the transition</span>\n    ease_aes(<span style=\"color:#e6db74\">&#39;exponential-in&#39;</span>) <span style=\"color:#f92672\">+</span>\n    theme_void() <span style=\"color:#f92672\">+</span>\n    coord_cartesian(xlim <span style=\"color:#f92672\">=</span> lims, ylim <span style=\"color:#f92672\">=</span> lims)\n\n  <span style=\"color:#75715e\"># create and save frames</span>\n\n   animate(p,\n   renderer <span style=\"color:#f92672\">=</span> file_renderer(dir <span style=\"color:#f92672\">=</span> <span style=\"color:#e6db74\">&#34;august_frames&#34;</span>,\n                            prefix <span style=\"color:#f92672\">=</span> <span style=\"color:#e6db74\">&#34;plot2_&#34;</span>) )</code></pre></div>\n<p>Now we can use all the PNGs that are in the &ldquo;august_frames&rdquo; folder, with <code>gifski</code>!</p>\n<div class=\"highlight\"><pre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"><code class=\"language-r\" data-lang=\"r\">images <span style=\"color:#f92672\">&lt;-</span> <span style=\"color:#66d9ef\">sort</span>(<span style=\"color:#66d9ef\">as.character</span>(\n   fs<span style=\"color:#f92672\">::</span>dir_ls(<span style=\"color:#e6db74\">&#34;august_frames&#34;</span>)))\n\ngifski<span style=\"color:#f92672\">::</span>gifski(images,\n                gif_file <span style=\"color:#f92672\">=</span> path,\n                delay <span style=\"color:#f92672\">=</span> <span style=\"color:#ae81ff\">0.1</span>,\n                width <span style=\"color:#f92672\">=</span> <span style=\"color:#ae81ff\">480</span>,\n                height <span style=\"color:#f92672\">=</span> <span style=\"color:#ae81ff\">480</span>)\n\n<span style=\"color:#75715e\"># clean</span>\n fs<span style=\"color:#f92672\">::</span>dir_delete(<span style=\"color:#e6db74\">&#34;august_frames&#34;</span>)</code></pre></div>\n<p>And voilà, a glass shattering animation!</p>\n\n\n<figure >\n    \n        <img src=\"../img/destruction.gif\" />\n    \n    \n    <figcaption>\n        <h4>Glass shattering book winner reveal</h4>\n        \n    </figcaption>\n    \n</figure>\n\n\n<h1 id=\"conclusion-and-resources-round-up\">Conclusion and resources round-up</h1>\n\n<p>In this post I explained how I created an animation of glass shattering.</p>\n\n<p>R packages that are important to know for producing animations are:</p>\n\n<ul>\n<li><p><code>gganimate</code> that now implements the Grammar of animation, like <code>ggplot2</code> implements the Grammar of graphics! I&rsquo;d recommend to watch <a href=\"https://www.youtube.com/watch?v=21ZWDrTukEs\">Thomas Lin Pedersen&rsquo;s useR! keynote talk about The Grammar of animation</a> and to follow the impressive activity of the <a href=\"https://github.com/thomasp85/gganimate\"><code>gganimate</code> GitHub repo</a>.</p></li>\n\n<li><p><code>gifski</code> for gif rendering. It&rsquo;s used under the hood by <code>gganimate</code> but you might need it to combine PNGs yourself if you tweak animations a bit more like we did here. You can read this <a href=\"https://ropensci.org/technotes/2018/07/23/gifski-release/\">tech note about <code>gifski</code> by Jeroen Ooms</a>, and to check out the <a href=\"https://github.com/r-rust\">r-rust Github organization</a>.</p></li>\n\n<li><p>Likewise, if you want to tweak some frames, it&rsquo;ll be useful to know a bit about <code>magick</code>, wrapper to <a href=\"https://www.imagemagick.org/Magick++/STL.html\">ImageMagick</a>, an R package for image manipulation developed at <a href=\"https://ropensci.org/\">rOpenSci</a> by <a href=\"https://github.com/jeroen\">Jeroen Ooms</a>. This package has a <a href=\"https://cran.r-project.org/web/packages/magick/vignettes/intro.html\">good vignette</a>.</p></li>\n</ul>\n\n<p>Have fun animating R visualizations! And don&rsquo;t forget that next month, again a random Locke Data follower will win a great book: you should follow <a href=\"https://twitter.com/LockeData\">Locke Data on Twitter</a> to be in with a chance of winning!</p>"
}