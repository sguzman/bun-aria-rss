{
  "title": "A crystal clear book draw",
  "link": "https://itsalocke.com/blog/a-crystal-clear-book-draw/",
  "pubDate": "Fri, 01 Jun 2018 00:00:00 +0000",
  "guid": "https://itsalocke.com/blog/a-crystal-clear-book-draw/",
  "description": "<p>As you might know, every month, a random Locke Data Twitter follower wins an excellent data science book! This month&rsquo;s gift was <a href=\"http://geni.us/introtostatslearning\">&ldquo;An Introduction to Statistical Learning: with Applications in R&rdquo;</a>, a classic and useful textbook. In this post I&rsquo;ll give you some <code>magick</code>-al tips from behind-the-scenes of this month&rsquo;s winner announcement. It&rsquo;ll feature learning from my mistakes, and reading from a crystal ball&hellip; or more seriously, image manipulation in R!</p>\n\n<h1 id=\"an-introduction-to-learning-from-my-mistakes\">An Introduction to Learning from my Mistakes</h1>\n\n<p>In this month&rsquo;s instalment, I corrected two of my previous mistakes, here is what I learnt&hellip;</p>\n\n<h2 id=\"package-your-code-right-away\">Package your code right away!</h2>\n\n<p>This book draw was the fourth one I was in charge of. The first three times I simply (or so I thought) put an R script and pictures in a GitHub repo, merely listing the dependencies in a DESCRIPTION file&hellip; how suboptimal! This month I transformed <a href=\"https://github.com/lockedata/twitterbookdraw\">the repo</a> into a package, moving the old scripts to a subfolder after naming them correctly in order to no longer have one called&hellip; &ldquo;code.R&rdquo;, and creating a function to draw the winner.</p>\n\n<p>Now the repo looks good which is nice but I can&rsquo;t but regret not having organized it right away. I&rsquo;d have saved time and energy and my pride. Steph actually maintains a nifty package helping with proper project setup, <a href=\"https://github.com/lockedata/pRojects\"><code>pRojects</code></a>, that&rsquo;ll soon get some love and will probably be featured on this blog. Stay tuned!</p>\n\n<h2 id=\"automate-what-can-be-automated\">Automate what can be automated</h2>\n\n<p>As I confessed <a href=\"https://itsalocke.com/blog/a-particles-arly-fun-book-draw/\">last month</a>, in the last announcement tweet the winner&rsquo;s Twitter handle was different in the tweet text and the gif. Now it won&rsquo;t happen ever again because I wrote an <code>announce_winner</code> function so that the worfklow now is</p>\n\n<ul>\n<li><p>Draw the winner via <code>twitterbookdraw::draw_winner()</code></p></li>\n\n<li><p>Automatically create tweet text using that winner <code>twitterbookdraw::announce_winner()</code></p></li>\n\n<li><p>Automatically create visualization using that winner via  <code>twitterbookdraw::show_winner()</code></p></li>\n</ul>\n\n<p>You can witness this <a href=\"https://github.com/lockedata/twitterbookdraw#2018-06-01\">in <code>twitterbookdraw</code> README</a>.</p>\n\n<p>Writing <code>announce_winner</code> was quite pleasing thanks to using the nice <a href=\"https://github.com/tidyverse/glue\"><code>glue</code> package</a> by RStudio <a href=\"http://www.jimhester.com/\">Jim Hester</a>:</p>\n<div class=\"highlight\"><pre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"><code class=\"language-r\" data-lang=\"r\">announce_winner <span style=\"color:#f92672\">&lt;-</span> <span style=\"color:#66d9ef\">function</span>(winner, book, book_url){\n  glue<span style=\"color:#f92672\">::</span>glue(<span style=\"color:#e6db74\">&#39;This month\\&#39;s winner is {winner$name} (@{winner$screen_name})! DM us to receive &#34;{book}&#34;!\n</span><span style=\"color:#e6db74\">\n</span><span style=\"color:#e6db74\">             \\n{book_url}\n</span><span style=\"color:#e6db74\">\n</span><span style=\"color:#e6db74\">             \\n#datascience&#39;</span>)\n}</code></pre></div>\n<h1 id=\"an-introduction-to-crystal-ball-reading\">An Introduction to Crystal Ball Reading</h1>\n\n<p>I try to vary the viz used each month to keep it interesting for Twitter readers but also for anyone interested in playing with the code. Now that the GitHub repo is tidier, finding previous month&rsquo;s scripts for inspiration has gotten easier! But still, blogging a few tips is probably the best way to digest that information.</p>\n\n<p>This month, the challenge was to create a crystall ball that&rsquo;d progressively reveal the Twitter avatar of the winner, as if chibi Steph were reading it to announce the winner.</p>\n\n<p>I prepared this gif using the <a href=\"https://cran.r-project.org/web/packages/magick/vignettes/intro.html\"><code>magick</code> package</a> for image manipulation, developed by <a href=\"https://github.com/jeroen\">Jeroen Ooms</a> at <a href=\"https://ropensci.org/\">rOpenSci</a>. It wraps the famous image manipulation library ImageMagick, allowing the user to use it in pipelines within R. Using <code>magick</code> is in my opinion a great geometry and logic training: what size and form should each piece have, which one should you put below/above the other etc. So on top of scripting your image manipulation to make it reproducible, you get to play!</p>\n\n<h2 id=\"step-1-create-a-face-in-hole-picture-prop\">Step 1: create a face-in-hole picture prop</h2>\n\n<p>I designed the gif skeleton as a face-in-hole photo prop, where the hole was the crystal ball.</p>\n<div class=\"highlight\"><pre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"><code class=\"language-r\" data-lang=\"r\">june_background <span style=\"color:#f92672\">&lt;-</span> <span style=\"color:#66d9ef\">function</span>(){\n  <span style=\"color:#75715e\"># create a blue rectangle as background</span>\n  background <span style=\"color:#f92672\">&lt;-</span>  magick<span style=\"color:#f92672\">::</span>image_blank(<span style=\"color:#ae81ff\">400</span>, <span style=\"color:#ae81ff\">300</span>, <span style=\"color:#e6db74\">&#39;#2165B6&#39;</span>)\n\n  <span style=\"color:#75715e\"># activate it as a plot background</span>\n  img <span style=\"color:#f92672\">&lt;-</span> magick<span style=\"color:#f92672\">::</span>image_draw(background)\n  <span style=\"color:#75715e\"># add stars using base plot!</span>\n  points(runif(n <span style=\"color:#f92672\">=</span> <span style=\"color:#ae81ff\">42</span>, min <span style=\"color:#f92672\">=</span> <span style=\"color:#ae81ff\">0</span>, max <span style=\"color:#f92672\">=</span> <span style=\"color:#ae81ff\">400</span>),\n         runif(n <span style=\"color:#f92672\">=</span> <span style=\"color:#ae81ff\">42</span>, min <span style=\"color:#f92672\">=</span> <span style=\"color:#ae81ff\">0</span>, max <span style=\"color:#f92672\">=</span> <span style=\"color:#ae81ff\">300</span>),\n         cex <span style=\"color:#f92672\">=</span> runif(<span style=\"color:#ae81ff\">42</span>, min <span style=\"color:#f92672\">=</span> <span style=\"color:#ae81ff\">2</span>, max <span style=\"color:#f92672\">=</span> <span style=\"color:#ae81ff\">4</span>),\n         col <span style=\"color:#f92672\">=</span> <span style=\"color:#e6db74\">&#34;white&#34;</span>,\n         pch <span style=\"color:#f92672\">=</span> <span style=\"color:#ae81ff\">8</span>)\n\n  <span style=\"color:#75715e\"># add ball support using base plot as well</span>\n  rect(<span style=\"color:#ae81ff\">250</span>, <span style=\"color:#ae81ff\">250</span>, <span style=\"color:#ae81ff\">350</span>, <span style=\"color:#ae81ff\">150</span>,\n       border <span style=\"color:#f92672\">=</span> <span style=\"color:#e6db74\">&#34;white&#34;</span>, lwd <span style=\"color:#f92672\">=</span> <span style=\"color:#ae81ff\">5</span>,\n       col <span style=\"color:#f92672\">=</span> <span style=\"color:#e6db74\">&#34;white&#34;</span>)\n\n  <span style=\"color:#75715e\"># add crystal ball, its background is a random color</span>\n  symbols(<span style=\"color:#ae81ff\">300</span>, <span style=\"color:#ae81ff\">150</span>, circles <span style=\"color:#f92672\">=</span> <span style=\"color:#ae81ff\">50</span>,\n          fg <span style=\"color:#f92672\">=</span> <span style=\"color:#e6db74\">&#34;white&#34;</span>, inches <span style=\"color:#f92672\">=</span> <span style=\"color:#ae81ff\">1</span>, add <span style=\"color:#f92672\">=</span> <span style=\"color:#66d9ef\">TRUE</span>,\n          bg <span style=\"color:#f92672\">=</span> <span style=\"color:#e6db74\">&#34;#B657A3&#34;</span>, lwd <span style=\"color:#f92672\">=</span> <span style=\"color:#ae81ff\">2</span>)\n\n  dev.off()\n\n  <span style=\"color:#75715e\"># get and resize wizard chibi</span>\n  chibi <span style=\"color:#f92672\">&lt;-</span> magick<span style=\"color:#f92672\">::</span>image_read(<span style=\"color:#66d9ef\">system.file</span>(<span style=\"color:#e6db74\">&#34;assets/wizard_steph.png&#34;</span>,\n                                          package<span style=\"color:#f92672\">=</span><span style=\"color:#e6db74\">&#34;twitterbookdraw&#34;</span>)) <span style=\"color:#f92672\">%&gt;%</span>\n    magick<span style=\"color:#f92672\">::</span>image_resize(<span style=\"color:#e6db74\">&#34;200x200&#34;</span>)\n\n\n  <span style=\"color:#75715e\"># add chibi on background</span>\n  img <span style=\"color:#f92672\">&lt;-</span> magick<span style=\"color:#f92672\">::</span>image_composite(img, chibi, offset <span style=\"color:#f92672\">=</span> <span style=\"color:#e6db74\">&#34;+10+50&#34;</span>,\n                                 operator <span style=\"color:#f92672\">=</span> <span style=\"color:#e6db74\">&#34;Over&#34;</span>)\n\n  <span style=\"color:#75715e\"># make the crystal ball transparent by replacing its color</span>\n  <span style=\"color:#75715e\"># by transparency. the hole is done!</span>\n  img <span style=\"color:#f92672\">&lt;-</span> magick<span style=\"color:#f92672\">::</span>image_transparent(img, <span style=\"color:#e6db74\">&#34;#B657A3&#34;</span>)\n\n  <span style=\"color:#75715e\"># return face-in-hole photo prop</span>\n  img\n}</code></pre></div>\n\n<figure >\n    \n        <img src=\"../img/2018-06-01-faceinhole.png\" />\n    \n    \n    <figcaption>\n        <h4>Face in hole photo prop</h4>\n        \n    </figcaption>\n    \n</figure>\n\n\n<h1 id=\"step-2-add-the-winner-s-face-behind-the-hole-and-an-evolving-opacity-veil\">Step 2: add the winner&rsquo;s face behind the hole and an evolving opacity veil</h1>\n\n<p>Now, I needed to get the winner&rsquo;s face behind that photo prop! For this I first downloaded the winner&rsquo;s avatar from Twitter, using the winner&rsquo;s information previously drawn.</p>\n<div class=\"highlight\"><pre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"><code class=\"language-r\" data-lang=\"r\"><span style=\"color:#75715e\"># winner &lt;- twitterbookdraw::draw_winner()</span>\nwinner_face <span style=\"color:#f92672\">&lt;-</span> magick<span style=\"color:#f92672\">::</span>image_read(winner<span style=\"color:#f92672\">$</span>profile_image_url) <span style=\"color:#f92672\">%&gt;%</span>\n    magick<span style=\"color:#f92672\">::</span>image_resize(<span style=\"color:#e6db74\">&#34;150x150&#34;</span>)</code></pre></div>\n<p>Then I wrote a helper function placing the winner&rsquo;s face behind the photo prop and behind a veil of a given opacity.</p>\n<div class=\"highlight\"><pre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"><code class=\"language-r\" data-lang=\"r\">june_colorized_frame <span style=\"color:#f92672\">&lt;-</span> <span style=\"color:#66d9ef\">function</span>(opacity, winner_face, background){\n\n  <span style=\"color:#75715e\"># add opacity veil in front of the winner&#39;s avatar</span>\n  winner_face <span style=\"color:#f92672\">&lt;-</span> winner_face <span style=\"color:#f92672\">%&gt;%</span>\n    magick<span style=\"color:#f92672\">::</span>image_colorize(opacity <span style=\"color:#f92672\">=</span> opacity,\n                           color <span style=\"color:#f92672\">=</span> <span style=\"color:#e6db74\">&#34;black&#34;</span>)\n\n  <span style=\"color:#75715e\"># put the winner&#39;s avatar on a white rectangle</span>\n  <span style=\"color:#75715e\"># which will help put the avatar right behind the hole</span>\n  winner_face <span style=\"color:#f92672\">&lt;-</span> magick<span style=\"color:#f92672\">::</span>image_blank(<span style=\"color:#ae81ff\">400</span>, <span style=\"color:#ae81ff\">300</span>, <span style=\"color:#e6db74\">&#34;white&#34;</span>) <span style=\"color:#f92672\">%&gt;%</span>\n    magick<span style=\"color:#f92672\">::</span>image_composite(winner_face, offset <span style=\"color:#f92672\">=</span> <span style=\"color:#e6db74\">&#34;+220+80&#34;</span>)\n\n  <span style=\"color:#75715e\"># put the carefully placed and veiled winner&#39;s avatar</span>\n  <span style=\"color:#75715e\"># behind the photo prop</span>\n  magick<span style=\"color:#f92672\">::</span>image_composite(winner_face, background)\n}</code></pre></div>\n<p>After this, I created a sequence of evolving opacity (from very dark to lighter and to very dark again, before the big reveal of the avatar, because crystal balls blink, don&rsquo;t they?).</p>\n<div class=\"highlight\"><pre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"><code class=\"language-r\" data-lang=\"r\">show_june_winner <span style=\"color:#f92672\">&lt;-</span> <span style=\"color:#66d9ef\">function</span>(winner, path <span style=\"color:#f92672\">=</span> <span style=\"color:#e6db74\">&#34;june.gif&#34;</span>){\n  <span style=\"color:#75715e\"># get winner&#39;s avatar</span>\n  winner_face <span style=\"color:#f92672\">&lt;-</span> magick<span style=\"color:#f92672\">::</span>image_read(winner<span style=\"color:#f92672\">$</span>profile_image_url) <span style=\"color:#f92672\">%&gt;%</span>\n    magick<span style=\"color:#f92672\">::</span>image_resize(<span style=\"color:#e6db74\">&#34;150x150&#34;</span>)\n\n  <span style=\"color:#75715e\"># create a sequence of varying opacities</span>\n  <span style=\"color:#75715e\"># and for each opacity create a frame</span>\n  <span style=\"color:#75715e\"># then join and animate frames</span>\n  frames <span style=\"color:#f92672\">&lt;-</span> purrr<span style=\"color:#f92672\">::</span>map(<span style=\"color:#66d9ef\">c</span>(<span style=\"color:#66d9ef\">seq</span>(from <span style=\"color:#f92672\">=</span> <span style=\"color:#ae81ff\">100</span>, to <span style=\"color:#f92672\">=</span> <span style=\"color:#ae81ff\">50</span>, by <span style=\"color:#f92672\">=</span> <span style=\"color:#ae81ff\">-5</span>),\n                         <span style=\"color:#66d9ef\">seq</span>(from <span style=\"color:#f92672\">=</span> <span style=\"color:#ae81ff\">50</span>, to <span style=\"color:#f92672\">=</span> <span style=\"color:#ae81ff\">100</span>, by <span style=\"color:#f92672\">=</span> <span style=\"color:#ae81ff\">5</span>),\n                         <span style=\"color:#66d9ef\">seq</span>(from <span style=\"color:#f92672\">=</span> <span style=\"color:#ae81ff\">100</span>, to <span style=\"color:#f92672\">=</span> <span style=\"color:#ae81ff\">50</span>, by <span style=\"color:#f92672\">=</span> <span style=\"color:#ae81ff\">-5</span>),\n               <span style=\"color:#66d9ef\">rep</span>(<span style=\"color:#ae81ff\">0</span>, <span style=\"color:#ae81ff\">5</span>)),\n             june_colorized_frame,\n             winner_face <span style=\"color:#f92672\">=</span> winner_face,\n             background <span style=\"color:#f92672\">=</span> june_background())\n\n  frames <span style=\"color:#f92672\">%&gt;%</span>\n    magick<span style=\"color:#f92672\">::</span>image_join() <span style=\"color:#f92672\">%&gt;%</span>\n    magick<span style=\"color:#f92672\">::</span>image_animate() <span style=\"color:#f92672\">%&gt;%</span>\n    magick<span style=\"color:#f92672\">::</span>image_write(path)\n\n}</code></pre></div>\n<p>Imagine the winner were Amy, <a href=\"https://twitter.com/AmyMcDougall96\">Locke Data&rsquo;s operation manager</a> (post written before the actual draw&hellip; Locke Data team members actually can&rsquo;t win, we&rsquo;d re-draw!):</p>\n<div class=\"highlight\"><pre style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"><code class=\"language-r\" data-lang=\"r\">winner <span style=\"color:#f92672\">&lt;-</span> rtweet<span style=\"color:#f92672\">::</span>search_users(<span style=\"color:#e6db74\">&#34;AmyMcDougall96&#34;</span>, n <span style=\"color:#f92672\">=</span> <span style=\"color:#ae81ff\">1</span>)\ntwitterbookdraw<span style=\"color:#f92672\">::</span>show_june_winner(winner, path <span style=\"color:#f92672\">=</span> <span style=\"color:#e6db74\">&#34;2018-06-01-winner.gif&#34;</span>)</code></pre></div>\n\n<figure >\n    \n        <img src=\"../img/2018-06-01-winner.gif\" />\n    \n    \n    <figcaption>\n        <h4>Winner gif</h4>\n        \n    </figcaption>\n    \n</figure>\n\n\n<p>Not too shabby, good crystal ball reading skills Wizard Steph!</p>\n\n<h1 id=\"future-plans\">Future plans?</h1>\n\n<p>Next month, again a random Locke Data follower will win a great book: you should follow <a href=\"https://twitter.com/LockeData\">Locke Data on Twitter</a> to get a chance! Besides, do not hesitate to ping us there if this post inspired you to play with magick</p>"
}