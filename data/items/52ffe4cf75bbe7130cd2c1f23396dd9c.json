{
  "title": "SymPy and Theano -- Scalar Simplification",
  "link": "",
  "updated": "2013-03-28T00:00:00+00:00",
  "id": "https://mrocklin.github.io/blog/work/2013/03/28/SymPy-Theano-part-2",
  "content": "<h2 id=\"introduction\">Introduction</h2>\n\n<p><em>This post uses some LaTeX.  You may want to read it on the original site.</em></p>\n\n<p>In my <a href=\"http://matthewrocklin.com/blog/work/2013/03/19/SymPy-Theano-part-1/\">last post</a> I showed how SymPy can benefit from Theano.  In particular Theano provided a mature platform for code generation that outperformed SymPy’s attempt at the same problem.  I argued that projects should stick to one specialty and depend on others for secondary concerns.  Interfaces are better than add-ons.</p>\n\n<p>In this post I’ll show how Theano can benefit from SymPy.  In particular I’ll demonstrate the practicality of SymPy’s impressive scalar simplification routines for generating efficient programs.</p>\n\n<p>After re-reading over this post I realize that it’s somewhat long.  I’ve decided to put the results first in hopes that it’ll motivate you to keep reading.</p>\n\n<table>\n  <thead>\n    <tr>\n      <th style=\"text-align: left\">Project</th>\n      <th style=\"text-align: center\">operation count</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td style=\"text-align: left\">SymPy</td>\n      <td style=\"text-align: center\">27</td>\n    </tr>\n    <tr>\n      <td style=\"text-align: left\">Theano</td>\n      <td style=\"text-align: center\">24</td>\n    </tr>\n    <tr>\n      <td style=\"text-align: left\">SymPy+Theano</td>\n      <td style=\"text-align: center\">17</td>\n    </tr>\n  </tbody>\n</table>\n\n<p>Now, lets find out what those numbers mean.</p>\n\n<h2 id=\"example-problem\">Example problem</h2>\n\n<p>We use a larger version of our problem from last time; a radial wavefunction corresponding to <code class=\"language-plaintext highlighter-rouge\">n = 6</code> and <code class=\"language-plaintext highlighter-rouge\">l = 2</code> for Carbon (<code class=\"language-plaintext highlighter-rouge\">Z = 6</code>)</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>from sympy.physics.hydrogen import R_nl\nfrom sympy.abc import x\nn, l, Z = 6, 2, 6\nexpr = R_nl(n, l, x, Z)\nprint latex(expr)\n</code></pre></div></div>\n\n\\[\\frac{1}{210} \\sqrt{70} x^{2} \\left(- \\frac{4}{3} x^{3} + 16 x^{2} - 56 x + 56\\right) e^{- x}\\]\n\n<p>We want to generate code to compute both this expression and its derivative.  Both SymPy and Theano can compute and simplify derivatives.  In this post we’ll measure the complexity of a computation that simultaneously computes both the above expression and its derivative.  We’ll arrive at this computation through a couple of different routes that use overlapping parts of SymPy and Theano.  This will supply a couple of direct comparisons.</p>\n\n<p><em>Disclaimer: I’ve chosen a larger expression here to exaggerate results.  Simpler expressions yield less impressive results.</em></p>\n\n<h2 id=\"simplification\">Simplification</h2>\n\n<p>We show the expression, it’s derivative, and SymPy’s simplification of that derivative.  In each case we quantify the complexity of the expression by the number of algebraic operations</p>\n\n<p><strong>The target expression:</strong></p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>print latex(expr)\n</code></pre></div></div>\n\n\\[\\frac{1}{210} \\sqrt{70} x^{2} \\left(- \\frac{4}{3} x^{3} + 16 x^{2} - 56 x + 56\\right) e^{- x}\\]\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>print \"Operations: \", count_ops(expr)\nOperations:  17\n</code></pre></div></div>\n\n<p><strong>It’s derivative</strong></p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>print latex(expr.diff(x))\n</code></pre></div></div>\n\n\\[\\frac{1}{210} \\sqrt{70} x^{2} \\left(- 4 x^{2} + 32 x - 56\\right) e^{- x} - \\frac{1}{210} \\sqrt{70} x^{2} \\left(- \\frac{4}{3} x^{3} + 16 x^{2} - 56 x + 56\\right) e^{- x} + \\frac{1}{105} \\sqrt{70} x \\left(- \\frac{4}{3} x^{3} + 16 x^{2} - 56 x + 56\\right) e^{- x}\\]\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>print \"Operations: \", count_ops(expr.diff(x))\nOperations:  48\n</code></pre></div></div>\n\n<p><strong>The result of <code class=\"language-plaintext highlighter-rouge\">simplify</code></strong> on the derivative.  Note the significant cancellation of the above expression.</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>print latex(simplify(expr.diff(x)))\n</code></pre></div></div>\n\n\\[\\frac{2}{315} \\sqrt{70} x \\left(x^{4} - 17 x^{3} + 90 x^{2} - 168 x + 84\\right) e^{- x}\\]\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>print \"Operations: \", count_ops(simplify(expr.diff(x)))\nOperations:  18\n</code></pre></div></div>\n\n<p><strong>An unevaluated derivative object</strong>.  We’ll end up passing this to Theano so that it computes the derivative on its own.</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>print latex(Derivative(expr, x))\n</code></pre></div></div>\n\n\\[\\frac{\\partial}{\\partial x}\\left(\\frac{1}{210} \\sqrt{70} x^{2} \\left(- \\frac{4}{3} x^{3} + 16 x^{2} - 56 x + 56\\right) e^{- x}\\right)\\]\n\n<h2 id=\"bounds-on-the-cost-of-differentiation\">Bounds on the cost of Differentiation</h2>\n\n<p>Scalar differentiation is actually a very simple transformation.</p>\n\n<p>You need to know how to transform all of the elementary functions (<code class=\"language-plaintext highlighter-rouge\">exp, log, sin, cos, polynomials, etc...</code>), the chain rule, and that’s it.  Theorems behind automatic differentiation state that the cost of a derivative will be at most five times the cost of the original.  In this case we’re guaranteed to have at most <code class=\"language-plaintext highlighter-rouge\">17*5 == 85</code> operations in the derivative computation; this holds in our case because <code class=\"language-plaintext highlighter-rouge\">48 &lt; 85</code></p>\n\n<p>However derivatives are often far simpler than this upper bound.  We see that after simplification the operation count of the derivative is <code class=\"language-plaintext highlighter-rouge\">18</code>, only one more than the original.  This is common in practice.</p>\n\n<h2 id=\"theano-simplification\">Theano Simplification</h2>\n\n<p>Like SymPy, Theano transforms graphs to mathematically equivalent but computationally more efficient representations.  It provides standard compiler optimizations like constant folding, and common sub-expressions as well as array specific optimizations like the element-wise operation fusion.</p>\n\n<p>Because users regularly handle mathematical terms Theano also provides a set of optimizations to simplify some common scalar expressions.  For example Theano will convert expressions like <code class=\"language-plaintext highlighter-rouge\">x*y/x</code> to <code class=\"language-plaintext highlighter-rouge\">y</code>.  In this sense it overlaps with SymPy’s <code class=\"language-plaintext highlighter-rouge\">simplify</code> functions.  This post is largely a demonstration that SymPy’s scalar simplifications are far more powerful than Theano’s and that their use can result in significant improvements.  This shouldn’t be surprising.  Sympians are devoted to scalar simplification to a degree that far exceeds the Theano community’s devotion to this topic.</p>\n\n<h2 id=\"experiment\">Experiment</h2>\n\n<p>We’ll compute the derivative of our radial wavefunction and then simplify the result.  We’ll do this using both SymPy’s derivative and simplify routines and using Theano’s derivative and simplify routines.  We’ll then compare the two results by counting the number of required operations.</p>\n\n<p>Here is some setup code that you can safely ignore:</p>\n\n<figure class=\"highlight\">\n  <pre><code class=\"language-python\" data-lang=\"python\"><span class=\"k\">def</span> <span class=\"nf\">fgraph_of</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">exprs</span><span class=\"p\">):</span>\n    <span class=\"s\">\"\"\" Transform SymPy expressions into Theano Computation \"\"\"</span>\n    <span class=\"n\">outs</span> <span class=\"o\">=</span> <span class=\"nb\">map</span><span class=\"p\">(</span><span class=\"n\">theano_code</span><span class=\"p\">,</span> <span class=\"n\">exprs</span><span class=\"p\">)</span>\n    <span class=\"n\">ins</span> <span class=\"o\">=</span> <span class=\"n\">theano</span><span class=\"p\">.</span><span class=\"n\">gof</span><span class=\"p\">.</span><span class=\"n\">graph</span><span class=\"p\">.</span><span class=\"n\">inputs</span><span class=\"p\">(</span><span class=\"n\">outs</span><span class=\"p\">)</span>\n    <span class=\"n\">ins</span><span class=\"p\">,</span> <span class=\"n\">outs</span> <span class=\"o\">=</span> <span class=\"n\">theano</span><span class=\"p\">.</span><span class=\"n\">gof</span><span class=\"p\">.</span><span class=\"n\">graph</span><span class=\"p\">.</span><span class=\"n\">clone</span><span class=\"p\">(</span><span class=\"n\">ins</span><span class=\"p\">,</span> <span class=\"n\">outs</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">theano</span><span class=\"p\">.</span><span class=\"n\">gof</span><span class=\"p\">.</span><span class=\"n\">FunctionGraph</span><span class=\"p\">(</span><span class=\"n\">ins</span><span class=\"p\">,</span> <span class=\"n\">outs</span><span class=\"p\">)</span>\n\n<span class=\"k\">def</span> <span class=\"nf\">theano_simplify</span><span class=\"p\">(</span><span class=\"n\">fgraph</span><span class=\"p\">):</span>\n    <span class=\"s\">\"\"\" Simplify a Theano Computation \"\"\"</span>\n    <span class=\"n\">mode</span> <span class=\"o\">=</span> <span class=\"n\">theano</span><span class=\"p\">.</span><span class=\"nb\">compile</span><span class=\"p\">.</span><span class=\"n\">get_default_mode</span><span class=\"p\">().</span><span class=\"n\">excluding</span><span class=\"p\">(</span><span class=\"s\">\"fusion\"</span><span class=\"p\">)</span>\n    <span class=\"n\">fgraph</span> <span class=\"o\">=</span> <span class=\"n\">fgraph</span><span class=\"p\">.</span><span class=\"n\">clone</span><span class=\"p\">()</span>\n    <span class=\"n\">mode</span><span class=\"p\">.</span><span class=\"n\">optimizer</span><span class=\"p\">.</span><span class=\"n\">optimize</span><span class=\"p\">(</span><span class=\"n\">fgraph</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">fgraph</span>\n\n<span class=\"k\">def</span> <span class=\"nf\">theano_count_ops</span><span class=\"p\">(</span><span class=\"n\">fgraph</span><span class=\"p\">):</span>\n    <span class=\"s\">\"\"\" Count the number of Scalar operations in a Theano Computation \"\"\"</span>\n    <span class=\"k\">return</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"nb\">filter</span><span class=\"p\">(</span><span class=\"k\">lambda</span> <span class=\"n\">n</span><span class=\"p\">:</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">n</span><span class=\"p\">.</span><span class=\"n\">op</span><span class=\"p\">,</span> <span class=\"n\">theano</span><span class=\"p\">.</span><span class=\"n\">tensor</span><span class=\"p\">.</span><span class=\"n\">Elemwise</span><span class=\"p\">),</span>\n                      <span class=\"n\">fgraph</span><span class=\"p\">.</span><span class=\"n\">apply_nodes</span><span class=\"p\">))</span></code></pre>\n</figure>\n\n<p>In SymPy we create both an unevaluated derivative and a fully evaluated and sympy-simplified version.  We translate each to Theano, simplify within Theano, and then count the number of operations both before and after simplification.  In this way we can see the value added by both SymPy’s and Theano’s optimizations.</p>\n\n<figure class=\"highlight\">\n  <pre><code class=\"language-python\" data-lang=\"python\"><span class=\"n\">exprs</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"n\">Derivative</span><span class=\"p\">(</span><span class=\"n\">expr</span><span class=\"p\">,</span> <span class=\"n\">x</span><span class=\"p\">),</span>    <span class=\"c1\"># derivative computed in Theano\n</span>         <span class=\"n\">simplify</span><span class=\"p\">(</span><span class=\"n\">expr</span><span class=\"p\">.</span><span class=\"n\">diff</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"p\">))]</span> <span class=\"c1\"># derivative computed in SymPy, also sympy-simplified\n</span>\n<span class=\"k\">for</span> <span class=\"n\">expr</span> <span class=\"ow\">in</span> <span class=\"n\">exprs</span><span class=\"p\">:</span>\n    <span class=\"n\">fgraph</span> <span class=\"o\">=</span> <span class=\"n\">fgraph_of</span><span class=\"p\">(</span><span class=\"n\">expr</span><span class=\"p\">)</span>\n    <span class=\"n\">simp_fgraph</span> <span class=\"o\">=</span> <span class=\"n\">theano_simplify</span><span class=\"p\">(</span><span class=\"n\">fgraph</span><span class=\"p\">)</span>\n    <span class=\"k\">print</span> <span class=\"n\">latex</span><span class=\"p\">(</span><span class=\"n\">expr</span><span class=\"p\">)</span>\n    <span class=\"k\">print</span> <span class=\"s\">\"Operations:                             \"</span><span class=\"p\">,</span> <span class=\"n\">theano_count_ops</span><span class=\"p\">(</span><span class=\"n\">fgraph</span><span class=\"p\">)</span>\n    <span class=\"k\">print</span> <span class=\"s\">\"Operations after Theano Simplification: \"</span><span class=\"p\">,</span> <span class=\"n\">theano_count_ops</span><span class=\"p\">(</span><span class=\"n\">simp_fgraph</span><span class=\"p\">)</span></code></pre>\n</figure>\n\n<p>Theano Only</p>\n\n\\[\\frac{\\partial}{\\partial x}\\left(\\frac{1}{210} \\sqrt{70} x^{2} \\left(- \\frac{4}{3} x^{3} + 16 x^{2} - 56 x + 56\\right) e^{- x}\\right)\\]\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Operations:                              40\nOperations after Theano Simplification:  21\n</code></pre></div></div>\n\n<p>SymPy + Theano</p>\n\n\\[\\frac{2}{315} \\sqrt{70} x \\left(x^{4} - 17 x^{3} + 90 x^{2} - 168 x + 84\\right) e^{- x}\\]\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Operations:                              13\nOperations after Theano Simplification:  10\n</code></pre></div></div>\n\n<h2 id=\"analysis\">Analysis</h2>\n\n<p>On its own Theano produces a derivative expression that is about as complex as the unsimplified SymPy version.  Theano simplification then does a surprisingly good job, roughly halving the amount of work needed (<code class=\"language-plaintext highlighter-rouge\">40 -&gt; 21</code>) to compute the result.  If you dig deeper however you find that this isn’t because it was able to algebraically simplify the computation (it wasn’t) but rather because the computation contained several common sub-expressions.  The Theano version looks a lot like the unsimplified SymPy version.  Note the common sub-expressions like <code class=\"language-plaintext highlighter-rouge\">56*x</code> below.</p>\n\n\\[\\frac{1}{210} \\sqrt{70} x^{2} \\left(- 4 x^{2} + 32 x - 56\\right) e^{- x} - \\frac{1}{210} \\sqrt{70} x^{2} \\left(- \\frac{4}{3} x^{3} + 16 x^{2} - 56 x + 56\\right) e^{- x} + \\frac{1}{105} \\sqrt{70} x \\left(- \\frac{4}{3} x^{3} + 16 x^{2} - 56 x + 56\\right) e^{- x}\\]\n\n<p>The pure-SymPy simplified result is again substantially more efficient (<code class=\"language-plaintext highlighter-rouge\">13</code> operations).  Interestingly Theano is still able to improve on this, again not because of additional algebraic simplification but rather due to constant folding.  The two projects simplify in orthogonal ways.</p>\n\n<h2 id=\"simultaneous-computation\">Simultaneous Computation</h2>\n\n<p>When we compute both the expression and its derivative simultaneously we find substantial benefits from using the two projects together.</p>\n\n<figure class=\"highlight\">\n  <pre><code class=\"language-python\" data-lang=\"python\"><span class=\"n\">orig_expr</span> <span class=\"o\">=</span> <span class=\"n\">R_nl</span><span class=\"p\">(</span><span class=\"n\">n</span><span class=\"p\">,</span> <span class=\"n\">l</span><span class=\"p\">,</span> <span class=\"n\">x</span><span class=\"p\">,</span> <span class=\"n\">Z</span><span class=\"p\">)</span>\n<span class=\"k\">for</span> <span class=\"n\">expr</span> <span class=\"ow\">in</span> <span class=\"n\">exprs</span><span class=\"p\">:</span>\n    <span class=\"n\">fgraph</span> <span class=\"o\">=</span> <span class=\"n\">fgraph_of</span><span class=\"p\">(</span><span class=\"n\">expr</span><span class=\"p\">,</span> <span class=\"n\">orig_expr</span><span class=\"p\">)</span>\n    <span class=\"n\">simp_fgraph</span> <span class=\"o\">=</span> <span class=\"n\">theano_simplify</span><span class=\"p\">(</span><span class=\"n\">fgraph</span><span class=\"p\">)</span>\n    <span class=\"k\">print</span> <span class=\"n\">latex</span><span class=\"p\">((</span><span class=\"n\">expr</span><span class=\"p\">,</span> <span class=\"n\">orig_expr</span><span class=\"p\">))</span>\n    <span class=\"k\">print</span> <span class=\"s\">\"Operations:                             \"</span><span class=\"p\">,</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">fgraph</span><span class=\"p\">.</span><span class=\"n\">apply_nodes</span><span class=\"p\">)</span>\n    <span class=\"k\">print</span> <span class=\"s\">\"Operations after Theano Simplification: \"</span><span class=\"p\">,</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">simp_fgraph</span><span class=\"p\">.</span><span class=\"n\">apply_nodes</span><span class=\"p\">)</span></code></pre>\n</figure>\n\n\\[\\begin{pmatrix}\\frac{\\partial}{\\partial x}\\left(\\frac{1}{210} \\sqrt{70} x^{2} \\left(- \\frac{4}{3} x^{3} + 16 x^{2} - 56 x + 56\\right) e^{- x}\\right), &amp; \\frac{1}{210} \\sqrt{70} x^{2} \\left(- \\frac{4}{3} x^{3} + 16 x^{2} - 56 x + 56\\right) e^{- x}\\end{pmatrix}\\]\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Operations:                              57\nOperations after Theano Simplification:  24\n</code></pre></div></div>\n\n\\[\\begin{pmatrix}\\frac{2}{315} \\sqrt{70} x \\left(x^{4} - 17 x^{3} + 90 x^{2} - 168 x + 84\\right) e^{- x}, &amp; \\frac{1}{210} \\sqrt{70} x^{2} \\left(- \\frac{4}{3} x^{3} + 16 x^{2} - 56 x + 56\\right) e^{- x}\\end{pmatrix}\\]\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Operations:                              27\nOperations after Theano Simplification:  17\n</code></pre></div></div>\n\n<p>The combination of SymPy’s scalar simplification and Theano’s common sub-expression optimization yields a significantly simpler computation than either project could do independently.</p>\n\n<p>To summarize</p>\n\n<table>\n  <thead>\n    <tr>\n      <th style=\"text-align: left\">Project</th>\n      <th style=\"text-align: center\">operation count</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td style=\"text-align: left\">SymPy</td>\n      <td style=\"text-align: center\">27</td>\n    </tr>\n    <tr>\n      <td style=\"text-align: left\">Theano</td>\n      <td style=\"text-align: center\">24</td>\n    </tr>\n    <tr>\n      <td style=\"text-align: left\">SymPy+Theano</td>\n      <td style=\"text-align: center\">17</td>\n    </tr>\n  </tbody>\n</table>\n\n<h2 id=\"references\">References</h2>\n\n<ul>\n  <li><a href=\"https://mrocklin.github.io/blog/scripts/sympy_theano_simplification.py\">A script of this session</a></li>\n</ul>"
}