{
  "title": "Beautiful Plots With Pandas and Matplotlib",
  "link": "https://datasciencelab.wordpress.com/2013/12/21/beautiful-plots-with-pandas-and-matplotlib/",
  "comments": "https://datasciencelab.wordpress.com/2013/12/21/beautiful-plots-with-pandas-and-matplotlib/#comments",
  "dc:creator": "datasciencelab",
  "pubDate": "Sat, 21 Dec 2013 14:05:05 +0000",
  "category": [
    "Experiments",
    "matplotlib",
    "pandas",
    "plotting",
    "python",
    "visualization"
  ],
  "guid": "http://datasciencelab.wordpress.com/?p=356",
  "description": "[Click here to see the final plot described in this article.] Data visualization plays a crucial role in the communication of results from data analyses, and it should always help transmit insights in an honest and clear way. Recently, the highly recommendable blog Flowing Data posted a review of data visualization highlights during 2013, and [&#8230;]",
  "content:encoded": "<p>[Click <a href=\"https://datasciencelab.files.wordpress.com/2013/12/eu3.png\">here</a> to see the final plot described in this article.]</p>\n<p>Data visualization plays a crucial role in the communication of results from data analyses, and it should always help transmit insights in an honest and clear way. Recently, the highly recommendable blog Flowing Data <a href=\"http://flowingdata.com/2013/12/16/data-and-visualization-year-in-review-2013/\">posted a review of data visualization highlights during 2013</a>, and at The Data Science Lab we felt like doing a bit of pretty plotting as well.</p>\n<p>For Python lovers, <a href=\"http://matplotlib.org/gallery.html\">matplotlib</a> is the library of choice when it comes to plotting. Quite conveniently, the <a href=\"https://datasciencelab.wordpress.com/2013/11/18/put-some-pandas-in-your-python/\" title=\"Put Some Pandas in Your Python\">data analysis library pandas</a> comes equipped with useful wrappers around several matplotlib plotting routines, allowing for quick and handy plotting of data frames. Nice examples of plotting with pandas can be seen for instance <a href=\"http://nbviewer.ipython.org/urls/gist.github.com/fonnesbeck/5850463/raw/a29d9ffb863bfab09ff6c1fc853e1d5bf69fe3e4/3.+Plotting+and+Visualization.ipynb\">in this ipython notebook</a>. Still, for customized plots or not so typical visualizations, the panda wrappers need a bit of tweaking and playing with matplotlib&#8217;s inside machinery. If one is willing to devote a bit of time to google-ing and experimenting, very beautiful plots can emerge. </p>\n<h3>Visualizing demographic data</h3>\n<p>For this pre-Christmas data visualization <a href=\"https://datasciencelab.wordpress.com/category/experiments/\">table-top experiment</a> we are going to use demographic data from countries in the European Union obtained from <a href=\"https://www.wolframalpha.com/input/?i=size+and+population+of+countries+in+the+european+union\">Wolfram|Alpha</a>. Our data set contains information on population, extension and life expectancy in 24 European countries. We create a pandas data frame from three series that we simply construct from lists, setting the countries as index for each series, and consequently for the data frame.</p>\n<pre class=\"brush: python; title: ; notranslate\">\nimport pandas as pd\nimport matplotlib as mpl\nfrom matplotlib.colors import LinearSegmentedColormap\nfrom matplotlib.lines import Line2D \n\ncountries = ['France','Spain','Sweden','Germany','Finland','Poland','Italy',\n             'United Kingdom','Romania','Greece','Bulgaria','Hungary',\n             'Portugal','Austria','Czech Republic','Ireland','Lithuania','Latvia',\n             'Croatia','Slovakia','Estonia','Denmark','Netherlands','Belgium']\nextensions = [547030,504782,450295,357022,338145,312685,301340,243610,238391,\n              131940,110879,93028,92090,83871,78867,70273,65300,64589,56594,\n              49035,45228,43094,41543,30528]\npopulations = [63.8,47,9.55,81.8,5.42,38.3,61.1,63.2,21.3,11.4,7.35,\n               9.93,10.7,8.44,10.6,4.63,3.28,2.23,4.38,5.49,1.34,5.61,\n               16.8,10.8]\nlife_expectancies = [81.8,82.1,81.8,80.7,80.5,76.4,82.4,80.5,73.8,80.8,73.5,\n                    74.6,79.9,81.1,77.7,80.7,72.1,72.2,77,75.4,74.4,79.4,81,80.5]\ndata = {'extension' : pd.Series(extensions, index=countries), \n        'population' : pd.Series(populations, index=countries),\n        'life expectancy' : pd.Series(life_expectancies, index=countries)}\n\ndf = pd.DataFrame(data)\ndf = df.sort('life expectancy')\n</pre>\n<p>Now, thanks to the pandas plotting machinery, it is extremely straightforward to show the contents of this data frame by calling the <code>pd.plot</code> function. The code below generates a figure with three subplots displayed vertically, each of which shows a bar plot for a particular column of the data frame. The plots are automatically labelled with the column names of the data frame, and the whole procedure takes literally no time.</p>\n<pre class=\"brush: python; title: ; notranslate\">\nfig, axes = plt.subplots(nrows=3, ncols=1)\nfor i, c in enumerate(df.columns):\n    df[c].plot(kind='bar', ax=axes[i], figsize=(12, 10), title=c)\nplt.savefig('EU1.png', bbox_inches='tight')\n</pre>\n<p>The output figure looks like this:</p>\n<p><a href=\"https://datasciencelab.files.wordpress.com/2013/12/eu1.png\"><img data-attachment-id=\"373\" data-permalink=\"https://datasciencelab.wordpress.com/2013/12/21/beautiful-plots-with-pandas-and-matplotlib/eu1/\" data-orig-file=\"https://datasciencelab.files.wordpress.com/2013/12/eu1.png\" data-orig-size=\"725,670\" data-comments-opened=\"1\" data-image-meta=\"{\"aperture\":\"0\",\"credit\":\"\",\"camera\":\"\",\"caption\":\"\",\"created_timestamp\":\"0\",\"copyright\":\"\",\"focal_length\":\"0\",\"iso\":\"0\",\"shutter_speed\":\"0\",\"title\":\"\"}\" data-image-title=\"EU1\" data-image-description=\"\" data-image-caption=\"\" data-medium-file=\"https://datasciencelab.files.wordpress.com/2013/12/eu1.png?w=300\" data-large-file=\"https://datasciencelab.files.wordpress.com/2013/12/eu1.png?w=725\" src=\"https://datasciencelab.files.wordpress.com/2013/12/eu1.png?w=830\" alt=\"EU1\"   class=\"aligncenter size-full wp-image-373\" srcset=\"https://datasciencelab.files.wordpress.com/2013/12/eu1.png 725w, https://datasciencelab.files.wordpress.com/2013/12/eu1.png?w=150 150w, https://datasciencelab.files.wordpress.com/2013/12/eu1.png?w=300 300w\" sizes=\"(max-width: 725px) 100vw, 725px\" /></a></p>\n<h3>Customization with matplotlib directives</h3>\n<p>While this is an acceptable plot for the first steps of <a href=\"https://datasciencelab.wordpress.com/2013/12/05/a-peek-at-the-orcid-registry-public-data-file/\" title=\"A Peek at the ORCID Registry Public Data File\">data exploration</a>, the figure is not really publication-ready. It also looks very much &#8220;academic&#8221; and lacks that subtle flair that infographics in mainstream media have. Over the next paragraphs we will turn this plot into a much more beautiful object by playing around with the options that matplotlib supplies. </p>\n<p>Let us first start by creating a figure and an axis object that will contain our subfigure:</p>\n<pre class=\"brush: python; title: ; notranslate\">\n# Create a figure of given size\nfig = plt.figure(figsize=(16,12))\n# Add a subplot\nax = fig.add_subplot(111)\n# Set title\nttl = 'Population, size and age expectancy in the European Union'\n</pre>\n<p>Colors are very important for data visualizations. By default, the matplotlib color palette offers solid hues, which can be softened by applying transparencies. Similarly, the <a href=\"http://wiki.scipy.org/Cookbook/Matplotlib/Show_colormaps\">default colorbars</a> can be customized to match our taste (see below how one can define a custom-made color map with a gradient that softly changes from orange to gray-blue hues).</p>\n<pre class=\"brush: python; title: ; notranslate\">\n# Set color transparency (0: transparent; 1: solid)\na = 0.7\n# Create a colormap\ncustomcmap = [(x/24.0,  x/48.0, 0.05) for x in range(len(df))]\n</pre>\n<p>The main plotting instruction in our figure uses the pandas plot wrapper. In the initialization options, we specify the type of plot (horizontal bar), the transparency, the color of the bars following the above-defined custom color map, the x-axis limits and the figure title. We also set the color of the bar borders to white for a cleaner look.</p>\n<pre class=\"brush: python; title: ; notranslate\">\n# Plot the 'population' column as horizontal bar plot\ndf['population'].plot(kind='barh', ax=ax, alpha=a, legend=False, color=customcmap,\n                      edgecolor='w', xlim=(0,max(df['population'])), title=ttl)\n</pre>\n<p>After this simple pandas plot directive, the figure already looks very promising. Note that, because we sorted the data frame by life expectancy and applied a gradient color map, the color of the different bars in itself carries information. We will explicitly label that information below when constructing a color bar. For now we want to remove the grid, frame and axes lines from our plot, as well as customize its title and x,y axes labels. </p>\n<pre class=\"brush: python; title: ; notranslate\">\n# Remove grid lines (dotted lines inside plot)\nax.grid(False)\n# Remove plot frame\nax.set_frame_on(False)\n# Pandas trick: remove weird dotted line on axis\nax.lines[0].set_visible(False)\n\n# Customize title, set position, allow space on top of plot for title\nax.set_title(ax.get_title(), fontsize=26, alpha=a, ha='left')\nplt.subplots_adjust(top=0.9)\nax.title.set_position((0,1.08))\n\n# Set x axis label on top of plot, set label text\nax.xaxis.set_label_position('top')\nxlab = 'Population (in millions)'\nax.set_xlabel(xlab, fontsize=20, alpha=a, ha='left')\nax.xaxis.set_label_coords(0, 1.04)\n\n# Position x tick labels on top\nax.xaxis.tick_top()\n# Remove tick lines in x and y axes\nax.yaxis.set_ticks_position('none')\nax.xaxis.set_ticks_position('none')\n\n# Customize x tick lables\nxticks = [5,10,20,50,80]\nax.xaxis.set_ticks(xticks)\nax.set_xticklabels(xticks, fontsize=16, alpha=a)\n\n# Customize y tick labels\nyticks = [item.get_text() for item in ax.get_yticklabels()]\nax.set_yticklabels(yticks, fontsize=16, alpha=a)\nax.yaxis.set_tick_params(pad=12)  \n</pre>\n<p>So far, the lenghts of our horizontal bars display the population (in millions) of the EU countries. All bars have the same height (which is set to 50% of the total space between bars by default by pandas). An interesting idea is to use the height of the bars to display further data. If we could made the bar height dependent on, say, the countries&#8217; extension, we would be adding an supplementary piece of information to the plot. This is possible in matplotlib by accessing the elements that contain the bars and assigning them a specific height in a <code>for</code> loop. Each bar is an element of the class <a href=\"http://matplotlib.org/api/artist_api.html?highlight=rectangle#matplotlib.patches.Rectangle\">Rectangle</a>, and all the corresponding class methods can be applied to it. For assigning a given height according to each country&#8217;s extension, we code a simple linear interpolation and create a <code>lambda</code> function to apply it. </p>\n<pre class=\"brush: python; title: ; notranslate\">\n# Set bar height dependent on country extension\n# Set min and max bar thickness (from 0 to 1)\nhmin, hmax = 0.3, 0.9\nxmin, xmax = min(df['extension']), max(df['extension'])\n# Function that interpolates linearly between hmin and hmax\nf = lambda x: hmin + (hmax-hmin)*(x-xmin)/(xmax-xmin)\n# Make array of heights\nhs = [f(x) for x in df['extension']]\n\n# Iterate over bars\nfor container in ax.containers:\n    # Each bar has a Rectangle element as child\n    for i,child in enumerate(container.get_children()):\n        # Reset the lower left point of each bar so that bar is centered\n        child.set_y(child.get_y()- 0.125 + 0.5-hs[i]/2)\n        # Attribute height to each Recatangle according to country's size\n        plt.setp(child, height=hs[i])\n</pre>\n<p>Having added this &#8220;dimension&#8221; to the plot, we need a way of labelling the information so that the countries&#8217; extension is understandable. A legend would be the ideal solution, but since our plotting directive was set to display the column <code>['population']</code>, we can not use the default. We can construct a &#8220;fake&#8221; legend though, and custom-made its handles to roughly match the height of the bars. We position the legend in the lower right part of our plot.</p>\n<pre class=\"brush: python; title: ; notranslate\">\n# Legend\n# Create fake labels for legend\nl1 = Line2D([], [], linewidth=6, color='k', alpha=a) \nl2 = Line2D([], [], linewidth=12, color='k', alpha=a) \nl3 = Line2D([], [], linewidth=22, color='k', alpha=a)\n\n# Set three legend labels to be min, mean and max of countries extensions \n# (rounded up to 10k km2)\nrnd = 10000\nlabels = [str(int(round(l/rnd)*rnd)) for l in min(df['extension']), \n          mean(df['extension']), max(df['extension'])]\n\n# Position legend in lower right part\n# Set ncol=3 for horizontally expanding legend\nleg = ax.legend([l1, l2, l3], labels, ncol=3, frameon=False, fontsize=16, \n                bbox_to_anchor=[1.1, 0.11], handlelength=2, \n                handletextpad=1, columnspacing=2, title='Size (in km2)')\n\n# Customize legend title\n# Set position to increase space between legend and labels\nplt.setp(leg.get_title(), fontsize=20, alpha=a)\nleg.get_title().set_position((0, 10))\n# Customize transparency for legend labels\n[plt.setp(label, alpha=a) for label in leg.get_texts()]\n</pre>\n<p>Finally, there is another piece of information in the plot that needs to be labelled, and that is the color map indicating the average life expectancy in the EU countries. Since we used a custom-made color map, the regular call to <code>plt.colorbar()</code> would not work. We need to create a <a href=\"http://matplotlib.org/api/colors_api.html?highlight=linearsegmentedcolormap#matplotlib.colors.LinearSegmentedColormap\">LinearSegmentedColormap</a> instead and &#8220;trick&#8221; matplotlib to display it as a colorbar. Then we can use the usual customization methods from <code>colorbar</code> to set fonts, transparency, position and size of the diverse elements in the color legend.</p>\n<pre class=\"brush: python; title: ; notranslate\">\n# Create a fake colorbar\nctb = LinearSegmentedColormap.from_list('custombar', customcmap, N=2048)\n# Trick from http://stackoverflow.com/questions/8342549/\n# matplotlib-add-colorbar-to-a-sequence-of-line-plots\nsm = plt.cm.ScalarMappable(cmap=ctb, norm=plt.normalize(vmin=72, vmax=84))\n# Fake up the array of the scalar mappable\nsm._A = []\n\n# Set colorbar, aspect ratio\ncbar = plt.colorbar(sm, alpha=0.05, aspect=16, shrink=0.4)\ncbar.solids.set_edgecolor(\"face\")\n# Remove colorbar container frame\ncbar.outline.set_visible(False)\n# Fontsize for colorbar ticklabels\ncbar.ax.tick_params(labelsize=16)\n# Customize colorbar tick labels\nmytks = range(72,86,2)\ncbar.set_ticks(mytks)\ncbar.ax.set_yticklabels([str(a) for a in mytks], alpha=a)\n\n# Colorbar label, customize fontsize and distance to colorbar\ncbar.set_label('Age expectancy (in years)', alpha=a, \n               rotation=270, fontsize=20, labelpad=20)\n# Remove color bar tick lines, while keeping the tick labels\ncbarytks = plt.getp(cbar.ax.axes, 'yticklines')\nplt.setp(cbarytks, visible=False)\n</pre>\n<p><a id=\"FinalPlot\"></a><br />\nThe final and most rewarding step consists of saving the figure in our preferred format. </p>\n<pre class=\"brush: python; title: ; notranslate\">\n# Save figure in png with tight bounding box\nplt.savefig('EU.png', bbox_inches='tight', dpi=300)\n</pre>\n<p>The final result looks this beautiful:</p>\n<p><a href=\"https://datasciencelab.files.wordpress.com/2013/12/eu3.png\"><img loading=\"lazy\" data-attachment-id=\"480\" data-permalink=\"https://datasciencelab.wordpress.com/2013/12/21/beautiful-plots-with-pandas-and-matplotlib/eu-2/\" data-orig-file=\"https://datasciencelab.files.wordpress.com/2013/12/eu3.png\" data-orig-size=\"2841,2118\" data-comments-opened=\"1\" data-image-meta=\"{\"aperture\":\"0\",\"credit\":\"\",\"camera\":\"\",\"caption\":\"\",\"created_timestamp\":\"0\",\"copyright\":\"\",\"focal_length\":\"0\",\"iso\":\"0\",\"shutter_speed\":\"0\",\"title\":\"\"}\" data-image-title=\"EU\" data-image-description=\"\" data-image-caption=\"\" data-medium-file=\"https://datasciencelab.files.wordpress.com/2013/12/eu3.png?w=300\" data-large-file=\"https://datasciencelab.files.wordpress.com/2013/12/eu3.png?w=830\" src=\"https://datasciencelab.files.wordpress.com/2013/12/eu3.png?w=830&#038;h=618\" alt=\"EU\" width=\"830\" height=\"618\" class=\"aligncenter size-large wp-image-480\" srcset=\"https://datasciencelab.files.wordpress.com/2013/12/eu3.png?w=830&h=618 830w, https://datasciencelab.files.wordpress.com/2013/12/eu3.png?w=1658&h=1236 1658w, https://datasciencelab.files.wordpress.com/2013/12/eu3.png?w=150&h=112 150w, https://datasciencelab.files.wordpress.com/2013/12/eu3.png?w=300&h=224 300w, https://datasciencelab.files.wordpress.com/2013/12/eu3.png?w=768&h=573 768w, https://datasciencelab.files.wordpress.com/2013/12/eu3.png?w=1024&h=763 1024w\" sizes=\"(max-width: 830px) 100vw, 830px\" /></a></p>\n<h3>Table-top data experiment take-away message</h3>\n<p>When producing a plot based on multidimensional data, it is a good idea to resort to shapes and colors that visually guide us through the variables on display. Matplotlib offers a high level of customization for all details of a plot, albeit the truth is that finding exactly which knob to tweak might be at times bewildering. Beautiful plots can be created by experimenting with various settings, among which hues, transparencies and simple layouts are the focal points. The results are publication-ready figures with open-source software that can be easily replicated by means of structured python code. </p>\n",
  "wfw:commentRss": "https://datasciencelab.wordpress.com/2013/12/21/beautiful-plots-with-pandas-and-matplotlib/feed/",
  "slash:comments": 25,
  "media:content": [
    {
      "media:title": "datasciencelab"
    },
    {
      "media:title": "EU1"
    },
    {
      "media:title": "EU"
    }
  ]
}