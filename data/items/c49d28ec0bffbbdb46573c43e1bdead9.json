{
  "title": "Dangerous streets of Bratislava! Animated maps using open data in R",
  "description": "<p>At the work recently, I wanted to make some interesting start-up pitch (presentation) ready animated visualization and got some first experience with spatial data (e.g. polygons). I enjoyed working with such a type of data and I wanted to improve on working with them, so I decided to try to visualize something interesting with Bratislava (Slovakia) open-data and OpenStreetMaps. I ended with animated maps of violations on Bratislava streets through the time of 2 and a half years.</p>\n\n<p>Since spatial time series are analyzed in this post, it still sticks with the blog domain and it is time series data mining :)\nYou can read more about time series forecasting, representations and clustering in my <a href=\"https://petolau.github.io/blog\">previous blog posts here</a>.</p>\n\n<p>Aaand teaser, what I will create in this blog post:</p>\n\n<p><img src=\"/images/post_12/gif_ba_whole.gif\" alt=\"\" /></p>\n\n<p>In this blog post you will learn how to:</p>\n\n<ul>\n  <li>get free city district polygons data from OpenStreetMaps API,</li>\n  <li>get free street lines (polygons) coordinates from OpenStreetMaps API,</li>\n  <li>visualize polygons and street lines with <code class=\"language-plaintext highlighter-rouge\">ggplot2</code> and <code class=\"language-plaintext highlighter-rouge\">ggmap</code>,</li>\n  <li>merge spatial data with violation data represented as time series,</li>\n  <li>animate spatial data combined with violation time series with <code class=\"language-plaintext highlighter-rouge\">gganimate</code>.</li>\n</ul>\n\n<h2 id=\"bratislava-open-data\">Bratislava Open-Data</h2>\n\n<p>The ultimate goal is to show where and when are the most dangerous places in the capital of Slovakia - Bratislava.\nFor this task, I will use open-data that cover violations gathered from the city police with locations (city district and street name) and time-stamp.</p>\n\n<p>Firstly, load all the needed packages.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">library</span><span class=\"p\">(</span><span class=\"n\">data.table</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"c1\"># handling data</span><span class=\"w\">\n</span><span class=\"n\">library</span><span class=\"p\">(</span><span class=\"n\">lubridate</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"c1\"># handling timestamps</span><span class=\"w\">\n</span><span class=\"n\">library</span><span class=\"p\">(</span><span class=\"n\">stringi</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"c1\"># text processing</span><span class=\"w\">\n</span><span class=\"n\">library</span><span class=\"p\">(</span><span class=\"n\">osmdata</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"c1\"># OSM data API</span><span class=\"w\">\n</span><span class=\"c1\"># library(nominatim) # alternative OSM data API</span><span class=\"w\">\n</span><span class=\"n\">library</span><span class=\"p\">(</span><span class=\"n\">sf</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"c1\"># handling spatial data</span><span class=\"w\">\n</span><span class=\"n\">library</span><span class=\"p\">(</span><span class=\"n\">ggplot2</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"c1\"># visualisations</span><span class=\"w\">\n</span><span class=\"n\">library</span><span class=\"p\">(</span><span class=\"n\">ggsci</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"c1\"># color pallets</span><span class=\"w\">\n</span><span class=\"n\">library</span><span class=\"p\">(</span><span class=\"n\">ggmap</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"c1\"># map vis</span><span class=\"w\">\n</span><span class=\"n\">library</span><span class=\"p\">(</span><span class=\"n\">gganimate</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"c1\"># animations</span><span class=\"w\">\n</span><span class=\"n\">library</span><span class=\"p\">(</span><span class=\"n\">magick</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"c1\"># image handling</span></code></pre></figure>\n\n<p>Then, let’s download the violations data from <a href=\"https://opendata.bratislava.sk\">opendata.bratislava.sk</a> webpage and translate Slovak column names to English.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">data_violation_17</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">fread</span><span class=\"p\">(</span><span class=\"s2\">\"https://opendata.bratislava.sk/dataset/download/pocet-priestupkov-podla-druhu-udalosti-v-roku-r/1\"</span><span class=\"p\">,</span><span class=\"w\">\n                           </span><span class=\"n\">encoding</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Latin-1\"</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"n\">data_violation_18</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">fread</span><span class=\"p\">(</span><span class=\"s2\">\"https://opendata.bratislava.sk/dataset/download/pocet-priestupkov-podla-druhu-udalosti-v-roku-/1\"</span><span class=\"p\">,</span><span class=\"w\">\n                           </span><span class=\"n\">encoding</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Latin-1\"</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"n\">data_violation_19</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">fread</span><span class=\"p\">(</span><span class=\"s2\">\"https://opendata.bratislava.sk/dataset/download/pocet-priestupkov-podla-druhu-udalosti-----ethyanzgrthar/1\"</span><span class=\"p\">,</span><span class=\"w\">\n                           </span><span class=\"n\">encoding</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Latin-1\"</span><span class=\"p\">)</span><span class=\"w\">\n \n</span><span class=\"c1\"># colnames to English</span><span class=\"w\">\n</span><span class=\"n\">setnames</span><span class=\"p\">(</span><span class=\"n\">data_violation_17</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">colnames</span><span class=\"p\">(</span><span class=\"n\">data_violation_17</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"s2\">\"Date_Time\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"Group_vio\"</span><span class=\"p\">,</span><span class=\"w\">\n                                                           </span><span class=\"s2\">\"Type_vio\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"Street\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"Place\"</span><span class=\"p\">))</span><span class=\"w\">\n</span><span class=\"n\">setnames</span><span class=\"p\">(</span><span class=\"n\">data_violation_18</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">colnames</span><span class=\"p\">(</span><span class=\"n\">data_violation_18</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"s2\">\"Date_Time\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"Group_vio\"</span><span class=\"p\">,</span><span class=\"w\">\n                                                           </span><span class=\"s2\">\"Type_vio\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"Street\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"Place\"</span><span class=\"p\">))</span><span class=\"w\">\n</span><span class=\"n\">setnames</span><span class=\"p\">(</span><span class=\"n\">data_violation_19</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">colnames</span><span class=\"p\">(</span><span class=\"n\">data_violation_19</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"s2\">\"Date_Time\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"Group_vio\"</span><span class=\"p\">,</span><span class=\"w\">\n                                                           </span><span class=\"s2\">\"Type_vio\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"Street\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"Place\"</span><span class=\"p\">))</span></code></pre></figure>\n\n<p>Let’s bind all the data together.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">data_violation</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">rbindlist</span><span class=\"p\">(</span><span class=\"nf\">list</span><span class=\"p\">(</span><span class=\"n\">data_violation_17</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">data_violation_18</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">data_violation_19</span><span class=\"p\">),</span><span class=\"w\">\n                            </span><span class=\"n\">use.names</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">T</span><span class=\"p\">)</span></code></pre></figure>\n\n<!-- See, what we got. -->\n<!-- ```{r} -->\n<!-- str(data_violation) -->\n<!-- ``` -->\n\n<p>Next, I will transform Date_Time to POCIXct format and generate time aggregation features - Year and Month - <em>Year_M</em>.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">data_violation</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Date_Time</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">dmy_hm</span><span class=\"p\">(</span><span class=\"n\">Date_Time</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">data_violation</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Date</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">date</span><span class=\"p\">(</span><span class=\"n\">Date_Time</span><span class=\"p\">)]</span><span class=\"w\">\n \n</span><span class=\"c1\"># Aggregation features</span><span class=\"w\">\n</span><span class=\"n\">data_violation</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Month</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">month</span><span class=\"p\">(</span><span class=\"n\">Date_Time</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">data_violation</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Year</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">year</span><span class=\"p\">(</span><span class=\"n\">Date_Time</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">data_violation</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Year_M</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Year</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">Month</span><span class=\"o\">/</span><span class=\"m\">100</span><span class=\"p\">]</span></code></pre></figure>\n\n<p>Let’s see how many violations have each <em>Place</em> (city district) for whole available period (2017-2019.09):</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">data_violation</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">.N</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Place</span><span class=\"p\">)]</span></code></pre></figure>\n\n<figure class=\"highlight\"><pre><code class=\"language-text\" data-lang=\"text\">##                 Place     N\n##  1:       Stare Mesto 68714\n##  2:       Karlova Ves 11462\n##  3:         Petrzalka 17062\n##  4:          Dubravka  6307\n##  5:           Ruzinov 21352\n##  6:           Vajnory  1194\n##  7:    Pod. Biskupice  1590\n##  8:           Vrakuna  1262\n##  9:        Nove Mesto 17964\n## 10:             Devin   269\n## 11:              Raca  2390\n## 12: Devinska Nova Ves  1406\n## 13:             Lamac  1455\n## 14:           Jarovce    66\n## 15:     Zah. Bystrica   928\n## 16:           Rusovce   753\n## 17:            Cunovo   569</code></pre></figure>\n\n<p>We can see that Old-town (Stare Mesto) rocks in this statistic..obviously - e.g. lot of tourists. There are also some misunderstand Slavic letters. We should get rid of them - in the blog post there we be lot of handling of these special Slavic (Slovak) symbols.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">data_violation</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Place</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">stri_trans_general</span><span class=\"p\">(</span><span class=\"n\">Place</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"Latin-ASCII\"</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">data_violation</span><span class=\"p\">[</span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"s2\">\"Eunovo\"</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Place</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">Place</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"Cunovo\"</span><span class=\"p\">]</span><span class=\"w\">\n</span><span class=\"n\">data_violation</span><span class=\"p\">[</span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"s2\">\"Raea\"</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Place</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">Place</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"Raca\"</span><span class=\"p\">]</span><span class=\"w\">\n</span><span class=\"n\">data_violation</span><span class=\"p\">[</span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"s2\">\"Vrakuoa\"</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Place</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">Place</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"Vrakuna\"</span><span class=\"p\">]</span><span class=\"w\">\n</span><span class=\"n\">data_violation</span><span class=\"p\">[</span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"s2\">\"Lamae\"</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Place</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">Place</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"Lamac\"</span><span class=\"p\">]</span></code></pre></figure>\n\n<p>I will extract only types of violations that relate to the bad behavior of people, like harassment, using alcoholic beverages on public space and related things. So, I will not extract traffic violations like bad car parking, etc. For this task, I need to extract codes of violations:</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">data_violation</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Group_vio_ID</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"nf\">as.numeric</span><span class=\"p\">(</span><span class=\"n\">substr</span><span class=\"p\">(</span><span class=\"n\">Group_vio</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"m\">4</span><span class=\"p\">))]</span><span class=\"w\">\n</span><span class=\"c1\"># our codes are: 4836, 5000, 4834, 4700, 4838, 4828, 4839,</span><span class=\"w\">\n</span><span class=\"c1\"># 4813, 9803, 4840, 4841, 9809, 3000, 9806, 4900</span></code></pre></figure>\n\n<h2 id=\"polygons-of-city-districts\">Polygons of city districts</h2>\n\n<p>I want to show a number of crimes per city district and street (so both place information) on a map, so I need to get coordinates of city districts and streets.\nLet’s get polygons of city districts first using OpenStreetMap API.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">poly_sm</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">getbb</span><span class=\"p\">(</span><span class=\"n\">place_name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Stare Mesto Bratislava\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">format_out</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"polygon\"</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"n\">poly_nm</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">getbb</span><span class=\"p\">(</span><span class=\"n\">place_name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Nove Mesto Bratislava\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">format_out</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"polygon\"</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"n\">poly_ruz</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">getbb</span><span class=\"p\">(</span><span class=\"n\">place_name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Ruzinov Bratislava\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">format_out</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"polygon\"</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"n\">poly_raca</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">getbb</span><span class=\"p\">(</span><span class=\"n\">place_name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Raca Bratislava\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">format_out</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"polygon\"</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"n\">poly_petr</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">getbb</span><span class=\"p\">(</span><span class=\"n\">place_name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Petrzalka Bratislava\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">format_out</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"polygon\"</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"n\">poly_kv</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">getbb</span><span class=\"p\">(</span><span class=\"n\">place_name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Karlova Ves Bratislava\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">format_out</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"polygon\"</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"n\">poly_dubr</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">getbb</span><span class=\"p\">(</span><span class=\"n\">place_name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Dubravka Bratislava\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">format_out</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"polygon\"</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"n\">poly_vajn</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">getbb</span><span class=\"p\">(</span><span class=\"n\">place_name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Vajnory Bratislava\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">format_out</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"polygon\"</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"n\">poly_lamac</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">getbb</span><span class=\"p\">(</span><span class=\"n\">place_name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Lamac Bratislava\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">format_out</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"polygon\"</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"n\">poly_vrak</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">getbb</span><span class=\"p\">(</span><span class=\"n\">place_name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Vrakuna Bratislava\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">format_out</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"polygon\"</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"n\">poly_pd</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">getbb</span><span class=\"p\">(</span><span class=\"n\">place_name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Podunajske Biskupice Bratislava\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">format_out</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"polygon\"</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"n\">poly_jar</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">getbb</span><span class=\"p\">(</span><span class=\"n\">place_name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Jarovce Bratislava\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">format_out</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"polygon\"</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"n\">poly_dnv</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">getbb</span><span class=\"p\">(</span><span class=\"n\">place_name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Devinska Nova Ves Bratislava\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">format_out</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"polygon\"</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"n\">poly_rus</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">getbb</span><span class=\"p\">(</span><span class=\"n\">place_name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Rusovce Bratislava\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">format_out</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"polygon\"</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"n\">poly_zb</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">getbb</span><span class=\"p\">(</span><span class=\"n\">place_name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Zahorska Bystrica Bratislava\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">format_out</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"polygon\"</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"n\">poly_devin</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">getbb</span><span class=\"p\">(</span><span class=\"n\">place_name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Devin Bratislava\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">format_out</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"polygon\"</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"n\">poly_cun</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">getbb</span><span class=\"p\">(</span><span class=\"n\">place_name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Cunovo Bratislava\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">format_out</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"polygon\"</span><span class=\"p\">)</span></code></pre></figure>\n\n<p>Let’s bind all the districts data of Bratislava.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">data_poly_ba</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">rbindlist</span><span class=\"p\">(</span><span class=\"nf\">list</span><span class=\"p\">(</span><span class=\"w\">\n  </span><span class=\"n\">as.data.table</span><span class=\"p\">(</span><span class=\"n\">poly_sm</span><span class=\"p\">)[,</span><span class=\"w\"> </span><span class=\"n\">Place</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"Stare Mesto\"</span><span class=\"p\">],</span><span class=\"w\">\n  </span><span class=\"n\">as.data.table</span><span class=\"p\">(</span><span class=\"n\">poly_nm</span><span class=\"p\">[[</span><span class=\"m\">1</span><span class=\"p\">]])[,</span><span class=\"w\"> </span><span class=\"n\">Place</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"Nove Mesto\"</span><span class=\"p\">],</span><span class=\"w\">\n  </span><span class=\"n\">as.data.table</span><span class=\"p\">(</span><span class=\"n\">poly_ruz</span><span class=\"p\">[[</span><span class=\"m\">1</span><span class=\"p\">]])[,</span><span class=\"w\"> </span><span class=\"n\">Place</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"Ruzinov\"</span><span class=\"p\">],</span><span class=\"w\">\n  </span><span class=\"n\">as.data.table</span><span class=\"p\">(</span><span class=\"n\">poly_raca</span><span class=\"p\">)[,</span><span class=\"w\"> </span><span class=\"n\">Place</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"Raca\"</span><span class=\"p\">],</span><span class=\"w\">\n  </span><span class=\"n\">as.data.table</span><span class=\"p\">(</span><span class=\"n\">poly_petr</span><span class=\"p\">)[,</span><span class=\"w\"> </span><span class=\"n\">Place</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"Petrzalka\"</span><span class=\"p\">],</span><span class=\"w\">\n  </span><span class=\"n\">as.data.table</span><span class=\"p\">(</span><span class=\"n\">poly_kv</span><span class=\"p\">[[</span><span class=\"m\">1</span><span class=\"p\">]])[,</span><span class=\"w\"> </span><span class=\"n\">Place</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"Karlova Ves\"</span><span class=\"p\">],</span><span class=\"w\">\n  </span><span class=\"n\">as.data.table</span><span class=\"p\">(</span><span class=\"n\">poly_dubr</span><span class=\"p\">[[</span><span class=\"m\">1</span><span class=\"p\">]])[,</span><span class=\"w\"> </span><span class=\"n\">Place</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"Dubravka\"</span><span class=\"p\">],</span><span class=\"w\">\n  </span><span class=\"n\">as.data.table</span><span class=\"p\">(</span><span class=\"n\">poly_vajn</span><span class=\"p\">[[</span><span class=\"m\">1</span><span class=\"p\">]])[,</span><span class=\"w\"> </span><span class=\"n\">Place</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"Vajnory\"</span><span class=\"p\">],</span><span class=\"w\">\n  </span><span class=\"n\">as.data.table</span><span class=\"p\">(</span><span class=\"n\">poly_lamac</span><span class=\"p\">[[</span><span class=\"m\">1</span><span class=\"p\">]])[,</span><span class=\"w\"> </span><span class=\"n\">Place</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"Lamac\"</span><span class=\"p\">],</span><span class=\"w\">\n  </span><span class=\"n\">as.data.table</span><span class=\"p\">(</span><span class=\"n\">poly_vrak</span><span class=\"p\">[[</span><span class=\"m\">1</span><span class=\"p\">]])[,</span><span class=\"w\"> </span><span class=\"n\">Place</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"Vrakuna\"</span><span class=\"p\">],</span><span class=\"w\">\n  </span><span class=\"n\">as.data.table</span><span class=\"p\">(</span><span class=\"n\">poly_pd</span><span class=\"p\">[[</span><span class=\"m\">1</span><span class=\"p\">]])[,</span><span class=\"w\"> </span><span class=\"n\">Place</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"Pod. Biskupice\"</span><span class=\"p\">],</span><span class=\"w\">\n  </span><span class=\"n\">as.data.table</span><span class=\"p\">(</span><span class=\"n\">poly_jar</span><span class=\"p\">[[</span><span class=\"m\">1</span><span class=\"p\">]])[,</span><span class=\"w\"> </span><span class=\"n\">Place</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"Jarovce\"</span><span class=\"p\">],</span><span class=\"w\">\n  </span><span class=\"n\">as.data.table</span><span class=\"p\">(</span><span class=\"n\">poly_dnv</span><span class=\"p\">[[</span><span class=\"m\">1</span><span class=\"p\">]])[,</span><span class=\"w\"> </span><span class=\"n\">Place</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"Devinska Nova Ves\"</span><span class=\"p\">],</span><span class=\"w\">\n  </span><span class=\"n\">as.data.table</span><span class=\"p\">(</span><span class=\"n\">poly_rus</span><span class=\"p\">[[</span><span class=\"m\">1</span><span class=\"p\">]])[,</span><span class=\"w\"> </span><span class=\"n\">Place</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"Rusovce\"</span><span class=\"p\">],</span><span class=\"w\">\n  </span><span class=\"n\">as.data.table</span><span class=\"p\">(</span><span class=\"n\">poly_zb</span><span class=\"p\">[[</span><span class=\"m\">1</span><span class=\"p\">]])[,</span><span class=\"w\"> </span><span class=\"n\">Place</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"Zah. Bystrica\"</span><span class=\"p\">],</span><span class=\"w\">\n  </span><span class=\"n\">as.data.table</span><span class=\"p\">(</span><span class=\"n\">poly_devin</span><span class=\"p\">[[</span><span class=\"m\">1</span><span class=\"p\">]])[,</span><span class=\"w\"> </span><span class=\"n\">Place</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"Devin\"</span><span class=\"p\">],</span><span class=\"w\">\n  </span><span class=\"n\">as.data.table</span><span class=\"p\">(</span><span class=\"n\">poly_cun</span><span class=\"p\">[[</span><span class=\"m\">1</span><span class=\"p\">]])[,</span><span class=\"w\"> </span><span class=\"n\">Place</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"Cunovo\"</span><span class=\"p\">]</span><span class=\"w\">\n</span><span class=\"p\">))</span><span class=\"w\">\n \n</span><span class=\"n\">setnames</span><span class=\"p\">(</span><span class=\"n\">data_poly_ba</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"s2\">\"V1\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"V2\"</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"s2\">\"lon\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"lat\"</span><span class=\"p\">))</span><span class=\"w\">\n</span><span class=\"n\">data_poly_ba</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Place</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">factor</span><span class=\"p\">(</span><span class=\"n\">Place</span><span class=\"p\">)]</span></code></pre></figure>\n\n<p>Let’s visualize simply the districts.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">ggplot</span><span class=\"p\">(</span><span class=\"n\">data_poly_ba</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">geom_polygon</span><span class=\"p\">(</span><span class=\"n\">aes</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lon</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lat</span><span class=\"p\">,</span><span class=\"w\">\n                   </span><span class=\"n\">fill</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Place</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">color</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Place</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  \n  </span><span class=\"n\">theme_void</span><span class=\"p\">()</span></code></pre></figure>\n\n<p><img src=\"/images/post_12/unnamed-chunk-10-1.png\" alt=\"plot of chunk unnamed-chunk-10\" /></p>\n\n<p>For animation and visualization purposes, I need to aggregate violations data by districts (<em>Place</em>) and Year+Month columns (<em>Year_M</em>).</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">data_violation_agg_place</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">copy</span><span class=\"p\">(</span><span class=\"n\">data_violation</span><span class=\"p\">[</span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"m\">4836</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"m\">5000</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"m\">4834</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"m\">4700</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"m\">4838</span><span class=\"p\">,</span><span class=\"w\">\n                                                    </span><span class=\"m\">4828</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"m\">4839</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"m\">4813</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"m\">9803</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"m\">4840</span><span class=\"p\">,</span><span class=\"w\">\n                                                    </span><span class=\"m\">4841</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"m\">9809</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"m\">3000</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"m\">9806</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"m\">4900</span><span class=\"p\">)),</span><span class=\"w\">\n                                                </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Group_vio_ID</span><span class=\"p\">),</span><span class=\"w\">\n                                                </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.N</span><span class=\"p\">),</span><span class=\"w\">\n                                                </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Place</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Year_M</span><span class=\"p\">)])</span></code></pre></figure>\n\n<p>The next step is to merge polygon data with aggregated violation data:</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">data_places</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">merge</span><span class=\"p\">(</span><span class=\"n\">data_poly_ba</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Place</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lon</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lat</span><span class=\"p\">)],</span><span class=\"w\">\n                     </span><span class=\"n\">data_violation_agg_place</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Place</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">N_violation</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Year_M</span><span class=\"p\">)],</span><span class=\"w\">\n                     </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Place\"</span><span class=\"p\">,</span><span class=\"w\">\n                     </span><span class=\"n\">all.y</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">T</span><span class=\"p\">,</span><span class=\"w\">\n                     </span><span class=\"n\">allow.cartesian</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">T</span><span class=\"p\">)</span></code></pre></figure>\n\n<p>Let’s also compute mean coordinates for every district for showing theirs names on a graph.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">data_poly_ba_mean_place</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">copy</span><span class=\"p\">(</span><span class=\"n\">data_poly_ba</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">lon</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">mean</span><span class=\"p\">(</span><span class=\"n\">lon</span><span class=\"p\">),</span><span class=\"w\">\n                                                 </span><span class=\"n\">lat</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">mean</span><span class=\"p\">(</span><span class=\"n\">lat</span><span class=\"p\">)),</span><span class=\"w\">\n                                             </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Place</span><span class=\"p\">)])</span></code></pre></figure>\n\n<p>Let’s test visualization of violations on June 2019:</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">ggplot</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">geom_polygon</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">data_places</span><span class=\"p\">[</span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"m\">2019.06</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Year_M</span><span class=\"p\">)],</span><span class=\"w\">\n               </span><span class=\"n\">aes</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lon</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lat</span><span class=\"p\">,</span><span class=\"w\">\n                   </span><span class=\"n\">fill</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">N_violation</span><span class=\"p\">,</span><span class=\"w\">\n                   </span><span class=\"n\">group</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Place</span><span class=\"p\">),</span><span class=\"w\">\n               </span><span class=\"n\">color</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"grey40\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">scale_fill_material</span><span class=\"p\">(</span><span class=\"s2\">\"grey\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">geom_label</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">data_poly_ba_mean_place</span><span class=\"p\">,</span><span class=\"w\">\n             </span><span class=\"n\">aes</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lon</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lat</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">label</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Place</span><span class=\"p\">),</span><span class=\"w\">\n             </span><span class=\"n\">color</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"black\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">fill</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"dodgerblue1\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0.65</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">theme_void</span><span class=\"p\">()</span></code></pre></figure>\n\n<p><img src=\"/images/post_12/unnamed-chunk-14-1.png\" alt=\"plot of chunk unnamed-chunk-14\" /></p>\n\n<h2 id=\"street-lines-coordinates\">Street lines coordinates</h2>\n\n<p>The next step is to download street coordinates from OpenStreetMaps.</p>\n\n<p>Firstly, we have to extract unique street names from violation data, and handle Slovak letters and other punctuation for easier matching by street name.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">dt_uni_streets</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">copy</span><span class=\"p\">(</span><span class=\"n\">data_violation</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Place</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">data.table</span><span class=\"o\">::</span><span class=\"n\">first</span><span class=\"p\">(</span><span class=\"n\">Place</span><span class=\"p\">)),</span><span class=\"w\">\n                                      </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Street</span><span class=\"p\">)])</span><span class=\"w\">\n \n</span><span class=\"n\">dt_uni_streets</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">gsub</span><span class=\"p\">(</span><span class=\"n\">pattern</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Ãˆ\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">replacement</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"C\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Street</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">dt_uni_streets</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">gsub</span><span class=\"p\">(</span><span class=\"n\">pattern</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Ã²\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">replacement</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"n\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">dt_uni_streets</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">gsub</span><span class=\"p\">(</span><span class=\"n\">pattern</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Ã¨\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">replacement</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"c\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">dt_uni_streets</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">gsub</span><span class=\"p\">(</span><span class=\"n\">pattern</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"\\u009d\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">replacement</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"t\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">dt_uni_streets</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">gsub</span><span class=\"p\">(</span><span class=\"n\">pattern</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Â¾\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">replacement</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"l\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">dt_uni_streets</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">gsub</span><span class=\"p\">(</span><span class=\"n\">pattern</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Â¼\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">replacement</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"L\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">dt_uni_streets</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">gsub</span><span class=\"p\">(</span><span class=\"n\">pattern</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Ã²\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">replacement</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"n\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">dt_uni_streets</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">gsub</span><span class=\"p\">(</span><span class=\"n\">pattern</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"_\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">replacement</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">dt_uni_streets</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">gsub</span><span class=\"p\">(</span><span class=\"n\">pattern</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Ã¯\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">replacement</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"d\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">dt_uni_streets</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">gsub</span><span class=\"p\">(</span><span class=\"n\">pattern</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Ã \"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">replacement</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"r\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">dt_uni_streets</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">stri_trans_general</span><span class=\"p\">(</span><span class=\"n\">Street_edit</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"Latin-ASCII\"</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">dt_uni_streets</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">sub</span><span class=\"p\">(</span><span class=\"s2\">\" - MC.*\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">dt_uni_streets</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">gsub</span><span class=\"p\">(</span><span class=\"n\">pattern</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Nam.\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">replacement</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Namestie \"</span><span class=\"p\">,</span><span class=\"w\">\n                                     </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"p\">)]</span><span class=\"w\">\n \n</span><span class=\"n\">dt_uni_streets</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Street_query</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">gsub</span><span class=\"p\">(</span><span class=\"n\">pattern</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\" \"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">replacement</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"+\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">dt_uni_streets</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Street_query</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">paste0</span><span class=\"p\">(</span><span class=\"n\">Street_query</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"+Bratislava\"</span><span class=\"p\">)]</span></code></pre></figure>\n\n<p>Let’s get all streets coordinates of Bratislava just by one (powerful) command, again using OSM API:</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">ba_bb</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">getbb</span><span class=\"p\">(</span><span class=\"n\">place_name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Bratislava\"</span><span class=\"p\">)</span><span class=\"w\">\n \n</span><span class=\"n\">bratislava</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">opq</span><span class=\"p\">(</span><span class=\"n\">bbox</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ba_bb</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">%&gt;%</span><span class=\"w\">\n  </span><span class=\"n\">add_osm_feature</span><span class=\"p\">(</span><span class=\"n\">key</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s1\">'highway'</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">%&gt;%</span><span class=\"w\">\n  </span><span class=\"n\">osmdata_sf</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"o\">%&gt;%</span><span class=\"w\">\n  </span><span class=\"n\">osm_poly2line</span><span class=\"p\">()</span></code></pre></figure>\n\n<p>Let’s plot it:</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">ggplot</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bratislava</span><span class=\"o\">$</span><span class=\"n\">osm_lines</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">geom_sf</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">theme_bw</span><span class=\"p\">()</span></code></pre></figure>\n\n<p><img src=\"/images/post_12/unnamed-chunk-17-1.png\" alt=\"plot of chunk unnamed-chunk-17\" /></p>\n\n<p>Pretty nice web.</p>\n\n<p>Now, we need to handle again street names downloaded from OSM. I will extract only available streets from violation data:</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">street_names</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">data.table</span><span class=\"p\">(</span><span class=\"n\">Street</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">unique</span><span class=\"p\">(</span><span class=\"n\">bratislava</span><span class=\"o\">$</span><span class=\"n\">osm_lines</span><span class=\"o\">$</span><span class=\"n\">name</span><span class=\"p\">))</span><span class=\"w\">\n \n</span><span class=\"n\">street_names</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">gsub</span><span class=\"p\">(</span><span class=\"n\">pattern</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Ãƒ\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">replacement</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"i\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Street</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">street_names</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">gsub</span><span class=\"p\">(</span><span class=\"n\">pattern</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"iÂ©\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">replacement</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"e\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">street_names</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">gsub</span><span class=\"p\">(</span><span class=\"n\">pattern</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"iÂ¡\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">replacement</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"a\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">street_names</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">gsub</span><span class=\"p\">(</span><span class=\"n\">pattern</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"iÂº\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">replacement</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"u\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">street_names</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">gsub</span><span class=\"p\">(</span><span class=\"n\">pattern</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Ã…Â¾\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">replacement</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"z\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">street_names</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">gsub</span><span class=\"p\">(</span><span class=\"n\">pattern</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Ã„Â¾\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">replacement</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"l\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">street_names</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">gsub</span><span class=\"p\">(</span><span class=\"n\">pattern</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Ã„\\u008d\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">replacement</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"c\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">street_names</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">gsub</span><span class=\"p\">(</span><span class=\"n\">pattern</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Ã…Â¡\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">replacement</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"s\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">street_names</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">gsub</span><span class=\"p\">(</span><span class=\"n\">pattern</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Ã„Â½\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">replacement</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"L\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">street_names</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">gsub</span><span class=\"p\">(</span><span class=\"n\">pattern</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Ã…Ë†\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">replacement</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"n\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">street_names</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">gsub</span><span class=\"p\">(</span><span class=\"n\">pattern</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"iÂ½\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">replacement</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"y\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">street_names</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">gsub</span><span class=\"p\">(</span><span class=\"n\">pattern</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Ã…â€¢\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">replacement</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"r\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">street_names</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">gsub</span><span class=\"p\">(</span><span class=\"n\">pattern</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"iÂ³\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">replacement</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"o\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">street_names</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">gsub</span><span class=\"p\">(</span><span class=\"n\">pattern</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"iÂ¤\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">replacement</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"a\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">street_names</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">gsub</span><span class=\"p\">(</span><span class=\"n\">pattern</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Ã…Â½\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">replacement</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Z\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">street_names</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">gsub</span><span class=\"p\">(</span><span class=\"n\">pattern</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Ã… \"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">replacement</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"S\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">street_names</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">gsub</span><span class=\"p\">(</span><span class=\"n\">pattern</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Ã…Â¥\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">replacement</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"t\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">street_names</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">gsub</span><span class=\"p\">(</span><span class=\"n\">pattern</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Ã„Å’\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">replacement</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"C\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">street_names</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">gsub</span><span class=\"p\">(</span><span class=\"n\">pattern</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Ã„\\u008f\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">replacement</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"d\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">street_names</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">gsub</span><span class=\"p\">(</span><span class=\"n\">pattern</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"iÂ¶\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">replacement</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"o\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">street_names</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">gsub</span><span class=\"p\">(</span><span class=\"n\">pattern</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Ã…â€˜\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">replacement</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"o\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">street_names</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">gsub</span><span class=\"p\">(</span><span class=\"n\">pattern</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Ã„â€º\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">replacement</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"e\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">street_names</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">gsub</span><span class=\"p\">(</span><span class=\"n\">pattern</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Ã„â€º\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">replacement</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"e\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"p\">)]</span><span class=\"w\">\n \n</span><span class=\"n\">street_names</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">stri_trans_general</span><span class=\"p\">(</span><span class=\"n\">Street_edit</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"Latin-ASCII\"</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">street_names</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">gsub</span><span class=\"p\">(</span><span class=\"n\">pattern</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"i-\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">replacement</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"i\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">street_names</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">gsub</span><span class=\"p\">(</span><span class=\"n\">pattern</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"A \"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">replacement</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"S\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"p\">)]</span><span class=\"w\">\n \n</span><span class=\"n\">street_names</span><span class=\"p\">[</span><span class=\"n\">dt_uni_streets</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Street_edit</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">street_names_vio</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">copy</span><span class=\"p\">(</span><span class=\"n\">street_names</span><span class=\"p\">[</span><span class=\"n\">dt_uni_streets</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Street_edit</span><span class=\"p\">),</span><span class=\"w\">\n                                      </span><span class=\"n\">Street_orig</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">i.Street</span><span class=\"p\">])[</span><span class=\"o\">!</span><span class=\"nf\">is.na</span><span class=\"p\">(</span><span class=\"n\">Street_orig</span><span class=\"p\">)]</span></code></pre></figure>\n\n<p>We lost some street data from the dataset by not exact matched street names.</p>\n\n<p>Let’s subset the street data.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">ba_streets_vio</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">bratislava</span><span class=\"o\">$</span><span class=\"n\">osm_lines</span><span class=\"w\">\n</span><span class=\"n\">ba_streets_vio</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">ba_streets_vio</span><span class=\"p\">[</span><span class=\"n\">ba_streets_vio</span><span class=\"o\">$</span><span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">%in%</span><span class=\"w\"> </span><span class=\"n\">street_names_vio</span><span class=\"o\">$</span><span class=\"n\">Street</span><span class=\"p\">,]</span><span class=\"w\">\n</span><span class=\"n\">ba_streets_vio</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">ba_streets_vio</span><span class=\"p\">[</span><span class=\"o\">!</span><span class=\"nf\">is.na</span><span class=\"p\">(</span><span class=\"n\">ba_streets_vio</span><span class=\"o\">$</span><span class=\"n\">name</span><span class=\"p\">),]</span></code></pre></figure>\n\n<p>Now, I will transform data to standard lon/lat matrix (<code class=\"language-plaintext highlighter-rouge\">data.table</code> class) format instead of <code class=\"language-plaintext highlighter-rouge\">sf</code> object (I highly recommend this for next <code class=\"language-plaintext highlighter-rouge\">ggplot</code> usage).</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">data_streets_st</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">data.table</span><span class=\"o\">::</span><span class=\"n\">data.table</span><span class=\"p\">(</span><span class=\"n\">sf</span><span class=\"o\">::</span><span class=\"n\">st_coordinates</span><span class=\"p\">(</span><span class=\"n\">ba_streets_vio</span><span class=\"o\">$</span><span class=\"n\">geometry</span><span class=\"p\">))</span></code></pre></figure>\n\n<p>Next, I will bound streets by existing polygons of Bratislava and add merging column - Street_edit:</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">ba_streets_vio</span><span class=\"o\">$</span><span class=\"n\">L1</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"o\">:</span><span class=\"n\">nrow</span><span class=\"p\">(</span><span class=\"n\">ba_streets_vio</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"n\">data_streets_st</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">merge</span><span class=\"p\">(</span><span class=\"n\">data_streets_st</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">as.data.table</span><span class=\"p\">(</span><span class=\"n\">ba_streets_vio</span><span class=\"p\">)[,</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">L1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"p\">)],</span><span class=\"w\">\n                         </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"L1\"</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"n\">data_streets_st</span><span class=\"p\">[</span><span class=\"n\">street_names_vio</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"p\">)],</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">),</span><span class=\"w\">\n                </span><span class=\"n\">Street_edit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">i.Street_edit</span><span class=\"p\">]</span><span class=\"w\">\n</span><span class=\"n\">setnames</span><span class=\"p\">(</span><span class=\"n\">data_streets_st</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"s2\">\"X\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"Y\"</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"s2\">\"lon\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"lat\"</span><span class=\"p\">))</span><span class=\"w\">\n</span><span class=\"n\">data_streets_st</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">data_streets_st</span><span class=\"p\">[</span><span class=\"o\">!</span><span class=\"n\">lon</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">data_poly_ba</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"nf\">max</span><span class=\"p\">(</span><span class=\"n\">lon</span><span class=\"p\">)]]</span><span class=\"w\">\n</span><span class=\"n\">data_streets_st</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">data_streets_st</span><span class=\"p\">[</span><span class=\"o\">!</span><span class=\"n\">lon</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">data_poly_ba</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"nf\">min</span><span class=\"p\">(</span><span class=\"n\">lon</span><span class=\"p\">)]]</span><span class=\"w\">\n</span><span class=\"n\">data_streets_st</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">data_streets_st</span><span class=\"p\">[</span><span class=\"o\">!</span><span class=\"n\">lat</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">data_poly_ba</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"nf\">max</span><span class=\"p\">(</span><span class=\"n\">lat</span><span class=\"p\">)]]</span></code></pre></figure>\n\n<p>Let’s also aggregate violation data by street names and Year + Month (<em>Year_M</em>):</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">data_violation_agg_street</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">copy</span><span class=\"p\">(</span><span class=\"n\">data_violation</span><span class=\"p\">[</span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"m\">4836</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"m\">5000</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"m\">4834</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"m\">4700</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"m\">4838</span><span class=\"p\">,</span><span class=\"w\">\n                                                    </span><span class=\"m\">4828</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"m\">4839</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"m\">4813</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"m\">9803</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"m\">4840</span><span class=\"p\">,</span><span class=\"w\">\n                                                    </span><span class=\"m\">4841</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"m\">9809</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"m\">3000</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"m\">9806</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"m\">4900</span><span class=\"p\">)),</span><span class=\"w\">\n                                                 </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Group_vio_ID</span><span class=\"p\">),</span><span class=\"w\">\n                                                 </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.N</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Street</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Year_M</span><span class=\"p\">)])</span><span class=\"w\">\n \n</span><span class=\"n\">setorder</span><span class=\"p\">(</span><span class=\"n\">data_violation_agg_street</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Year_M</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">N</span><span class=\"p\">)</span></code></pre></figure>\n\n<p>Let’s add look-up column <em>Street_edit</em> to aggregated data and merge spatial street data with violation data.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">data_violation_agg_street</span><span class=\"p\">[</span><span class=\"n\">dt_uni_streets</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Street</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">i.Street_edit</span><span class=\"p\">]</span><span class=\"w\">\n \n</span><span class=\"n\">data_streets_st</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">merge</span><span class=\"p\">(</span><span class=\"n\">data_streets_st</span><span class=\"p\">,</span><span class=\"w\">\n                         </span><span class=\"n\">data_violation_agg_street</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Street_edit</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">N_violations</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Year_M</span><span class=\"p\">)],</span><span class=\"w\">\n                         </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Street_edit\"</span><span class=\"p\">,</span><span class=\"w\">\n                         </span><span class=\"n\">all.y</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">T</span><span class=\"p\">,</span><span class=\"w\">\n                         </span><span class=\"n\">allow.cartesian</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">TRUE</span><span class=\"p\">)</span></code></pre></figure>\n\n<p>Now, I will transform integers of the number of violations to reasonable factors segments:</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">data_streets_st</span><span class=\"p\">[</span><span class=\"n\">N_violations</span><span class=\"w\"> </span><span class=\"o\">&gt;=</span><span class=\"w\"> </span><span class=\"m\">11</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">N_violation_type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"&gt; 11\"</span><span class=\"p\">]</span><span class=\"w\">\n</span><span class=\"n\">data_streets_st</span><span class=\"p\">[</span><span class=\"n\">N_violations</span><span class=\"w\"> </span><span class=\"o\">&gt;=</span><span class=\"w\"> </span><span class=\"m\">6</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"n\">N_violations</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"m\">11</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">N_violation_type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"(6, 10)\"</span><span class=\"p\">]</span><span class=\"w\">\n</span><span class=\"n\">data_streets_st</span><span class=\"p\">[</span><span class=\"n\">N_violations</span><span class=\"w\"> </span><span class=\"o\">&gt;=</span><span class=\"w\"> </span><span class=\"m\">3</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"w\"> </span><span class=\"n\">N_violations</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"m\">6</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">N_violation_type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"(3, 5)\"</span><span class=\"p\">]</span><span class=\"w\">\n</span><span class=\"n\">data_streets_st</span><span class=\"p\">[</span><span class=\"n\">N_violations</span><span class=\"w\"> </span><span class=\"o\">&lt;=</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">N_violation_type</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"&lt; 2\"</span><span class=\"p\">]</span><span class=\"w\">\n</span><span class=\"n\">data_streets_st</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">N_violations_per_street</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">factor</span><span class=\"p\">(</span><span class=\"n\">N_violation_type</span><span class=\"p\">,</span><span class=\"w\">\n                                                    </span><span class=\"n\">levels</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"s2\">\"&lt; 2\"</span><span class=\"p\">,</span><span class=\"w\">  </span><span class=\"s2\">\"(3, 5)\"</span><span class=\"p\">,</span><span class=\"w\">\n                                                               </span><span class=\"s2\">\"(6, 10)\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"&gt; 11\"</span><span class=\"p\">))]</span></code></pre></figure>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">levels</span><span class=\"p\">(</span><span class=\"n\">data_streets_st</span><span class=\"o\">$</span><span class=\"n\">N_violations_per_street</span><span class=\"p\">)</span></code></pre></figure>\n\n<figure class=\"highlight\"><pre><code class=\"language-text\" data-lang=\"text\">## [1] \"&lt; 2\"     \"(3, 5)\"  \"(6, 10)\" \"&gt; 11\"</code></pre></figure>\n\n<p>Let’s see what we extracted so far for streets in one example year-month…</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">ggplot</span><span class=\"p\">(</span><span class=\"n\">data_streets_st</span><span class=\"p\">[</span><span class=\"o\">!</span><span class=\"nf\">is.na</span><span class=\"p\">(</span><span class=\"n\">L1</span><span class=\"p\">)][</span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"m\">2019.06</span><span class=\"p\">),</span><span class=\"w\">\n                                   </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Year_M</span><span class=\"p\">)])</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">geom_line</span><span class=\"p\">(</span><span class=\"n\">aes</span><span class=\"p\">(</span><span class=\"n\">lon</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lat</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">group</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">L1</span><span class=\"p\">,</span><span class=\"w\">\n                </span><span class=\"n\">color</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">N_violations_per_street</span><span class=\"p\">),</span><span class=\"w\">\n            </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">1.4</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">scale_color_brewer</span><span class=\"p\">(</span><span class=\"n\">palette</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Reds\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">theme_bw</span><span class=\"p\">()</span></code></pre></figure>\n\n<p><img src=\"/images/post_12/unnamed-chunk-26-1.png\" alt=\"plot of chunk unnamed-chunk-26\" /></p>\n\n<h2 id=\"ggmap\">ggmap</h2>\n\n<p>Since, we will use <code class=\"language-plaintext highlighter-rouge\">ggmap</code> for visualizations, we need to extract map image of Bratislava:</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">bbox</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">make_bbox</span><span class=\"p\">(</span><span class=\"n\">lon</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lat</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">data_poly_ba</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">.01</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"c1\"># used our polygons</span><span class=\"w\">\n</span><span class=\"n\">map_ba</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">get_map</span><span class=\"p\">(</span><span class=\"n\">location</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bbox</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">source</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s1\">'stamen'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">maptype</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"watercolor\"</span><span class=\"p\">)</span></code></pre></figure>\n\n<p>Now, let’s make it altogether to one visualization - so violations by city districts and also streets for one time-stamp (<em>Year_M</em>).</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">ggmap</span><span class=\"p\">(</span><span class=\"n\">map_ba</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">extent</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"device\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">geom_polygon</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">data_places</span><span class=\"p\">[</span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"m\">2019.06</span><span class=\"p\">),</span><span class=\"w\">\n                                  </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Year_M</span><span class=\"p\">)],</span><span class=\"w\">\n               </span><span class=\"n\">aes</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lon</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lat</span><span class=\"p\">,</span><span class=\"w\">\n                   </span><span class=\"n\">fill</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">N_violation</span><span class=\"p\">,</span><span class=\"w\">\n                   </span><span class=\"n\">group</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Place</span><span class=\"p\">),</span><span class=\"w\">\n               </span><span class=\"n\">color</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"grey40\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">scale_fill_material</span><span class=\"p\">(</span><span class=\"s2\">\"grey\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0.75</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">geom_line</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">data_streets_st</span><span class=\"p\">[</span><span class=\"o\">!</span><span class=\"nf\">is.na</span><span class=\"p\">(</span><span class=\"n\">L1</span><span class=\"p\">)][</span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"m\">2019.06</span><span class=\"p\">),</span><span class=\"w\">\n                                               </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Year_M</span><span class=\"p\">)],</span><span class=\"w\">\n            </span><span class=\"n\">aes</span><span class=\"p\">(</span><span class=\"n\">lon</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lat</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">group</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">L1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">color</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">N_violations_per_street</span><span class=\"p\">),</span><span class=\"w\">\n            </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">1.4</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">scale_color_brewer</span><span class=\"p\">(</span><span class=\"n\">palette</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Reds\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">geom_label</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">data_poly_ba_mean_place</span><span class=\"p\">,</span><span class=\"w\">\n             </span><span class=\"n\">aes</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lon</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lat</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">label</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Place</span><span class=\"p\">,</span><span class=\"w\">\n                 </span><span class=\"n\">fill</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">NA_real_</span><span class=\"p\">),</span><span class=\"w\">\n             </span><span class=\"n\">color</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"black\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">fill</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"dodgerblue1\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0.75</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">labs</span><span class=\"p\">(</span><span class=\"n\">fill</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"N_vio_district\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">color</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"N_vio_street\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">guides</span><span class=\"p\">(</span><span class=\"n\">color</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">guide_legend</span><span class=\"p\">(</span><span class=\"n\">override.aes</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nf\">list</span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"p\">)))</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">theme_void</span><span class=\"p\">()</span></code></pre></figure>\n\n<p><img src=\"/images/post_12/unnamed-chunk-28-1.png\" alt=\"plot of chunk unnamed-chunk-28\" /></p>\n\n<p>I will also extract the most violated streets by Year+Month for labeling purposes.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">data_streets_st_max</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">copy</span><span class=\"p\">(</span><span class=\"n\">data_streets_st</span><span class=\"p\">[</span><span class=\"o\">!</span><span class=\"nf\">is.na</span><span class=\"p\">(</span><span class=\"n\">L1</span><span class=\"p\">),</span><span class=\"w\">\n                                            </span><span class=\"n\">.SD</span><span class=\"p\">[</span><span class=\"n\">N_violations</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"nf\">max</span><span class=\"p\">(</span><span class=\"n\">N_violations</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">na.rm</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">T</span><span class=\"p\">)],</span><span class=\"w\">\n                                            </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Year_M</span><span class=\"p\">)])</span><span class=\"w\">\n \n</span><span class=\"n\">data_streets_st_max</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">unique</span><span class=\"p\">(</span><span class=\"n\">Street_edit</span><span class=\"p\">)]</span><span class=\"w\"> </span><span class=\"c1\"># the unique month \"winners\"</span><span class=\"w\">\n</span><span class=\"n\">data_streets_st_max</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">copy</span><span class=\"p\">(</span><span class=\"n\">data_streets_st_max</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">lon</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">mean</span><span class=\"p\">(</span><span class=\"n\">lon</span><span class=\"p\">),</span><span class=\"w\">\n                                                    </span><span class=\"n\">lat</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">mean</span><span class=\"p\">(</span><span class=\"n\">lat</span><span class=\"p\">),</span><span class=\"w\">\n                                                    </span><span class=\"n\">Street_edit</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">first</span><span class=\"p\">(</span><span class=\"n\">Street_edit</span><span class=\"p\">),</span><span class=\"w\">\n                                                    </span><span class=\"n\">N_violations</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">first</span><span class=\"p\">(</span><span class=\"n\">N_violations</span><span class=\"p\">),</span><span class=\"w\">\n                                                    </span><span class=\"n\">N_violations_per_street</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> \n                                                      </span><span class=\"n\">first</span><span class=\"p\">(</span><span class=\"n\">N_violations_per_street</span><span class=\"p\">)</span><span class=\"w\">\n                                                    </span><span class=\"p\">),</span><span class=\"w\">\n                                                </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Year_M</span><span class=\"p\">)])</span></code></pre></figure>\n\n<p>As we noticed so far, the most violated city district is Old-town, so I will create also zoomed visualization for this city district like this (using <code class=\"language-plaintext highlighter-rouge\">coord_map</code> function):</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">ggmap</span><span class=\"p\">(</span><span class=\"n\">map_ba</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">geom_polygon</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">data_places</span><span class=\"p\">[</span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"m\">2019.06</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Year_M</span><span class=\"p\">)],</span><span class=\"w\">\n               </span><span class=\"n\">aes</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lon</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lat</span><span class=\"p\">,</span><span class=\"w\">\n                   </span><span class=\"n\">fill</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">N_violation</span><span class=\"p\">,</span><span class=\"w\">\n                   </span><span class=\"n\">group</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Place</span><span class=\"w\">\n               </span><span class=\"p\">),</span><span class=\"w\">\n               </span><span class=\"n\">color</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"grey40\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">scale_fill_material</span><span class=\"p\">(</span><span class=\"s2\">\"grey\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0.75</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">geom_line</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">data_streets_st</span><span class=\"p\">[</span><span class=\"o\">!</span><span class=\"nf\">is.na</span><span class=\"p\">(</span><span class=\"n\">L1</span><span class=\"p\">)][</span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"m\">2019.06</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Year_M</span><span class=\"p\">)],</span><span class=\"w\">\n            </span><span class=\"n\">aes</span><span class=\"p\">(</span><span class=\"n\">lon</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lat</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">group</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">L1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">color</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">N_violations_per_street</span><span class=\"p\">),</span><span class=\"w\">\n            </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">1.4</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">geom_label</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">data_streets_st_max</span><span class=\"p\">[</span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"m\">2019.06</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Year_M</span><span class=\"p\">)],</span><span class=\"w\">\n             </span><span class=\"n\">aes</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lon</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lat</span><span class=\"p\">,</span><span class=\"w\">\n                 </span><span class=\"n\">label</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">paste0</span><span class=\"p\">(</span><span class=\"n\">Street_edit</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\" - \"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">N_violations</span><span class=\"p\">)</span><span class=\"w\">\n             </span><span class=\"p\">),</span><span class=\"w\">\n             </span><span class=\"n\">color</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"black\"</span><span class=\"p\">,</span><span class=\"w\">\n             </span><span class=\"n\">fill</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"firebrick2\"</span><span class=\"p\">,</span><span class=\"w\">\n             </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">4.5</span><span class=\"p\">,</span><span class=\"w\">\n             </span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0.75</span><span class=\"w\">\n  </span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">scale_color_brewer</span><span class=\"p\">(</span><span class=\"n\">palette</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Reds\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">geom_label</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">data_poly_ba_mean_place</span><span class=\"p\">,</span><span class=\"w\">\n             </span><span class=\"n\">aes</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lon</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lat</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">label</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Place</span><span class=\"p\">,</span><span class=\"w\">\n                 </span><span class=\"n\">fill</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">NA_real_</span><span class=\"p\">),</span><span class=\"w\">\n             </span><span class=\"n\">color</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"black\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">fill</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"dodgerblue1\"</span><span class=\"p\">,</span><span class=\"w\">\n             </span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0.75</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">4.5</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">coord_map</span><span class=\"p\">(</span><span class=\"w\">\n    </span><span class=\"n\">xlim</span><span class=\"o\">=</span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"n\">data_poly_ba</span><span class=\"p\">[</span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"s2\">\"Stare Mesto\"</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Place</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nf\">min</span><span class=\"p\">(</span><span class=\"n\">lon</span><span class=\"p\">)],</span><span class=\"w\">\n           </span><span class=\"n\">data_poly_ba</span><span class=\"p\">[</span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"s2\">\"Stare Mesto\"</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Place</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nf\">max</span><span class=\"p\">(</span><span class=\"n\">lon</span><span class=\"p\">)]),</span><span class=\"w\">\n    </span><span class=\"n\">ylim</span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"n\">data_poly_ba</span><span class=\"p\">[</span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"s2\">\"Stare Mesto\"</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Place</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nf\">min</span><span class=\"p\">(</span><span class=\"n\">lat</span><span class=\"p\">)],</span><span class=\"w\">\n            </span><span class=\"n\">data_poly_ba</span><span class=\"p\">[</span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"s2\">\"Stare Mesto\"</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Place</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nf\">max</span><span class=\"p\">(</span><span class=\"n\">lat</span><span class=\"p\">)])</span><span class=\"w\">\n  </span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">labs</span><span class=\"p\">(</span><span class=\"n\">fill</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"N_vio_district\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">color</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"N_vio_street\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">guides</span><span class=\"p\">(</span><span class=\"n\">color</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">guide_legend</span><span class=\"p\">(</span><span class=\"n\">ncol</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">override.aes</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nf\">list</span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"p\">),</span><span class=\"w\">\n                              </span><span class=\"n\">title.position</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"top\"</span><span class=\"p\">),</span><span class=\"w\">\n         </span><span class=\"n\">fill</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">guide_legend</span><span class=\"p\">(</span><span class=\"n\">nrow</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">title.position</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"top\"</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">theme_bw</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">theme</span><span class=\"p\">(</span><span class=\"n\">axis.text</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">element_blank</span><span class=\"p\">(),</span><span class=\"w\">\n        </span><span class=\"n\">axis.line</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">element_blank</span><span class=\"p\">(),</span><span class=\"w\">\n        </span><span class=\"n\">axis.title</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">element_blank</span><span class=\"p\">(),</span><span class=\"w\">\n        </span><span class=\"n\">axis.ticks</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">element_blank</span><span class=\"p\">(),</span><span class=\"w\">\n        </span><span class=\"n\">legend.text</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">element_text</span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">13</span><span class=\"p\">),</span><span class=\"w\">\n        </span><span class=\"n\">legend.title</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">element_text</span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">14</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">face</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"bold\"</span><span class=\"p\">),</span><span class=\"w\">\n        </span><span class=\"n\">legend.background</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">element_rect</span><span class=\"p\">(</span><span class=\"n\">fill</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"white\"</span><span class=\"p\">),</span><span class=\"w\">\n        </span><span class=\"n\">legend.key</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">element_rect</span><span class=\"p\">(</span><span class=\"n\">fill</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"white\"</span><span class=\"p\">),</span><span class=\"w\">\n        </span><span class=\"n\">legend.position</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"bottom\"</span><span class=\"p\">)</span></code></pre></figure>\n\n<p><img src=\"/images/post_12/unnamed-chunk-30-1.png\" alt=\"plot of chunk unnamed-chunk-30\" /></p>\n\n<h2 id=\"using-ggnanimate\">Using ggnanimate</h2>\n\n<p>We have all prepared to create some interesting animated map.\nFor this purpose, I will use the <code class=\"language-plaintext highlighter-rouge\">gganimate</code> package that simply uses the <code class=\"language-plaintext highlighter-rouge\">transition_states</code> function that combines our previously prepared <code class=\"language-plaintext highlighter-rouge\">ggplot2</code> and <code class=\"language-plaintext highlighter-rouge\">ggmap</code> plot and time feature <em>Year_M</em>.\nLet’s firstly animate the whole city picture.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">gg_ba_anim_lines</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">ggmap</span><span class=\"p\">(</span><span class=\"n\">map_ba</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">extent</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"device\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">geom_polygon</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">data_places</span><span class=\"p\">,</span><span class=\"w\">\n               </span><span class=\"n\">aes</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lon</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lat</span><span class=\"p\">,</span><span class=\"w\">\n                   </span><span class=\"n\">fill</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">N_violation</span><span class=\"p\">,</span><span class=\"w\">\n                   </span><span class=\"n\">group</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Place</span><span class=\"p\">),</span><span class=\"w\">\n               </span><span class=\"n\">color</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"grey40\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">scale_fill_material</span><span class=\"p\">(</span><span class=\"s2\">\"grey\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0.7</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">geom_line</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">data_streets_st</span><span class=\"p\">[</span><span class=\"o\">!</span><span class=\"nf\">is.na</span><span class=\"p\">(</span><span class=\"n\">L1</span><span class=\"p\">)],</span><span class=\"w\">\n            </span><span class=\"n\">aes</span><span class=\"p\">(</span><span class=\"n\">lon</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lat</span><span class=\"p\">,</span><span class=\"w\">\n                </span><span class=\"n\">group</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">L1</span><span class=\"p\">,</span><span class=\"w\">\n                </span><span class=\"n\">color</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">N_violations_per_street</span><span class=\"w\">\n            </span><span class=\"p\">),</span><span class=\"w\">\n            </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">1.4</span><span class=\"w\">\n  </span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">scale_color_brewer</span><span class=\"p\">(</span><span class=\"n\">palette</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Reds\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">labs</span><span class=\"p\">(</span><span class=\"n\">fill</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"N_vio_district\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">color</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"N_vio_street\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">geom_label</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">data_poly_ba_mean_place</span><span class=\"p\">,</span><span class=\"w\">\n             </span><span class=\"n\">aes</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lon</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lat</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">label</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Place</span><span class=\"p\">,</span><span class=\"w\">\n                 </span><span class=\"n\">fill</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">NA_real_</span><span class=\"p\">),</span><span class=\"w\">\n             </span><span class=\"n\">color</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"black\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">fill</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"dodgerblue1\"</span><span class=\"p\">,</span><span class=\"w\">\n             </span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0.75</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">4.5</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">transition_states</span><span class=\"p\">(</span><span class=\"n\">reorder</span><span class=\"p\">(</span><span class=\"n\">Year_M</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Year_M</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">transition_length</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"p\">,</span><span class=\"w\">\n                    </span><span class=\"n\">state_length</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">labs</span><span class=\"p\">(</span><span class=\"n\">title</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Year.Month - {closest_state}\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">guides</span><span class=\"p\">(</span><span class=\"n\">color</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">FALSE</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">fill</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">FALSE</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">theme_void</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">theme</span><span class=\"p\">(</span><span class=\"n\">plot.title</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">element_text</span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">16</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">face</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"bold\"</span><span class=\"p\">)</span><span class=\"w\">\n  </span><span class=\"p\">)</span><span class=\"w\">\n \n</span><span class=\"c1\"># save animation to object</span><span class=\"w\">\n</span><span class=\"n\">anim_whole</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">animate</span><span class=\"p\">(</span><span class=\"n\">gg_ba_anim_lines</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">duration</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">46</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">width</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">700</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">height</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">750</span><span class=\"p\">)</span></code></pre></figure>\n\n<p>Then, let’s animate zoomed map of Old-town district.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">gg_ba_anim_lines_zoom</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">ggmap</span><span class=\"p\">(</span><span class=\"n\">map_ba</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">extent</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"device\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">geom_polygon</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">data_places</span><span class=\"p\">,</span><span class=\"w\">\n               </span><span class=\"n\">aes</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lon</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lat</span><span class=\"p\">,</span><span class=\"w\">\n                   </span><span class=\"n\">fill</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">N_violation</span><span class=\"p\">,</span><span class=\"w\">\n                   </span><span class=\"n\">group</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Place</span><span class=\"p\">),</span><span class=\"w\">\n               </span><span class=\"n\">color</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"grey40\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">scale_fill_material</span><span class=\"p\">(</span><span class=\"s2\">\"grey\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0.7</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">geom_line</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">data_streets_st</span><span class=\"p\">[</span><span class=\"o\">!</span><span class=\"nf\">is.na</span><span class=\"p\">(</span><span class=\"n\">L1</span><span class=\"p\">)],</span><span class=\"w\">\n            </span><span class=\"n\">aes</span><span class=\"p\">(</span><span class=\"n\">lon</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lat</span><span class=\"p\">,</span><span class=\"w\">\n                </span><span class=\"n\">group</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">L1</span><span class=\"p\">,</span><span class=\"w\">\n                </span><span class=\"n\">color</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">N_violations_per_street</span><span class=\"w\">\n            </span><span class=\"p\">),</span><span class=\"w\">\n            </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">1.4</span><span class=\"w\">\n  </span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">scale_color_brewer</span><span class=\"p\">(</span><span class=\"n\">palette</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Reds\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">geom_label</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">data_streets_st_max</span><span class=\"p\">,</span><span class=\"w\">\n             </span><span class=\"n\">aes</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lon</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lat</span><span class=\"p\">,</span><span class=\"w\">\n                 </span><span class=\"n\">label</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">paste0</span><span class=\"p\">(</span><span class=\"n\">Street_edit</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\" - \"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">N_violations</span><span class=\"p\">)</span><span class=\"w\">\n             </span><span class=\"p\">),</span><span class=\"w\">\n             </span><span class=\"n\">color</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"black\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">fill</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"firebrick2\"</span><span class=\"p\">,</span><span class=\"w\">\n             </span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0.75</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">4.5</span><span class=\"w\">\n  </span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">geom_label</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">data_poly_ba_mean_place</span><span class=\"p\">,</span><span class=\"w\">\n             </span><span class=\"n\">aes</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lon</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lat</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">label</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Place</span><span class=\"p\">,</span><span class=\"w\">\n                 </span><span class=\"n\">fill</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">NA_real_</span><span class=\"p\">),</span><span class=\"w\">\n             </span><span class=\"n\">color</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"black\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">fill</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"dodgerblue1\"</span><span class=\"p\">,</span><span class=\"w\">\n             </span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0.75</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">4.5</span><span class=\"w\">\n  </span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">coord_map</span><span class=\"p\">(</span><span class=\"w\">\n    </span><span class=\"n\">xlim</span><span class=\"o\">=</span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"n\">data_poly_ba</span><span class=\"p\">[</span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"s2\">\"Stare Mesto\"</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Place</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nf\">min</span><span class=\"p\">(</span><span class=\"n\">lon</span><span class=\"p\">)],</span><span class=\"w\">\n           </span><span class=\"n\">data_poly_ba</span><span class=\"p\">[</span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"s2\">\"Stare Mesto\"</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Place</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nf\">max</span><span class=\"p\">(</span><span class=\"n\">lon</span><span class=\"p\">)]),</span><span class=\"w\">\n    </span><span class=\"n\">ylim</span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"n\">data_poly_ba</span><span class=\"p\">[</span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"s2\">\"Stare Mesto\"</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Place</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nf\">min</span><span class=\"p\">(</span><span class=\"n\">lat</span><span class=\"p\">)],</span><span class=\"w\">\n            </span><span class=\"n\">data_poly_ba</span><span class=\"p\">[</span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"s2\">\"Stare Mesto\"</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Place</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nf\">max</span><span class=\"p\">(</span><span class=\"n\">lat</span><span class=\"p\">)])</span><span class=\"w\">\n  </span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">transition_states</span><span class=\"p\">(</span><span class=\"n\">reorder</span><span class=\"p\">(</span><span class=\"n\">Year_M</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Year_M</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">transition_length</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"p\">,</span><span class=\"w\">\n                    </span><span class=\"n\">state_length</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">labs</span><span class=\"p\">(</span><span class=\"n\">fill</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"N_vio_district\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">color</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"N_vio_street\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">guides</span><span class=\"p\">(</span><span class=\"n\">color</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">guide_legend</span><span class=\"p\">(</span><span class=\"n\">ncol</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">override.aes</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nf\">list</span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"p\">),</span><span class=\"w\">\n                              </span><span class=\"n\">title.position</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"top\"</span><span class=\"p\">),</span><span class=\"w\">\n         </span><span class=\"n\">fill</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">guide_legend</span><span class=\"p\">(</span><span class=\"n\">nrow</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">title.position</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"top\"</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">theme_bw</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">theme</span><span class=\"p\">(</span><span class=\"n\">axis.text</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">element_blank</span><span class=\"p\">(),</span><span class=\"w\">\n        </span><span class=\"n\">axis.line</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">element_blank</span><span class=\"p\">(),</span><span class=\"w\">\n        </span><span class=\"n\">axis.title</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">element_blank</span><span class=\"p\">(),</span><span class=\"w\">\n        </span><span class=\"n\">axis.ticks</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">element_blank</span><span class=\"p\">(),</span><span class=\"w\">\n        </span><span class=\"n\">legend.text</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">element_text</span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">13</span><span class=\"p\">),</span><span class=\"w\">\n        </span><span class=\"n\">legend.title</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">element_text</span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">14</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">face</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"bold\"</span><span class=\"p\">),</span><span class=\"w\">\n        </span><span class=\"n\">legend.background</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">element_rect</span><span class=\"p\">(</span><span class=\"n\">fill</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"white\"</span><span class=\"p\">),</span><span class=\"w\">\n        </span><span class=\"n\">legend.key</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">element_rect</span><span class=\"p\">(</span><span class=\"n\">fill</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"white\"</span><span class=\"p\">),</span><span class=\"w\">\n        </span><span class=\"n\">legend.position</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"bottom\"</span><span class=\"p\">)</span><span class=\"w\">\n \n</span><span class=\"c1\"># save animation to object</span><span class=\"w\">\n</span><span class=\"n\">anim_zoom</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">animate</span><span class=\"p\">(</span><span class=\"n\">gg_ba_anim_lines_zoom</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">duration</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">46</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">width</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">700</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">height</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">750</span><span class=\"p\">)</span></code></pre></figure>\n\n<h2 id=\"gifs-binding-with-magick-package\">GIFS binding with magick package</h2>\n\n<p>Now, we have to bind these two animations into one GIF. I will do it by functions from the <code class=\"language-plaintext highlighter-rouge\">magick</code> package.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">a_mgif</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">image_read</span><span class=\"p\">(</span><span class=\"n\">anim_whole</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"n\">b_mgif</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">image_read</span><span class=\"p\">(</span><span class=\"n\">anim_zoom</span><span class=\"p\">)</span><span class=\"w\">\n \n</span><span class=\"n\">new_gif</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">image_append</span><span class=\"p\">(</span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"n\">a_mgif</span><span class=\"p\">[</span><span class=\"m\">1</span><span class=\"p\">],</span><span class=\"w\">\n                          </span><span class=\"n\">b_mgif</span><span class=\"p\">[</span><span class=\"m\">1</span><span class=\"p\">]))</span><span class=\"w\">\n \n</span><span class=\"k\">for</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"o\">:</span><span class=\"m\">100</span><span class=\"p\">){</span><span class=\"w\">\n  </span><span class=\"n\">combined</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">image_append</span><span class=\"p\">(</span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"n\">a_mgif</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">],</span><span class=\"w\">\n                             </span><span class=\"n\">b_mgif</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">]))</span><span class=\"w\">\n  </span><span class=\"n\">new_gif</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"n\">new_gif</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">combined</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"p\">}</span><span class=\"w\">\n \n</span><span class=\"c1\"># final!</span><span class=\"w\">\n</span><span class=\"n\">new_gif</span></code></pre></figure>\n\n<p>Voilaaa:</p>\n\n<p><img src=\"/images/post_12/gif_ba_streets.gif\" alt=\"\" /></p>\n\n<p>For full resolution - right click on the gif and click on the view image option.</p>\n\n<p>We can see that at the end of the observed period, so the summer of 2019, the Old-town district has even-more violations than usual. That can be caused by multiple factors…</p>\n\n<p>Also notice, that peripheral areas of districts as Ruzinov and Vrakuna have streets with repeating multiple violations.</p>\n\n<h3 id=\"streets-with-the-most-violations\">Streets with the most violations</h3>\n\n<p>Let’s see some of the most violated streets as time series as we seen in the animation.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">times</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">data.table</span><span class=\"p\">(</span><span class=\"n\">Year_M</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">data_violation_agg_street</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">sort</span><span class=\"p\">(</span><span class=\"n\">unique</span><span class=\"p\">(</span><span class=\"n\">Year_M</span><span class=\"p\">))])</span><span class=\"w\">\n</span><span class=\"n\">times</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Date</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">as.Date</span><span class=\"p\">(</span><span class=\"s2\">\"2017-01-01\"</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">times</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">row_id</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"o\">:</span><span class=\"n\">.N</span><span class=\"p\">]</span><span class=\"w\">\n</span><span class=\"n\">times</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Date</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">Date</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">row_id</span><span class=\"o\">*</span><span class=\"m\">30.4</span><span class=\"p\">]</span><span class=\"w\">\n \n</span><span class=\"n\">data_vio_most_street</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">copy</span><span class=\"p\">(</span><span class=\"n\">data_violation_agg_street</span><span class=\"p\">[</span><span class=\"w\">\n  </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"s2\">\"Michalska\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"Postova\"</span><span class=\"p\">,</span><span class=\"w\">\n      </span><span class=\"s2\">\"Rybarska brana\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"Namestie slobody\"</span><span class=\"p\">)),</span><span class=\"w\">\n  </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Street_edit</span><span class=\"p\">)])</span><span class=\"w\">\n \n</span><span class=\"n\">data_vio_most_street</span><span class=\"p\">[</span><span class=\"n\">times</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Year_M</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">Date</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">i.Date</span><span class=\"p\">]</span><span class=\"w\">\n</span><span class=\"n\">setnames</span><span class=\"p\">(</span><span class=\"n\">data_vio_most_street</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"N\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"N_violations\"</span><span class=\"p\">)</span><span class=\"w\">\n \n</span><span class=\"n\">ggplot</span><span class=\"p\">(</span><span class=\"n\">data_vio_most_street</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">geom_line</span><span class=\"p\">(</span><span class=\"n\">aes</span><span class=\"p\">(</span><span class=\"n\">Date</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">N_violations</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">color</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Street_edit</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0.8</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">theme_bw</span><span class=\"p\">()</span></code></pre></figure>\n\n<p><img src=\"/images/post_12/unnamed-chunk-34-1.png\" alt=\"plot of chunk unnamed-chunk-34\" /></p>\n\n<p>The most of the time, Michalska street in the historical center of the Old-town was the most violated street, but the last three months is Postova the “winner of the most violated street”…this is maybe because of the new city-police station nearby.</p>\n\n<h2 id=\"summary\">Summary</h2>\n\n<p>In this blog post, I showed you how to:</p>\n\n<ul>\n  <li>work with different spatial data as polygons, street lines or map images,</li>\n  <li>combine these spatial objects with external data as city violation time series,</li>\n  <li>create animated maps using packages as <code class=\"language-plaintext highlighter-rouge\">ggplot2</code>, <code class=\"language-plaintext highlighter-rouge\">ggmap</code>, <code class=\"language-plaintext highlighter-rouge\">gganimate</code>, and <code class=\"language-plaintext highlighter-rouge\">magick</code>.</li>\n</ul>\n\n<p>I hope, you will use these information with your spatial-time series data combo for creating some interesting visualization :)</p>\n\n<p>The source code for this blog post can be found on <a href=\"https://github.com/PetoLau/petolau.github.io/tree/master/_Rscripts\">my GitHub repository</a>.</p>",
  "pubDate": "Sun, 10 Nov 2019 00:00:00 +0000",
  "link": "https://petolau.github.io/Dangerous-streets-of-Bratislava-animated-maps-using-opendata/",
  "guid": {
    "@isPermaLink": true,
    "#text": "https://petolau.github.io/Dangerous-streets-of-Bratislava-animated-maps-using-opendata/"
  }
}