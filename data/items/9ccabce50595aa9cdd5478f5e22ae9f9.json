{
  "title": "Speeding up pandas's file parsers with Cython",
  "link": "",
  "published": "2011-10-16T00:00:00-07:00",
  "updated": "2011-10-16T00:00:00-07:00",
  "author": {
    "name": "Wes McKinney"
  },
  "id": "tag:wesmckinney.com,2011-10-16:/blog/speeding-up-pandass-file-parsers-with-cython/",
  "summary": "<p>I've tried to make the file parsing functions in pandas, <code>read_csv</code> and <code>read_table</code>, as robust (they do the right thing) and fast as possible. What do we really care about?</p>\n<ul>\n<li>Good performance: can read a CSV file as fast as other statistical computing / data analysis languages, like R</li>\n<li>Proper type …</li></ul>",
  "content": "<p>I've tried to make the file parsing functions in pandas, <code>read_csv</code> and <code>read_table</code>, as robust (they do the right thing) and fast as possible. What do we really care about?</p>\n<ul>\n<li>Good performance: can read a CSV file as fast as other statistical computing / data analysis languages, like R</li>\n<li>Proper type handling: if a column of data has integers, the resulting column will be integer dtype. But you can't be too aggressive, values like '1.0' and '2.0' should not get converted to integers.</li>\n<li>Support for converting strings into datetime objects</li>\n<li>Support for returning indexed DataFrame (with a simple or hierarchical index)</li>\n<li>NA value handling. This is tricky as you want to recognize lots of common NA representations (\"NA\", \"NULL\", etc.) and also allow the user to specify custom NA value strings.</li>\n</ul>\n<p>While hacking yesterdays with folks at the <a\nhref=\"http://datawithoutborders.cc/\" title=\"Data Without Borders\"\ntarget=\"_blank\">Data Without Borders</a> event, I realized that boolean values\n(\"True\" and \"False\") weren't resulting in an boolean array in the result. Also,\nI was not satisfied with the performance of the pure Python code. Since I've\nhad great results using <a href=\"http://cython.org\" title=\"Cython\"\ntarget=\"_blank\">Cython</a> to create C extensions, it was the natural\nchoice. The results were great: parsing the data set we were looking at at DWB\nwent from about 8 seconds before to 800ms, a full 10x improvement. I also fixed\na number of bugs / corner cases with type handling.</p>\n<h3>TL;DR pandas.read_csv is a lot faster now</h3>\n<p>Here was the speed of <code>read_csv</code> before these changes on a fairly big file (46738&#215;54):</p>\n<div class=\"github\"><pre><span></span><code>In [1]: %time df = read_csv(&#39;data.csv&#39;)\nCPU times: user 7.99 s, sys: 0.09 s, total: 8.08 s\nWall time: 8.11 s\n</code></pre></div>\n\n<p>This obviously will not do. And here post-Cythonization:</p>\n<div class=\"github\"><pre><span></span><code><span class=\"nv\">In</span> [<span class=\"mi\">17</span>]: <span class=\"nv\">timeit</span> <span class=\"nv\">df</span> <span class=\"o\">=</span> <span class=\"nv\">read_csv</span><span class=\"ss\">(</span><span class=\"s1\">&#39;</span><span class=\"s\">data.csv</span><span class=\"s1\">&#39;</span><span class=\"ss\">)</span>\n<span class=\"mi\">1</span> <span class=\"nv\">loops</span>, <span class=\"nv\">best</span> <span class=\"nv\">of</span> <span class=\"mi\">3</span>: <span class=\"mi\">804</span> <span class=\"nv\">ms</span> <span class=\"nv\">per</span> <span class=\"k\">loop</span>\n</code></pre></div>\n\n<p>As a point of comparison, R is pretty speedy but about 2x slower.</p>\n<div class=\"github\"><pre><span></span><code><span class=\"o\">&gt;</span> <span class=\"nf\">system.time</span><span class=\"p\">(</span><span class=\"n\">df</span> <span class=\"o\">&lt;-</span> <span class=\"nf\">read.csv</span><span class=\"p\">(</span><span class=\"s\">&#39;data.csv&#39;</span><span class=\"p\">,</span> <span class=\"n\">header</span><span class=\"o\">=</span><span class=\"bp\">T</span><span class=\"p\">))</span>\n   <span class=\"n\">user</span>  <span class=\"n\">system</span> <span class=\"n\">elapsed</span>\n  <span class=\"m\">1.660</span>   <span class=\"m\">0.000</span>   <span class=\"m\">1.667</span>\n</code></pre></div>\n\n<p>In fairness I am 100% sure that <code>read.csv</code> is \"doing\" a lot more, but it shows that I'm at least on the right track.</p>\n<p>I won't rehash all the code, but there were a number of interesting things along the way.</p>\n<h3>The basics: working with NumPy arrays in Cython</h3>\n<p>One of the truly beautiful things about programming in Cython is that you can get the speed of working with a C array representing a multi-dimensional array (e.g. <code>double *</code>) without the headache of having to handle the striding information of the ndarray yourself. Also, you can work with non-contiguous arrays and arrays with dtype=object (which are just arrays of <code>PyObject*</code> underneath) with no code changes (!). Cython calls this the <a href=\"http://docs.cython.org/src/tutorial/numpy.html\" title=\"buffer interface\" target=\"_blank\">buffer interface</a>:</p>\n<div class=\"github\"><pre><span></span><code><span class=\"k\">def</span> <span class=\"nf\">sanitize_objects</span><span class=\"p\">(</span><span class=\"n\">ndarray</span><span class=\"p\">[</span><span class=\"nb\">object</span><span class=\"p\">]</span> <span class=\"n\">values</span><span class=\"p\">):</span>\n    <span class=\"k\">cdef</span><span class=\"p\">:</span>\n        <span class=\"nb\">Py_ssize_t</span> <span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"n\">n</span>\n        <span class=\"nb\">object</span> <span class=\"n\">val</span><span class=\"p\">,</span> <span class=\"n\">onan</span>\n\n    <span class=\"n\">n</span> <span class=\"o\">=</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">values</span><span class=\"p\">)</span>\n    <span class=\"n\">onan</span> <span class=\"o\">=</span> <span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">nan</span>\n\n    <span class=\"k\">for</span> <span class=\"n\">i</span> <span class=\"k\">from</span> <span class=\"mf\">0</span> <span class=\"o\">&lt;=</span> <span class=\"n\">i</span> <span class=\"o\">&lt;</span> <span class=\"n\">n</span><span class=\"p\">:</span>\n        <span class=\"n\">val</span> <span class=\"o\">=</span> <span class=\"n\">values</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">]</span>\n        <span class=\"k\">if</span> <span class=\"n\">val</span> <span class=\"o\">==</span> <span class=\"s\">&#39;&#39;</span><span class=\"p\">:</span>\n            <span class=\"n\">values</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">onan</span>\n</code></pre></div>\n\n<p>For multi-dimensional arrays, you specify the number of dimensions in the buffer. and pass multiple indexes (<code>Py_ssize_t</code> is the proper C \"index type\" to use). I'll demonstrate this in:</p>\n<h3>Converting rows to columns faster than zip(*rows)</h3>\n<p>A cool Python trick to convert rows to column is:</p>\n<div class=\"github\"><pre><span></span><code>In [5]: rows\nOut[5]:\n[(0.39455404791938709, 0.13120015514691319, -0.38366356835950594),\n (-0.744567101498121, -0.9189909692195557, 1.3558711696319314),\n (-0.20933216711571506, 0.36102965753837235, 0.94614438124063927),\n (0.49200559154161844, 0.099177280246717708, -1.2622899429921068),\n (-0.48238271158753454, -0.9414862514454051, -1.0257632509581869)]\n\nIn [6]: zip(*rows)\nOut[6]:\n[(0.39455404791938709,\n  -0.744567101498121,\n  -0.20933216711571506,\n  0.49200559154161844,\n  -0.48238271158753454),\n (0.13120015514691319,\n  -0.9189909692195557,\n  0.36102965753837235,\n  0.099177280246717708,\n  -0.9414862514454051),\n (-0.38366356835950594,\n  1.3558711696319314,\n  0.94614438124063927,\n  -1.2622899429921068,\n  -1.0257632509581869)]\n</code></pre></div>\n\n<p>While <code>zip</code> is very fast (a built-in Python function), the larger problem here is that our target data structure is NumPy arrays to begin with. So it would make sense to write out the rows directly to a 2-dimensional object array:</p>\n<div class=\"github\"><pre><span></span><code><span class=\"k\">def</span> <span class=\"nf\">to_object_array</span><span class=\"p\">(</span><span class=\"nb\">list</span> <span class=\"n\">rows</span><span class=\"p\">):</span>\n    <span class=\"k\">cdef</span><span class=\"p\">:</span>\n        <span class=\"nb\">Py_ssize_t</span> <span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"n\">j</span><span class=\"p\">,</span> <span class=\"n\">n</span><span class=\"p\">,</span> <span class=\"n\">k</span><span class=\"p\">,</span> <span class=\"n\">tmp</span>\n        <span class=\"n\">ndarray</span><span class=\"p\">[</span><span class=\"nb\">object</span><span class=\"p\">,</span> <span class=\"n\">ndim</span><span class=\"o\">=</span><span class=\"mf\">2</span><span class=\"p\">]</span> <span class=\"n\">result</span>\n        <span class=\"nb\">list</span> <span class=\"n\">row</span>\n\n    <span class=\"n\">n</span> <span class=\"o\">=</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">rows</span><span class=\"p\">)</span>\n\n    <span class=\"c\"># get the maximum row length</span>\n    <span class=\"n\">k</span> <span class=\"o\">=</span> <span class=\"mf\">0</span>\n    <span class=\"k\">for</span> <span class=\"n\">i</span> <span class=\"k\">from</span> <span class=\"mf\">0</span> <span class=\"o\">&lt;=</span> <span class=\"n\">i</span> <span class=\"o\">&lt;</span> <span class=\"n\">n</span><span class=\"p\">:</span>\n        <span class=\"n\">tmp</span> <span class=\"o\">=</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">rows</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">])</span>\n        <span class=\"k\">if</span> <span class=\"n\">tmp</span> <span class=\"o\">&gt;</span> <span class=\"n\">k</span><span class=\"p\">:</span>\n            <span class=\"n\">k</span> <span class=\"o\">=</span> <span class=\"n\">tmp</span>\n\n    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">empty</span><span class=\"p\">((</span><span class=\"n\">n</span><span class=\"p\">,</span> <span class=\"n\">k</span><span class=\"p\">),</span> <span class=\"n\">dtype</span><span class=\"o\">=</span><span class=\"nb\">object</span><span class=\"p\">)</span>\n\n    <span class=\"k\">for</span> <span class=\"n\">i</span> <span class=\"k\">from</span> <span class=\"mf\">0</span> <span class=\"o\">&lt;=</span> <span class=\"n\">i</span> <span class=\"o\">&lt;</span> <span class=\"n\">n</span><span class=\"p\">:</span>\n        <span class=\"n\">row</span> <span class=\"o\">=</span> <span class=\"n\">rows</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">]</span>\n\n        <span class=\"k\">for</span> <span class=\"n\">j</span> <span class=\"k\">from</span> <span class=\"mf\">0</span> <span class=\"o\">&lt;=</span> <span class=\"n\">j</span> <span class=\"o\">&lt;</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">row</span><span class=\"p\">):</span>\n            <span class=\"n\">result</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"n\">j</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">row</span><span class=\"p\">[</span><span class=\"n\">j</span><span class=\"p\">]</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">result</span>\n</code></pre></div>\n\n<p>And lo and behold, this function is significantly faster than the zip trick:</p>\n<div class=\"github\"><pre><span></span><code><span class=\"n\">In</span> <span class=\"p\">[</span><span class=\"mi\">12</span><span class=\"p\">]:</span> <span class=\"n\">data</span> <span class=\"o\">=</span> <span class=\"nb\">map</span><span class=\"p\">(</span><span class=\"nb\">list</span><span class=\"p\">,</span> <span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">random</span><span class=\"o\">.</span><span class=\"n\">randn</span><span class=\"p\">(</span><span class=\"mi\">10000</span><span class=\"p\">,</span> <span class=\"mi\">10</span><span class=\"p\">))</span>\n\n<span class=\"n\">In</span> <span class=\"p\">[</span><span class=\"mi\">13</span><span class=\"p\">]:</span> <span class=\"n\">timeit</span> <span class=\"nb\">zip</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">data</span><span class=\"p\">)</span>\n<span class=\"mi\">100</span> <span class=\"n\">loops</span><span class=\"p\">,</span> <span class=\"n\">best</span> <span class=\"n\">of</span> <span class=\"mi\">3</span><span class=\"p\">:</span> <span class=\"mf\">3.66</span> <span class=\"n\">ms</span> <span class=\"n\">per</span> <span class=\"n\">loop</span>\n\n<span class=\"n\">In</span> <span class=\"p\">[</span><span class=\"mi\">14</span><span class=\"p\">]:</span> <span class=\"n\">timeit</span> <span class=\"n\">lib</span><span class=\"o\">.</span><span class=\"n\">to_object_array</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">)</span>\n<span class=\"mi\">1000</span> <span class=\"n\">loops</span><span class=\"p\">,</span> <span class=\"n\">best</span> <span class=\"n\">of</span> <span class=\"mi\">3</span><span class=\"p\">:</span> <span class=\"mf\">1.47</span> <span class=\"n\">ms</span> <span class=\"n\">per</span> <span class=\"n\">loop</span>\n</code></pre></div>\n\n<p>It's even more of a big deal if you zip <strong>and</strong> convert to ndarray:</p>\n<div class=\"github\"><pre><span></span><code><span class=\"nv\">In</span> [<span class=\"mi\">15</span>]: <span class=\"nv\">timeit</span> [<span class=\"nv\">np</span>.<span class=\"nv\">asarray</span><span class=\"ss\">(</span><span class=\"nv\">x</span>, <span class=\"nv\">dtype</span><span class=\"o\">=</span><span class=\"nv\">object</span><span class=\"ss\">)</span> <span class=\"k\">for</span> <span class=\"nv\">x</span> <span class=\"nv\">in</span> <span class=\"nv\">zip</span><span class=\"ss\">(</span><span class=\"o\">*</span><span class=\"nv\">data</span><span class=\"ss\">)</span>]\n<span class=\"mi\">100</span> <span class=\"nv\">loops</span>, <span class=\"nv\">best</span> <span class=\"nv\">of</span> <span class=\"mi\">3</span>: <span class=\"mi\">6</span>.<span class=\"mi\">72</span> <span class=\"nv\">ms</span> <span class=\"nv\">per</span> <span class=\"k\">loop</span>\n</code></pre></div>\n\n<h3>Numeric conversion: floats, ints, and NA's, oh my</h3>\n<p>When converting the Python strings to numeric data, you must:</p>\n<ul>\n<li>Check that the value is not among the set of NA values</li>\n<li>Handle data like <code>['1', '2', '3.5', '4']</code> where you may have \"integer-like\" data until you observe a floating point value</li>\n</ul>\n<p>Unfortunately, code for this sort of thing ends up looking like a state machine 99% of the time, but at least it's fairly tidy in Cython and runs super fast:</p>\n<div class=\"github\"><pre><span></span><code><span class=\"k\">def</span> <span class=\"nf\">maybe_convert_numeric</span><span class=\"p\">(</span><span class=\"n\">ndarray</span><span class=\"p\">[</span><span class=\"nb\">object</span><span class=\"p\">]</span> <span class=\"n\">values</span><span class=\"p\">,</span> <span class=\"nb\">set</span> <span class=\"n\">na_values</span><span class=\"p\">):</span>\n    <span class=\"k\">cdef</span><span class=\"p\">:</span>\n        <span class=\"nb\">Py_ssize_t</span> <span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"n\">n</span>\n        <span class=\"n\">ndarray</span><span class=\"p\">[</span><span class=\"n\">float64_t</span><span class=\"p\">]</span> <span class=\"n\">floats</span>\n        <span class=\"n\">ndarray</span><span class=\"p\">[</span><span class=\"n\">int64_t</span><span class=\"p\">]</span> <span class=\"n\">ints</span>\n        <span class=\"nb\">bint</span> <span class=\"n\">seen_float</span> <span class=\"o\">=</span> <span class=\"mf\">0</span>\n        <span class=\"nb\">object</span> <span class=\"n\">val</span>\n        <span class=\"n\">float64_t</span> <span class=\"n\">fval</span>\n\n    <span class=\"n\">n</span> <span class=\"o\">=</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">values</span><span class=\"p\">)</span>\n\n    <span class=\"n\">floats</span> <span class=\"o\">=</span> <span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">empty</span><span class=\"p\">(</span><span class=\"n\">n</span><span class=\"p\">,</span> <span class=\"n\">dtype</span><span class=\"o\">=</span><span class=\"s\">&#39;f8&#39;</span><span class=\"p\">)</span>\n    <span class=\"n\">ints</span> <span class=\"o\">=</span> <span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">empty</span><span class=\"p\">(</span><span class=\"n\">n</span><span class=\"p\">,</span> <span class=\"n\">dtype</span><span class=\"o\">=</span><span class=\"s\">&#39;i8&#39;</span><span class=\"p\">)</span>\n\n    <span class=\"k\">for</span> <span class=\"n\">i</span> <span class=\"k\">from</span> <span class=\"mf\">0</span> <span class=\"o\">&lt;=</span> <span class=\"n\">i</span> <span class=\"o\">&lt;</span> <span class=\"n\">n</span><span class=\"p\">:</span>\n        <span class=\"n\">val</span> <span class=\"o\">=</span> <span class=\"n\">values</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">]</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">cpython</span><span class=\"o\">.</span><span class=\"n\">PyFloat_Check</span><span class=\"p\">(</span><span class=\"n\">val</span><span class=\"p\">):</span>\n            <span class=\"n\">floats</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">val</span>\n            <span class=\"n\">seen_float</span> <span class=\"o\">=</span> <span class=\"mf\">1</span>\n        <span class=\"k\">elif</span> <span class=\"n\">val</span> <span class=\"ow\">in</span> <span class=\"n\">na_values</span><span class=\"p\">:</span>\n            <span class=\"n\">floats</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">nan</span>\n            <span class=\"n\">seen_float</span> <span class=\"o\">=</span> <span class=\"mf\">1</span>\n        <span class=\"k\">elif</span> <span class=\"n\">val</span> <span class=\"ow\">is</span> <span class=\"bp\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">floats</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">nan</span>\n            <span class=\"n\">seen_float</span> <span class=\"o\">=</span> <span class=\"mf\">1</span>\n        <span class=\"k\">elif</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">val</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"mf\">0</span><span class=\"p\">:</span>\n            <span class=\"n\">floats</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">nan</span>\n            <span class=\"n\">seen_float</span> <span class=\"o\">=</span> <span class=\"mf\">1</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">fval</span> <span class=\"o\">=</span> <span class=\"nb\">float</span><span class=\"p\">(</span><span class=\"n\">val</span><span class=\"p\">)</span>\n            <span class=\"n\">floats</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">fval</span>\n            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">seen_float</span><span class=\"p\">:</span>\n                <span class=\"k\">if</span> <span class=\"s\">&#39;.&#39;</span> <span class=\"ow\">in</span> <span class=\"n\">val</span><span class=\"p\">:</span>\n                    <span class=\"n\">seen_float</span> <span class=\"o\">=</span> <span class=\"mf\">1</span>\n                <span class=\"k\">else</span><span class=\"p\">:</span>\n                    <span class=\"n\">ints</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"o\">&lt;</span><span class=\"n\">int64_t</span><span class=\"o\">&gt;</span> <span class=\"n\">fval</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">seen_float</span><span class=\"p\">:</span>\n        <span class=\"k\">return</span> <span class=\"n\">floats</span>\n    <span class=\"k\">else</span><span class=\"p\">:</span>\n        <span class=\"k\">return</span> <span class=\"n\">ints</span>\n</code></pre></div>\n\n<p>Adopting the Python philosophy that it's \"easier to ask forgiveness than permission\" if float conversion ever fails, the exception will get raised and the code will just leave the column as dtype=object. And this function would obviously have problems with European decimal format— but I'm not willing to compromise performance in 99% cases for the sake of the 1% cases. It will make sense to write a slower function that also handles a broader variety of formatting issues.</p>"
}