{
  "title": "Sessionizing Log Data Using dplyr [Follow-up]",
  "description": "<p>Last week, I wrote a blog post showing how to <a href=\"http://randyzwitch.com/sessionizing-log-data-sql\">sessionize log data using standard SQL</a>. The main idea of that post is that if your analytics platform supports window functions (like Postgres and Hive do), you can make quick work out of sessionizing logs. Here’s the winning query:</p>",
  "pubDate": "Tue, 13 Jan 2015 16:24:52 +0000",
  "link": "http://randyzwitch.com/sessionizing-log-data-dplyr-r-window-functions/",
  "guid": "http://randyzwitch.com/sessionizing-log-data-dplyr-r-window-functions/",
  "content": "<p>Last week, I wrote a blog post showing how to <a href=\"http://randyzwitch.com/sessionizing-log-data-sql\">sessionize log data using standard SQL</a>. The main idea of that post is that if your analytics platform supports window functions (like Postgres and Hive do), you can make quick work out of sessionizing logs. Here’s the winning query:</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-sql\" data-lang=\"sql\"><table class=\"rouge-table\"><tbody><tr><td class=\"gutter gl\"><pre class=\"lineno\">1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n</pre></td><td class=\"code\"><pre><span class=\"k\">select</span>\n<span class=\"n\">uid</span><span class=\"p\">,</span>\n<span class=\"k\">sum</span><span class=\"p\">(</span><span class=\"n\">new_event_boundary</span><span class=\"p\">)</span> <span class=\"n\">OVER</span> <span class=\"p\">(</span><span class=\"n\">PARTITION</span> <span class=\"k\">BY</span> <span class=\"n\">uid</span> <span class=\"k\">ORDER</span> <span class=\"k\">BY</span> <span class=\"n\">event_timestamp</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">session_id</span><span class=\"p\">,</span>\n<span class=\"n\">event_timestamp</span><span class=\"p\">,</span>\n<span class=\"n\">minutes_since_last_interval</span><span class=\"p\">,</span>\n<span class=\"n\">new_event_boundary</span>\n<span class=\"k\">from</span>\n\t\t\t<span class=\"c1\">--Query 1: Define boundary events</span>\n\t\t\t<span class=\"p\">(</span><span class=\"k\">select</span>\n\t\t\t<span class=\"n\">uid</span><span class=\"p\">,</span>\n\t\t\t<span class=\"n\">event_timestamp</span><span class=\"p\">,</span>\n\t\t\t<span class=\"p\">(</span><span class=\"k\">extract</span><span class=\"p\">(</span><span class=\"n\">epoch</span> <span class=\"k\">from</span> <span class=\"n\">event_timestamp</span><span class=\"p\">)</span> <span class=\"o\">-</span> <span class=\"n\">lag</span><span class=\"p\">(</span><span class=\"k\">extract</span><span class=\"p\">(</span><span class=\"n\">epoch</span> <span class=\"k\">from</span> <span class=\"n\">event_timestamp</span><span class=\"p\">))</span> <span class=\"n\">OVER</span> <span class=\"p\">(</span><span class=\"n\">PARTITION</span> <span class=\"k\">BY</span> <span class=\"n\">uid</span> <span class=\"k\">ORDER</span> <span class=\"k\">BY</span> <span class=\"n\">event_timestamp</span><span class=\"p\">))</span><span class=\"o\">/</span><span class=\"mi\">60</span> <span class=\"k\">as</span> <span class=\"n\">minutes_since_last_interval</span><span class=\"p\">,</span>\n\t\t\t<span class=\"k\">case</span> <span class=\"k\">when</span> <span class=\"k\">extract</span><span class=\"p\">(</span><span class=\"n\">epoch</span> <span class=\"k\">from</span> <span class=\"n\">event_timestamp</span><span class=\"p\">)</span> <span class=\"o\">-</span> <span class=\"n\">lag</span><span class=\"p\">(</span><span class=\"k\">extract</span><span class=\"p\">(</span><span class=\"n\">epoch</span> <span class=\"k\">from</span> <span class=\"n\">event_timestamp</span><span class=\"p\">))</span> <span class=\"n\">OVER</span> <span class=\"p\">(</span><span class=\"n\">PARTITION</span> <span class=\"k\">BY</span> <span class=\"n\">uid</span> <span class=\"k\">ORDER</span> <span class=\"k\">BY</span> <span class=\"n\">event_timestamp</span><span class=\"p\">)</span> <span class=\"o\">&gt;</span> <span class=\"mi\">30</span> <span class=\"o\">*</span> <span class=\"mi\">60</span> <span class=\"k\">then</span> <span class=\"mi\">1</span> <span class=\"k\">ELSE</span> <span class=\"mi\">0</span> <span class=\"k\">END</span> <span class=\"k\">as</span> <span class=\"n\">new_event_boundary</span>\n\t\t\t<span class=\"k\">from</span> <span class=\"n\">single_col_timestamp</span>\n\t\t\t<span class=\"p\">)</span> <span class=\"n\">a</span><span class=\"p\">;</span>\n</pre></td></tr></tbody></table></code></pre></figure>\n\n<p>One nested sub-query and two window functions are all it takes to calculate the event boundaries and create a unique identifier for sessions for any arbitrary timeout chosen.</p>\n\n<h2 id=\"its-hadleys-house-were-justleasing\">It’s Hadley’s House, We’re Just Leasing</h2>\n\n<p>Up until today, I hadn’t really done anything using dplyr.  But having a bunch of free time this week and hearing people talk so much about how great dplyr is, I decided to see what it would take to replicate this same exercise using R. dplyr has support for Postgres as a back-end, and has verbs that translate R code into window functions, so I figured it had to be possible. Here’s what I came up with:</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><table class=\"rouge-table\"><tbody><tr><td class=\"gutter gl\"><pre class=\"lineno\">1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n</pre></td><td class=\"code\"><pre><span class=\"c1\">###Sessionization using dplyr</span><span class=\"w\">\n\n</span><span class=\"n\">library</span><span class=\"p\">(</span><span class=\"n\">dplyr</span><span class=\"p\">)</span><span class=\"w\">\n\n</span><span class=\"c1\">#Open a localhost connection to Postgres</span><span class=\"w\">\n</span><span class=\"c1\">#Use table 'single_col_timestamp'</span><span class=\"w\">\n</span><span class=\"c1\">#group by uid and sort by timestamp for window function</span><span class=\"w\">\n</span><span class=\"c1\">#Do minutes calculation, working around missing support for extract(epoch from timestamp)</span><span class=\"w\">\n</span><span class=\"c1\">#Calculate event boundary and unique id via cumulative sum window function</span><span class=\"w\">\n</span><span class=\"n\">sessions</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\">  \n        </span><span class=\"n\">src_postgres</span><span class=\"p\">(</span><span class=\"s2\">\"logfiles\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">%&gt;%</span><span class=\"w\">\n        </span><span class=\"n\">tbl</span><span class=\"p\">(</span><span class=\"s2\">\"single_col_timestamp\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">%&gt;%</span><span class=\"w\">\n        </span><span class=\"n\">group_by</span><span class=\"p\">(</span><span class=\"n\">uid</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">%&gt;%</span><span class=\"w\">\n        </span><span class=\"n\">arrange</span><span class=\"p\">(</span><span class=\"n\">event_timestamp</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">%&gt;%</span><span class=\"w\">\n        </span><span class=\"n\">mutate</span><span class=\"p\">(</span><span class=\"n\">minutes_since_last_event</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"w\">\n                                           </span><span class=\"n\">DATE_PART</span><span class=\"p\">(</span><span class=\"s1\">'day'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">event_timestamp</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">lag</span><span class=\"p\">(</span><span class=\"n\">event_timestamp</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"m\">24</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n                                           </span><span class=\"n\">DATE_PART</span><span class=\"p\">(</span><span class=\"s1\">'hour'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">event_timestamp</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">lag</span><span class=\"p\">(</span><span class=\"n\">event_timestamp</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"m\">60</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n                                           </span><span class=\"n\">DATE_PART</span><span class=\"p\">(</span><span class=\"s1\">'minute'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">event_timestamp</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">lag</span><span class=\"p\">(</span><span class=\"n\">event_timestamp</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"m\">60</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n                                           </span><span class=\"n\">DATE_PART</span><span class=\"p\">(</span><span class=\"s1\">'second'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">event_timestamp</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">lag</span><span class=\"p\">(</span><span class=\"n\">event_timestamp</span><span class=\"p\">))</span><span class=\"w\">\n                                           </span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"m\">60</span><span class=\"w\">\n              </span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">%&gt;%</span><span class=\"w\">\n        </span><span class=\"n\">mutate</span><span class=\"p\">(</span><span class=\"n\">event_boundary</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"p\">(</span><span class=\"n\">minutes_since_last_event</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"m\">30</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"m\">0</span><span class=\"p\">,</span><span class=\"w\">\n               </span><span class=\"n\">session_id</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"n\">event_timestamp</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nf\">cumsum</span><span class=\"p\">(</span><span class=\"k\">if</span><span class=\"p\">(</span><span class=\"n\">minutes_since_last_event</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"m\">30</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"m\">0</span><span class=\"p\">)))</span><span class=\"w\">\n\n</span><span class=\"c1\">#Show query syntax</span><span class=\"w\">\n</span><span class=\"n\">show_query</span><span class=\"p\">(</span><span class=\"n\">sessions</span><span class=\"p\">)</span><span class=\"w\">\n\n</span><span class=\"c1\">#Actually run the query</span><span class=\"w\">\n</span><span class=\"n\">answer</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">collect</span><span class=\"p\">(</span><span class=\"n\">sessions</span><span class=\"p\">)</span>\n</pre></td></tr></tbody></table></code></pre></figure>\n\n<p>Generally, I’m not a fan of the pipe operator, but I figured I’d give it a shot since everyone else seems to like it. This is one nasty bit of R code, but ultimately, it is possible to get the same result as writing SQL directly. I did need to take a few roundabout ways, specifically in calculating the minutes between timestamps and substituting the CASE expression into the window function rather than call it by name, but it’s basically the same logic.</p>\n\n<h2 id=\"why-does-this-work\">Why Does This Work?</h2>\n\n<p>If you compare the SQL code above to the R code, you might be wondering why the dplyr code works. Certainly, working the dplyr way gives me cognitive dissonance, as you generally specify the verbs you are using in reverse order as you do in SQL. But calling <code class=\"language-plaintext highlighter-rouge\">show_query(sessions)</code>, you actually see that dplyr is generating SQL under-the-hood (I formatted the code for easier viewing):</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-sql\" data-lang=\"sql\"><table class=\"rouge-table\"><tbody><tr><td class=\"gutter gl\"><pre class=\"lineno\">1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n</pre></td><td class=\"code\"><pre><span class=\"k\">SELECT</span>\n\t<span class=\"nv\">\"uid\"</span><span class=\"p\">,</span>\n\t<span class=\"nv\">\"event_timestamp\"</span><span class=\"p\">,</span>\n\t<span class=\"nv\">\"minutes_since_last_event\"</span><span class=\"p\">,</span>\n\t<span class=\"nv\">\"event_boundary\"</span><span class=\"p\">,</span>\n\t<span class=\"nv\">\"session_id\"</span>\n<span class=\"k\">FROM</span> <span class=\"p\">(</span>\n\t\t<span class=\"k\">SELECT</span>\n\t\t\t<span class=\"nv\">\"uid\"</span><span class=\"p\">,</span>\n\t\t\t<span class=\"nv\">\"event_timestamp\"</span><span class=\"p\">,</span>\n\t\t\t<span class=\"nv\">\"minutes_since_last_event\"</span><span class=\"p\">,</span>\n\t\t\t<span class=\"k\">CASE</span> <span class=\"k\">WHEN</span> <span class=\"nv\">\"minutes_since_last_event\"</span> <span class=\"o\">&gt;</span> <span class=\"mi\">30</span><span class=\"p\">.</span><span class=\"mi\">0</span> <span class=\"k\">THEN</span> <span class=\"mi\">1</span><span class=\"p\">.</span><span class=\"mi\">0</span> <span class=\"k\">ELSE</span> <span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">0</span> <span class=\"k\">END</span> <span class=\"k\">AS</span> <span class=\"nv\">\"event_boundary\"</span><span class=\"p\">,</span>\n\t\t\t<span class=\"k\">sum</span><span class=\"p\">(</span><span class=\"k\">CASE</span> <span class=\"k\">WHEN</span> <span class=\"nv\">\"minutes_since_last_event\"</span> <span class=\"o\">&gt;</span> <span class=\"mi\">30</span><span class=\"p\">.</span><span class=\"mi\">0</span> <span class=\"k\">THEN</span> <span class=\"mi\">1</span><span class=\"p\">.</span><span class=\"mi\">0</span> <span class=\"k\">ELSE</span> <span class=\"mi\">0</span><span class=\"p\">.</span><span class=\"mi\">0</span> <span class=\"k\">END</span><span class=\"p\">)</span> <span class=\"n\">OVER</span> <span class=\"p\">(</span><span class=\"n\">PARTITION</span> <span class=\"k\">BY</span> <span class=\"nv\">\"uid\"</span> <span class=\"k\">ORDER</span> <span class=\"k\">BY</span> <span class=\"nv\">\"event_timestamp\"</span> <span class=\"k\">ROWS</span> <span class=\"n\">UNBOUNDED</span> <span class=\"n\">PRECEDING</span><span class=\"p\">)</span> <span class=\"k\">AS</span> <span class=\"nv\">\"session_id\"</span>\n\t\t<span class=\"k\">FROM</span>\n\t\t\t<span class=\"p\">(</span>\n\t\t\t\t<span class=\"k\">SELECT</span>\n\t\t\t\t\t<span class=\"nv\">\"uid\"</span><span class=\"p\">,</span>\n\t\t\t\t\t<span class=\"nv\">\"event_timestamp\"</span><span class=\"p\">,</span>\n\t\t\t\t\t<span class=\"p\">(</span><span class=\"n\">DATE_PART</span><span class=\"p\">(</span><span class=\"s1\">'day'</span><span class=\"p\">,</span> <span class=\"nv\">\"event_timestamp\"</span> <span class=\"o\">-</span> <span class=\"n\">LAG</span><span class=\"p\">(</span><span class=\"nv\">\"event_timestamp\"</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"k\">NULL</span><span class=\"p\">)</span> <span class=\"n\">OVER</span> <span class=\"p\">(</span><span class=\"n\">PARTITION</span> <span class=\"k\">BY</span> <span class=\"nv\">\"uid\"</span> <span class=\"k\">ORDER</span> <span class=\"k\">BY</span> <span class=\"nv\">\"event_timestamp\"</span><span class=\"p\">))</span> <span class=\"o\">*</span> <span class=\"mi\">24</span><span class=\"p\">.</span><span class=\"mi\">0</span>\n\t\t\t\t\t\t<span class=\"o\">+</span> <span class=\"n\">DATE_PART</span><span class=\"p\">(</span><span class=\"s1\">'hour'</span><span class=\"p\">,</span> <span class=\"nv\">\"event_timestamp\"</span> <span class=\"o\">-</span> <span class=\"n\">LAG</span><span class=\"p\">(</span><span class=\"nv\">\"event_timestamp\"</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"k\">NULL</span><span class=\"p\">)</span> <span class=\"n\">OVER</span> <span class=\"p\">(</span><span class=\"n\">PARTITION</span> <span class=\"k\">BY</span> <span class=\"nv\">\"uid\"</span> <span class=\"k\">ORDER</span> <span class=\"k\">BY</span> <span class=\"nv\">\"event_timestamp\"</span><span class=\"p\">))</span> <span class=\"o\">*</span> <span class=\"mi\">60</span><span class=\"p\">.</span><span class=\"mi\">0</span>\n\t\t\t\t\t\t<span class=\"o\">+</span> <span class=\"n\">DATE_PART</span><span class=\"p\">(</span><span class=\"s1\">'minute'</span><span class=\"p\">,</span> <span class=\"nv\">\"event_timestamp\"</span> <span class=\"o\">-</span> <span class=\"n\">LAG</span><span class=\"p\">(</span><span class=\"nv\">\"event_timestamp\"</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"k\">NULL</span><span class=\"p\">)</span> <span class=\"n\">OVER</span> <span class=\"p\">(</span><span class=\"n\">PARTITION</span> <span class=\"k\">BY</span> <span class=\"nv\">\"uid\"</span> <span class=\"k\">ORDER</span> <span class=\"k\">BY</span> <span class=\"nv\">\"event_timestamp\"</span><span class=\"p\">))</span> <span class=\"o\">*</span> <span class=\"mi\">60</span><span class=\"p\">.</span><span class=\"mi\">0</span>\n\t\t\t\t\t\t<span class=\"o\">+</span> <span class=\"n\">DATE_PART</span><span class=\"p\">(</span><span class=\"s1\">'second'</span><span class=\"p\">,</span> <span class=\"nv\">\"event_timestamp\"</span> <span class=\"o\">-</span> <span class=\"n\">LAG</span><span class=\"p\">(</span><span class=\"nv\">\"event_timestamp\"</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"k\">NULL</span><span class=\"p\">)</span> <span class=\"n\">OVER</span> <span class=\"p\">(</span><span class=\"n\">PARTITION</span> <span class=\"k\">BY</span> <span class=\"nv\">\"uid\"</span> <span class=\"k\">ORDER</span> <span class=\"k\">BY</span> <span class=\"nv\">\"event_timestamp\"</span><span class=\"p\">)))</span> <span class=\"o\">/</span> <span class=\"mi\">60</span><span class=\"p\">.</span><span class=\"mi\">0</span> <span class=\"k\">AS</span> <span class=\"nv\">\"minutes_since_last_event\"</span>\n\t\t\t\t<span class=\"k\">FROM</span> <span class=\"nv\">\"single_col_timestamp\"</span>\n\t\t\t\t<span class=\"k\">ORDER</span> <span class=\"k\">BY</span> <span class=\"nv\">\"uid\"</span><span class=\"p\">,</span> <span class=\"nv\">\"event_timestamp\"</span>\n\t\t\t<span class=\"p\">)</span> <span class=\"k\">AS</span> <span class=\"nv\">\"_W1\"</span>\n\t<span class=\"p\">)</span> <span class=\"k\">AS</span> <span class=\"nv\">\"_W2\"</span>\n</pre></td></tr></tbody></table></code></pre></figure>\n\n<p>Like all SQL-generating tools, the code is a bit inelegant; however, I have to say that I’m truly impressed the dplyr code was able to handle this scenario at all, given that this example has to be at least an edge-, if not a corner-case of what dplyr is meant for in terms of data manipulation.</p>\n\n<h2 id=\"so-dplyris-going-to-become-part-of-your-toolbox\">So, dplyr Is Going To Become Part Of Your Toolbox?</h2>\n\n<p>While it was possible to re-create the same functionality, ultimately, I don’t see myself using dplyr a whole lot. In the case of using databases, it seems more efficient and portable just to write the SQL directly; at the very least, it’s what I’m already comfortable doing as part of my analytics workflow. For manipulating data frames, maybe I’d use it (I do use plyr extensively in my <a href=\"http://cran.r-project.org/web/packages/RSiteCatalyst/index.html\">RSiteCatalyst</a> package), but I’d probably be more inclined to use <a href=\"http://randyzwitch.com/sqldf-package-r/\">sqldf</a> instead.</p>\n\n<p>But that’s just me, not a reflection on the package quality. Happy manipulating, however you choose to do it! 🙂</p>"
}