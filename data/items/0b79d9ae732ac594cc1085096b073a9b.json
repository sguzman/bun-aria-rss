{
  "title": "Fast and easy pivot tables in pandas 0.5.0",
  "link": "",
  "published": "2011-10-23T00:00:00-07:00",
  "updated": "2011-10-23T00:00:00-07:00",
  "author": {
    "name": "Wes McKinney"
  },
  "id": "tag:wesmckinney.com,2011-10-23:/blog/fast-and-easy-pivot-tables-in-pandas-0-5-0/",
  "summary": "<blockquote>\n<p>10/2/2015: Some API changes in pandas in the last 4 years but the general advice stands.</p>\n</blockquote>\n<p>Over the last several months, I've invested a great deal in the <a href=\"http://pandas.sourceforge.net/groupby.html\" title=\"GroupBy\" target=\"_blank\">GroupBy</a> and <a href=\"http://pandas.sourceforge.net/indexing.html#hierarchical-indexing-multiindex\" title=\"Indexing\" target=\"_blank\">indexing</a> infrastructure of <a href=\"http://pandas.sourceforge.net\" title=\"pandas\" target=\"_blank\">pandas</a>. GroupBy in particular could still use more work to be made even higher performance …</p>",
  "content": "<blockquote>\n<p>10/2/2015: Some API changes in pandas in the last 4 years but the general advice stands.</p>\n</blockquote>\n<p>Over the last several months, I've invested a great deal in the <a href=\"http://pandas.sourceforge.net/groupby.html\" title=\"GroupBy\" target=\"_blank\">GroupBy</a> and <a href=\"http://pandas.sourceforge.net/indexing.html#hierarchical-indexing-multiindex\" title=\"Indexing\" target=\"_blank\">indexing</a> infrastructure of <a href=\"http://pandas.sourceforge.net\" title=\"pandas\" target=\"_blank\">pandas</a>. GroupBy in particular could still use more work to be made even higher performance, but even for quite large data sets, most users will find it more than satisfactory compared with other Python alternatives (which are mainly DIY approaches these days) or even in other data analysis packages, e.g. those in R, which I'll talk a bit about in this article.</p>\n<p>An easy application of GroupBy is creating <em>pivot tables</em> from a tabular data set. This involves aggregating a data set on some number of keys, then reshaping it to form a 2D table with the stratified aggregated values. I added a new function <code>pivot_table</code> which provides a high level interface for creating pivot tables. Let's consider the <code>tips</code> data set used in some examples of the <a href=\"http://had.co.nz\" title=\"Hadley Wickham\" target=\"_blank\">Hadley Wickham's</a> excellent R <a href=\"http://cran.r-project.org/web/packages/reshape2/index.html\" title=\"reshape2\" target=\"_blank\">reshape2</a> package:</p>\n<div class=\"github\"><pre><span></span><code><span class=\"n\">In</span> <span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]:</span> <span class=\"kn\">import</span> <span class=\"nn\">pandas.rpy.common</span> <span class=\"k\">as</span> <span class=\"nn\">com</span>\n\n<span class=\"n\">In</span> <span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">]:</span> <span class=\"n\">tips</span> <span class=\"o\">=</span> <span class=\"n\">com</span><span class=\"o\">.</span><span class=\"n\">load_data</span><span class=\"p\">(</span><span class=\"s1\">&#39;tips&#39;</span><span class=\"p\">,</span> <span class=\"n\">package</span><span class=\"o\">=</span><span class=\"s1\">&#39;reshape2&#39;</span><span class=\"p\">)</span>\n\n<span class=\"n\">In</span> <span class=\"p\">[</span><span class=\"mi\">3</span><span class=\"p\">]:</span> <span class=\"n\">tips</span><span class=\"p\">[</span><span class=\"s1\">&#39;tip_pct&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">tips</span><span class=\"p\">[</span><span class=\"s1\">&#39;tip&#39;</span><span class=\"p\">]</span> <span class=\"o\">/</span> <span class=\"n\">tips</span><span class=\"p\">[</span><span class=\"s1\">&#39;total_bill&#39;</span><span class=\"p\">]</span>\n\n<span class=\"n\">In</span> <span class=\"p\">[</span><span class=\"mi\">4</span><span class=\"p\">]:</span> <span class=\"n\">tips</span><span class=\"o\">.</span><span class=\"n\">head</span><span class=\"p\">()</span>\n<span class=\"n\">Out</span><span class=\"p\">[</span><span class=\"mi\">4</span><span class=\"p\">]:</span>\n   <span class=\"n\">total_bill</span>  <span class=\"n\">tip</span>   <span class=\"n\">sex</span>     <span class=\"n\">smoker</span>  <span class=\"n\">day</span>  <span class=\"n\">time</span>    <span class=\"n\">size</span>  <span class=\"n\">tip_pct</span>\n<span class=\"mi\">1</span>  <span class=\"mf\">16.99</span>       <span class=\"mf\">1.01</span>  <span class=\"n\">Female</span>  <span class=\"n\">No</span>      <span class=\"n\">Sun</span>  <span class=\"n\">Dinner</span>  <span class=\"mi\">2</span>     <span class=\"mf\">0.05945</span>\n<span class=\"mi\">2</span>  <span class=\"mf\">10.34</span>       <span class=\"mf\">1.66</span>  <span class=\"n\">Male</span>    <span class=\"n\">No</span>      <span class=\"n\">Sun</span>  <span class=\"n\">Dinner</span>  <span class=\"mi\">3</span>     <span class=\"mf\">0.1605</span>\n<span class=\"mi\">3</span>  <span class=\"mf\">21.01</span>       <span class=\"mf\">3.5</span>   <span class=\"n\">Male</span>    <span class=\"n\">No</span>      <span class=\"n\">Sun</span>  <span class=\"n\">Dinner</span>  <span class=\"mi\">3</span>     <span class=\"mf\">0.1666</span>\n<span class=\"mi\">4</span>  <span class=\"mf\">23.68</span>       <span class=\"mf\">3.31</span>  <span class=\"n\">Male</span>    <span class=\"n\">No</span>      <span class=\"n\">Sun</span>  <span class=\"n\">Dinner</span>  <span class=\"mi\">2</span>     <span class=\"mf\">0.1398</span>\n<span class=\"mi\">5</span>  <span class=\"mf\">24.59</span>       <span class=\"mf\">3.61</span>  <span class=\"n\">Female</span>  <span class=\"n\">No</span>      <span class=\"n\">Sun</span>  <span class=\"n\">Dinner</span>  <span class=\"mi\">4</span>     <span class=\"mf\">0.1468</span>\n</code></pre></div>\n\n<p>Since most readers won't have rpy2, you can get the data file <a href=\"http://wesmckinney.com/files/tips.csv\" title=\"data\">here</a> and read it with:</p>\n<div class=\"github\"><pre><span></span><code>tips = read_csv(&#39;tips.csv&#39;)\n</code></pre></div>\n\n<p>All of this new functionality is available now on <a href=\"http://github.com/wesm/pandas\" title=\"GitHub\" target=\"_blank\">GitHub</a> but will be a part of the upcoming pandas 0.5.0 release. Note that I am <strong>only</strong> using rpy2 here to pull the R data set into my Python sesson— all of the below code is implemented in pure Python (with a little Cython magic to make things fast).</p>\n<h3>Pivot table basics</h3>\n<p>To use <code>pivot_table</code>, pass the pandas <code>DataFrame</code> and specify the column you wish to aggregate and the columns to group on the rows and columns of the table. Note the default aggregation is <strong>mean</strong>, though this can be specified:</p>\n<div class=\"github\"><pre><span></span><code>In [9]: table = pivot_table(tips, &#39;tip_pct&#39;, rows=[&#39;time&#39;, &#39;sex&#39;],\n                            cols=&#39;smoker&#39;)\n\nIn [10]: table\nOut[10]:\n  smoker       No      Yes\ntime   sex\nDinner Female  0.1568  0.1851\n       Male    0.1594  0.1489\nLunch  Female  0.1571  0.1753\n       Male    0.1657  0.1667\n\nIn [17]: pivot_table(tips, &#39;tip_pct&#39;, rows=[&#39;day&#39;, &#39;time&#39;],\n                     cols=&#39;sex&#39;)\nOut[17]:\n  sex        Female  Male\nday  time\nFri  Dinner  0.1991  0.1302\n     Lunch   0.1997  0.1741\nSat  Dinner  0.1565  0.1516\nSun  Dinner  0.1816  0.1623\nThur Dinner  0.1597  NaN\n     Lunch   0.1575  0.1653\n</code></pre></div>\n\n<p>Note that the returned object is still a <code>DataFrame</code>, so you can use all of the standard indexing technology to select portions of the resulting table:</p>\n<div class=\"github\"><pre><span></span><code>In [22]: table.ix[&#39;Dinner&#39;]\nOut[22]:\n  smoker  No      Yes\nsex\nFemale    0.1568  0.1851\nMale      0.1594  0.1489\n</code></pre></div>\n\n<p>If you don't specify a particular values column, it will try to aggregate all the other columns:</p>\n<div class=\"github\"><pre><span></span><code>In [24]: pivot_table(tips, rows=[&#39;sex&#39;, &#39;smoker&#39;])\nOut[24]:\n               size   tip    tip_pct  total_bill\nsex    smoker\nFemale No      2.593  2.774  0.1569   18.11\n       Yes     2.242  2.932  0.1822   17.98\nMale   No      2.711  3.113  0.1607   19.79\n       Yes     2.5    3.051  0.1528   22.28\n</code></pre></div>\n\n<p>Other aggregations can be performed, like using <code>len</code> to get group counts:</p>\n<div class=\"codecolorer-container python mac-classic\" style=\"overflow:auto;white-space:nowrap;\">\n  <div class=\"python codecolorer\">\n    In <span class=\"br0\">&#91;</span><span class=\"nu0\">26</span><span class=\"br0\">&#93;</span>: pivot_table<span class=\"br0\">&#40;</span>tips<span class=\"sy0\">,</span> <span class=\"st0\">'tip_pct'</span><span class=\"sy0\">,</span> rows<span class=\"sy0\">=</span><span class=\"st0\">'sex'</span><span class=\"sy0\">,</span> cols<span class=\"sy0\">=</span><span class=\"st0\">'smoker'</span><span class=\"sy0\">,</span> aggfunc<span class=\"sy0\">=</span><span class=\"kw2\">len</span><span class=\"br0\">&#41;</span><br /> Out<span class=\"br0\">&#91;</span><span class=\"nu0\">26</span><span class=\"br0\">&#93;</span>: <br /> &nbsp; smoker &nbsp;No &nbsp;Yes<br /> sex &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br /> Female &nbsp; &nbsp;<span class=\"nu0\">54</span> &nbsp;<span class=\"nu0\">33</span> <br /> Male &nbsp; &nbsp; &nbsp;<span class=\"nu0\">97</span> &nbsp;<span class=\"nu0\">60</span>\n  </div>\n</div>\n\n<p>Once you've done the aggregation, you're free to use the built-in <a href=\"http://pandas.sourceforge.net/reshaping.html#reshaping-by-stacking-and-unstacking\" title=\"Reshaping\" target=\"_blank\">reshaping capability</a> to reshape the data in the table:</p>\n<div class=\"github\"><pre><span></span><code><span class=\"n\">In</span> <span class=\"p\">[</span><span class=\"mi\">29</span><span class=\"p\">]:</span> <span class=\"n\">table</span> <span class=\"o\">=</span> <span class=\"n\">pivot_table</span><span class=\"p\">(</span><span class=\"n\">tips</span><span class=\"p\">,</span> <span class=\"s1\">&#39;tip_pct&#39;</span><span class=\"p\">,</span> <span class=\"n\">rows</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"s1\">&#39;sex&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;day&#39;</span><span class=\"p\">],</span>\n                             <span class=\"n\">cols</span><span class=\"o\">=</span><span class=\"s1\">&#39;smoker&#39;</span><span class=\"p\">,</span> <span class=\"n\">aggfunc</span><span class=\"o\">=</span><span class=\"nb\">len</span><span class=\"p\">)</span>\n\n<span class=\"n\">In</span> <span class=\"p\">[</span><span class=\"mi\">30</span><span class=\"p\">]:</span> <span class=\"n\">table</span>\n<span class=\"n\">Out</span><span class=\"p\">[</span><span class=\"mi\">30</span><span class=\"p\">]:</span>\n  <span class=\"n\">smoker</span>     <span class=\"n\">No</span>  <span class=\"n\">Yes</span>\n<span class=\"n\">sex</span>    <span class=\"n\">day</span>\n<span class=\"n\">Female</span> <span class=\"n\">Fri</span>   <span class=\"mi\">2</span>   <span class=\"mi\">7</span>\n       <span class=\"n\">Sat</span>   <span class=\"mi\">13</span>  <span class=\"mi\">15</span>\n       <span class=\"n\">Sun</span>   <span class=\"mi\">14</span>  <span class=\"mi\">4</span>\n       <span class=\"n\">Thur</span>  <span class=\"mi\">25</span>  <span class=\"mi\">7</span>\n<span class=\"n\">Male</span>   <span class=\"n\">Fri</span>   <span class=\"mi\">2</span>   <span class=\"mi\">8</span>\n       <span class=\"n\">Sat</span>   <span class=\"mi\">32</span>  <span class=\"mi\">27</span>\n       <span class=\"n\">Sun</span>   <span class=\"mi\">43</span>  <span class=\"mi\">15</span>\n       <span class=\"n\">Thur</span>  <span class=\"mi\">20</span>  <span class=\"mi\">10</span>\n\n<span class=\"n\">In</span> <span class=\"p\">[</span><span class=\"mi\">31</span><span class=\"p\">]:</span> <span class=\"n\">table</span><span class=\"o\">.</span><span class=\"n\">unstack</span><span class=\"p\">(</span><span class=\"s1\">&#39;sex&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">Out</span><span class=\"p\">[</span><span class=\"mi\">31</span><span class=\"p\">]:</span>\n  <span class=\"n\">smoker</span>  <span class=\"n\">No</span>            <span class=\"n\">Yes</span>\n  <span class=\"n\">sex</span>     <span class=\"n\">Female</span>  <span class=\"n\">Male</span>  <span class=\"n\">Female</span>  <span class=\"n\">Male</span>\n<span class=\"n\">day</span>\n<span class=\"n\">Fri</span>       <span class=\"mi\">2</span>       <span class=\"mi\">2</span>     <span class=\"mi\">7</span>       <span class=\"mi\">8</span>\n<span class=\"n\">Sat</span>       <span class=\"mi\">13</span>      <span class=\"mi\">32</span>    <span class=\"mi\">15</span>      <span class=\"mi\">27</span>\n<span class=\"n\">Sun</span>       <span class=\"mi\">14</span>      <span class=\"mi\">43</span>    <span class=\"mi\">4</span>       <span class=\"mi\">15</span>\n<span class=\"n\">Thur</span>      <span class=\"mi\">25</span>      <span class=\"mi\">20</span>    <span class=\"mi\">7</span>       <span class=\"mi\">10</span>\n</code></pre></div>\n\n<p>If you know a bit more about groupby, you can get clever and pass a dict of functions to perform multiple aggregations at once:</p>\n<div class=\"github\"><pre><span></span><code><span class=\"n\">In</span> <span class=\"p\">[</span><span class=\"mi\">59</span><span class=\"p\">]:</span> <span class=\"n\">pivot_table</span><span class=\"p\">(</span><span class=\"n\">tips</span><span class=\"p\">,</span> <span class=\"n\">rows</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"s1\">&#39;sex&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;smoker&#39;</span><span class=\"p\">],</span>\n                     <span class=\"n\">aggfunc</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s1\">&#39;tip_pct&#39;</span> <span class=\"p\">:</span> <span class=\"s1\">&#39;mean&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;size&#39;</span> <span class=\"p\">:</span> <span class=\"s1\">&#39;sum&#39;</span><span class=\"p\">})</span>\n<span class=\"n\">Out</span><span class=\"p\">[</span><span class=\"mi\">59</span><span class=\"p\">]:</span>\n               <span class=\"n\">size</span>  <span class=\"n\">tip_pct</span>\n<span class=\"n\">sex</span>    <span class=\"n\">smoker</span>\n<span class=\"n\">Female</span> <span class=\"n\">No</span>      <span class=\"mi\">140</span>   <span class=\"mf\">0.1569</span>\n       <span class=\"n\">Yes</span>     <span class=\"mi\">74</span>    <span class=\"mf\">0.1822</span>\n<span class=\"n\">Male</span>   <span class=\"n\">No</span>      <span class=\"mi\">263</span>   <span class=\"mf\">0.1607</span>\n       <span class=\"n\">Yes</span>     <span class=\"mi\">150</span>   <span class=\"mf\">0.1528</span>\n</code></pre></div>\n\n<p>I thought that was pretty cool.</p>\n<h3>Comparison with reshape2</h3>\n<p>R's reshape2 package relies on two functions, <code>melt</code> and <code>cast</code>, to do the reshaping. Its implementation is, at least in my opinion, a <em>slightly</em> more ad hoc approach than in pandas (the actual <code>pivot_table</code> function is only about 10 lines and basically falls out of the groupby and hierarchical-indexing based reshaping). However, it can take advantage of R's built-in formulas which makes the syntax very intuitive. Here are some of the same examples using reshape2:</p>\n<div class=\"github\"><pre><span></span><code><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">tips</span><span class=\"o\">$</span><span class=\"n\">tip</span><span class=\"o\">.</span><span class=\"n\">pct</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">tips</span><span class=\"o\">$</span><span class=\"n\">tip</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"n\">tips</span><span class=\"o\">$</span><span class=\"n\">total_bill</span><span class=\"w\"></span>\n<span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">mtips</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">melt</span><span class=\"p\">(</span><span class=\"n\">tips</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">=</span><span class=\"n\">c</span><span class=\"p\">(</span><span class=\"s2\">&quot;sex&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">&quot;smoker&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">&quot;day&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">&quot;time&quot;</span><span class=\"p\">))</span><span class=\"w\"></span>\n<span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">acast</span><span class=\"p\">(</span><span class=\"n\">mtips</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">day</span><span class=\"w\"> </span><span class=\"o\">~</span><span class=\"w\"> </span><span class=\"n\">sex</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">smoker</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">length</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">subset</span><span class=\"o\">=.</span><span class=\"p\">(</span><span class=\"n\">variable</span><span class=\"o\">==</span><span class=\"s2\">&quot;tip&quot;</span><span class=\"p\">))</span><span class=\"w\"></span>\n<span class=\"w\">     </span><span class=\"n\">Female_No</span><span class=\"w\"> </span><span class=\"n\">Female_Yes</span><span class=\"w\"> </span><span class=\"n\">Male_No</span><span class=\"w\"> </span><span class=\"n\">Male_Yes</span><span class=\"w\"></span>\n<span class=\"n\">Fri</span><span class=\"w\">          </span><span class=\"mi\">2</span><span class=\"w\">          </span><span class=\"mi\">7</span><span class=\"w\">       </span><span class=\"mi\">2</span><span class=\"w\">        </span><span class=\"mi\">8</span><span class=\"w\"></span>\n<span class=\"n\">Sat</span><span class=\"w\">         </span><span class=\"mi\">13</span><span class=\"w\">         </span><span class=\"mi\">15</span><span class=\"w\">      </span><span class=\"mi\">32</span><span class=\"w\">       </span><span class=\"mi\">27</span><span class=\"w\"></span>\n<span class=\"n\">Sun</span><span class=\"w\">         </span><span class=\"mi\">14</span><span class=\"w\">          </span><span class=\"mi\">4</span><span class=\"w\">      </span><span class=\"mi\">43</span><span class=\"w\">       </span><span class=\"mi\">15</span><span class=\"w\"></span>\n<span class=\"n\">Thur</span><span class=\"w\">        </span><span class=\"mi\">25</span><span class=\"w\">          </span><span class=\"mi\">7</span><span class=\"w\">      </span><span class=\"mi\">20</span><span class=\"w\">       </span><span class=\"mi\">10</span><span class=\"w\"></span>\n\n<span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">acast</span><span class=\"p\">(</span><span class=\"n\">mtips</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">sex</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">smoker</span><span class=\"w\"> </span><span class=\"o\">~</span><span class=\"w\"> </span><span class=\"n\">variable</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">mean</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">           </span><span class=\"n\">total_bill</span><span class=\"w\">      </span><span class=\"n\">tip</span><span class=\"w\">     </span><span class=\"n\">size</span><span class=\"w\">   </span><span class=\"n\">tip</span><span class=\"o\">.</span><span class=\"n\">pct</span><span class=\"w\"></span>\n<span class=\"n\">Female_No</span><span class=\"w\">    </span><span class=\"mf\">18.10519</span><span class=\"w\"> </span><span class=\"mf\">2.773519</span><span class=\"w\"> </span><span class=\"mf\">2.592593</span><span class=\"w\"> </span><span class=\"mf\">0.1569210</span><span class=\"w\"></span>\n<span class=\"n\">Female_Yes</span><span class=\"w\">   </span><span class=\"mf\">17.97788</span><span class=\"w\"> </span><span class=\"mf\">2.931515</span><span class=\"w\"> </span><span class=\"mf\">2.242424</span><span class=\"w\"> </span><span class=\"mf\">0.1821504</span><span class=\"w\"></span>\n<span class=\"n\">Male_No</span><span class=\"w\">      </span><span class=\"mf\">19.79124</span><span class=\"w\"> </span><span class=\"mf\">3.113402</span><span class=\"w\"> </span><span class=\"mf\">2.711340</span><span class=\"w\"> </span><span class=\"mf\">0.1606687</span><span class=\"w\"></span>\n<span class=\"n\">Male_Yes</span><span class=\"w\">     </span><span class=\"mf\">22.28450</span><span class=\"w\"> </span><span class=\"mf\">3.051167</span><span class=\"w\"> </span><span class=\"mf\">2.500000</span><span class=\"w\"> </span><span class=\"mf\">0.1527712</span><span class=\"w\"></span>\n</code></pre></div>\n\n<p>R lacks hierarchical indexing as far as I know, so reshape2 munges the group labels together into a row label.</p>\n<p>In R there is also the <code>xtabs</code> function for doing cross-tabulation:</p>\n<div class=\"github\"><pre><span></span><code>&gt; ftable(xtabs(size ~ time + sex + smoker + day, data=tips))\n                     day Fri Sat Sun Thur\ntime   sex    smoker\nDinner Female No           2  30  43    2\n              Yes          8  33  10    0\n       Male   No           4  85 124    0\n              Yes         12  71  39    0\nLunch  Female No           3   0   0   60\n              Yes          6   0   0   17\n       Male   No           0   0   0   50\n              Yes          5   0   0   23\n</code></pre></div>\n\n<p><code>ftable</code> just creates a flat table which can be more easily viewed. This table could be created with pandas by:</p>\n<div class=\"github\"><pre><span></span><code>In [54]: pivot_table(tips, &#39;size&#39;, rows=[&#39;time&#39;, &#39;sex&#39;, &#39;smoker&#39;],\n   ....:             cols=&#39;day&#39;, aggfunc=np.sum, fill_value=0)\nOut[54]:\n  day                 Fri  Sat  Sun  Thur\ntime   sex    smoker\nDinner Female No      2    30   43   2\n              Yes     8    33   10   0\nDinner Male   No      4    85   124  0\n              Yes     12   71   39   0\nLunch  Female No      3    0    0    60\n              Yes     6    0    0    17\nLunch  Male   No      0    0    0    50\n              Yes     5    0    0    23\n</code></pre></div>\n\n<h3>Performance</h3>\n<p>pandas is very fast as I've invested a great deal in optimizing the indexing infrastructure and other core algorithms related to things such as this. I don't have a lot of points of comparison, but here is a simple benchmark of reshape2 versus <code>pandas.pivot_table</code> on a data set with 100000 entries and 25 groups. Here is the R code for the benchmark:</p>\n<div class=\"github\"><pre><span></span><code><span class=\"n\">library</span><span class=\"p\">(</span><span class=\"n\">reshape2</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"mi\">100000</span><span class=\"w\"></span>\n<span class=\"n\">a</span><span class=\"p\">.</span><span class=\"k\">size</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"></span>\n<span class=\"n\">b</span><span class=\"p\">.</span><span class=\"k\">size</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"></span>\n<span class=\"k\">data</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"k\">data</span><span class=\"p\">.</span><span class=\"n\">frame</span><span class=\"p\">(</span><span class=\"n\">a</span><span class=\"o\">=</span><span class=\"n\">sample</span><span class=\"p\">(</span><span class=\"n\">letters</span><span class=\"o\">[</span><span class=\"n\">1:a.size</span><span class=\"o\">]</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nf\">replace</span><span class=\"o\">=</span><span class=\"n\">T</span><span class=\"p\">),</span><span class=\"w\"></span>\n<span class=\"w\">                   </span><span class=\"n\">b</span><span class=\"o\">=</span><span class=\"n\">sample</span><span class=\"p\">(</span><span class=\"n\">letters</span><span class=\"o\">[</span><span class=\"n\">1:b.size</span><span class=\"o\">]</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nf\">replace</span><span class=\"o\">=</span><span class=\"n\">T</span><span class=\"p\">),</span><span class=\"w\"></span>\n<span class=\"w\">                   </span><span class=\"n\">c</span><span class=\"o\">=</span><span class=\"n\">rnorm</span><span class=\"p\">(</span><span class=\"n\">n</span><span class=\"p\">),</span><span class=\"w\"></span>\n<span class=\"w\">                   </span><span class=\"n\">d</span><span class=\"o\">=</span><span class=\"n\">rnorm</span><span class=\"p\">(</span><span class=\"n\">n</span><span class=\"p\">))</span><span class=\"w\"></span>\n<span class=\"n\">timings</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"nc\">numeric</span><span class=\"p\">()</span><span class=\"w\"></span>\n\n<span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"ow\">in</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"err\">:</span><span class=\"mi\">10</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"err\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">gc</span><span class=\"p\">()</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">tim</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"k\">system</span><span class=\"p\">.</span><span class=\"nc\">time</span><span class=\"p\">(</span><span class=\"n\">acast</span><span class=\"p\">(</span><span class=\"n\">melt</span><span class=\"p\">(</span><span class=\"k\">data</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">=</span><span class=\"n\">c</span><span class=\"p\">(</span><span class=\"ss\">&quot;a&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"ss\">&quot;b&quot;</span><span class=\"p\">)),</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">~</span><span class=\"w\"> </span><span class=\"k\">variable</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">mean</span><span class=\"p\">))</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"n\">timings</span><span class=\"o\">[</span><span class=\"n\">i</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tim</span><span class=\"o\">[</span><span class=\"n\">3</span><span class=\"o\">]</span><span class=\"w\"></span>\n<span class=\"err\">}</span><span class=\"w\"></span>\n<span class=\"n\">mean</span><span class=\"p\">(</span><span class=\"n\">timings</span><span class=\"p\">)</span><span class=\"w\"></span>\n</code></pre></div>\n\n<p>Here is what the actual table looks like:</p>\n<div class=\"github\"><pre><span></span><code><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">table</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">acast</span><span class=\"p\">(</span><span class=\"n\">melt</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">=</span><span class=\"n\">c</span><span class=\"p\">(</span><span class=\"s2\">&quot;a&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">&quot;b&quot;</span><span class=\"p\">)),</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">~</span><span class=\"w\"> </span><span class=\"n\">variable</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">mean</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">head</span><span class=\"p\">(</span><span class=\"n\">table</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">               </span><span class=\"n\">c</span><span class=\"w\">            </span><span class=\"n\">d</span><span class=\"w\"></span>\n<span class=\"n\">a_a</span><span class=\"w\">  </span><span class=\"mf\">0.002761963</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"mf\">0.008793516</span><span class=\"w\"></span>\n<span class=\"n\">a_b</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"mf\">0.004618980</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"mf\">0.026978744</span><span class=\"w\"></span>\n<span class=\"n\">a_c</span><span class=\"w\">  </span><span class=\"mf\">0.022491767</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"mf\">0.002163986</span><span class=\"w\"></span>\n<span class=\"n\">a_d</span><span class=\"w\">  </span><span class=\"mf\">0.005027362</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"mf\">0.002532782</span><span class=\"w\"></span>\n<span class=\"n\">a_e</span><span class=\"w\">  </span><span class=\"mf\">0.006146438</span><span class=\"w\">  </span><span class=\"mf\">0.031699238</span><span class=\"w\"></span>\n<span class=\"n\">b_a</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"mf\">0.025094899</span><span class=\"w\">  </span><span class=\"mf\">0.003334301</span><span class=\"w\"></span>\n</code></pre></div>\n\n<p>Here's the equivalent Python code (sans timings, which I'll do in IPython):</p>\n<div class=\"github\"><pre><span></span><code><span class=\"kn\">from</span> <span class=\"nn\">pandas</span> <span class=\"kn\">import</span> <span class=\"o\">*</span>\n<span class=\"kn\">import</span> <span class=\"nn\">string</span>\n<span class=\"n\">n</span> <span class=\"o\">=</span> <span class=\"mi\">100000</span>\n<span class=\"n\">asize</span> <span class=\"o\">=</span> <span class=\"mi\">5</span>\n<span class=\"n\">bsize</span> <span class=\"o\">=</span> <span class=\"mi\">5</span>\n\n<span class=\"n\">letters</span> <span class=\"o\">=</span> <span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">asarray</span><span class=\"p\">(</span><span class=\"nb\">list</span><span class=\"p\">(</span><span class=\"n\">string</span><span class=\"o\">.</span><span class=\"n\">letters</span><span class=\"p\">),</span> <span class=\"n\">dtype</span><span class=\"o\">=</span><span class=\"nb\">object</span><span class=\"p\">)</span>\n\n<span class=\"n\">data</span> <span class=\"o\">=</span> <span class=\"n\">DataFrame</span><span class=\"p\">(</span><span class=\"nb\">dict</span><span class=\"p\">(</span><span class=\"n\">foo</span><span class=\"o\">=</span><span class=\"n\">letters</span><span class=\"p\">[:</span><span class=\"n\">asize</span><span class=\"p\">][</span><span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">random</span><span class=\"o\">.</span><span class=\"n\">randint</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">asize</span><span class=\"p\">,</span> <span class=\"n\">n</span><span class=\"p\">)],</span>\n                      <span class=\"n\">bar</span><span class=\"o\">=</span><span class=\"n\">letters</span><span class=\"p\">[:</span><span class=\"n\">bsize</span><span class=\"p\">][</span><span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">random</span><span class=\"o\">.</span><span class=\"n\">randint</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">bsize</span><span class=\"p\">,</span> <span class=\"n\">n</span><span class=\"p\">)],</span>\n                      <span class=\"n\">baz</span><span class=\"o\">=</span><span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">random</span><span class=\"o\">.</span><span class=\"n\">randn</span><span class=\"p\">(</span><span class=\"n\">n</span><span class=\"p\">),</span>\n                      <span class=\"n\">qux</span><span class=\"o\">=</span><span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">random</span><span class=\"o\">.</span><span class=\"n\">randn</span><span class=\"p\">(</span><span class=\"n\">n</span><span class=\"p\">)))</span>\n\n<span class=\"n\">table</span> <span class=\"o\">=</span> <span class=\"n\">pivot_table</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">rows</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"s1\">&#39;foo&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;bar&#39;</span><span class=\"p\">])</span>\n</code></pre></div>\n\n<p>Similarly:</p>\n<div class=\"github\"><pre><span></span><code>In [36]: table = pivot_table(data, rows=[&#39;foo&#39;, &#39;bar&#39;])\n\nIn [37]: table[:10]\nOut[37]:\n         baz       qux\nfoo bar\na   a   -0.02162   0.02186\n    b   -0.002155  0.01173\n    c   -0.002331  0.006608\n    d   -0.01734   0.01109\n    e    0.02837   0.01093\nb   a    0.01703  -0.005845\n    b   -0.001043  0.01283\n    c   -0.006015 -0.0005866\n    d    0.009683  0.02211\n    e    0.02347  -8.346e-05\n</code></pre></div>\n\n<p>And the R timing</p>\n<div class=\"github\"><pre><span></span><code>&gt; mean(timings)\n[1] 0.42\n</code></pre></div>\n\n<p>And pandas:</p>\n<div class=\"github\"><pre><span></span><code><span class=\"nv\">In</span> [<span class=\"mi\">38</span>]: <span class=\"nv\">timeit</span> <span class=\"nv\">table</span> <span class=\"o\">=</span> <span class=\"nv\">pivot_table</span><span class=\"ss\">(</span><span class=\"nv\">data</span>, <span class=\"nv\">rows</span><span class=\"o\">=</span>[<span class=\"s1\">&#39;</span><span class=\"s\">foo</span><span class=\"s1\">&#39;</span>, <span class=\"s1\">&#39;</span><span class=\"s\">bar</span><span class=\"s1\">&#39;</span>]<span class=\"ss\">)</span>\n<span class=\"mi\">10</span> <span class=\"nv\">loops</span>, <span class=\"nv\">best</span> <span class=\"nv\">of</span> <span class=\"mi\">3</span>: <span class=\"mi\">117</span> <span class=\"nv\">ms</span> <span class=\"nv\">per</span> <span class=\"k\">loop</span>\n</code></pre></div>\n\n<p>So it's about 3-4x faster than reshape2. This obviously depends on the data set and how you structure the aggregation. Here's a couple slightly different benchmarks on the same data:</p>\n<div class=\"github\"><pre><span></span><code><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">acast</span><span class=\"p\">(</span><span class=\"n\">melt</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">id</span><span class=\"o\">=</span><span class=\"n\">c</span><span class=\"p\">(</span><span class=\"s2\">&quot;a&quot;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">&quot;b&quot;</span><span class=\"p\">)),</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">~</span><span class=\"n\">b</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">mean</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">subset</span><span class=\"o\">=.</span><span class=\"p\">(</span><span class=\"n\">variable</span><span class=\"o\">==</span><span class=\"s2\">&quot;c&quot;</span><span class=\"p\">))</span><span class=\"w\"></span>\n<span class=\"w\">             </span><span class=\"n\">a</span><span class=\"w\">            </span><span class=\"n\">b</span><span class=\"w\">            </span><span class=\"n\">c</span><span class=\"w\">           </span><span class=\"n\">d</span><span class=\"w\">            </span><span class=\"n\">e</span><span class=\"w\"></span>\n<span class=\"n\">a</span><span class=\"w\">  </span><span class=\"mf\">0.002761963</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"mf\">0.004618980</span><span class=\"w\">  </span><span class=\"mf\">0.022491767</span><span class=\"w\"> </span><span class=\"mf\">0.005027362</span><span class=\"w\">  </span><span class=\"mf\">0.006146438</span><span class=\"w\"></span>\n<span class=\"n\">b</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"mf\">0.025094899</span><span class=\"w\">  </span><span class=\"mf\">0.015966167</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"mf\">0.007663059</span><span class=\"w\"> </span><span class=\"mf\">0.006795551</span><span class=\"w\">  </span><span class=\"mf\">0.006648496</span><span class=\"w\"></span>\n<span class=\"n\">c</span><span class=\"w\">  </span><span class=\"mf\">0.012273797</span><span class=\"w\">  </span><span class=\"mf\">0.006139820</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"mf\">0.019169968</span><span class=\"w\"> </span><span class=\"mf\">0.009035374</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"mf\">0.006079683</span><span class=\"w\"></span>\n<span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"mf\">0.014174747</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"mf\">0.009844566</span><span class=\"w\">  </span><span class=\"mf\">0.022450738</span><span class=\"w\"> </span><span class=\"mf\">0.025967638</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"mf\">0.006572791</span><span class=\"w\"></span>\n<span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"mf\">0.003623382</span><span class=\"w\">  </span><span class=\"mf\">0.005924704</span><span class=\"w\">  </span><span class=\"mf\">0.008156482</span><span class=\"w\"> </span><span class=\"mf\">0.013288116</span><span class=\"w\">  </span><span class=\"mf\">0.009839315</span><span class=\"w\"></span>\n\n<span class=\"n\">Timing</span><span class=\"w\"></span>\n<span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">mean</span><span class=\"p\">(</span><span class=\"n\">timings</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"mf\">0.3036</span><span class=\"w\"></span>\n</code></pre></div>\n\n<p>and pandas:</p>\n<div class=\"github\"><pre><span></span><code><span class=\"nv\">In</span> [<span class=\"mi\">41</span>]: <span class=\"nv\">pivot_table</span><span class=\"ss\">(</span><span class=\"nv\">data</span>, <span class=\"s1\">&#39;</span><span class=\"s\">baz</span><span class=\"s1\">&#39;</span>, <span class=\"nv\">rows</span><span class=\"o\">=</span><span class=\"s1\">&#39;</span><span class=\"s\">foo</span><span class=\"s1\">&#39;</span>, <span class=\"nv\">cols</span><span class=\"o\">=</span><span class=\"s1\">&#39;</span><span class=\"s\">bar</span><span class=\"s1\">&#39;</span><span class=\"ss\">)</span>\n<span class=\"nv\">Out</span>[<span class=\"mi\">41</span>]:\n  <span class=\"nv\">bar</span>  <span class=\"nv\">a</span>         <span class=\"nv\">b</span>          <span class=\"nv\">c</span>         <span class=\"nv\">d</span>         <span class=\"nv\">e</span>\n<span class=\"nv\">foo</span>\n<span class=\"nv\">a</span>     <span class=\"o\">-</span><span class=\"mi\">0</span>.<span class=\"mi\">02162</span>  <span class=\"o\">-</span><span class=\"mi\">0</span>.<span class=\"mi\">002155</span>  <span class=\"o\">-</span><span class=\"mi\">0</span>.<span class=\"mi\">002331</span> <span class=\"o\">-</span><span class=\"mi\">0</span>.<span class=\"mi\">01734</span>   <span class=\"mi\">0</span>.<span class=\"mi\">02837</span>\n<span class=\"nv\">b</span>      <span class=\"mi\">0</span>.<span class=\"mi\">01703</span>  <span class=\"o\">-</span><span class=\"mi\">0</span>.<span class=\"mi\">001043</span>  <span class=\"o\">-</span><span class=\"mi\">0</span>.<span class=\"mi\">006015</span>  <span class=\"mi\">0</span>.<span class=\"mi\">009683</span>  <span class=\"mi\">0</span>.<span class=\"mi\">02347</span>\n<span class=\"nv\">c</span>      <span class=\"mi\">0</span>.<span class=\"mi\">01561</span>   <span class=\"mi\">0</span>.<span class=\"mi\">0003992</span>  <span class=\"mi\">0</span>.<span class=\"mi\">01451</span>  <span class=\"o\">-</span><span class=\"mi\">0</span>.<span class=\"mi\">01046</span>  <span class=\"o\">-</span><span class=\"mi\">0</span>.<span class=\"mi\">00368</span>\n<span class=\"nv\">d</span>      <span class=\"mi\">0</span>.<span class=\"mi\">003504</span> <span class=\"o\">-</span><span class=\"mi\">0</span>.<span class=\"mi\">01437</span>   <span class=\"o\">-</span><span class=\"mi\">0</span>.<span class=\"mi\">03265</span>   <span class=\"mi\">0</span>.<span class=\"mi\">003471</span> <span class=\"o\">-</span><span class=\"mi\">0</span>.<span class=\"mi\">004638</span>\n<span class=\"nv\">e</span>     <span class=\"o\">-</span><span class=\"mi\">0</span>.<span class=\"mi\">01656</span>  <span class=\"o\">-</span><span class=\"mi\">0</span>.<span class=\"mi\">01276</span>   <span class=\"o\">-</span><span class=\"mi\">0</span>.<span class=\"mi\">02481</span>   <span class=\"mi\">0</span>.<span class=\"mi\">008629</span>  <span class=\"mi\">0</span>.<span class=\"mi\">011</span>\n\n<span class=\"nv\">In</span> [<span class=\"mi\">42</span>]: <span class=\"nv\">timeit</span> <span class=\"nv\">pivot_table</span><span class=\"ss\">(</span><span class=\"nv\">data</span>, <span class=\"s1\">&#39;</span><span class=\"s\">baz</span><span class=\"s1\">&#39;</span>, <span class=\"nv\">rows</span><span class=\"o\">=</span><span class=\"s1\">&#39;</span><span class=\"s\">foo</span><span class=\"s1\">&#39;</span>, <span class=\"nv\">cols</span><span class=\"o\">=</span><span class=\"s1\">&#39;</span><span class=\"s\">bar</span><span class=\"s1\">&#39;</span><span class=\"ss\">)</span>\n<span class=\"mi\">10</span> <span class=\"nv\">loops</span>, <span class=\"nv\">best</span> <span class=\"nv\">of</span> <span class=\"mi\">3</span>: <span class=\"mi\">55</span> <span class=\"nv\">ms</span> <span class=\"nv\">per</span> <span class=\"k\">loop</span>\n</code></pre></div>\n\n<p>I suspect one source of slowdown reshape/reshape2 approach is that the <code>melt</code> operation is very expensive, as is variable subsetting. However, it enables easier computation of group margins, something which I have not yet addressed (but will, eventually) in pandas.</p>"
}