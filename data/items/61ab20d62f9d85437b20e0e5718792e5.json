{
  "title": "Histogram intersection for change detection",
  "link": "http://blog.datadive.net/histogram-intersection-for-change-detection/",
  "comments": "http://blog.datadive.net/histogram-intersection-for-change-detection/#comments",
  "dc:creator": "ando",
  "pubDate": "Sun, 28 Feb 2016 15:12:51 +0000",
  "category": [
    "Change detection",
    "Data science"
  ],
  "guid": "http://blog.datadive.net/?p=4051",
  "description": "The need for anomaly and change detection will pop up in almost any data driven system or quality monitoring application. Typically, there are set of metrics that need to be monitored and an alert raised if the values deviate from &#8230; <a href=\"http://blog.datadive.net/histogram-intersection-for-change-detection/\">Continue reading <span class=\"meta-nav\">&#8594;</span></a>",
  "content:encoded": "\n<p>The need for anomaly and change detection will pop up in almost any data driven system or quality monitoring application. Typically, there are set of metrics that need to be monitored and an alert raised if the values deviate from the expected. Depending on the task at hand, this can happen at individual datapoint level (anomaly detection) or population level where we want to know if the underlying distribution changes or not (change detection).</p>\n\n\n\n<p>The latter is most commonly tackled by the most straightforward: calculating some point estimates, typically the mean or median and track these. This could be time based such as calculating the daily mean, or be based on some unit of &#8220;work done&#8221; such as for batches in a production line or versions in software product. The calculated point estimates can be displayed on dashboards to be checked visually or a delta computed between consequtive numbers, which can be compared against some pre-defined threshold to see if an alarm should be raised.</p>\n\n\n\n<p>The problem with such point estimates is that they don&#8217;t necessarily capture the change in the underlying distribution of the tracked measure well. A change in the distribution can be signficicant while the mean or the median remains unchanged.</p>\n\n\n\n<p>In cases when change needs to be detected, measuring it directly on the distribution is typically a much better option.</p>\n\n\n\n<h2>Histogram intersection</h2>\n\n\n\n<p>Histogram intersection calculates the similarity of two discretized probability distributions (histograms), with possible value of the intersection lying between 0 (no overlap) and 1 (identical distributions). Given bin edges and two normalized histogram, it can be calculated by</p>\n\n\n<div class=\"wp-block-syntaxhighlighter-code \"><pre class=\"brush: python; title: ; notranslate\">\ndef histogram_intersection(h1, h2, bins):\n    bins = numpy.diff(bins)\n    sm = 0\n    for i in range(len(bins)):\n        sm += min(bins&#091;i]*h1&#091;i], bins&#091;i]*h2&#091;i])\n    return sm\n</pre></div>\n\n\n<p>For example for the two distributions \\(\\mathcal{N}(2,1)\\) and \\(\\mathcal{N}(3,1.5)\\), the intersection is ~0.66, easy to represent graphically<br><a href=\"http://blog.datadive.net/wp-content/uploads/2016/02/intersect.png\"><img loading=\"lazy\" class=\"alignnone size-full wp-image-4071\" src=\"http://blog.datadive.net/wp-content/uploads/2016/02/intersect.png\" alt=\"intersect\" width=\"551\" height=\"313\" srcset=\"http://blog.datadive.net/wp-content/uploads/2016/02/intersect.png 551w, http://blog.datadive.net/wp-content/uploads/2016/02/intersect-300x170.png 300w\" sizes=\"(max-width: 551px) 100vw, 551px\" /></a></p>\n\n\n\n<p>Histogram intersection has a few extra benefits:</p>\n\n\n\n<ul><li>It works equally well on categorical data, where we can use category frequencies to compute the intersection</li><li>Dealing with null values comes for free, simply by making nulls part of the distribution: if there is an increase in nulls, it changes the intersection, even if non-null values will continue to be distributed the same way. In contrast, when tracking point estimates such as the mean, null value checks need to be explicitly added as an additional item to track.</li></ul>\n\n\n\n<p>As always, there are some caveats. One issue is that the intersection depends on how the bins have been selected. This becomes an issue especially for long tailed distributions. For example for the lognormal distribution, with same \\(\\mu\\) and \\(\\sigma\\) as above, the histogram might look something like the following, with practically all density concentrated in the first bin. Calculating the intersection on that would clearly give very misleading results.<br><a href=\"http://blog.datadive.net/wp-content/uploads/2016/02/intersect2.png\"><img loading=\"lazy\" class=\"alignnone size-full wp-image-4081\" src=\"http://blog.datadive.net/wp-content/uploads/2016/02/intersect2.png\" alt=\"intersect2\" width=\"561\" height=\"312\" srcset=\"http://blog.datadive.net/wp-content/uploads/2016/02/intersect2.png 561w, http://blog.datadive.net/wp-content/uploads/2016/02/intersect2-300x167.png 300w\" sizes=\"(max-width: 561px) 100vw, 561px\" /></a></p>\n\n\n\n<p>This can be tackled by either moving the histogram to log-scale, or simply by clipping the long tail to use it as an approximtion. For this particular examples clipping gives the same result as the &#8220;true&#8221; intersection calculted in log scale.</p>\n\n\n\n<figure class=\"wp-block-image\"><a href=\"http://blog.datadive.net/wp-content/uploads/2016/02/intersect3.png\"><img loading=\"lazy\" width=\"565\" height=\"318\" src=\"http://blog.datadive.net/wp-content/uploads/2016/02/intersect3.png\" alt=\"intersect3\" class=\"wp-image-4091\" srcset=\"http://blog.datadive.net/wp-content/uploads/2016/02/intersect3.png 565w, http://blog.datadive.net/wp-content/uploads/2016/02/intersect3-300x169.png 300w\" sizes=\"(max-width: 565px) 100vw, 565px\" /></a></figure>\n\n\n\n<h3>Kullback-Leibler divergence and statistical tests</h3>\n\n\n\n<p>Two methods often recommended for detecting change in distribution are <a href=\"https://en.wikipedia.org/wiki/Kullback%E2%80%93Leibler_divergence\">Kullback-Leibler divergence</a> and statistical tests, for example a chi-squared test which could be used both on categorical data and a histogram of continous data. Both of the methods have significant drawbacks however.</p>\n\n\n\n<p>Kullback-Leibler divergence is measured in bits and unlike histogram intersection, does not lie in a given range. This makes comparison on two different dataset difficult. Secondly, it is only defined when zeroes in the distributions lie in the same bins. Ths can be overcome by transferrning some of the probability mass to locations with zero probability, however, this is another extra complexity that needs to be handled. Finally, KL divergence is not a true metric, i.e. it does not obey triangle inequality, and is non-symmetric, i.e. in general, when comparing two different distributions \\(P\\) and \\(Q\\), \\(KL(P,Q) \\neq KL(Q,P)\\).</p>\n\n\n\n<p>Using a statistical test, for example a chi-squared test might seem like a good option, since it gives you a p-value you can use to estimate how likely it is that the distribution has changed. The problem is that the p-value of a test is a function of the size of the data, so we can obtain tiny p-values with very small differences in the distributions. In the following, we are comparing \\(\\mathcal{N}(0,1)\\) and \\(\\mathcal{N}(0.005,1)\\) in the first plot, and \\(\\mathcal{N}(0,1)\\) and \\(\\mathcal{N}(1,1)\\) in the second plot.<br><a href=\"http://blog.datadive.net/wp-content/uploads/2016/02/intersect4.png\"><img loading=\"lazy\" class=\"alignnone size-full wp-image-4171\" src=\"http://blog.datadive.net/wp-content/uploads/2016/02/intersect4.png\" alt=\"intersect4\" width=\"753\" height=\"322\" srcset=\"http://blog.datadive.net/wp-content/uploads/2016/02/intersect4.png 753w, http://blog.datadive.net/wp-content/uploads/2016/02/intersect4-300x128.png 300w\" sizes=\"(max-width: 753px) 100vw, 753px\" /></a></p>\n\n\n\n<p>In both cases, we have tiny p-values, in fact it is even smaller for the first plot. From practical point of view, the change in the first case is likely irrelevant, since the absolute change is so small.</p>\n\n\n\n<p>A chi-squared test can of course still be very useful and complement the histogram intersection, by letting us know if the amount of data is small enough that measuring the intersection likely won&#8217;t give meaningful results.</p>\n\n\n\n<h3>Beyond histogram intersection</h3>\n\n\n\n<p>One drawback of histogram intersection is that it does not consider distances between bins, which can be important in case of ordinal data.</p>\n\n\n\n<p>For example, consider the following plot with three different histograms. Histogram intersection between histograms 1 and 2, and 1 and 3 are the same. However, assuming it is ordinal data, we might want to say that histgorams 1 and 2 are actually more similar to each other, since the changed bins are closer to each other than the change between 1 and 3.<br><a href=\"http://blog.datadive.net/wp-content/uploads/2016/02/intersect51.png\"><img loading=\"lazy\" class=\"alignnone size-full wp-image-4421\" src=\"http://blog.datadive.net/wp-content/uploads/2016/02/intersect51.png\" alt=\"intersect5\" width=\"719\" height=\"317\" srcset=\"http://blog.datadive.net/wp-content/uploads/2016/02/intersect51.png 719w, http://blog.datadive.net/wp-content/uploads/2016/02/intersect51-300x132.png 300w\" sizes=\"(max-width: 719px) 100vw, 719px\" /></a></p>\n\n\n\n<p>There are various methods to take this into account, the most well known being <a href=\"https://en.wikipedia.org/wiki/Earth_mover's_distance\">earth mover&#8217;s distance</a>. There is a nice overview of these methods <a href=\"http://www.ariel.ac.il/sites/ofirpele/publications/ECCV2010.pdf\">here</a>.</p>\n<div style=\"padding-top:0px;\t\npadding-right:0px;\npadding-bottom:0px;\npadding-left:0px;\nmargin-top:0px;\nmargin-right:0px;\nmargin-bottom:0px;\nmargin-left:0px;\"><a href=\"https://twitter.com/crossentropy\" class=\"twitter-follow-button\" \n\t\t\t\t\t\tdata-show-count=\"false\"\n\t\t\t\t\t\tdata-lang=\"autoLANGauto\"\n\t\t\t\t\t\tdata-width=\"250px\"\n\t\t\t\t\t\tdata-align=\"left\"\n\t\t\t\t\t\tdata-show-screen-name=\"true\"\n\t\t\t\t\t\tdata-size=\"medium\"\n\t\t\t\t\t\tdata-dnt=\"false\">\n\t\t\t\t\t\tFollow @crossentropy </a> </div>\n\t\t\t\t\t\t<script>\n\t\t\t\t\t\t!function(d,s,id) {\n\t\t\t\t\t\t  var js,fjs=d.getElementsByTagName(s)[0];\n\t\t\t\t\t\t  if(!d.getElementById(id)) {\n\t\t\t\t\t\t   js=d.createElement(s);\n\t\t\t\t\t\t   js.id=id;js.src=\"//platform.twitter.com/widgets.js\";\n\t\t\t\t\t\t   fjs.parentNode.insertBefore(js,fjs);\n\t\t\t\t\t\t  }\n\t\t\t\t\t\t}\n\t\t\t\t\t\t(document,\"script\",\"twitter-wjs\");\n\t\t\t\t\t\t</script><div style=\"padding-top:0px;\t\npadding-right:0px;\npadding-bottom:0px;\npadding-left:0px;\nmargin-top:0px;\nmargin-right:0px;\nmargin-bottom:0px;\nmargin-left:0px;\"><a href=\"https://twitter.com/share\" class=\"twitter-share-button\" \n\t\t\t\t        data-url=\"http://blog.datadive.net/histogram-intersection-for-change-detection/\" \n\t\t\t\t        data-via=\"crossentropy\"\n\t\t\t\t\t    data-text=\"Histogram intersection for change detection\"\n\t\t\t\t\t    data-related=\"\"\n\t\t\t\t\t    data-count=\"horizontal\"\n\t\t\t\t\t    data-hashtags=\"\"\n\t\t\t\t\t    data-lang=\"autoLANGauto\"\n\t\t\t\t\t    data-counturl=\"\"\n\t\t\t\t\t    data-size=\"medium\"\n\t\t\t\t\t    data-dnt=\"false\"\t> Tweet </a> </div>\n\t\t                <script>\n\t\t\t\t\t    !function(d,s,id) {\n\t\t\t\t\t      var js,fjs=d.getElementsByTagName(s)[0];\n\t\t\t\t\t      if(!d.getElementById(id)) {\n\t\t\t\t\t       js=d.createElement(s);js.id=id;js.src=\"https://platform.twitter.com/widgets.js\";fjs.parentNode.insertBefore(js,fjs);\n\t\t\t\t\t      }\n\t\t\t\t\t    }\n\t\t\t\t\t   (document,\"script\",\"twitter-wjs\");\n\t\t\t\t\t    </script>",
  "wfw:commentRss": "http://blog.datadive.net/histogram-intersection-for-change-detection/feed/",
  "slash:comments": 13
}