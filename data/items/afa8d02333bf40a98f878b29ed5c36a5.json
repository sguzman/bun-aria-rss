{
  "title": "Find duplicates and near-duplicates in a corpus with Natural Language Processing",
  "link": "https://blogs.sas.com/content/subconsciousmusings/2022/10/03/find-duplicates-with-nlp/",
  "comments": "https://blogs.sas.com/content/subconsciousmusings/2022/10/03/find-duplicates-with-nlp/#comments",
  "dc:creator": "Estelle Wang",
  "pubDate": "Mon, 03 Oct 2022 15:32:05 +0000",
  "category": [
    "Uncategorized",
    "Analytics R&D",
    "Corpus Analysis",
    "data culture and fluency",
    "data scientist",
    "Natural Language Generation (NLG)",
    "natural language processing",
    "SAS Visual Text Analytics",
    "Text analytics"
  ],
  "guid": "https://blogs.sas.com/content/subconsciousmusings/?p=13791",
  "description": "<p>To find exact duplicates, matching all string pairs is the simplest approach, but it is not a very efficient or sufficient technique. Using the MD5 or SHA-1 hash algorithms can get us a correct outcome with a faster speed, yet near-duplicates would still not be on the radar. Text similarity is useful for finding files that look alike. There are various approaches to this and each of them has its own way to define documents that are considered duplicates. Furthermore, the definition of duplicate documents has implications for the type of processing and the results produced. Below are some of the options.</p>\n<p>Using SAS Visual Text Analytics, you can customize and accomplish this task during your corpus analysis journey either with Python SWAT package or with PROC SQL in SAS.</p>\n<p>The post <a rel=\"nofollow\" href=\"https://blogs.sas.com/content/subconsciousmusings/2022/10/03/find-duplicates-with-nlp/\">Find duplicates and near-duplicates in a corpus with Natural Language Processing</a> appeared first on <a rel=\"nofollow\" href=\"https://blogs.sas.com/content/subconsciousmusings\">The SAS Data Science Blog</a>.</p>\n",
  "content:encoded": "<p>Building a large high-quality corpus for <a href=\"https://www.sas.com/en_us/insights/analytics/what-is-natural-language-processing-nlp.html\">Natural Language Processing (NLP)</a> is not for the faint of heart. Text data can be large, cumbersome, and unwieldy and unlike clean numbers or categorical data in rows and columns, discerning differences between documents can be challenging. In organizations where documents are shared, modified, and shared again before being saved in an archive, the problem of duplication can become overwhelming.</p>\n<p>To find exact duplicates, matching all string pairs is the simplest approach, but it is not a very efficient or sufficient technique. Using the <a href=\"https://en.wikipedia.org/wiki/MD5\">MD5</a> or <a href=\"https://en.wikipedia.org/wiki/SHA-1\">SHA-1</a> hash algorithms can get us a correct outcome with a faster speed, yet near-duplicates would still not be on the radar. Text similarity is useful for finding files that look alike. There are various approaches to this and each of them has its own way to define documents that are considered duplicates. Furthermore, the definition of duplicate documents has implications for the type of processing and the results produced. Below are some of the options.</p>\n<p>Using <a href=\"https://www.sas.com/en_us/software/visual-text-analytics.html\">SAS Visual Text Analytics</a>, you can customize and accomplish this task during your corpus analysis journey either with Python SWAT package or with PROC SQL in SAS.</p>\n<h2>Work with Python SWAT</h2>\n<p>The Python SWAT package provides us with a Python interface to <a href=\"https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/lrcon/n0bc1qjcm0ieegn15og9lfelk7pm.htm\">SAS Cloud Analytic Services (CAS)</a>. In this article, we’ll call the profileText action, pull down output tables, and perform duplicate identification in Python.</p>\n<h3>Prepare the data</h3>\n<p>The corpus we’re going to explore is <a href=\"https://anc.org/\">Second Release of the American National Corpus (ANC2)</a>. It’s also one of the reference corpora for the profileText action. The corpus contains over 22,000,000 words of written and spoken texts and comes with both annotated data and their plain texts.</p>\n<p>We put all 13295 plain text files under /home/anc2. After connecting to the CAS server, we create the table TESTDATA with ANC2 data.</p>\n\n<div class=\"wp_syntax\"><table><tr><td class=\"code\"><pre class=\"python\" style=\"font-family:monospace;\"><span style=\"color: #808080; font-style: italic;\"># Import libraries</span>\n<span style=\"color: #ff7700;font-weight:bold;\">import</span> swat\n<span style=\"color: #ff7700;font-weight:bold;\">from</span> <span style=\"color: #dc143c;\">collections</span> <span style=\"color: #ff7700;font-weight:bold;\">import</span> Counter\n<span style=\"color: #ff7700;font-weight:bold;\">import</span> pandas <span style=\"color: #ff7700;font-weight:bold;\">as</span> pd\n<span style=\"color: #ff7700;font-weight:bold;\">import</span> <span style=\"color: #dc143c;\">itertools</span>\n<span style=\"color: #ff7700;font-weight:bold;\">import</span> <span style=\"color: #dc143c;\">random</span>\n&nbsp;\n<span style=\"color: #808080; font-style: italic;\"># Connect to CAS server</span>\ns <span style=\"color: #66cc66;\">=</span> swat.<span style=\"color: black;\">CAS</span><span style=\"color: black;\">&#40;</span><span style=\"color: #483d8b;\">\"cloud.example.com\"</span><span style=\"color: #66cc66;\">,</span> <span style=\"color: #ff4500;\">5570</span><span style=\"color: black;\">&#41;</span>\n&nbsp;\n<span style=\"color: #808080; font-style: italic;\"># Add the caslib mycas with the path to corpus directory</span>\ns.<span style=\"color: black;\">addCaslib</span><span style=\"color: black;\">&#40;</span>caslib<span style=\"color: #66cc66;\">=</span><span style=\"color: #483d8b;\">'mycas'</span><span style=\"color: #66cc66;\">,</span>\n            datasource<span style=\"color: #66cc66;\">=</span><span style=\"color: black;\">&#123;</span><span style=\"color: #483d8b;\">\"srcType\"</span>:<span style=\"color: #483d8b;\">\"path\"</span><span style=\"color: black;\">&#125;</span><span style=\"color: #66cc66;\">,</span>\n            session<span style=\"color: #66cc66;\">=</span><span style=\"color: #008000;\">False</span><span style=\"color: #66cc66;\">,</span>\n            path<span style=\"color: #66cc66;\">=</span><span style=\"color: #483d8b;\">\"/home\"</span><span style=\"color: #66cc66;\">,</span>\n            subdirectories<span style=\"color: #66cc66;\">=</span><span style=\"color: #483d8b;\">\"yes\"</span><span style=\"color: black;\">&#41;</span>\n&nbsp;\n<span style=\"color: #808080; font-style: italic;\"># Load txt files under anc/ to the CASTable testdata</span>\ns.<span style=\"color: black;\">loadTable</span><span style=\"color: black;\">&#40;</span>casout<span style=\"color: #66cc66;\">=</span><span style=\"color: black;\">&#123;</span><span style=\"color: #483d8b;\">\"name\"</span>:<span style=\"color: #483d8b;\">\"TESTDATA\"</span><span style=\"color: #66cc66;\">,</span> <span style=\"color: #483d8b;\">\"replace\"</span>:<span style=\"color: #008000;\">True</span><span style=\"color: black;\">&#125;</span><span style=\"color: #66cc66;\">,</span>\n            caslib<span style=\"color: #66cc66;\">=</span><span style=\"color: #483d8b;\">\"mycas\"</span><span style=\"color: #66cc66;\">,</span>\n            importOptions<span style=\"color: #66cc66;\">=</span><span style=\"color: black;\">&#123;</span><span style=\"color: #483d8b;\">\"fileType\"</span>:<span style=\"color: #483d8b;\">\"Document\"</span><span style=\"color: black;\">&#125;</span><span style=\"color: #66cc66;\">,</span>\n            path<span style=\"color: #66cc66;\">=</span><span style=\"color: #483d8b;\">\"anc2\"</span><span style=\"color: black;\">&#41;</span></pre></td></tr></table></div>\n\n<p>Out:</p>\n<p><a href=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out1.png\"><img loading=\"lazy\" class=\"aligncenter size-large wp-image-13794\" src=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out1-1024x276.png\" alt=\"\" width=\"702\" height=\"189\" srcset=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out1-1024x276.png 1024w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out1-300x81.png 300w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out1-768x207.png 768w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out1.png 1380w\" sizes=\"(max-width: 702px) 100vw, 702px\" /></a></p>\n<p>We can check on the table easily, such as by using columnInfo() or head().</p>\n\n<div class=\"wp_syntax\"><table><tr><td class=\"code\"><pre class=\"python\" style=\"font-family:monospace;\"><span style=\"color: #808080; font-style: italic;\"># View column summary for testdata</span>\nanc2 <span style=\"color: #66cc66;\">=</span> s.<span style=\"color: black;\">CASTable</span><span style=\"color: black;\">&#40;</span><span style=\"color: #483d8b;\">\"TESTDATA\"</span><span style=\"color: #66cc66;\">,</span> replace<span style=\"color: #66cc66;\">=</span><span style=\"color: #008000;\">True</span><span style=\"color: black;\">&#41;</span>\nanc2.<span style=\"color: black;\">columninfo</span><span style=\"color: black;\">&#40;</span><span style=\"color: black;\">&#41;</span></pre></td></tr></table></div>\n\n<p>Out:</p>\n<p><a href=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out2.png\"><img loading=\"lazy\" class=\"aligncenter size-large wp-image-13797\" src=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out2-1024x282.png\" alt=\"\" width=\"702\" height=\"193\" srcset=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out2-1024x282.png 1024w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out2-300x82.png 300w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out2-768x211.png 768w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out2-1536x422.png 1536w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out2.png 1564w\" sizes=\"(max-width: 702px) 100vw, 702px\" /></a></p>\n\n<div class=\"wp_syntax\"><table><tr><td class=\"code\"><pre class=\"python\" style=\"font-family:monospace;\"><span style=\"color: #808080; font-style: italic;\"># Check on the first five rows</span>\nanc2.<span style=\"color: black;\">head</span><span style=\"color: black;\">&#40;</span><span style=\"color: black;\">&#41;</span></pre></td></tr></table></div>\n\n<p>Out:</p>\n<p><a href=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out3.png\"><img loading=\"lazy\" class=\"aligncenter size-large wp-image-13800\" src=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out3-1024x172.png\" alt=\"\" width=\"702\" height=\"118\" srcset=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out3-1024x172.png 1024w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out3-300x50.png 300w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out3-768x129.png 768w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out3-1536x258.png 1536w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out3-2048x344.png 2048w\" sizes=\"(max-width: 702px) 100vw, 702px\" /></a></p>\n<h3>Profile the data</h3>\n<p>We load the Text Management action set and call the profileText action to profile the ANC2 data. The casOut parameter is required to run the action. This output table contains information complexity, information density, and vocabulary diversity statistics. For duplicate identification we need the results from two output tables, documentOut and intermediateOut. A CASTable can be converted to a SASDataFrame by using the CASTable.to_frame() method. This method helps us pull all of the data down for further exploration.</p>\n\n<div class=\"wp_syntax\"><table><tr><td class=\"code\"><pre class=\"python\" style=\"font-family:monospace;\"><span style=\"color: #808080; font-style: italic;\"># Load the action set textManagement</span>\ns.<span style=\"color: black;\">loadactionset</span><span style=\"color: black;\">&#40;</span><span style=\"color: #483d8b;\">'textManagement'</span><span style=\"color: black;\">&#41;</span>\n&nbsp;\n<span style=\"color: #808080; font-style: italic;\"># Call the action profileText</span>\nresults <span style=\"color: #66cc66;\">=</span> s.<span style=\"color: black;\">profileText</span><span style=\"color: black;\">&#40;</span>table<span style=\"color: #66cc66;\">=</span><span style=\"color: #008000;\">dict</span><span style=\"color: black;\">&#40;</span>caslib<span style=\"color: #66cc66;\">=</span><span style=\"color: #483d8b;\">\"mycas\"</span><span style=\"color: #66cc66;\">,</span> name<span style=\"color: #66cc66;\">=</span><span style=\"color: #483d8b;\">\"testdata\"</span><span style=\"color: black;\">&#41;</span><span style=\"color: #66cc66;\">,</span>\n                        documentid<span style=\"color: #66cc66;\">=</span><span style=\"color: #483d8b;\">\"fileName\"</span><span style=\"color: #66cc66;\">,</span>\n                        text<span style=\"color: #66cc66;\">=</span><span style=\"color: #483d8b;\">\"content\"</span><span style=\"color: #66cc66;\">,</span>\n                        language<span style=\"color: #66cc66;\">=</span><span style=\"color: #483d8b;\">\"english\"</span><span style=\"color: #66cc66;\">,</span>\n                        casOut<span style=\"color: #66cc66;\">=</span><span style=\"color: #008000;\">dict</span><span style=\"color: black;\">&#40;</span>name<span style=\"color: #66cc66;\">=</span><span style=\"color: #483d8b;\">\"casOut\"</span><span style=\"color: #66cc66;\">,</span> replace<span style=\"color: #66cc66;\">=</span><span style=\"color: #008000;\">True</span><span style=\"color: black;\">&#41;</span><span style=\"color: #66cc66;\">,</span>\n                        documentOut<span style=\"color: #66cc66;\">=</span><span style=\"color: #008000;\">dict</span><span style=\"color: black;\">&#40;</span>name<span style=\"color: #66cc66;\">=</span><span style=\"color: #483d8b;\">\"docOut\"</span><span style=\"color: #66cc66;\">,</span> replace<span style=\"color: #66cc66;\">=</span><span style=\"color: #008000;\">True</span><span style=\"color: black;\">&#41;</span><span style=\"color: #66cc66;\">,</span>\n                        intermediateOut<span style=\"color: #66cc66;\">=</span><span style=\"color: #008000;\">dict</span><span style=\"color: black;\">&#40;</span>name<span style=\"color: #66cc66;\">=</span><span style=\"color: #483d8b;\">\"interOut\"</span><span style=\"color: #66cc66;\">,</span> replace<span style=\"color: #66cc66;\">=</span><span style=\"color: #008000;\">True</span><span style=\"color: black;\">&#41;</span><span style=\"color: black;\">&#41;</span></pre></td></tr></table></div>\n\n<p>The documentOut contains document-level information complexity statistics. For each file, we know their total number of sentences and maximum number of tokens in these sentences.</p>\n\n<div class=\"wp_syntax\"><table><tr><td class=\"code\"><pre class=\"python\" style=\"font-family:monospace;\"><span style=\"color: #808080; font-style: italic;\"># Convert the CASTable docOut to SASDataFrame</span>\ndf_docout <span style=\"color: #66cc66;\">=</span> s.<span style=\"color: black;\">CASTable</span><span style=\"color: black;\">&#40;</span><span style=\"color: #483d8b;\">'docOut'</span><span style=\"color: black;\">&#41;</span>.<span style=\"color: black;\">to_frame</span><span style=\"color: black;\">&#40;</span><span style=\"color: black;\">&#41;</span>\ndf_docout.<span style=\"color: black;\">head</span><span style=\"color: black;\">&#40;</span><span style=\"color: black;\">&#41;</span></pre></td></tr></table></div>\n\n<p>Out:</p>\n<p><a href=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out4.png\"><img loading=\"lazy\" class=\"aligncenter size-large wp-image-13803\" src=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out4-1024x177.png\" alt=\"\" width=\"702\" height=\"121\" srcset=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out4-1024x177.png 1024w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out4-300x52.png 300w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out4-768x133.png 768w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out4-1536x265.png 1536w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out4-2048x354.png 2048w\" sizes=\"(max-width: 702px) 100vw, 702px\" /></a></p>\n<p>The other output, intermediateOut, contains the token count of each sentence in each document.</p>\n\n<div class=\"wp_syntax\"><table><tr><td class=\"code\"><pre class=\"python\" style=\"font-family:monospace;\"><span style=\"color: #808080; font-style: italic;\"># Convert the CASTable interOut to SASDataFrame</span>\ndf_interout <span style=\"color: #66cc66;\">=</span> s.<span style=\"color: black;\">CASTable</span><span style=\"color: black;\">&#40;</span><span style=\"color: #483d8b;\">'interOut'</span><span style=\"color: black;\">&#41;</span>.<span style=\"color: black;\">to_frame</span><span style=\"color: black;\">&#40;</span><span style=\"color: black;\">&#41;</span>\ndf_interout.<span style=\"color: black;\">head</span><span style=\"color: black;\">&#40;</span><span style=\"color: black;\">&#41;</span></pre></td></tr></table></div>\n\n<p>Out:</p>\n<p><a href=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out5.png\"><img loading=\"lazy\" class=\"aligncenter size-large wp-image-13806\" src=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out5-1024x182.png\" alt=\"\" width=\"702\" height=\"125\" srcset=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out5-1024x182.png 1024w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out5-300x53.png 300w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out5-768x136.png 768w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out5-1536x273.png 1536w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out5-2048x364.png 2048w\" sizes=\"(max-width: 702px) 100vw, 702px\" /></a></p>\n<h3>Filter the data</h3>\n<p>Our goal is to locate both identical documents and documents that are not identical but substantially similar. To narrow our search results for good candidates, we introduce an assumption that if two files have the same number of sentences and the maximum number of tokens for a sentence, they have a higher possibility to be duplicates or near-duplicates.</p>\n<p>Having this assumption, we keep the documents with their value pair of _NUM_SENTENCES_ and _MAX_TOKENS_SENTENCES_ occurring more than once, leaving us 8972 out of 13295 files.</p>\n\n<div class=\"wp_syntax\"><table><tr><td class=\"code\"><pre class=\"python\" style=\"font-family:monospace;\"><span style=\"color: #808080; font-style: italic;\"># Filter out docs with their column values appearing more than once</span>\ndf_docout_selected <span style=\"color: #66cc66;\">=</span> df_docout<span style=\"color: black;\">&#91;</span>df_docout.<span style=\"color: black;\">groupby</span><span style=\"color: black;\">&#40;</span><span style=\"color: black;\">&#91;</span><span style=\"color: #483d8b;\">'_NUM_SENTENCES_'</span><span style=\"color: #66cc66;\">,</span><span style=\"color: #483d8b;\">'_MAX_TOKENS_SENTENCE_'</span><span style=\"color: black;\">&#93;</span><span style=\"color: black;\">&#41;</span>\n                                                 <span style=\"color: black;\">&#91;</span><span style=\"color: #483d8b;\">'_NUM_SENTENCES_'</span><span style=\"color: black;\">&#93;</span>.<span style=\"color: black;\">transform</span><span style=\"color: black;\">&#40;</span><span style=\"color: #483d8b;\">'size'</span><span style=\"color: black;\">&#41;</span>&gt<span style=\"color: #66cc66;\">;</span><span style=\"color: #ff4500;\">1</span><span style=\"color: black;\">&#93;</span>\n<span style=\"color: #ff7700;font-weight:bold;\">print</span><span style=\"color: black;\">&#40;</span>f<span style=\"color: #483d8b;\">\"Number of rows after selection: {len(df_docout_selected)}\"</span><span style=\"color: black;\">&#41;</span>\ndf_docout_selected.<span style=\"color: black;\">head</span><span style=\"color: black;\">&#40;</span><span style=\"color: black;\">&#41;</span></pre></td></tr></table></div>\n\n<p>Out:</p>\n<p><a href=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out6.png\"><img loading=\"lazy\" class=\"aligncenter size-large wp-image-13809\" src=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out6-1024x215.png\" alt=\"\" width=\"702\" height=\"147\" srcset=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out6-1024x215.png 1024w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out6-300x63.png 300w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out6-768x162.png 768w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out6-1536x323.png 1536w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out6.png 1844w\" sizes=\"(max-width: 702px) 100vw, 702px\" /></a></p>\n<p>You can further reduce results if there’s a focus in your search by providing conditions like, only selecting documents with a total number of sentences of more than 200, or selecting those with a maximum number of tokens in a sentence of more than 80.</p>\n\n<div class=\"wp_syntax\"><table><tr><td class=\"code\"><pre class=\"python\" style=\"font-family:monospace;\"><span style=\"color: #808080; font-style: italic;\"># (Optional) Reduce search results by filtering out docs by condition</span>\ndf_docout_selected<span style=\"color: #66cc66;\">=</span>df_docout_selected<span style=\"color: black;\">&#91;</span>df_docout_selected._NUM_SENTENCES_&gt<span style=\"color: #66cc66;\">;</span><span style=\"color: #ff4500;\">200</span><span style=\"color: black;\">&#93;</span>\ndf_docout_selected<span style=\"color: #66cc66;\">=</span>df_docout_selected<span style=\"color: black;\">&#91;</span>df_docout_selected._MAX_TOKENS_SENTENCE_&gt<span style=\"color: #66cc66;\">;</span><span style=\"color: #ff4500;\">80</span><span style=\"color: black;\">&#93;</span></pre></td></tr></table></div>\n\n<p>Next, we prepare pair combinations of files that share the values for _NUM_SENTENCES_ and _MAX_TOKENS_SENTENCES_. Notice that sometimes more than 2 files share the same values. The total number of unique pairs is 14617.</p>\n\n<div class=\"wp_syntax\"><table><tr><td class=\"code\"><pre class=\"python\" style=\"font-family:monospace;\"><span style=\"color: #808080; font-style: italic;\"># Keep only the interout data for files that are selected</span>\nsearch_dict <span style=\"color: #66cc66;\">=</span> df_docout_selected.<span style=\"color: black;\">set_index</span><span style=\"color: black;\">&#40;</span><span style=\"color: #483d8b;\">'fileName'</span><span style=\"color: black;\">&#41;</span>.<span style=\"color: black;\">T</span>.<span style=\"color: black;\">to_dict</span><span style=\"color: black;\">&#40;</span><span style=\"color: #483d8b;\">'list'</span><span style=\"color: black;\">&#41;</span>\ndf_interout_selected <span style=\"color: #66cc66;\">=</span> df_interout<span style=\"color: black;\">&#91;</span>df_interout<span style=\"color: black;\">&#91;</span><span style=\"color: #483d8b;\">'fileName'</span><span style=\"color: black;\">&#93;</span>.<span style=\"color: black;\">isin</span><span style=\"color: black;\">&#40;</span>search_dict.<span style=\"color: black;\">keys</span><span style=\"color: black;\">&#40;</span><span style=\"color: black;\">&#41;</span><span style=\"color: black;\">&#41;</span><span style=\"color: black;\">&#93;</span>\n&nbsp;\n<span style=\"color: #808080; font-style: italic;\"># Get all unique combinations of every two docs</span>\ncheck_tmp_dict <span style=\"color: #66cc66;\">=</span> Counter<span style=\"color: black;\">&#40;</span><span style=\"color: black;\">&#91;</span><span style=\"color: #008000;\">tuple</span><span style=\"color: black;\">&#40;</span>s<span style=\"color: black;\">&#41;</span> <span style=\"color: #ff7700;font-weight:bold;\">for</span> s <span style=\"color: #ff7700;font-weight:bold;\">in</span> search_dict.<span style=\"color: black;\">values</span><span style=\"color: black;\">&#40;</span><span style=\"color: black;\">&#41;</span><span style=\"color: black;\">&#93;</span><span style=\"color: black;\">&#41;</span>\nfile_pair_lst <span style=\"color: #66cc66;\">=</span> <span style=\"color: black;\">&#91;</span><span style=\"color: black;\">&#93;</span>\n<span style=\"color: #ff7700;font-weight:bold;\">for</span> c <span style=\"color: #ff7700;font-weight:bold;\">in</span> check_tmp_dict:\n    file_pair <span style=\"color: #66cc66;\">=</span> <span style=\"color: black;\">&#91;</span>k <span style=\"color: #ff7700;font-weight:bold;\">for</span> k<span style=\"color: #66cc66;\">,</span>v <span style=\"color: #ff7700;font-weight:bold;\">in</span> search_dict.<span style=\"color: black;\">items</span><span style=\"color: black;\">&#40;</span><span style=\"color: black;\">&#41;</span> <span style=\"color: #ff7700;font-weight:bold;\">if</span> <span style=\"color: #008000;\">tuple</span><span style=\"color: black;\">&#40;</span>v<span style=\"color: black;\">&#41;</span><span style=\"color: #66cc66;\">==</span>c<span style=\"color: black;\">&#93;</span>\n    <span style=\"color: #ff7700;font-weight:bold;\">if</span> <span style=\"color: #008000;\">len</span><span style=\"color: black;\">&#40;</span>file_pair<span style=\"color: black;\">&#41;</span> <span style=\"color: #66cc66;\">==</span> <span style=\"color: #ff4500;\">2</span>:\n        file_pair_lst.<span style=\"color: black;\">append</span><span style=\"color: black;\">&#40;</span><span style=\"color: #008000;\">tuple</span><span style=\"color: black;\">&#40;</span>file_pair<span style=\"color: black;\">&#41;</span><span style=\"color: black;\">&#41;</span>\n    <span style=\"color: #ff7700;font-weight:bold;\">else</span>:\n        pair_lst <span style=\"color: #66cc66;\">=</span> <span style=\"color: #008000;\">list</span><span style=\"color: black;\">&#40;</span><span style=\"color: #dc143c;\">itertools</span>.<span style=\"color: black;\">combinations</span><span style=\"color: black;\">&#40;</span>file_pair<span style=\"color: #66cc66;\">,</span> <span style=\"color: #ff4500;\">2</span><span style=\"color: black;\">&#41;</span><span style=\"color: black;\">&#41;</span>\n        file_pair_lst +<span style=\"color: #66cc66;\">=</span> pair_lst\n&nbsp;\n<span style=\"color: #ff7700;font-weight:bold;\">print</span><span style=\"color: black;\">&#40;</span>f<span style=\"color: #483d8b;\">\"Number of unique pairs is: {len(file_pair_lst)}<span style=\"color: #000099; font-weight: bold;\">\\n</span>\"</span><span style=\"color: black;\">&#41;</span>\n<span style=\"color: #ff7700;font-weight:bold;\">print</span><span style=\"color: black;\">&#40;</span>f<span style=\"color: #483d8b;\">\"The first five pairs are: {file_pair_lst[:5]}\"</span><span style=\"color: black;\">&#41;</span></pre></td></tr></table></div>\n\n<p>Out:</p>\n<p><a href=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out7.png\"><img loading=\"lazy\" class=\"aligncenter size-large wp-image-13812\" src=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out7-1024x120.png\" alt=\"\" width=\"702\" height=\"82\" srcset=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out7-1024x120.png 1024w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out7-300x35.png 300w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out7-768x90.png 768w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out7-1536x180.png 1536w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out7-2048x240.png 2048w\" sizes=\"(max-width: 702px) 100vw, 702px\" /></a></p>\n<h3>Compare the data</h3>\n<p>Finding textual near duplicates is more complicated than duplicates. There is no gold standard on the similarity threshold of two considered near-duplicates. Based on the _NUM_TOKENS_ by _SENTENCE_ID_ from the table interOut earlier, we add the assumption that two documents have a very high possibility to be near-duplicates if they share the same number of tokens for the sentences ordered in a list with their indices randomly picked by a defined ratio to total sentence number.</p>\n<p>For example, fileA and fileB have 20 sentences each and the defined ratio is 0.5. We use pandas.Series.sample to randomly select 10 sentences from two files each. The random_state value is required to make sure that sentences from two files are picked up in parallel. If the two sentences have the same number of tokens for every pair we sampled, fileA and fileB are considered near-duplicates.</p>\n<p>Now we are ready for comparison.</p>\n\n<div class=\"wp_syntax\"><table><tr><td class=\"code\"><pre class=\"python\" style=\"font-family:monospace;\"><span style=\"color: #808080; font-style: italic;\"># Compare doc pairs</span>\npossibleDuplicate <span style=\"color: #66cc66;\">=</span> <span style=\"color: black;\">&#91;</span><span style=\"color: black;\">&#93;</span>\n<span style=\"color: #ff7700;font-weight:bold;\">for</span> <span style=\"color: black;\">&#40;</span>a<span style=\"color: #66cc66;\">,</span> b<span style=\"color: black;\">&#41;</span> <span style=\"color: #ff7700;font-weight:bold;\">in</span> file_pair_lst:\n    <span style=\"color: #808080; font-style: italic;\"># Keep only the column _NUM_TOKENS_</span>\n    tmp_a <span style=\"color: #66cc66;\">=</span> df_interout_selected<span style=\"color: black;\">&#91;</span>df_interout_selected<span style=\"color: black;\">&#91;</span><span style=\"color: #483d8b;\">'fileName'</span><span style=\"color: black;\">&#93;</span><span style=\"color: #66cc66;\">==</span>a<span style=\"color: black;\">&#93;</span>.<span style=\"color: black;\">loc</span><span style=\"color: black;\">&#91;</span>:<span style=\"color: #66cc66;\">,</span><span style=\"color: #483d8b;\">\"_NUM_TOKENS_\"</span><span style=\"color: black;\">&#93;</span>\n    tmp_b <span style=\"color: #66cc66;\">=</span> df_interout_selected<span style=\"color: black;\">&#91;</span>df_interout_selected<span style=\"color: black;\">&#91;</span><span style=\"color: #483d8b;\">'fileName'</span><span style=\"color: black;\">&#93;</span><span style=\"color: #66cc66;\">==</span>b<span style=\"color: black;\">&#93;</span>.<span style=\"color: black;\">loc</span><span style=\"color: black;\">&#91;</span>:<span style=\"color: #66cc66;\">,</span><span style=\"color: #483d8b;\">\"_NUM_TOKENS_\"</span><span style=\"color: black;\">&#93;</span>\n    <span style=\"color: #808080; font-style: italic;\"># Drop the index column to use pandas.Series.compare</span>\n    tmp_a.<span style=\"color: black;\">reset_index</span><span style=\"color: black;\">&#40;</span>drop<span style=\"color: #66cc66;\">=</span><span style=\"color: #008000;\">True</span><span style=\"color: #66cc66;\">,</span> inplace<span style=\"color: #66cc66;\">=</span><span style=\"color: #008000;\">True</span><span style=\"color: black;\">&#41;</span>\n    tmp_b.<span style=\"color: black;\">reset_index</span><span style=\"color: black;\">&#40;</span>drop<span style=\"color: #66cc66;\">=</span><span style=\"color: #008000;\">True</span><span style=\"color: #66cc66;\">,</span> inplace<span style=\"color: #66cc66;\">=</span><span style=\"color: #008000;\">True</span><span style=\"color: black;\">&#41;</span>\n    <span style=\"color: #808080; font-style: italic;\"># Select sentences by pandas.Series.sample with the defined ratio</span>\n    num_sent<span style=\"color: #66cc66;\">,</span> num_sent_tocheck <span style=\"color: #66cc66;\">=</span> <span style=\"color: #008000;\">len</span><span style=\"color: black;\">&#40;</span>tmp_a<span style=\"color: black;\">&#41;</span><span style=\"color: #66cc66;\">,</span> <span style=\"color: #008000;\">round</span><span style=\"color: black;\">&#40;</span>ratio_tocheck*<span style=\"color: #008000;\">len</span><span style=\"color: black;\">&#40;</span>tmp_a<span style=\"color: black;\">&#41;</span><span style=\"color: black;\">&#41;</span>\n    tmp_a <span style=\"color: #66cc66;\">=</span> tmp_a.<span style=\"color: black;\">sample</span><span style=\"color: black;\">&#40;</span>num_sent_tocheck<span style=\"color: #66cc66;\">,</span> random_state<span style=\"color: #66cc66;\">=</span><span style=\"color: #ff4500;\">1</span><span style=\"color: black;\">&#41;</span>\n    tmp_b <span style=\"color: #66cc66;\">=</span> tmp_b.<span style=\"color: black;\">sample</span><span style=\"color: black;\">&#40;</span>num_sent_tocheck<span style=\"color: #66cc66;\">,</span> random_state<span style=\"color: #66cc66;\">=</span><span style=\"color: #ff4500;\">1</span><span style=\"color: black;\">&#41;</span>\n    <span style=\"color: #808080; font-style: italic;\"># Detect duplicates by checking whether it is an empty dataframe (with a shape of (0,2))</span>\n    <span style=\"color: #ff7700;font-weight:bold;\">if</span> tmp_a.<span style=\"color: black;\">compare</span><span style=\"color: black;\">&#40;</span>tmp_b<span style=\"color: black;\">&#41;</span>.<span style=\"color: black;\">shape</span> <span style=\"color: #66cc66;\">!=</span> <span style=\"color: black;\">&#40;</span><span style=\"color: #ff4500;\">0</span><span style=\"color: #66cc66;\">,</span><span style=\"color: #ff4500;\">2</span><span style=\"color: black;\">&#41;</span>:\n        <span style=\"color: #ff7700;font-weight:bold;\">pass</span>\n    <span style=\"color: #ff7700;font-weight:bold;\">else</span>:\n        possibleDuplicate.<span style=\"color: black;\">append</span><span style=\"color: black;\">&#40;</span><span style=\"color: black;\">&#91;</span>a<span style=\"color: #66cc66;\">,</span> b<span style=\"color: black;\">&#93;</span><span style=\"color: black;\">&#41;</span></pre></td></tr></table></div>\n\n<p>The possibleDuplicate list contains 188 pairs of file names.</p>\n\n<div class=\"wp_syntax\"><table><tr><td class=\"code\"><pre class=\"python\" style=\"font-family:monospace;\"><span style=\"color: #808080; font-style: italic;\"># View the result</span>\nview <span style=\"color: #66cc66;\">=</span> <span style=\"color: #483d8b;\">'======<span style=\"color: #000099; font-weight: bold;\">\\n</span>'</span>+<span style=\"color: #483d8b;\">'<span style=\"color: #000099; font-weight: bold;\">\\n</span>'</span>.<span style=\"color: black;\">join</span><span style=\"color: black;\">&#40;</span><span style=\"color: black;\">&#91;</span><span style=\"color: #483d8b;\">\" \"</span>.<span style=\"color: black;\">join</span><span style=\"color: black;\">&#40;</span>p<span style=\"color: black;\">&#41;</span> <span style=\"color: #ff7700;font-weight:bold;\">for</span> p <span style=\"color: #ff7700;font-weight:bold;\">in</span> possibleDuplicate<span style=\"color: black;\">&#93;</span><span style=\"color: black;\">&#41;</span>+<span style=\"color: #483d8b;\">'<span style=\"color: #000099; font-weight: bold;\">\\n</span>======'</span>\n<span style=\"color: #ff7700;font-weight:bold;\">print</span><span style=\"color: black;\">&#40;</span>f<span style=\"color: #483d8b;\">\"NOTE: [ {len(possibleDuplicate) } ] possible duplicate pairs -&gt; <span style=\"color: #000099; font-weight: bold;\">\\n</span>{view}\"</span><span style=\"color: black;\">&#41;</span></pre></td></tr></table></div>\n\n<p>Out:</p>\n<p><a href=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out8.png\"><img loading=\"lazy\" class=\"aligncenter size-large wp-image-13815\" src=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out8-1024x360.png\" alt=\"\" width=\"702\" height=\"247\" srcset=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out8-1024x360.png 1024w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out8-300x105.png 300w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out8-768x270.png 768w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Out8.png 1332w\" sizes=\"(max-width: 702px) 100vw, 702px\" /></a></p>\n<h3>Verify the results</h3>\n<p>Now it’s time to see how far we went for our duplicate search. By checking the content of each pair, it’s not hard to find 133 being duplicates and 55 being near duplicates. Let’s take a look at two near-duplicate pairs we find. These documents have around 50 sentences and the differences occur just between 2 sentences.</p>\n<p><a href=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Diff1.png\"><img loading=\"lazy\" class=\"aligncenter size-large wp-image-13818\" src=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Diff1-1024x179.png\" alt=\"\" width=\"702\" height=\"123\" srcset=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Diff1-1024x179.png 1024w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Diff1-300x53.png 300w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Diff1-768x134.png 768w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Diff1-1536x269.png 1536w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Diff1.png 1736w\" sizes=\"(max-width: 702px) 100vw, 702px\" /></a></p>\n<p><a href=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Diff2.png\"><img loading=\"lazy\" class=\"aligncenter size-large wp-image-13821\" src=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Diff2-1024x260.png\" alt=\"\" width=\"702\" height=\"178\" srcset=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Diff2-1024x260.png 1024w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Diff2-300x76.png 300w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Diff2-768x195.png 768w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Diff2-1536x389.png 1536w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/Diff2.png 1562w\" sizes=\"(max-width: 702px) 100vw, 702px\" /></a></p>\n<h2>Work with PROC SQL in SAS</h2>\n<p>SQL is one of the many languages built into the SAS system. Using PROC SQL, you have access to a robust data manipulation and query tool.</p>\n<h3>Prepare the data</h3>\n<p>We load the folder /home/anc2 with all plain text files to the table TESTDATA.</p>\n\n<div class=\"wp_syntax\"><table><tr><td class=\"code\"><pre class=\"sas\" style=\"font-family:monospace;\"><span style=\"color: #0000ff;\">libname</span> mycas cas;\n&nbsp;\n<span style=\"color: #000080; font-weight: bold;\">proc cas</span>;\n  <span style=\"color: #0000ff;\">table</span>.addcaslib /\n    caslib = <span style=\"color: #a020f0;\">\"mycas\"</span>\n    datasource = <span style=\"color: #66cc66;\">&#123;</span>srctype=<span style=\"color: #a020f0;\">\"path\"</span><span style=\"color: #66cc66;\">&#125;</span>\n    session = False\n    path = <span style=\"color: #a020f0;\">\"/home\"</span>\n    subdirectories = <span style=\"color: #a020f0;\">\"yes\"</span>;\n<span style=\"color: #000080; font-weight: bold;\">run</span>;\n&nbsp;\n  <span style=\"color: #0000ff;\">table</span>.loadTable /\n    casout = <span style=\"color: #66cc66;\">&#123;</span>name=<span style=\"color: #a020f0;\">\"testdata\"</span>, <span style=\"color: #0000ff;\">replace</span>=True<span style=\"color: #66cc66;\">&#125;</span>\n    caslib = <span style=\"color: #a020f0;\">\"mycas\"</span>\n    importOptions = <span style=\"color: #66cc66;\">&#123;</span>fileType=<span style=\"color: #a020f0;\">\"DOCUMENT\"</span><span style=\"color: #66cc66;\">&#125;</span>\n    path = <span style=\"color: #a020f0;\">\"anc2\"</span>;\n<span style=\"color: #000080; font-weight: bold;\">run</span>;\n<span style=\"color: #000080; font-weight: bold;\">quit</span>;</pre></td></tr></table></div>\n\n<p>You can load it directly if you have already saved them to a .sashdata file.</p>\n\n<div class=\"wp_syntax\"><table><tr><td class=\"code\"><pre class=\"sas\" style=\"font-family:monospace;\"><span style=\"color: #000080; font-weight: bold;\">proc cas</span>;\n  <span style=\"color: #0000ff;\">table</span>.save /\n    <span style=\"color: #0000ff;\">table</span> = <span style=\"color: #66cc66;\">&#123;</span>name=<span style=\"color: #a020f0;\">\"testdata\"</span><span style=\"color: #66cc66;\">&#125;</span>\n    caslib = <span style=\"color: #a020f0;\">\"mycas\"</span>\n    name = <span style=\"color: #a020f0;\">\"ANC2.sashdat\"</span>;\n<span style=\"color: #000080; font-weight: bold;\">run</span>;\n&nbsp;\n  <span style=\"color: #0000ff;\">table</span>.loadtable /\n    casout = <span style=\"color: #66cc66;\">&#123;</span>name=<span style=\"color: #a020f0;\">\"testdata\"</span>, <span style=\"color: #0000ff;\">replace</span>=true<span style=\"color: #66cc66;\">&#125;</span>\n    path = <span style=\"color: #a020f0;\">\"ANC2.sashdat\"</span>\n    caslib = <span style=\"color: #a020f0;\">\"mycas\"</span>;\n<span style=\"color: #000080; font-weight: bold;\">run</span>;\n<span style=\"color: #000080; font-weight: bold;\">quit</span>;</pre></td></tr></table></div>\n\n<h3>Profile the data</h3>\n<p>We call the profileText action in the textManagement action set to profile the data.</p>\n\n<div class=\"wp_syntax\"><table><tr><td class=\"code\"><pre class=\"sas\" style=\"font-family:monospace;\"><span style=\"color: #000080; font-weight: bold;\">proc cas</span>;\n  textManagement.profiletext /\n    <span style=\"color: #0000ff;\">table</span> = <span style=\"color: #66cc66;\">&#123;</span>name=<span style=\"color: #a020f0;\">\"testdata\"</span><span style=\"color: #66cc66;\">&#125;</span>\n    documentid = <span style=\"color: #a020f0;\">\"fileName\"</span>\n    text = <span style=\"color: #a020f0;\">\"content\"</span>\n    language = <span style=\"color: #a020f0;\">\"english\"</span>\n    casOut = <span style=\"color: #66cc66;\">&#123;</span>name=<span style=\"color: #a020f0;\">\"casOut\"</span>, <span style=\"color: #0000ff;\">replace</span>=True<span style=\"color: #66cc66;\">&#125;</span>\n    documentOut = <span style=\"color: #66cc66;\">&#123;</span>name=<span style=\"color: #a020f0;\">\"docOut\"</span>, <span style=\"color: #0000ff;\">replace</span>=True<span style=\"color: #66cc66;\">&#125;</span>\n    intermediateOut = <span style=\"color: #66cc66;\">&#123;</span>name=<span style=\"color: #a020f0;\">\"interOut\"</span>, <span style=\"color: #0000ff;\">replace</span>=True<span style=\"color: #66cc66;\">&#125;</span>;\n  <span style=\"color: #000080; font-weight: bold;\">run</span>;\n&nbsp;\n  <span style=\"color: #0000ff;\">table</span>.<span style=\"color: #0000ff;\">fetch</span> /\n    <span style=\"color: #0000ff;\">table</span> = <span style=\"color: #66cc66;\">&#123;</span>name=<span style=\"color: #a020f0;\">\"docOut\"</span><span style=\"color: #66cc66;\">&#125;</span>;\n  <span style=\"color: #000080; font-weight: bold;\">run</span>;\n&nbsp;\n  <span style=\"color: #0000ff;\">table</span>.<span style=\"color: #0000ff;\">fetch</span> /\n    <span style=\"color: #0000ff;\">table</span> = <span style=\"color: #66cc66;\">&#123;</span>name=<span style=\"color: #a020f0;\">\"interOut\"</span><span style=\"color: #66cc66;\">&#125;</span>;\n  <span style=\"color: #000080; font-weight: bold;\">run</span>;\n<span style=\"color: #000080; font-weight: bold;\">quit</span>;</pre></td></tr></table></div>\n\n<p><a href=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/System1.png\"><img loading=\"lazy\" class=\"aligncenter size-large wp-image-13824\" src=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/System1-1024x460.png\" alt=\"\" width=\"702\" height=\"315\" srcset=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/System1-1024x460.png 1024w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/System1-300x135.png 300w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/System1-768x345.png 768w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/System1.png 1272w\" sizes=\"(max-width: 702px) 100vw, 702px\" /></a></p>\n<p><a href=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/System2.png\"><img loading=\"lazy\" class=\"aligncenter size-large wp-image-13827\" src=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/System2-1024x482.png\" alt=\"\" width=\"702\" height=\"330\" srcset=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/System2-1024x482.png 1024w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/System2-300x141.png 300w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/System2-768x361.png 768w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/System2.png 1148w\" sizes=\"(max-width: 702px) 100vw, 702px\" /></a></p>\n<h3>Filter the data</h3>\n<p>We keep the documents given that their value pair occurs more than once.</p>\n\n<div class=\"wp_syntax\"><table><tr><td class=\"code\"><pre class=\"sas\" style=\"font-family:monospace;\"><span style=\"color: #000080; font-weight: bold;\">proc sql</span>;\n  <span style=\"color: #0000ff;\">create</span> <span style=\"color: #0000ff;\">table</span> search1 <span style=\"color: #0000ff;\">as</span>\n    <span style=\"color: #0000ff;\">select</span> <span style=\"color: #006400; font-style: italic;\">* from mycas.docout\n    group by _NUM_SENTENCES_, _MAX_TOKENS_SENTENCE_\n    having count(*) &gt;</span> <span style=\"color: #2e8b57; font-weight: bold;\">1</span>;\n<span style=\"color: #000080; font-weight: bold;\">quit</span>;</pre></td></tr></table></div>\n\n<p>We prepare all pair combinations of files that share the same values.</p>\n\n<div class=\"wp_syntax\"><table><tr><td class=\"code\"><pre class=\"sas\" style=\"font-family:monospace;\"><span style=\"color: #000080; font-weight: bold;\">proc sql</span>;\n  <span style=\"color: #0000ff;\">create</span> <span style=\"color: #0000ff;\">table</span> search2 <span style=\"color: #0000ff;\">as</span>\n    <span style=\"color: #0000ff;\">select</span> a.<span style=\"color: #0000ff;\">fileName</span> <span style=\"color: #0000ff;\">as</span> fileA , b.<span style=\"color: #0000ff;\">fileName</span> <span style=\"color: #0000ff;\">as</span> fileB\n    <span style=\"color: #0000ff;\">from</span>\n      <span style=\"color: #66cc66;\">&#40;</span><span style=\"color: #0000ff;\">select</span> <span style=\"color: #006400; font-style: italic;\">* from search1 ) a\n        cross join\n      (select * from search1 ) b\n    where a._NUM_SENTENCES_ = b._NUM_SENTENCES_ and\n      a._MAX_TOKENS_SENTENCE_ = b._MAX_TOKENS_SENTENCE_ and\n      a.fileName &lt;</span><span style=\"color: #0000ff; font-weight: bold;\">&gt</span>; b.<span style=\"color: #0000ff;\">fileName</span>;\n<span style=\"color: #000080; font-weight: bold;\">quit</span>;\n&nbsp;\n<span style=\"color: #000080; font-weight: bold;\">proc print</span> <span style=\"color: #000080; font-weight: bold;\">data</span>=search2<span style=\"color: #66cc66;\">&#40;</span>obs=<span style=\"color: #2e8b57; font-weight: bold;\">5</span><span style=\"color: #66cc66;\">&#41;</span>;\n<span style=\"color: #000080; font-weight: bold;\">run</span>;</pre></td></tr></table></div>\n\n<p><a href=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/System3.png\"><img loading=\"lazy\" class=\"aligncenter size-large wp-image-13830\" src=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/System3-1024x436.png\" alt=\"\" width=\"702\" height=\"299\" srcset=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/System3-1024x436.png 1024w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/System3-300x128.png 300w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/System3-768x327.png 768w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/System3.png 1180w\" sizes=\"(max-width: 702px) 100vw, 702px\" /></a></p>\n<p>With a glimpse of table search2, we notice that it would be better to get just unique pairs to avoid repeating comparing those with the same file names.</p>\n\n<div class=\"wp_syntax\"><table><tr><td class=\"code\"><pre class=\"sas\" style=\"font-family:monospace;\"><span style=\"color: #000080; font-weight: bold;\">proc sql</span>;\n  <span style=\"color: #0000ff;\">create</span> <span style=\"color: #0000ff;\">table</span> search3 <span style=\"color: #0000ff;\">as</span>\n    <span style=\"color: #0000ff;\">select</span> <span style=\"color: #0000ff;\">distinct</span> fileA, fileB <span style=\"color: #0000ff;\">from</span> search2\n    <span style=\"color: #0000ff;\">where</span> search2.fileA <span style=\"color: #0000ff; font-weight: bold;\">&lt</span>; search2.fileB;\n<span style=\"color: #000080; font-weight: bold;\">quit</span>;\n&nbsp;\n<span style=\"color: #000080; font-weight: bold;\">proc print</span> <span style=\"color: #000080; font-weight: bold;\">data</span>=search3<span style=\"color: #66cc66;\">&#40;</span>obs=<span style=\"color: #2e8b57; font-weight: bold;\">5</span><span style=\"color: #66cc66;\">&#41;</span>;\n<span style=\"color: #000080; font-weight: bold;\">run</span>;</pre></td></tr></table></div>\n\n<p><a href=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/System4.png\"><img loading=\"lazy\" class=\"aligncenter size-large wp-image-13833\" src=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/System4-1024x417.png\" alt=\"\" width=\"702\" height=\"286\" srcset=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/System4-1024x417.png 1024w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/System4-300x122.png 300w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/System4-768x313.png 768w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/System4.png 1246w\" sizes=\"(max-width: 702px) 100vw, 702px\" /></a></p>\n<h3>Compare the data</h3>\n<p>Given the assumption that two documents have a very high possibility to be near-duplicates if they share the same number of tokens for the sentences ordered in a list with their indices randomly picked by a defined ratio to total sentence number. Here we use the rand(‘uniform’) function to generate an observation from the continuous uniform distribution in the interval (0,1) as default. Setting it with ‘between .2 and .7’ helps us randomly get 50% of sentences. The similarity threshold can be customized by changing the range, say “where rand(‘uniform’) between .2 and .9” which means 70% of sentences in the documents would be examined.</p>\n\n<div class=\"wp_syntax\"><table><tr><td class=\"code\"><pre class=\"sas\" style=\"font-family:monospace;\"><span style=\"color: #000080; font-weight: bold;\">proc sql</span>;\n  <span style=\"color: #0000ff;\">create</span> <span style=\"color: #0000ff;\">table</span> search4 <span style=\"color: #0000ff;\">as</span>\n    <span style=\"color: #0000ff;\">select</span> fileA <span style=\"color: #0000ff;\">as</span> f1, fileB <span style=\"color: #0000ff;\">as</span> f2 <span style=\"color: #0000ff;\">from</span> search3 \n    <span style=\"color: #0000ff;\">where</span> <span style=\"color: #0000ff;\">not</span> exists <span style=\"color: #66cc66;\">&#40;</span>\n      <span style=\"color: #0000ff;\">select</span> <span style=\"color: #006400; font-style: italic;\">* from (\n        select tmp1A, tmp2A from (\n          select tmp1._NUM_TOKENS_ as tmp1A, tmp1._SENTENCE_ID_ as tmp1B,\n                 tmp2._NUM_TOKENS_ as tmp2A, tmp2._SENTENCE_ID_ as tmp2B from\n            (select * from sasout1.interout interout1 where interout1.fileName = f1) tmp1,\n            (select * from sasout1.interout interout2 where interout2.fileName = f2) tmp2 \n\t    where tmp1B = tmp2B)\n          where rand('uniform') between .2 and .7)\n        where tmp1A &lt;</span><span style=\"color: #0000ff; font-weight: bold;\">&gt</span>; tmp2A<span style=\"color: #66cc66;\">&#41;</span>;\n<span style=\"color: #000080; font-weight: bold;\">quit</span>;</pre></td></tr></table></div>\n\n<p><a href=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/System5.png\"><img loading=\"lazy\" class=\"aligncenter size-large wp-image-13836\" src=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/System5-1024x391.png\" alt=\"\" width=\"702\" height=\"268\" srcset=\"https://blogs.sas.com/content/subconsciousmusings/files/2022/09/System5-1024x391.png 1024w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/System5-300x114.png 300w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/System5-768x293.png 768w, https://blogs.sas.com/content/subconsciousmusings/files/2022/09/System5.png 1400w\" sizes=\"(max-width: 702px) 100vw, 702px\" /></a></p>\n<h3>Verify the results</h3>\n<p>We use the table testdata to verify the results. There are 133 duplicates and 39 near duplicates out of 172 pairs.</p>\n\n<div class=\"wp_syntax\"><table><tr><td class=\"code\"><pre class=\"sas\" style=\"font-family:monospace;\"><span style=\"color: #000080; font-weight: bold;\">proc sql</span>;\n  <span style=\"color: #0000ff;\">create</span> <span style=\"color: #0000ff;\">table</span> Duplicates <span style=\"color: #0000ff;\">as</span>\n    <span style=\"color: #0000ff;\">select</span> f1, f2 <span style=\"color: #0000ff;\">from</span> search4\n    <span style=\"color: #0000ff;\">where</span> <span style=\"color: #0000ff;\">not</span> exists <span style=\"color: #66cc66;\">&#40;</span>\n      <span style=\"color: #66cc66;\">&#40;</span><span style=\"color: #0000ff;\">select</span> content <span style=\"color: #0000ff;\">from</span> mycas.testdata tmp <span style=\"color: #0000ff;\">where</span> tmp.<span style=\"color: #0000ff;\">fileName</span> = f1<span style=\"color: #66cc66;\">&#41;</span>\n      except\n      <span style=\"color: #66cc66;\">&#40;</span><span style=\"color: #0000ff;\">select</span> content <span style=\"color: #0000ff;\">from</span> mycas.testdata tmp <span style=\"color: #0000ff;\">where</span> tmp.<span style=\"color: #0000ff;\">fileName</span> = f2<span style=\"color: #66cc66;\">&#41;</span>\n    <span style=\"color: #66cc66;\">&#41;</span>;\n<span style=\"color: #000080; font-weight: bold;\">quit</span>;\n&nbsp;\n<span style=\"color: #000080; font-weight: bold;\">proc sql</span>;\n  <span style=\"color: #0000ff;\">create</span> <span style=\"color: #0000ff;\">table</span> nearDuplicates <span style=\"color: #0000ff;\">as</span>\n    <span style=\"color: #0000ff;\">select</span> f1, f2 <span style=\"color: #0000ff;\">from</span> search4\n    <span style=\"color: #0000ff;\">where</span> exists <span style=\"color: #66cc66;\">&#40;</span>\n      <span style=\"color: #66cc66;\">&#40;</span><span style=\"color: #0000ff;\">select</span> content <span style=\"color: #0000ff;\">from</span> mycas.testdata tmp <span style=\"color: #0000ff;\">where</span> tmp.<span style=\"color: #0000ff;\">fileName</span> = f1<span style=\"color: #66cc66;\">&#41;</span>\n      except\n      <span style=\"color: #66cc66;\">&#40;</span><span style=\"color: #0000ff;\">select</span> content <span style=\"color: #0000ff;\">from</span> mycas.testdata tmp <span style=\"color: #0000ff;\">where</span> tmp.<span style=\"color: #0000ff;\">fileName</span> = f2<span style=\"color: #66cc66;\">&#41;</span>\n    <span style=\"color: #66cc66;\">&#41;</span>;\n<span style=\"color: #000080; font-weight: bold;\">quit</span>;</pre></td></tr></table></div>\n\n<h2>Conclusions</h2>\n<p>Exploring derived statistics from the profileText action provides a practical perspective to gain insights not only by comparing to a reference corpus, but at token, sentence, and document levels within a corpus itself. With the randomness in selecting which sentences to compare, we might observe different results after performing this duplication identification method. The smaller ratio we define, the more near-duplicate pairs we get. And you would probably be surprised by the fact that if we set the ratio to 0.1, the result would still be around 207 pairs, just a little bit more than 172 pairs when the ratio is set to 0.5. The method doesn’t seem to overfire because two files are required to have the same number of sentences and the same maximum number of tokens in a sentence before we pair them up. This requirement gives us a safer place to start our search.</p>\n<p>Textual near duplicate identification is simple to understand but not easy to develop standards to include every type of near duplicates. In this article, we provide one way to describe near duplicates in which distance is between several sentences or words in order, yet not including cases like sentences of two documents are not arranged in the same order or some chunks are glued together so that the results are affected by different sentence indexing. These are fun to think about and they might be turned into the next level detection.</p>\n<p>How would you define the similarity for near duplicates?</p>\n<h3>Learn more</h3>\n<ul>\n<li>Check out <a href=\"https://go.documentation.sas.com/doc/us/pgmsascdc/v_021/casanpg/p1e93w56dte67qn14kcy9njkxs1p.htm\">additional documentation on corpus analysis</a> and  <a href=\"https://support.sas.com/en/software/visual-text-analytics-support.html#documentation\">SAS</a> <a href=\"https://support.sas.com/en/software/visual-text-analytics-support.html#documentation\">Visual Text Analytics.</a></li>\n<li>Keep exploring by checking out the ebook “<a href=\"https://www.sas.com/en/whitepapers/natural-language-processing-110641.html\">Make Every Voice Heard with Natural Language Processing</a>” or visit <a href=\"https://www.sas.com/en_us/software/visual-text-analytics.html\">SAS Visual Text Analytics</a>.</li>\n</ul>\n<p>The post <a rel=\"nofollow\" href=\"https://blogs.sas.com/content/subconsciousmusings/2022/10/03/find-duplicates-with-nlp/\">Find duplicates and near-duplicates in a corpus with Natural Language Processing</a> appeared first on <a rel=\"nofollow\" href=\"https://blogs.sas.com/content/subconsciousmusings\">The SAS Data Science Blog</a>.</p>\n",
  "wfw:commentRss": "https://blogs.sas.com/content/subconsciousmusings/2022/10/03/find-duplicates-with-nlp/feed/",
  "slash:comments": 2,
  "enclosure": ""
}