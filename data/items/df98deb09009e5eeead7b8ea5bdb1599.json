{
  "id": "tag:blogger.com,1999:blog-5825758052688213474.post-6869788315354330264",
  "published": "2016-07-31T10:05:00.000-07:00",
  "updated": "2016-08-02T10:19:03.357-07:00",
  "title": "Mind Your Units",
  "content": "By JEAN STEINER<br /><br />Randomized A/B experiments are the gold standard for estimating causal effects. The analysis can be straightforward, especially when it's safe to assume that individual observations of an outcome measure are independent. However, this is not always the case. When observations are not independent, an analysis that assumes independence can lead us to believe that effects are significant when they actually aren't. This blog post explores how this problem arises in applications at Google, and how we can 'mind our units' through analysis and logging.<br /><br /><br /><h2>A tale of two units</h2>Imagine you are interested in the effectiveness of a new mathematics curriculum. You might run an experiment in which some students are exposed to the new curriculum while others are taught based on the existing curriculum. At the end of the semester, you administer a proficiency test to the students and compare test performance across the groups. For example, you might compare the average test score among students exposed to the new curriculum to the average score among the controls.<br /><div><br />Sounds straightforward, right? So, why is this a tale about 'two units'? The first unit is the unit of observation. The outcome measure we care about is an average of the students' test scores, and so the unit of observation is a student. There is one test score per student, and each student was exposed to either the new or the old curriculum. But, can we treat all of the test scores from all of the students as&nbsp;independent observations?<br /><br />To figure this out, let's consider an appropriate experimental design. To evaluate a curriculum, we will need many teachers to use it, and we will also want many students to be exposed to each curriculum.  Since teachers can only teach from a single curriculum for each semester, we will need to ensure that each teacher is assigned to either the new curriculum or the old curriculum. This means that we'll need to assign treatment status, or <i>randomize</i>, at the level of the teacher. In other words, the teacher is our second kind of unit, the unit of experimentation.</div><div><br />This type of experimental design is known as a group-randomized or <a href=\"https://en.wikipedia.org/wiki/Cluster_randomised_controlled_trial\" target=\"_blank\">cluster-randomized</a> trial. As the name suggests, in a group-randomized trial randomization occurs at the group level. In the example above, randomization occurs at the level of a teacher rather than at the student level. Since each teacher works with a group of students, the entire group of a teacher's students is exposed to either the new or the old curriculum.<br /><br />With this experimental design in mind, let's revisit this question: can we treat all of the students' test scores as independent observations? The answer is no -- there are at least two features of classroom dynamics that prevent us from treating test scores from students in the same classroom as independent observations.<br /><br />First, there will generally be a teacher effect: when a teacher is really good, their students will likely do a bit better than when a teacher performs less well, and this should hold regardless of the curriculum. The second source of dependence comes from student interactions. Students within the same classroom will likely talk to each other and work with each other: some students might understand the material better and then teach their classmates, or, in the negative scenario, a classroom with a real trouble-maker might impede the progress of several classmates by distracting them.</div><div><br /></div><div>In summary, there is likely dependence among observations that come from students with the same teacher. When analyzing the outcome measure (e.g., student test scores) in a group-randomized trial, it is critical to account for the group structure (or the experimental unit). Ignoring the group structure would underestimate the variance and could lead to false positive findings.</div><br />One typical modelling approach to account for the group structure is a mixed-level model with random effects. This is a comprehensive approach, and we often employ it at Google. However, we also employ alternative approaches whose conceptual simplicity can be a practical advantage.<br /><br />Let's begin by considering a typical online experiment with a group-randomized structure. Suppose we want to evaluate a proposed change to the user interface for web search. We want an experimental set-up that is consistent with what would happen if we actually launched the new interface so that our experiment will lead us to make relevant conclusions. Additionally, we want to ensure users have a great search experience even as we're trying out new features, so we don't want users to keep seeing new interfaces every time they do a new search. To satisfy both of these experimental design requirements, the best experimental unit is the user. Randomizing at the level of user (or cookie, which is often used as a proxy for a user) will ensure that each user sees the same interface every time she comes to the search page. For those familiar with causal inference, our design is said to satisfy the stable unit treatment value assumption, or <i>SUTVA</i>. This assumption says that the potential outcomes in one user are independent of the treatment status of all other users and that there are no hidden variations in treatment.<br /><br />Examples of outcome measures might include the click-through-rate or the time-to-first-action, an indication of how quickly users found the information they wanted. This means the unit of observation is an individual search result page. Some users will do many searches, some will do only a handful. The observations that come from the same user are clearly not independent. For example, some users will be faster readers or 'more clicky' than others.<br /><br />At this point, the group-randomized framework should be evident in the example of evaluating a new search interface: the 'group' is the user, and the 'unit of observation' is at the level of each search that a user conducts.<br /><br />This example also hints at a key difference between policy evaluations and online experiments; namely, the size of the study. Typically, in a policy evaluation setting there are relatively few groups, often on the order of hundreds or fewer per trial. By contrast, in an online setting, the number of groups can range from thousands to billions. As we will see, this informs the way we account for the group structure when performing causal inference at Google.<br /><div><br /><div><h2>The perils of incorrect units</h2>Is the idea of 'minding our units' just some esoteric issue, or can this actually hurt us in practice? Let's use a simple synthetic dataset to look at the effects of accounting for (or ignoring!) an existing group structure. We generate observations $Y_{ij}$ that correspond to the $i^\\textrm{th}$ observation for the $j^\\textrm{th}$ group.</div><div><br /></div><div>The simulation set-up is as follows: We fix the number of groups to be $N = 50,\\!000$, then we generate observations for each of the groups, with group sizes governed by the Poisson parameter $\\lambda$:<br /><div><ul><li>Draw the group mean, $m_j$, for the $j^\\textrm{th}$ group with $m_j \\sim N(0, 1)$.</li><li>For $\\lambda$ in (0.0, 0.2, ..., 1.2):</li><ul><li>Determine the size of the $j^\\textrm{th}$ group, $n_j$, by drawing from $\\textrm{Poiss}(\\lambda) + 1$.</li><li>Generate observations for the $j^\\textrm{th}$ group: for each group $j$ in 1, ..., $N$, generate $n_j$ individual observations $Y_{ij} \\sim N(m_j, 0.25)$, for $i = 1,..., n_j$ (where $n_j$ was the group size, and $m_j$ was the group mean).</li><li>Calculate 95% bootstrap confidence intervals with two alternative resampling schemes:</li><ul><li>Ignoring the group structure by resampling each observation $Y_{ij}$.</li><li>Accounting for the group structure by resampling each $j^\\textrm{th}$ group.</li></ul></ul></ul>It is worth noting that $\\lambda$ is the only parameter that governs the overall sample size (which is $\\Sigma n_j$ and will grow as $\\lambda$ grows). However, the total number of independent groups is fixed at $N = 50,\\!000$ throughout. Note also that in this simulation the within-group standard deviation (0.25) is much smaller than the between-group standard deviation (1.0), so we should not expect the overall sample standard deviation to respond directly to changes in the overall sample size.<br /><br />We've implemented the above simulation in a simple R script&nbsp;included at the bottom of this post. We ran the simulation once to illustrate what's going on (Table 1) and then repeated the process 1,000 times to demonstrate how coverage is affected (Figure 1).<br /><br />In Table 1, the first column gives the Poisson parameter $\\lambda$, which governs the group sizes. The second column gives the percent of groups that have more than one observation per group, and the 3rd column gives the total number of observations across the 50,000 groups. The 4th and 5th columns give the half-width of the confidence interval (CI) by ignoring and accounting for the group structure.<br /><br /><br /><div dir=\"ltr\" style=\"margin-left: 0pt;\"><table style=\"border-collapse: collapse; border: none;\"><colgroup><col width=\"100\"></col><col width=\"100\"></col><col width=\"100\"></col><col width=\"100\"></col><col width=\"100\"></col></colgroup><tbody><tr style=\"height: 0px;\"><td style=\"border-bottom: solid #000000 1px; border-left: solid #cccccc 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 14.6667px; font-style: italic; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;\">ùúÜ</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 14.6667px; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;\">% groups with more than one observation</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;\"># observations</span></div></td><td style=\"background-color: white; border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;\">CI half-width (a)</span></div></td><td style=\"background-color: white; border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;\">CI half-width (b)</span></div></td></tr><tr style=\"height: 0px;\"><td style=\"border-bottom: solid #000000 1px; border-left: solid #cccccc 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">0.0</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">0%</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">50,000</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">0.009 </span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">0.009</span></div></td></tr><tr style=\"height: 0px;\"><td style=\"border-bottom: solid #000000 1px; border-left: solid #cccccc 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">0.2</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">18%</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">59,887</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">0.008 &nbsp;</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">0.010</span></div></td></tr><tr style=\"height: 0px;\"><td style=\"border-bottom: solid #000000 1px; border-left: solid #cccccc 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">0.4</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">33%</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">70,154</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">0.007 </span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">0.010 </span></div></td></tr><tr style=\"height: 0px;\"><td style=\"border-bottom: solid #000000 1px; border-left: solid #cccccc 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">0.6</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">45%</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">79,920</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">0.007</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">0.010</span></div></td></tr><tr style=\"height: 0px;\"><td style=\"border-bottom: solid #000000 1px; border-left: solid #cccccc 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">0.8</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">55%</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">89,699</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">0.006</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">0.010</span></div></td></tr><tr style=\"height: 0px;\"><td style=\"border-bottom: solid #000000 1px; border-left: solid #cccccc 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">1.0</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">63%</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">100,070</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">0.006</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">0.010</span></div></td></tr><tr style=\"height: 0px;\"><td style=\"border-bottom: solid #000000 1px; border-left: solid #cccccc 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">1.2</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">70%</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">109,838</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">0.006</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">0.010</span></div></td></tr></tbody></table></div><div><br /></div><b>Table 1:</b> Output of the simulation showing CIs that either (a) ignore or (b) account for within-group dependence.<br /><br />You can see that as you read down the table, $\\lambda$ increases and the groups become increasingly heterogeneous (more groups contribute multiple observations per group). Of course, when $\\lambda = 0$, each group contains only one observation, so there is no dependence to account for, but it is included for reference. By comparing the 4th and 5th column it is clear that as the groups become more heterogeneous, the discrepancy between the two CIs increases.<br /><br />For example, in the third to last row, when $\\lambda = 0.8$ and 55% of the groups have more than one observation, the CI when we (mistakenly) treat each observation as independent is 40% narrower than the CI when we (correctly) account for the true group structure (compare 0.006 to 0.010). Even when we have a less extreme example such as the second row, with $\\lambda = 0.2$ and a mere 18% of groups having multiple observations per group, there is already a noticeable difference in the CI widths.<br /><br />While Table 1 indicates why ignoring the group structure can give incorrect and excessively narrow CIs, it is even more instructive to look at the actual coverage of the two estimators. Coverage is the probability the CI computed by a particular method contains (or 'covers') the true value of the estimand, which is an effect of 0 in this simulation. The figure below shows empirical coverage rates based on 1,000 simulations. The red bars show how often the CI contained the true value of the estimand when we ignore the group structure. Contrast this with the cyan-colored bars, which show coverage of the CIs in which we properly account for the group structure. Even at values as low as $\\lambda = 0.2$, the coverage of the CI that ignores the group structure drops to 90%, while the CI that accounts for the group structure keeps its nominal coverage of 95% (blue dotted line), in line with the desired false-positive rate of 5%. By the time $\\lambda$ is 1.2, ignoring the group structure reduces coverage to 77%, showing how ignoring the group structure leads to optimistic inferences (i.e., CIs which are too narrow).</div><div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><br /><div class=\"separator\" style=\"clear: both; text-align: center;\"><a href=\"https://4.bp.blogspot.com/-F_KYHtECeMY/V6Cmc1Wju8I/AAAAAAAAD7g/XJfvDajK9NQFkUQqxsfdAiuVFnR7DjdCgCLcB/s1600/mind_your_units_coverage.png\" imageanchor=\"1\" style=\"margin-left: 1em; margin-right: 1em;\"><img border=\"0\" src=\"https://4.bp.blogspot.com/-F_KYHtECeMY/V6Cmc1Wju8I/AAAAAAAAD7g/XJfvDajK9NQFkUQqxsfdAiuVFnR7DjdCgCLcB/s1600/mind_your_units_coverage.png\" /></a></div><br /><b>Figure 1:</b> Coverage based on 1,000 simulations in which we either ignore (red) or account for (cyan) within-group dependence. The x-axis shows the average group size minus 1. The plot shows how ignoring the group structure (red) leads to increasingly optimistic inferences (i.e., too narrow CIs) while accounting for the group structure leads to nominal coverage regardless of group size (cyan).</div><div><br /><h2> How do we mind our units in analyses at Google? </h2>The above simulation already hints at one of our approaches to incorporating the group structure in some analyses at Google. Since we often want to compute effects on hundreds of outcome measures and since their underlying distributions can be funky, we frequently resort to non-parametric methods such as the bootstrap. A common approach, then, to minding our units is to use the bootstrap as in the above simulation: we re-sample at the group level in order to account for the group structure.<br /><br />Another non-parametric method frequently used at Google is the <a href=\"https://en.wikipedia.org/wiki/Jackknife_resampling\" style=\"vertical-align: baseline;\" target=\"_blank\">jackknife</a>. In order to account for the group structure, we use a blocked version of the jackknife in order to ensure that all observations from the same group are either left-out or included together.</div><div><br /></div><div>When we're feeling parametric, we may also use the mixed-level model approach as in the policy evaluation setting. An <a href=\"http://www.unofficialgoogledatascience.com/2016/03/using-random-effects-models-in.html\">earlier blogpost</a> described applications and implementation details of mixed-level modeling in the 'big data' setting at Google.</div><div><br /></div><div><h2>What if we don't (or can't) know our groups? </h2>The blocked resampling strategies described above, as well as random-effects modelling, require that we have access to the independent unit or experimental unit, that is, that we know the group_id at analysis time. However, we might not be able to store all observations for each group_id. In cases like this, we employ an alternative solution: we use logging and intermediate data storage to capture the necessary information about the group <span style=\"font-family: &quot;arial&quot;; font-size: 14.6667px; white-space: pre-wrap;\">structure.</span></div></div><div><div dir=\"ltr\" style=\"margin-bottom: 0pt; margin-top: 0pt;\"><br />When possible, we begin by including the group_id in our stored data. We then store the full dataset in a table like the one shown below. <br /><br /></div><div dir=\"ltr\" style=\"margin-left: 0pt;\"><table style=\"border-collapse: collapse; border: none;\"><colgroup><col width=\"100\"></col><col width=\"100\"></col></colgroup><tbody><tr style=\"height: 0px;\"><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 14.6667px; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;\">group_id</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;\">value</span></div></td></tr><tr style=\"height: 0px;\"><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 14.6667px; vertical-align: baseline; white-space: pre-wrap;\">1325</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">0.1</span></div></td></tr><tr style=\"height: 0px;\"><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 14.6667px; vertical-align: baseline; white-space: pre-wrap;\">1325</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">1.4</span></div></td></tr><tr style=\"height: 0px;\"><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 14.6667px; vertical-align: baseline; white-space: pre-wrap;\">2347</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">0.5</span></div></td></tr><tr style=\"height: 0px;\"><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 14.6667px; vertical-align: baseline; white-space: pre-wrap;\">2347</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">0.4</span></div></td></tr><tr style=\"height: 0px;\"><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 14.6667px; vertical-align: baseline; white-space: pre-wrap;\">7825</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">0.9</span></div></td></tr><tr style=\"height: 0px;\"><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">...</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">...</span></div></td></tr></tbody></table></div><br /><b>Table 2:</b> Individual observations for each group_id.<br /><br />If we have the full data of Table 2, we can go ahead and apply the analysis methods described in the preceding section, e.g., bootstrap re-sampling the group_ids. However, when we can't store the group_id, we store partly aggregated data, which we call <i>bucketed data</i>. To generate bucketed data, all of the observations associated with the same group_id will go into the same bucket. To illustrate a simple bucketing scheme, compute the buckets by: <br /><br /><div style=\"text-align: center;\">bucket = (group_id mod 100).&nbsp;</div><br />Now store data for each bucket:</div><div><br /><div dir=\"ltr\" style=\"margin-left: 0pt;\"><table style=\"border-collapse: collapse; border: none;\"><colgroup><col width=\"100\"></col><col width=\"100\"></col><col width=\"160\"></col></colgroup><tbody><tr style=\"height: 0px;\"><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;\">bucket</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;\">SUM(value)</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;\"># data points in bucket</span></div></td></tr><tr style=\"height: 0px;\"><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">25</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">2.4</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">3</span></div></td></tr><tr style=\"height: 0px;\"><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">47</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">0.9</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">2</span></div></td></tr><tr style=\"height: 0px;\"><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">...</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">...</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">...</span></div></td></tr></tbody></table></div></div><div><br /><b>Table 3:</b> Bucketed observations (after associating each group_id with a bucket).<br /><br /><br />This bucketed data is no longer amenable to the group_id level bootstrap because we have aggregated observations and can no longer generate a full sampling distribution. However, we can still use methods that work on the bucketed data (including bootstrapping the bucket level data to get an estimate of the variability). One approach used at Google is the streaming bucket approach described in section 2.1 of <a href=\"http://research.google.com/pubs/pub43157.html\" target=\"_blank\">this report</a> by Nicholas Chamandy and colleagues, in which the variability of each bucket's estimate is used to approximate the overall variability of the estimator.<br /><br />Bucketed data is also amenable to the jackknife, which we can use in a leave-one-bucket-out fashion. The bucketed implementation of the jackknife is popular at Google because it provides a good trade-off between storage needs and statistical coverage: we can slice and deliver results on the fly across many dimensions. At the same time, compared to the streaming bucket approach and other alternatives considered, we have found that the bucketed jackknife has better coverage properties for ill-behaved metrics such as rare rate metrics.<br /><br />It is worth taking a small tangent to make a note of caution on how you bucket the data.  The simple bucketing scheme illustrated above, (group_id mod 100), is a bad idea in practice. If there is anything systematic about how the group_id's are generated, however subtle, then a simple modulus by itself fails to break this systematic behavior. This means we would retain systematic differences across buckets. For example, if the id's had been generated in a way to account for load balancing of some database, you can end up with simple buckets having strange periodicity to them. In other words, it's important to ensure that the group_id's are randomly distributed to buckets. We also want the bucket assignment to be consistent (say, across time), so that we can aggregate the data in various ways. One approach to having consistent and randomly distributed assignment is to use a salt (such as the experiment name) together with a hash of the group_id prior to taking the modulus. That is, if you wanted 100 buckets you could compute <br /><br /><div style=\"text-align: center;\">bucket = (hash(group_id + salt) mod 100).</div><br />It is also worth noting that for many of our applications at Google we only use 20 buckets, which we have found to give good coverage while allowing for storage and processing efficiency. It is important to use enough buckets to ensure that your CIs have the right coverage properties, and remember that applications with less data will likely need to use more buckets.<br /><h2> Not all observations created equally </h2>The basic bucketing method assumes that we care equally about the contribution from each observation. However, from a product perspective we sometimes care about some observations more than others. Suppose for example we have an onboarding flow in which users create new accounts.  Most of the time, each user will only create one account, but some power users might open up multiple accounts. From a product standpoint, we may want to focus only on analyzing the first account created by each user because the onboarding is really designed to onboard the new users, and when a user is returning to make a subsequent account, they likely don't need the onboarding. We also often see that power users exhibit different behaviors from the regular one-time users.<br /><br />In light of such considerations, instead of fully accounting for the group structure of these power users, we might want to separately analyze the first observation per group versus any subsequent observations. One approach might be to only log data for the first observation, but it's dangerous to lose visibility into a sizable chunk of data, and we generally would still want to be able to summarize all of the data and use the totals to sanity check our results and product health. In this type of situation, we would implement a counter that will log whether the group_id is seen for the first time or returning. In other words, we are adding another dimension to the data which we can filter by later.&nbsp;</div><div><br /></div><div>Once the data is tagged with this additional dimension, we can store a combination of the bucket as well as whether the observations occur on the first instance or subsequent.  For example, assuming the data in Table 2 was sorted by time, we would store:</div><div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><br /></div><div dir=\"ltr\" style=\"margin-left: 0pt;\"><table style=\"border-collapse: collapse; border: none;\"><colgroup><col width=\"90\"></col><col width=\"100\"></col><col width=\"90\"></col><col width=\"164\"></col></colgroup><tbody><tr style=\"height: 0px;\"><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;\">bucket</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;\">counter</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;\">SUM(value)</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; font-weight: 700; vertical-align: baseline; white-space: pre-wrap;\"># data points in bucket</span></div></td></tr><tr style=\"height: 0px;\"><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">25</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">first</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">1</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">2</span></div></td></tr><tr style=\"height: 0px;\"><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">25</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">subsequent</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">1.4</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">1</span></div></td></tr><tr style=\"height: 0px;\"><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">47</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">first</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">0.5</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">1</span></div></td></tr><tr style=\"height: 0px;\"><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">47</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">subsequent</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">0.4</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">1</span></div></td></tr><tr style=\"height: 0px;\"><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">...</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">...</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">...</span></div></td><td style=\"border-bottom: solid #000000 1px; border-left: solid #000000 1px; border-right: solid #000000 1px; border-top: solid #000000 1px; padding: 3px 3px 3px 3px; vertical-align: bottom;\"><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt; text-align: center;\"><span style=\"font-family: &quot;arial&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">...</span></div></td></tr></tbody></table></div><div dir=\"ltr\" style=\"margin-bottom: 0pt; margin-top: 0pt;\"><br /><b>Table 4:</b> Bucketed data that enables separate analysis for first observations.<br /><br />While this approach requires more data storage than the straight bucketed data approach, it allows us to compute the metrics that are most relevant for evaluating the product.  Again, we can apply the &nbsp;jackknife, but now to the subset of the data where the counter value is first or subsequent. In other words, we have filtered our data by a dimension value. Similarly, you can see that you can add any filter into the bucketed data approach (as long as the filtering field is available in the raw data logs). <br /><br />In summary, there are many different ways to account for the group structure when the experimental unit differs from the unit of observation. Regardless of how you do it, do remember to mind your units. <br /><br /><h4>Acknowledgments</h4><i>Many thanks to Dancsi Percival for his work on the impact of group-size heterogeneity on confidence intervals and to the many colleagues at Google who have evolved many of the ideas and tools described in this post. </i><br /><i><br /></i><br /><h2>Appendix: R code</h2><div><span style=\"font-family: &quot;courier new&quot;; font-size: 13.3333px; line-height: 1.2; white-space: pre-wrap;\">ComputeBootstrapMeanCI &lt;- function(data, data.grouping, num.replicates = 2000) {</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;# Function to calculate confidence intervals for the mean via bootstrap.</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;# Must pass in a grouping variable to do the sampling on the grouping units.</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;# For bootstrap, we sample with replacement and each replicate is same size</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;# as original data; 95% CI obtained empirically by taking percentiles.</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;#</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;# Args:</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;# &nbsp;&nbsp;data: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Numeric vector of data.</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;# &nbsp;&nbsp;data.grouping: &nbsp;Numeric vector of grouping variable for data. Must be same</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;# &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the same length as data.</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;# &nbsp;&nbsp;num.replicates: Number of replicates.</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;#</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;# Returns:</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;# &nbsp;&nbsp;Half-width of a 95% CI.</span></div><span id=\"docs-internal-guid-aa550ea3-2f4e-a4b6-9383-80409dda6dae\" style=\"font-weight: normal;\"><br /></span><br /><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;# Split the data by the grouping variable.</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;assertthat::assert_that(length(data) == length(data.grouping))</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;data.split &lt;- split(data, data.grouping)</span></div><span style=\"font-weight: normal;\"><br /></span><br /><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;# Create replicates.</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;n.groups &lt;- length(unique(data.grouping))</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;data.samples &lt;-</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;&nbsp;&nbsp;replicate(num.replicates,</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unlist(sample(data.split, replace = TRUE, size = n.groups)),</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;simplify = FALSE)</span></div><span style=\"font-weight: normal;\"><br /></span><br /><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;# Get sampling distribution and summarize empirically.</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;bootstrap.means &lt;- vapply(data.samples, mean, 1)</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;half.width &lt;- unname(diff(quantile(bootstrap.means, c(0.025, 0.975))) / 2)</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;return(half.width)</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">}</span></div><span style=\"font-weight: normal;\"><br /></span><br /><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">set.seed(1237)</span></div><span style=\"font-weight: normal;\"><br /></span><br /><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">kNumGroups &lt;- 50000 &nbsp;# Total number of groups for all simulations.</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">kGroupSd &lt;- 1 &nbsp;# This is the standard deviation for group level means.</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">kNumReplicates &lt;- 2000 &nbsp;# Number of replicates for bootstrap.</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">kWithinGroupShrink &lt;- 0.25 &nbsp;# Shrinks standard dev. of w/in group observations.</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">kLambdaVector &lt;- seq(0, 1.2, by = 0.2) &nbsp;# Poisson parameter for group size.</span></div><span style=\"font-weight: normal;\"><br /></span><br /><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"># Generate the mean for each group and use this for all runs of simulation.</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">group.means &lt;- rnorm(kNumGroups, 0, kGroupSd)</span></div><span style=\"font-weight: normal;\"><br /></span><br /><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"># Loop over simulation parameters and store results in a summary data frame.</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">summary.df &lt;- data.frame()</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">for (param in kLambdaVector) {</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;group.sizes &lt;- rpois(kNumGroups, param) + 1</span></div><span style=\"font-weight: normal;\"><br /></span><br /><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;# Make data frame with group size &amp; group mean for ease of computation.</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;group.df &lt;- data.frame(id = 1:kNumGroups, group.means, group.sizes)</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;group.info &lt;- split(group.df, group.df$id)</span></div><span style=\"font-weight: normal;\"><br /></span><br /><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;# Helper function to generate per-group observations.</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;SimulateGroupObservations &lt;- function(data) {</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;&nbsp;&nbsp;rnorm(data$group.sizes, data$group.means, kWithinGroupShrink * kGroupSd)</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;}</span></div><span style=\"font-weight: normal;\"><br /></span><br /><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;# Generate vector of per-group observations for all groups.</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;full.obs &lt;- unlist(sapply(group.info, SimulateGroupObservations))</span></div><span style=\"font-weight: normal;\"><br /></span><br /><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;# Compute CI pretending that each observation is independent.</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;ignore.group.est.half.width &lt;-</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ComputeBootstrapMeanCI(full.obs, 1:length(full.obs), kNumReplicates)</span></div><span style=\"font-weight: normal;\"><br /></span><br /><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;# Get a vector of group id's to incorporate dependence structure.</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;group.id &lt;- unlist(sapply(group.info, function(x) rep(x$id, x$group.sizes)))</span></div><span style=\"font-weight: normal;\"><br /></span><br /><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;# Compute CI accounting for the group structure.</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;include.group.est.half.width &lt;-</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ComputeBootstrapMeanCI(full.obs, group.id, kNumReplicates)</span></div><span style=\"font-weight: normal;\"><br /></span><br /><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;# Formulate data frame to summarize results.</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;my.row &lt;- data.frame(lambda = param,</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;n.multigroups = sum(group.sizes &gt; 1) / kNumGroups,</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;n.observations = sum(group.sizes),</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ignore.group.est.half.width,</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;include.group.est.half.width)</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"> &nbsp;summary.df &lt;- rbind(summary.df, my.row)</span></div><div dir=\"ltr\" style=\"line-height: 1.2; margin-bottom: 0pt; margin-top: 0pt;\"><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\">}</span><br /><div><span style=\"color: black; font-family: &quot;courier new&quot;; font-size: 13.3333px; vertical-align: baseline; white-space: pre-wrap;\"><br /></span></div></div></div></div></div></div>",
  "link": [
    "",
    "",
    "",
    "",
    ""
  ],
  "author": {
    "name": "Kay Brodersen",
    "uri": "http://www.blogger.com/profile/15877220456041691465",
    "email": "noreply@blogger.com",
    "gd:image": ""
  },
  "media:thumbnail": "",
  "thr:total": 0
}