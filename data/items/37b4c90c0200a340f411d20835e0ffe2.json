{
  "title": "Reshaping Data in R",
  "link": "",
  "published": "2015-06-06T19:17:00-07:00",
  "updated": "2015-06-06T19:17:00-07:00",
  "author": {
    "name": "Cathy Yeh"
  },
  "id": "tag:efavdb.com,2015-06-06:/reshaping-data-in-r",
  "summary": "<p>Today, we&#8217;ll talk about reshaping data in R. At the same time, we&#8217;ll see how for-loops can be avoided by using R functionals (functions of functions). Functionals are faster than for-loops and make code easier to read by clearly laying out the intent of a&nbsp;loop.</p>\n<h3>The&nbsp;Task …</h3>",
  "content": "<p>Today, we&#8217;ll talk about reshaping data in R. At the same time, we&#8217;ll see how for-loops can be avoided by using R functionals (functions of functions). Functionals are faster than for-loops and make code easier to read by clearly laying out the intent of a&nbsp;loop.</p>\n<h3>The&nbsp;Task</h3>\n<p>Suppose you&#8217;re given the two tables below, saved as individual .csv files.  Each table contains measurements of plant height on specific days. The plants are split into fertilizer treatment groups A and B, and each plant can be uniquely identified by its&nbsp;id.</p>\n<p>Day&nbsp;1</p>\n<table>\n<thead>\n<tr>\n<th>day</th>\n<th>group</th>\n<th>id</th>\n<th>height</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>A</td>\n<td>A.1</td>\n<td>1.1</td>\n</tr>\n<tr>\n<td>1</td>\n<td>A</td>\n<td>A.2</td>\n<td>1.2</td>\n</tr>\n<tr>\n<td>1</td>\n<td>B</td>\n<td>B.1</td>\n<td>1</td>\n</tr>\n<tr>\n<td>1</td>\n<td>B</td>\n<td>B.2</td>\n<td>0.9</td>\n</tr>\n</tbody>\n</table>\n<p>Day&nbsp;2</p>\n<table>\n<thead>\n<tr>\n<th>day</th>\n<th>group</th>\n<th>id</th>\n<th>height</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>2</td>\n<td>A</td>\n<td>A.1</td>\n<td>1.5</td>\n</tr>\n<tr>\n<td>2</td>\n<td>A</td>\n<td>A.2</td>\n<td>1.5</td>\n</tr>\n<tr>\n<td>2</td>\n<td>B</td>\n<td>B.1</td>\n<td>2.1</td>\n</tr>\n<tr>\n<td>2</td>\n<td>B</td>\n<td>B.2</td>\n<td>1.9</td>\n</tr>\n</tbody>\n</table>\n<p>Your task is to split the data by treatment group rather than day. The desired output is one file per group, with day on the vertical of the new tables, plant id on the horizontal, and height as the value inside the table. For example, the new table for group A would&nbsp;be:</p>\n<p>Group&nbsp;A</p>\n<table>\n<thead>\n<tr>\n<th>day</th>\n<th>A.1</th>\n<th>A.2</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>1.1</td>\n<td>1.2</td>\n</tr>\n<tr>\n<td>2</td>\n<td>1.5</td>\n<td>1.5</td>\n</tr>\n</tbody>\n</table>\n<p>This example can be manually formatted in Excel pretty quickly, but in real life, data only looks like this if you&#8217;re in first grade. So, we&#8217;re going to take a little time to write a script now in order to save a lot of time in the&nbsp;future.</p>\n<h3>The code broken&nbsp;down</h3>\n<p>First, let&#8217;s load some libraries that are useful for reshaping&nbsp;data.</p>\n<div class=\"highlight\"><pre><span></span><span class=\"nf\">library</span><span class=\"p\">(</span><span class=\"s\">&quot;plyr&quot;</span><span class=\"p\">)</span>\n<span class=\"nf\">library</span><span class=\"p\">(</span><span class=\"s\">&quot;reshape2&quot;</span><span class=\"p\">)</span>\n</pre></div>\n\n\n<p>(To install, e.g. the plyr package, simply type <code>install.packages(\"plyr\")</code> in the R&nbsp;console.)</p>\n<p>Then store the full names, including directory path, of the files in a character vector. Here, the input .csv files are stored in the subdirectory&nbsp;&#8220;input&#8221;.</p>\n<div class=\"highlight\"><pre><span></span><span class=\"n\">in_files</span> <span class=\"o\">=</span> <span class=\"nf\">list.files</span><span class=\"p\">(</span><span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"s\">&quot;input&quot;</span><span class=\"p\">,</span> <span class=\"n\">pattern</span><span class=\"o\">=</span><span class=\"s\">&quot;*.csv&quot;</span><span class=\"p\">,</span> <span class=\"n\">full.names</span> <span class=\"o\">=</span> <span class=\"bp\">T</span><span class=\"p\">)</span>\n</pre></div>\n\n\n<p>Now, we&#8217;ll use <code>lapply(...)</code>, one of base R&#8217;s functionals, to read the input files into a list of data frames, which we call&nbsp;list_dfperday.</p>\n<div class=\"highlight\"><pre><span></span><span class=\"n\">list_dfperday</span> <span class=\"o\">=</span> <span class=\"nf\">lapply</span><span class=\"p\">(</span><span class=\"n\">in_files</span><span class=\"p\">,</span> <span class=\"n\">read.csv</span><span class=\"p\">)</span>\n</pre></div>\n\n\n<p><code>lapply()</code> loops over the the names of the files in <code>in_files</code></p>\n<ul>\n<li>to each file, apply the function <code>read.csv()</code>, which reads the contents of the file into a data&nbsp;frame</li>\n<li>output the result into a list of data frames, called dfs, of the same length as the character vector containing the file&nbsp;names</li>\n</ul>\n<p>Bind together (rbind) the data frames in the list by rows into a single data frame, so we can more conveniently subset the data by&nbsp;group.</p>\n<div class=\"highlight\"><pre><span></span><span class=\"n\">df</span> <span class=\"o\">=</span> <span class=\"nf\">ldply</span><span class=\"p\">(</span><span class=\"n\">list_dfperday</span><span class=\"p\">,</span> <span class=\"n\">rbind</span><span class=\"p\">)</span>\n</pre></div>\n\n\n<p>In the <code>plyr</code> package, the first two letters in the &#8220;&#8212;ply&#8221; functions indicate what type of object is being transformed into another. In this case, we are reshaping a list (&#8216;l&#8217;) of data frames into a data frame (&#8216;d&#8217;), hence&nbsp;&#8220;ldply&#8221;.</p>\n<p>Define a function to cast the data into a data frame with a shape specified by the formula <code>day ~ id</code>: per <em>day</em> (x-variable), output the corresponding height (value.var) of each plant <em>id</em>&nbsp;(y-variable).</p>\n<div class=\"highlight\"><pre><span></span><span class=\"n\">cast_short</span> <span class=\"o\">=</span> <span class=\"nf\">function</span><span class=\"p\">(</span><span class=\"n\">mydata</span><span class=\"p\">)</span> <span class=\"nf\">dcast</span><span class=\"p\">(</span><span class=\"n\">mydata</span><span class=\"p\">,</span> <span class=\"n\">day</span> <span class=\"o\">~</span> <span class=\"n\">id</span><span class=\"p\">,</span> <span class=\"n\">value.var</span> <span class=\"o\">=</span> <span class=\"n\">height</span><span class=\"p\">)</span>\n</pre></div>\n\n\n<p>So the function &#8220;cast_short&#8221; takes as its argument a data frame &#8220;mydata&#8221; (containing columns &#8220;day&#8221; and &#8220;id&#8221;) and returns a reshaped data frame with &#8220;day&#8221; on the rows and &#8220;id&#8221; on the&nbsp;columns.</p>\n<p>Now apply the function we just defined to each treatment group. Store the outcome of each application of <code>cast_short</code> into a list. (Also compare to the earlier use of <code>ldply</code>.)</p>\n<div class=\"highlight\"><pre><span></span><span class=\"n\">list_dfpergroup</span> <span class=\"o\">=</span> <span class=\"nf\">dlply</span><span class=\"p\">(</span><span class=\"n\">df</span><span class=\"p\">,</span> <span class=\"n\">.(group</span><span class=\"p\">),</span> <span class=\"n\">cast_short</span><span class=\"p\">)</span>\n</pre></div>\n\n\n<p>It&#8217;s finally time to write the formatted data frames to .csv files. We&#8217;ll output them in a new directory called &#8220;output&#8221; with the aid of another base R functional <code>mapply</code>.</p>\n<div class=\"highlight\"><pre><span></span><span class=\"n\">outdir</span> <span class=\"o\">=</span> <span class=\"s\">&quot;output&quot;</span>\n<span class=\"n\">outnames</span> <span class=\"o\">=</span> <span class=\"nf\">paste0</span><span class=\"p\">(</span><span class=\"nf\">names</span><span class=\"p\">(</span><span class=\"n\">list_dfpergroup</span><span class=\"p\">),</span><span class=\"s\">&quot;.csv&quot;</span><span class=\"p\">)</span>\n\n<span class=\"nf\">dir.create</span><span class=\"p\">(</span><span class=\"n\">outdir</span><span class=\"p\">)</span>\n<span class=\"nf\">mapply</span><span class=\"p\">(</span><span class=\"nf\">function</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"p\">,</span><span class=\"n\">y</span><span class=\"p\">)</span> <span class=\"nf\">write.csv</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"p\">,</span> <span class=\"nf\">file.path</span><span class=\"p\">(</span><span class=\"n\">outdir</span><span class=\"p\">,</span><span class=\"n\">y</span><span class=\"p\">),</span> <span class=\"n\">row.names</span><span class=\"o\">=</span><span class=\"bp\">F</span><span class=\"p\">),</span>\n<span class=\"n\">list_dfpergroup</span><span class=\"p\">,</span>\n<span class=\"n\">outnames</span><span class=\"p\">)</span>\n</pre></div>\n\n\n<p><code>mapply</code> allows functions with multiple arguments to be applied in a loop. Here, we&#8217;ve defined an anonymous, i.e. unnamed, function within mapply that has two arguments: the value of <em>x</em> is given by list_dfpergroup, and <em>y</em> is given by the character vector outnames. In other words, mapply steps through the list and vector simultaneously, writing list_dfpergroup<span class=\"math\">\\(_i\\)</span> to a file named outnames<span class=\"math\">\\(_i\\)</span>.</p>\n<h3>The code in one&nbsp;piece</h3>\n<p>Now here&#8217;s the code all in one piece. Note that the core reshaping takes place in three lines, starting at the line containing <code>ldply</code>.</p>\n<div class=\"highlight\"><pre><span></span><span class=\"nf\">library</span><span class=\"p\">(</span><span class=\"s\">&quot;plyr&quot;</span><span class=\"p\">)</span>\n<span class=\"nf\">library</span><span class=\"p\">(</span><span class=\"s\">&quot;reshape2&quot;</span><span class=\"p\">)</span>\n\n<span class=\"n\">in_files</span> <span class=\"o\">=</span> <span class=\"nf\">list.files</span><span class=\"p\">(</span><span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"s\">&quot;input&quot;</span><span class=\"p\">,</span> <span class=\"n\">pattern</span><span class=\"o\">=</span><span class=\"s\">&quot;*.csv&quot;</span><span class=\"p\">,</span> <span class=\"n\">full.names</span> <span class=\"o\">=</span> <span class=\"bp\">T</span><span class=\"p\">)</span>\n<span class=\"n\">list_dfperday</span> <span class=\"o\">=</span> <span class=\"nf\">lapply</span><span class=\"p\">(</span><span class=\"n\">in_files</span><span class=\"p\">,</span> <span class=\"n\">read.csv</span><span class=\"p\">)</span>\n\n<span class=\"n\">df</span> <span class=\"o\">=</span> <span class=\"nf\">ldply</span><span class=\"p\">(</span><span class=\"n\">list_dfperday</span><span class=\"p\">,</span> <span class=\"n\">rbind</span><span class=\"p\">)</span>\n<span class=\"n\">cast_short</span> <span class=\"o\">=</span> <span class=\"nf\">function</span><span class=\"p\">(</span><span class=\"n\">mydata</span><span class=\"p\">)</span> <span class=\"nf\">dcast</span><span class=\"p\">(</span><span class=\"n\">mydata</span><span class=\"p\">,</span> <span class=\"n\">day</span> <span class=\"o\">~</span> <span class=\"n\">id</span><span class=\"p\">,</span> <span class=\"n\">value.var</span> <span class=\"o\">=</span> <span class=\"n\">height</span><span class=\"p\">)</span>\n<span class=\"n\">list_dfpergroup</span> <span class=\"o\">=</span> <span class=\"nf\">dlply</span><span class=\"p\">(</span><span class=\"n\">df</span><span class=\"p\">,</span> <span class=\"n\">.(group</span><span class=\"p\">),</span> <span class=\"n\">cast_short</span><span class=\"p\">)</span>\n\n<span class=\"n\">outdir</span> <span class=\"o\">=</span> <span class=\"s\">&quot;output&quot;</span>\n<span class=\"n\">outnames</span> <span class=\"o\">=</span> <span class=\"nf\">paste0</span><span class=\"p\">(</span><span class=\"nf\">names</span><span class=\"p\">(</span><span class=\"n\">list_dfpergroup</span><span class=\"p\">),</span><span class=\"s\">&quot;.csv&quot;</span><span class=\"p\">)</span>\n\n<span class=\"nf\">dir.create</span><span class=\"p\">(</span><span class=\"n\">outdir</span><span class=\"p\">)</span>\n<span class=\"nf\">mapply</span><span class=\"p\">(</span><span class=\"nf\">function</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"p\">,</span><span class=\"n\">y</span><span class=\"p\">)</span> <span class=\"nf\">write.csv</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"p\">,</span> <span class=\"nf\">file.path</span><span class=\"p\">(</span><span class=\"n\">outdir</span><span class=\"p\">,</span><span class=\"n\">y</span><span class=\"p\">),</span> <span class=\"n\">row.names</span><span class=\"o\">=</span><span class=\"bp\">F</span><span class=\"p\">),</span>\n<span class=\"n\">list_dfpergroup</span><span class=\"p\">,</span>\n<span class=\"n\">outnames</span><span class=\"p\">)</span>\n</pre></div>\n\n\n<script type=\"text/javascript\">if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {\n    var align = \"center\",\n        indent = \"0em\",\n        linebreak = \"false\";\n\n    if (false) {\n        align = (screen.width < 768) ? \"left\" : align;\n        indent = (screen.width < 768) ? \"0em\" : indent;\n        linebreak = (screen.width < 768) ? 'true' : linebreak;\n    }\n\n    var mathjaxscript = document.createElement('script');\n    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';\n    mathjaxscript.type = 'text/javascript';\n    mathjaxscript.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/latest.js?config=TeX-AMS-MML_HTMLorMML';\n\n    var configscript = document.createElement('script');\n    configscript.type = 'text/x-mathjax-config';\n    configscript[(window.opera ? \"innerHTML\" : \"text\")] =\n        \"MathJax.Hub.Config({\" +\n        \"    config: ['MMLorHTML.js'],\" +\n        \"    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'none' } },\" +\n        \"    jax: ['input/TeX','input/MathML','output/HTML-CSS'],\" +\n        \"    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js'],\" +\n        \"    displayAlign: '\"+ align +\"',\" +\n        \"    displayIndent: '\"+ indent +\"',\" +\n        \"    showMathMenu: true,\" +\n        \"    messageStyle: 'normal',\" +\n        \"    tex2jax: { \" +\n        \"        inlineMath: [ ['\\\\\\\\(','\\\\\\\\)'] ], \" +\n        \"        displayMath: [ ['$$','$$'] ],\" +\n        \"        processEscapes: true,\" +\n        \"        preview: 'TeX',\" +\n        \"    }, \" +\n        \"    'HTML-CSS': { \" +\n        \"        availableFonts: ['STIX', 'TeX'],\" +\n        \"        preferredFont: 'STIX',\" +\n        \"        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} },\" +\n        \"        linebreaks: { automatic: \"+ linebreak +\", width: '90% container' },\" +\n        \"    }, \" +\n        \"}); \" +\n        \"if ('default' !== 'default') {\" +\n            \"MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {\" +\n                \"var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;\" +\n                \"VARIANT['normal'].fonts.unshift('MathJax_default');\" +\n                \"VARIANT['bold'].fonts.unshift('MathJax_default-bold');\" +\n                \"VARIANT['italic'].fonts.unshift('MathJax_default-italic');\" +\n                \"VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');\" +\n            \"});\" +\n            \"MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {\" +\n                \"var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;\" +\n                \"VARIANT['normal'].fonts.unshift('MathJax_default');\" +\n                \"VARIANT['bold'].fonts.unshift('MathJax_default-bold');\" +\n                \"VARIANT['italic'].fonts.unshift('MathJax_default-italic');\" +\n                \"VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');\" +\n            \"});\" +\n        \"}\";\n\n    (document.body || document.getElementsByTagName('head')[0]).appendChild(configscript);\n    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);\n}\n</script>",
  "category": [
    "",
    "",
    ""
  ]
}