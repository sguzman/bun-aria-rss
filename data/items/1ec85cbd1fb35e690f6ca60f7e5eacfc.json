{
  "title": "Download shapefiles from ESRI ArcGIS Online Story Maps",
  "link": "https://www.r-bloggers.com/2022/11/download-shapefiles-from-esri-arcgis-online-story-maps/",
  "dc:creator": "Jonathan Chang",
  "pubDate": "Fri, 04 Nov 2022 00:00:00 +0000",
  "category": "R bloggers",
  "guid": "https://jonathanchang.org/blog/downloading-esri-online-shapefiles",
  "description": "<div style = \"width:60%; display: inline-block; float:left; \">\n     Liz recently needed some shapefiles from an ArcGIS online map. Checking out the linked page, it’s immediately clear that there’s a lot of data, and no obvious way to get it from a download or share link anywhere on the app page. The desired solut...</div>\n<div style = \"width: 40%; display: inline-block; float:right;\"></div>\n<div style=\"clear: both;\"></div>\n<strong>Continue reading</strong>: <a href=\"https://www.r-bloggers.com/2022/11/download-shapefiles-from-esri-arcgis-online-story-maps/\">Download shapefiles from ESRI ArcGIS Online Story Maps</a>",
  "content:encoded": "<!-- \n<div style=\"min-height: 30px;\">\n[social4i size=\"small\" align=\"align-left\"]\n</div>\n-->\n\n<div style=\"border: 1px solid; background: none repeat scroll 0 0 #EDEDED; margin: 1px; font-size: 12px;\">\n[This article was first published on  <strong><a href=\"https://jonathanchang.org/blog/downloading-esri-online-shapefiles/\"> Jonathan Chang</a></strong>, and kindly contributed to <a href=\"https://www.r-bloggers.com/\" rel=\"nofollow\">R-bloggers</a>].  (You can report issue about the content on this page <a href=\"https://www.r-bloggers.com/contact-us/\">here</a>)\n<hr>Want to share your content on R-bloggers?<a href=\"https://www.r-bloggers.com/add-your-blog/\" rel=\"nofollow\"> click here</a> if you have a blog, or <a href=\"http://r-posts.com/\" rel=\"nofollow\"> here</a> if you don't.\n</div>\n\n     <p>Liz <a href=\"https://twitter.com/E_Carlen/status/1587195960823783429\" rel=\"nofollow\" target=\"_blank\">recently needed some shapefiles</a> from an ArcGIS online map. Checking out the <a href=\"https://www.arcgis.com/apps/MapSeries/index.html?appid=34603bd48c9f496fa2750a770f655013\" rel=\"nofollow\" target=\"_blank\">linked page</a>, it’s immediately clear that there’s a lot of data, and no obvious way to get it from a download or share link anywhere on the app page. The desired solution is anything <em>but</em> taking a screenshot and tracing it in ImageJ, since that’s an absolute last resort.</p>\n      <p>In this post, I’ll walk through how I managed to get those shapefiles downloaded, and hopefully provide some easy tips to do the same for other ArcGIS online maps.</p>\n      <h2>The power of the web inspector</h2>\n      <p>This is fundamentally a <a href=\"https://en.wikipedia.org/wiki/Web_scraping\" rel=\"nofollow\" target=\"_blank\">web scraping task</a>, and I’ll start with opening the web developer tools in Firefox, by right-clicking a promising bit on the page (the map itself) and selecting “Inspect”. Looking through the HTML tree in the web inspector panel that pops up, I can see that while the shapefiles do appear to exist locally, these are parsed into a gnarly embedded <a href=\"https://en.wikipedia.org/wiki/Scalable_Vector_Graphics\" rel=\"nofollow\" target=\"_blank\">SVG object</a>. This could be used to reconstruct the shapefile, but it seems like a big pain that I don’t want to deal with, so I move on from this avenue.</p>\n      <p><img src=\"https://i0.wp.com/jonathanchang.org/uploads/2022/geojson/inspector-html.png?w=578&#038;ssl=1\" alt=\"Screenshot of an HTML source code tree, showing a complex SVG object.\" srcset_temp=\"/uploads/2022/geojson/inspector-html.png 2x\" data-recalc-dims=\"1\"></p>\n      <p>Next, I’ll check out the network tab. I’ll need to refresh the page, and I can see that there are a ton of requests that go to a lot of different places. But, I suspect that any shapefile that’s loaded will likely be downloaded via <a href=\"https://en.wikipedia.org/wiki/XMLHttpRequest\" rel=\"nofollow\" target=\"_blank\">XHR</a>, initiated from Javascript, and quite possibly hitting some API endpoint that probably speaks in JSON. I filter by JS and XHR and immediately see an request that pops out at me, to an endpoint at <code>services.arcgis.com</code> called <code>data</code> with a query payload of <code>f=json</code>. Inspecting that response object leads me to another API endpoint that appears to be what I want!</p>\n      <p><img src=\"https://i2.wp.com/jonathanchang.org/uploads/2022/geojson/inspector-json.png?w=578&#038;ssl=1\" alt=\"Screenshot of the network panel of the web developer console, showing a JSON response object with interesting URL fields.\" srcset_temp=\"/uploads/2022/geojson/inspector-json.png 2x\" data-recalc-dims=\"1\"></p>\n      <h2>ESRI API endpoints</h2>\n      <p>I’m actually fairly familiar with ESRI’s REST APIs, and I know that I can actually <a href=\"https://services.arcgis.com/8df8p0NlLFEShl0r/arcgis/rest/services/FHA_Grades/FeatureServer/0\" rel=\"nofollow\" target=\"_blank\">navigate to the API endpoint</a> and it’ll provide a fairly good description of its data. I can also interactively query it in the browser, without having to muck about with cURL in Terminal or anything like that. ESRI is quite humane in this respect, but again, there doesn’t seem to be an easy way to download the full shapefile directly from this endpoint, and I don’t feel quite up to the task of writing out a shapefile by copying and pasting a bunch of stuff.</p>\n      <p><img src=\"https://i0.wp.com/jonathanchang.org/uploads/2022/geojson/esri-endpoint.png?w=578&#038;ssl=1\" alt=\"Screenshot of the ESRI REST API query tool, showing the result of a query with complex shapefile geometries.\" srcset_temp=\"/uploads/2022/geojson/esri-endpoint.png 2x\" data-recalc-dims=\"1\"></p>\n      <p>A quick Google sojourn leads me to <code>pyesridump</code>, <a href=\"https://github.com/openaddresses/pyesridump\" rel=\"nofollow\" target=\"_blank\">a wonderful tool</a> by the folks over at OpenAddresses. This is actually exactly what I needed! Install the <code>esri2geojson</code> command with <a href=\"https://pypa.github.io/pipx/\" rel=\"nofollow\" target=\"_blank\">pipx</a>:</p>\n      <div class=\"language-console?prompt=% highlighter-rouge\">\n        <div class=\"highlight\">\n          <pre>% pipx install esridump\n  installed package esridump 1.11.0, installed using Python 3.10.8\n  These apps are now globally available\n    - esri2geojson\ndone! &#x2728; &#x1f31f; &#x2728;\n% esri2geojson “https://services.arcgis.com/8df8p0NlLFEShl0r/ArcGIS/rest/services/FHA_Grades/FeatureServer/0” fha.geojson\n2022-11-03 23:42:54,990 - cli.esridump - INFO - Built 1 requests using resultOffset method\n</pre>\n        </div>\n      </div>\n    </p>\n    <p>Now to fire up R and see that everything looks right by plotting it.</p>\n    <div class=\"language-console?lang=r&#038;comments=true&#038;output=plaintext&#038;prompt=> highlighter-rouge&#8221;>\n      <div class=\"highlight\">\n        <pre>> library(sf)\nLinking to GEOS 3.10.2, GDAL 3.4.2, PROJ 8.2.1; sf_use_s2() is TRUE\n> library(ggplot2)\n\n> xx <- read_sf(“fha.geojson”)\n\n> xx\nSimple feature collection with 74 features and 4 fields\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: -77.188 ymin: 38.79005 xmax: -76.8772 ymax: 39.0666\nGeodetic CRS:  WGS 84\n# A tibble: 74 × 5\n     FID Grade Shape__Area Shape__Length                         geometry\n<int> <chr>       <dbl>         <dbl>                    <POLYGON [°]>\n1     1 E5       2268576.         5849. ((-76.90432 38.85715, -76.9018 …\n2     2 G7      13563378.        19322. ((-76.93371 38.87391, -76.90942…\n3     3 H2       7772476.        12002. ((-76.88671 38.90218, -76.89007…\n4     4 H1      12964128.        20269. ((-76.90942 38.89269, -76.93095…\n5     5 G1       6516531.        19844. ((-76.93428 38.88311, -76.93574…\n6     6 C4       7199183.        16914. ((-76.93371 38.87391, -76.96229…\n7     7 H2       7328078.        14489. ((-76.96229 38.85169, -76.97798…\n8     8 E2       9790479.        21957. ((-76.98859 38.8399, -76.9885 3…\n9     9 F2       5253684.        15352. ((-76.99618 38.85609, -77.00305…\n10    10 H1       1810343.         8218. ((-76.97203 38.89815, -76.9833 …\n# … with 64 more rows\n&#x2139; Use print(n = ...) to see more rows\n\n> ggplot(xx) + geom_sf(aes(fill = Grade)) + theme_minimal()\n</pre>\n      </div>\n    </div>\n    <picture>\n      <source type=\"image/svg+xml\" srcset_temp=\"/uploads/2022/geojson/fha-shapefile.svg\">\n      <img src=\"https://i0.wp.com/jonathanchang.org/uploads/2022/geojson/fha-shapefile.png?w=578&#038;ssl=1\" alt=\"Plot of the FHA shapefile dataset of Washington, DC.\" data-recalc-dims=\"1\">\n    </picture>\n    <p>It looks fantastic, and is ready for further data analysis now!</p>\n    <h2>A more direct route</h2>\n    <p>After all of this, I was curious if there was a better way, so I did some digging. This ArcGIS Online tool is called ESRI Story Map Series, and the source code is actually <a href=\"https://github.com/Esri/storymap-series\" rel=\"nofollow\" target=\"_blank\">available on GitHub</a>. Looking through the repository we can see it’s a Javascript app with a fairly rich library API, intended for ESRI’s customers to develop “story maps” with deep integrations to justify their hefty enterprise contracts. In the README, one of the <a href=\"https://github.com/Esri/storymap-series/blob/109e94458da8f297cd21b7ed877832b8a8ce9867/README.md#link-between-entries\" rel=\"nofollow\" target=\"_blank\">code suggestions</a> points in an interesting direction, and I reopened the web inspector console to check it out.</p>\n    <p>Based on the README example, I learned that the top-level object is called <code>app</code>, and that layers can be obtained through a method on the <code>app.map</code> object. I grub around in the app’s internal data structures using the Javascript console, and discover an interesting <code>_layers</code> key inside this object, which seems to have the relevant data that I’m interested in.</p>\n    <p><img src=\"https://i2.wp.com/jonathanchang.org/uploads/2022/geojson/inspector-js.png?w=578&#038;ssl=1\" alt=\"Screenshot of the console panel of the web developer console, showing a Javascript data object corresponding to the ESRI map being shown in the map app.\" srcset_temp=\"/uploads/2022/geojson/inspector-js.png 2x\" data-recalc-dims=\"1\"></p>\n    <p>The full invocation in the Javascript console to get the ESRI REST API endpoint is therefore:</p>\n    <div class=\"language-javascript highlighter-rouge\">\n      <div class=\"highlight\">\n        <pre>app.map._layers.FHA_Grades_4159.url\n// \"https://services.arcgis.com/8df8p0NlLFEShl0r/arcgis/rest/services/FHA_Grades/FeatureServer/0\" \n</pre>\n      </div>\n    </div>\n    \n<div style=\"border: 1px solid; background: none repeat scroll 0 0 #EDEDED; margin: 1px; font-size: 13px;\">\n<div style=\"text-align: center;\">To <strong>leave a comment</strong> for the author, please follow the link and comment on their blog: <strong><a href=\"https://jonathanchang.org/blog/downloading-esri-online-shapefiles/\"> Jonathan Chang</a></strong>.</div>\n<hr />\n<a href=\"https://www.r-bloggers.com/\" rel=\"nofollow\">R-bloggers.com</a> offers <strong><a href=\"https://feedburner.google.com/fb/a/mailverify?uri=RBloggers\" rel=\"nofollow\">daily e-mail updates</a></strong> about <a title=\"The R Project for Statistical Computing\" href=\"https://www.r-project.org/\" rel=\"nofollow\">R</a> news and tutorials about <a title=\"R tutorials\" href=\"https://www.r-bloggers.com/how-to-learn-r-2/\" rel=\"nofollow\">learning R</a> and many other topics. <a title=\"Data science jobs\" href=\"https://www.r-users.com/\" rel=\"nofollow\">Click here if you're looking to post or find an R/data-science job</a>.\n\n<hr>Want to share your content on R-bloggers?<a href=\"https://www.r-bloggers.com/add-your-blog/\" rel=\"nofollow\"> click here</a> if you have a blog, or <a href=\"http://r-posts.com/\" rel=\"nofollow\"> here</a> if you don't.\n</div><strong>Continue reading</strong>: <a href=\"https://www.r-bloggers.com/2022/11/download-shapefiles-from-esri-arcgis-online-story-maps/\">Download shapefiles from ESRI ArcGIS Online Story Maps</a>",
  "enclosure": "",
  "post-id": 334336
}