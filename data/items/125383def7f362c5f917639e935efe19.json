{
  "title": "Authenticated API Testing Using Travis CI",
  "description": "<p>As I‚Äôve become more serious about contributing in the open-source community, having quality tests for my packages has been something I‚Äôve spent much more time on than when I was¬†just¬†writing quick-and-dirty code for¬†my own purposes. My most used open-sourced package is <a href=\"http://randyzwitch.com/tags/#rsitecatalyst\">RSiteCatalyst</a>, which accesses the Adobe Analytics (authenticated) API, which poses a problem: how do you maintain a project on GitHub with a full test suite, while at the same time not hard-coding your credentials in plain sight for everyone to see?</p>",
  "pubDate": "Thu, 06 Aug 2015 20:21:50 +0000",
  "link": "http://randyzwitch.com/authentication-travis-ci/",
  "guid": "http://randyzwitch.com/authentication-travis-ci/",
  "content": "<p>As I‚Äôve become more serious about contributing in the open-source community, having quality tests for my packages has been something I‚Äôve spent much more time on than when I was¬†just¬†writing quick-and-dirty code for¬†my own purposes. My most used open-sourced package is <a href=\"http://randyzwitch.com/tags/#rsitecatalyst\">RSiteCatalyst</a>, which accesses the Adobe Analytics (authenticated) API, which poses a problem: how do you maintain a project on GitHub with a full test suite, while at the same time not hard-coding your credentials in plain sight for everyone to see?</p>\n\n<p>The answer ends up being using <a href=\"http://docs.travis-ci.com/user/environment-variables/#Encrypted-Variables\">encrypted environment variables</a> within¬†<a href=\"https://travis-ci.org/\">Travis CI</a>.</p>\n\n<h3 id=\"testthat\">Testthat!</h3>\n\n<p>In terms of a testing framework, Hadley Wickham provides a great testing framework in <a href=\"https://github.com/hadley/testthat\">testthat</a>; while I wouldn‚Äôt go as far as he does to say that the package makes testing <em>fun</em>, it certainly makes testing <em>easy</em>. Let‚Äôs take a look at some of the tests in RSiteCatalyst from the <code class=\"language-plaintext highlighter-rouge\">QueueOvertime</code> function:</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><table class=\"rouge-table\"><tbody><tr><td class=\"gutter gl\"><pre class=\"lineno\">1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n47\n48\n49\n50\n51\n52\n53\n54\n55\n56\n57\n58\n59\n60\n61\n62\n63\n64\n65\n66\n67\n68\n69\n70\n71\n72\n73\n</pre></td><td class=\"code\"><pre><span class=\"n\">test_that</span><span class=\"p\">(</span><span class=\"s2\">\"Validate QueueOvertime using legacy credentials\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n\n  </span><span class=\"n\">skip_on_cran</span><span class=\"p\">()</span><span class=\"w\">\n\n  </span><span class=\"c1\">#Correct [masked] credentials</span><span class=\"w\">\n  </span><span class=\"n\">SCAuth</span><span class=\"p\">(</span><span class=\"n\">Sys.getenv</span><span class=\"p\">(</span><span class=\"s2\">\"USER\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">Sys.getenv</span><span class=\"p\">(</span><span class=\"s2\">\"SECRET\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span><span class=\"p\">))</span><span class=\"w\">\n\n  </span><span class=\"c1\">#Single Metric, No granularity (summary report)</span><span class=\"w\">\n  </span><span class=\"n\">aa</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">QueueOvertime</span><span class=\"p\">(</span><span class=\"s2\">\"zwitchdev\"</span><span class=\"p\">,</span><span class=\"w\">\n                      </span><span class=\"s2\">\"2014-01-01\"</span><span class=\"p\">,</span><span class=\"w\">\n                      </span><span class=\"s2\">\"2014-12-31\"</span><span class=\"p\">,</span><span class=\"w\">\n                      </span><span class=\"s2\">\"visits\"</span><span class=\"p\">,</span><span class=\"w\">\n                      </span><span class=\"s2\">\"\"</span><span class=\"p\">)</span><span class=\"w\">\n\n  </span><span class=\"c1\">#Validate returned value is a data.frame</span><span class=\"w\">\n  </span><span class=\"n\">expect_is</span><span class=\"p\">(</span><span class=\"n\">aa</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"data.frame\"</span><span class=\"p\">)</span><span class=\"w\">\n\n  </span><span class=\"c1\">#Single Metric, Daily Granularity</span><span class=\"w\">\n  </span><span class=\"n\">bb</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">QueueOvertime</span><span class=\"p\">(</span><span class=\"s2\">\"zwitchdev\"</span><span class=\"p\">,</span><span class=\"w\">\n                      </span><span class=\"s2\">\"2014-01-01\"</span><span class=\"p\">,</span><span class=\"w\">\n                      </span><span class=\"s2\">\"2014-12-31\"</span><span class=\"p\">,</span><span class=\"w\">\n                      </span><span class=\"s2\">\"visits\"</span><span class=\"p\">,</span><span class=\"w\">\n                      </span><span class=\"s2\">\"day\"</span><span class=\"p\">)</span><span class=\"w\">\n\n  </span><span class=\"c1\">#Validate returned value is a data.frame</span><span class=\"w\">\n  </span><span class=\"n\">expect_is</span><span class=\"p\">(</span><span class=\"n\">bb</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"data.frame\"</span><span class=\"p\">)</span><span class=\"w\">\n\n  </span><span class=\"c1\">#Single Metric, Week Granularity</span><span class=\"w\">\n  </span><span class=\"n\">cc</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">QueueOvertime</span><span class=\"p\">(</span><span class=\"s2\">\"zwitchdev\"</span><span class=\"p\">,</span><span class=\"w\">\n                      </span><span class=\"s2\">\"2014-01-01\"</span><span class=\"p\">,</span><span class=\"w\">\n                      </span><span class=\"s2\">\"2014-12-31\"</span><span class=\"p\">,</span><span class=\"w\">\n                      </span><span class=\"s2\">\"visits\"</span><span class=\"p\">,</span><span class=\"w\">\n                      </span><span class=\"s2\">\"week\"</span><span class=\"p\">)</span><span class=\"w\">\n\n  </span><span class=\"c1\">#Validate returned value is a data.frame</span><span class=\"w\">\n  </span><span class=\"n\">expect_is</span><span class=\"p\">(</span><span class=\"n\">cc</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"data.frame\"</span><span class=\"p\">)</span><span class=\"w\">\n\n  </span><span class=\"c1\">#Two Metrics, Week Granularity</span><span class=\"w\">\n  </span><span class=\"n\">dd</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">QueueOvertime</span><span class=\"p\">(</span><span class=\"s2\">\"zwitchdev\"</span><span class=\"p\">,</span><span class=\"w\">\n                      </span><span class=\"s2\">\"2014-01-01\"</span><span class=\"p\">,</span><span class=\"w\">\n                      </span><span class=\"s2\">\"2014-12-31\"</span><span class=\"p\">,</span><span class=\"w\">\n                      </span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"s2\">\"visits\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"pageviews\"</span><span class=\"p\">),</span><span class=\"w\">\n                      </span><span class=\"s2\">\"week\"</span><span class=\"p\">)</span><span class=\"w\">\n\n  </span><span class=\"c1\">#Validate returned value is a data.frame</span><span class=\"w\">\n  </span><span class=\"n\">expect_is</span><span class=\"p\">(</span><span class=\"n\">dd</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"data.frame\"</span><span class=\"p\">)</span><span class=\"w\">\n\n  </span><span class=\"c1\">#Two Metrics, Month Granularity, Social Visitors</span><span class=\"w\">\n  </span><span class=\"n\">ee</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">QueueOvertime</span><span class=\"p\">(</span><span class=\"s2\">\"zwitchdev\"</span><span class=\"p\">,</span><span class=\"w\">\n                      </span><span class=\"s2\">\"2014-01-01\"</span><span class=\"p\">,</span><span class=\"w\">\n                      </span><span class=\"s2\">\"2014-12-31\"</span><span class=\"p\">,</span><span class=\"w\">\n                      </span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"s2\">\"visits\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"pageviews\"</span><span class=\"p\">),</span><span class=\"w\">\n                      </span><span class=\"s2\">\"month\"</span><span class=\"p\">,</span><span class=\"w\">\n                      </span><span class=\"s2\">\"5433e4e6e4b02df70be4ac63\"</span><span class=\"p\">)</span><span class=\"w\">\n\n  </span><span class=\"c1\">#Validate returned value is a data.frame</span><span class=\"w\">\n  </span><span class=\"n\">expect_is</span><span class=\"p\">(</span><span class=\"n\">ee</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"data.frame\"</span><span class=\"p\">)</span><span class=\"w\">\n\n  </span><span class=\"c1\">#Two Metrics, Day Granularity, Social Visitors, Anomaly Detection</span><span class=\"w\">\n  </span><span class=\"n\">ff</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">QueueOvertime</span><span class=\"p\">(</span><span class=\"s2\">\"zwitchdev\"</span><span class=\"p\">,</span><span class=\"w\">\n                      </span><span class=\"s2\">\"2014-01-01\"</span><span class=\"p\">,</span><span class=\"w\">\n                      </span><span class=\"s2\">\"2014-12-31\"</span><span class=\"p\">,</span><span class=\"w\">\n                      </span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"s2\">\"visits\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"pageviews\"</span><span class=\"p\">),</span><span class=\"w\">\n                      </span><span class=\"s2\">\"day\"</span><span class=\"p\">,</span><span class=\"w\">\n                      </span><span class=\"s2\">\"5433e4e6e4b02df70be4ac63\"</span><span class=\"p\">,</span><span class=\"w\">\n                      </span><span class=\"n\">anomaly.detection</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"1\"</span><span class=\"p\">)</span><span class=\"w\">\n\n  </span><span class=\"c1\">#Validate returned value is a data.frame</span><span class=\"w\">\n  </span><span class=\"n\">expect_is</span><span class=\"p\">(</span><span class=\"n\">ff</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"data.frame\"</span><span class=\"p\">)</span><span class=\"w\">\n\n\n\n</span><span class=\"p\">})</span>\n</pre></td></tr></tbody></table></code></pre></figure>\n\n<p>From the code above, you can see the tests are fairly simplistic; for a given number of permutations of arguments of the function, I test to see if a data frame was returned. This is because, for the most part, RSiteCatalyst is just a means of generating JSON calls, submitting them to the Adobe Analytics API, then parsing the results into an R data frame.</p>\n\n<p>Since there is very little additional logic in the package, I don‚Äôt spend a bunch of time testing what data is actually returned (i.e. what is returned depends on the Adobe Analytics API, not R). What is interesting is line 6; I reference <code class=\"language-plaintext highlighter-rouge\">Sys.getenv()</code> twice in order to pass in my username and key for the Adobe Analytics API, which feels very ‚Äúinteractive R‚Äù, but the goal is¬†automated testing. Filling in those two environment variables¬†is where Travis CI comes in.</p>\n\n<h3 id=\"travis-ci-configuration\">Travis CI Configuration</h3>\n\n<p>In order to have any automation using Travis CI, you need to create a <code class=\"language-plaintext highlighter-rouge\">.travis.yml</code>¬†configuration file. While you can read the <a href=\"http://docs.travis-ci.com/user/languages/r/\">Travis docs to create the .travis.yml¬†file for R</a>, you‚Äôre probably better off just using the <code class=\"language-plaintext highlighter-rouge\">use_travis</code> function from <a href=\"https://github.com/hadley/devtools\">devtools</a>¬†(also from Hadley, little surprise!)¬†to create the file for you. In terms of <a href=\"http://docs.travis-ci.com/user/encryption-keys/\">creating encrypted keys to use with Travis</a>, you‚Äôll need to use the <a href=\"https://github.com/travis-ci/travis.rb\">Travis CLI tool</a>, which is distributed as a Ruby gem (i.e. package).¬† If you view the¬†<a href=\"https://github.com/randyzwitch/RSiteCatalyst/blob/master/.travis.yml\">RSiteCatalyst .travis.yml file</a>, you can see that I define two global ‚Äúsecure‚Äù variables, the value of which are the output from running a command similar to the following in¬†the Travis CLI tool:</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-shell\" data-lang=\"shell\"><span class=\"nv\">$ </span>travis encrypt <span class=\"nv\">RANDY</span><span class=\"o\">=</span>ZWITCH\nPlease add the following to your .travis.yml file:\n\n  secure: <span class=\"s2\">\"b6S4dBc7arvox8UpuFqkz+VP2UmAW/S/B/vgaAdZiZQqUp78YDR6VYdAYN3WisCK1VLGjOVVPQvGxLik0pQokF8FU3sjX0ekH6vSJeqg4utrEZmVtNvdDLEVAmagFy8Fyduow3U4CPW7rzXqvAE4cIVqGR5Lv2KLf8ANUGn+y3E=\"</span>\n\nPro Tip: You can add it automatically by running with <span class=\"nt\">--add</span>.</code></pre></figure>\n\n<p>Note that if this seems insecure, every time you run the <code class=\"language-plaintext highlighter-rouge\">encrypt</code> command with the same arguments, you get a different value; Travis CI is creating new public and private RSA keys each time.</p>\n\n<h3 id=\"setting-up-authenticated-testing-locally\">Setting Up Authenticated Testing Locally</h3>\n\n<p>If you get as far as setting up encrypted Travis CI keys and tests using <code class=\"language-plaintext highlighter-rouge\">testthat</code>, the final step is really for convenience. With the <code class=\"language-plaintext highlighter-rouge\">.travis.yml</code> file, Travis CI sets the R environment variables on THEIR system; on your local machine, the environment variables aren‚Äôt set. Even if the environment variables were set, they would be set to the Travis CI hashed values, which is not what I want to pass to my authentication function in my R package.</p>\n\n<p>To set the authentication variables locally, so that each time you hit ‚Äòcheck‚Äô to build and check against CRAN errors, you just need to modify the <code class=\"language-plaintext highlighter-rouge\">.Renviron</code> file for R:</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">USER</span><span class=\"o\">=</span><span class=\"s2\">\"myusername\"</span><span class=\"w\">\n</span><span class=\"n\">SECRET</span><span class=\"o\">=</span><span class=\"s2\">\"mysecret\"</span></code></pre></figure>\n\n<p>With that minor change, in addition to the <code class=\"language-plaintext highlighter-rouge\">.travis.yml</code> file, you‚Äôll have a seamless environment for developing and testing R packages.</p>\n\n<h3 id=\"testing-is-like-flossing\">Testing Is Like Flossing‚Ä¶</h3>\n\n<p>As easy as the <code class=\"language-plaintext highlighter-rouge\">testthat</code> and <code class=\"language-plaintext highlighter-rouge\">devtools</code> packages make testing, and as inexpensively as Travis CI is as a service (free for open source projects!), there‚Äôs really no excuse to provide packaged-up code and not include tests. Hopefully this blog post has demonstrated that it‚Äôs possible to include tests even when authentication is necessary without compromising your credentials.</p>\n\n<p>So let‚Äôs all be sure to include tests, not just pay lip service to the idea that testing is useful. Code testing¬†only works if you actually do it üôÇ</p>"
}