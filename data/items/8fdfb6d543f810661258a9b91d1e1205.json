{
  "title": "Code Refactoring Using Metaprogramming",
  "description": "<p>Itâ€™s been nearly a year since I wrote <a href=\"https://github.com/randyzwitch/Twitter.jl/\">Twitter.jl</a>, back when I seemingly had MUCH more free time.Â In these past 10 months, Iâ€™ve used Julia quite a bit to develop other packages, and I try to use it at work when I know Iâ€™m not going to be collaborating with others (since my colleagues donâ€™t know Julia, not because itâ€™s bad for collaboration!).</p>",
  "pubDate": "Tue, 18 Nov 2014 09:11:06 +0000",
  "link": "http://randyzwitch.com/julia-metaprogramming-refactoring/",
  "guid": "http://randyzwitch.com/julia-metaprogramming-refactoring/",
  "content": "<p>Itâ€™s been nearly a year since I wrote <a href=\"https://github.com/randyzwitch/Twitter.jl/\">Twitter.jl</a>, back when I seemingly had MUCH more free time.Â In these past 10 months, Iâ€™ve used Julia quite a bit to develop other packages, and I try to use it at work when I know Iâ€™m not going to be collaborating with others (since my colleagues donâ€™t know Julia, not because itâ€™s bad for collaboration!).</p>\n\n<p>One of the things thatâ€™s obvious from my earlier Julia code is that I didnâ€™t understand how powerful metaprogramming can be, so hereâ€™s a simple example where I can replace 50 lines of Julia code with 10.</p>\n\n<h2 id=\"ctrl-a-ctrl-c-ctrl-p-repeat\">CTRL-A, CTRL-C, CTRL-P. Repeat.</h2>\n\n<p>Admittedly, when I started on the Twitter package, I fully meant to go back and clean up the codebase, but moved onto something more fun instead. The Twitter packageÂ started out as a means of learningÂ how to use the <a href=\"https://github.com/JuliaWeb/Requests.jl\">Requests.jl</a> library to make API calls, figure out the OAuth syntax I needed (which itself should be factored out of Twitter.jl), then copied-and-pasted the same basic function structure over and over. While fast, what I was left with was this (currently, the help.jl file in the Twitter package):</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-julia\" data-lang=\"julia\"><table class=\"rouge-table\"><tbody><tr><td class=\"gutter gl\"><pre class=\"lineno\">1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n</pre></td><td class=\"code\"><pre><span class=\"c\">#############################################################</span>\n<span class=\"c\">#</span>\n<span class=\"c\"># Help section Functions for Twitter API</span>\n<span class=\"c\">#</span>\n<span class=\"c\">#############################################################</span>\n\n<span class=\"k\">function</span><span class=\"nf\"> get_help_configuration</span><span class=\"x\">(;</span> <span class=\"n\">options</span><span class=\"o\">=</span><span class=\"kt\">Dict</span><span class=\"x\">{</span><span class=\"kt\">String</span><span class=\"x\">,</span> <span class=\"kt\">String</span><span class=\"x\">}())</span>\n\n    <span class=\"n\">r</span> <span class=\"o\">=</span> <span class=\"n\">get_oauth</span><span class=\"x\">(</span><span class=\"s\">\"https://api.twitter.com/1.1/help/configuration.json\"</span><span class=\"x\">,</span> <span class=\"n\">options</span><span class=\"x\">)</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">r</span><span class=\"o\">.</span><span class=\"n\">status</span> <span class=\"o\">==</span> <span class=\"mi\">200</span> <span class=\"o\">?</span> <span class=\"n\">JSON</span><span class=\"o\">.</span><span class=\"n\">parse</span><span class=\"x\">(</span><span class=\"n\">r</span><span class=\"o\">.</span><span class=\"n\">data</span><span class=\"x\">)</span> <span class=\"o\">:</span> <span class=\"n\">r</span>\n\n<span class=\"k\">end</span>\n\n<span class=\"k\">function</span><span class=\"nf\"> get_help_languages</span><span class=\"x\">(;</span> <span class=\"n\">options</span><span class=\"o\">=</span><span class=\"kt\">Dict</span><span class=\"x\">{</span><span class=\"kt\">String</span><span class=\"x\">,</span> <span class=\"kt\">String</span><span class=\"x\">}())</span>\n\n    <span class=\"n\">r</span> <span class=\"o\">=</span> <span class=\"n\">get_oauth</span><span class=\"x\">(</span><span class=\"s\">\"https://api.twitter.com/1.1/help/languages.json\"</span><span class=\"x\">,</span> <span class=\"n\">options</span><span class=\"x\">)</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">r</span><span class=\"o\">.</span><span class=\"n\">status</span> <span class=\"o\">==</span> <span class=\"mi\">200</span> <span class=\"o\">?</span> <span class=\"n\">JSON</span><span class=\"o\">.</span><span class=\"n\">parse</span><span class=\"x\">(</span><span class=\"n\">r</span><span class=\"o\">.</span><span class=\"n\">data</span><span class=\"x\">)</span> <span class=\"o\">:</span> <span class=\"n\">r</span>\n\n<span class=\"k\">end</span>\n\n<span class=\"k\">function</span><span class=\"nf\"> get_help_privacy</span><span class=\"x\">(;</span> <span class=\"n\">options</span><span class=\"o\">=</span><span class=\"kt\">Dict</span><span class=\"x\">{</span><span class=\"kt\">String</span><span class=\"x\">,</span> <span class=\"kt\">String</span><span class=\"x\">}())</span>\n\n    <span class=\"n\">r</span> <span class=\"o\">=</span> <span class=\"n\">get_oauth</span><span class=\"x\">(</span><span class=\"s\">\"https://api.twitter.com/1.1/help/privacy.json\"</span><span class=\"x\">,</span> <span class=\"n\">options</span><span class=\"x\">)</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">r</span><span class=\"o\">.</span><span class=\"n\">status</span> <span class=\"o\">==</span> <span class=\"mi\">200</span> <span class=\"o\">?</span> <span class=\"n\">JSON</span><span class=\"o\">.</span><span class=\"n\">parse</span><span class=\"x\">(</span><span class=\"n\">r</span><span class=\"o\">.</span><span class=\"n\">data</span><span class=\"x\">)</span> <span class=\"o\">:</span> <span class=\"n\">r</span>\n\n<span class=\"k\">end</span>\n\n<span class=\"k\">function</span><span class=\"nf\"> get_help_tos</span><span class=\"x\">(;</span> <span class=\"n\">options</span><span class=\"o\">=</span><span class=\"kt\">Dict</span><span class=\"x\">{</span><span class=\"kt\">String</span><span class=\"x\">,</span> <span class=\"kt\">String</span><span class=\"x\">}())</span>\n\n    <span class=\"n\">r</span> <span class=\"o\">=</span> <span class=\"n\">get_oauth</span><span class=\"x\">(</span><span class=\"s\">\"https://api.twitter.com/1.1/help/tos.json\"</span><span class=\"x\">,</span> <span class=\"n\">options</span><span class=\"x\">)</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">r</span><span class=\"o\">.</span><span class=\"n\">status</span> <span class=\"o\">==</span> <span class=\"mi\">200</span> <span class=\"o\">?</span> <span class=\"n\">JSON</span><span class=\"o\">.</span><span class=\"n\">parse</span><span class=\"x\">(</span><span class=\"n\">r</span><span class=\"o\">.</span><span class=\"n\">data</span><span class=\"x\">)</span> <span class=\"o\">:</span> <span class=\"n\">r</span>\n\n<span class=\"k\">end</span>\n\n<span class=\"k\">function</span><span class=\"nf\"> get_application_rate_limit_status</span><span class=\"x\">(;</span> <span class=\"n\">options</span><span class=\"o\">=</span><span class=\"kt\">Dict</span><span class=\"x\">{</span><span class=\"kt\">String</span><span class=\"x\">,</span> <span class=\"kt\">String</span><span class=\"x\">}())</span>\n\n    <span class=\"n\">r</span> <span class=\"o\">=</span> <span class=\"n\">get_oauth</span><span class=\"x\">(</span><span class=\"s\">\"https://api.twitter.com/1.1/application/rate_limit_status.json\"</span><span class=\"x\">,</span> <span class=\"n\">options</span><span class=\"x\">)</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">r</span><span class=\"o\">.</span><span class=\"n\">status</span> <span class=\"o\">==</span> <span class=\"mi\">200</span> <span class=\"o\">?</span> <span class=\"n\">JSON</span><span class=\"o\">.</span><span class=\"n\">parse</span><span class=\"x\">(</span><span class=\"n\">r</span><span class=\"o\">.</span><span class=\"n\">data</span><span class=\"x\">)</span> <span class=\"o\">:</span> <span class=\"n\">r</span>\n\n<span class=\"k\">end</span>\n</pre></td></tr></tbody></table></code></pre></figure>\n\n<p>Itâ€™s pretty clear that this is the same exact code pattern, right down to the spacing! The way to interpret this code is that for these five Twitter API methods, there are no required inputs. Optionally, there is the â€˜optionsâ€™ keyword that allows for specifying a <code class=\"language-plaintext highlighter-rouge\">Dict()</code> of options. For these five functions, there are no options you can pass to the Twitter API, so even this keyword is redundant. These are simple functions so I donâ€™t gain a lot by way of maintainability by using metaprogramming, but at the same time, one of the core tenets of programming is â€˜Donâ€™t Repeat Yourselfâ€™, so letâ€™s clean this up.</p>\n\n<h2 id=\"for-symbol-in-symbolslist\">For :symbol in symbolslistâ€¦</h2>\n\n<p>In order to clean this up, we need to take out the unique parts of the function, then pass them as arguments to the <code class=\"language-plaintext highlighter-rouge\">@eval</code> macro as follows:</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-julia\" data-lang=\"julia\"><table class=\"rouge-table\"><tbody><tr><td class=\"gutter gl\"><pre class=\"lineno\">1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n</pre></td><td class=\"code\"><pre><span class=\"n\">funcname</span> <span class=\"o\">=</span> <span class=\"x\">(</span><span class=\"o\">:</span><span class=\"n\">get_help_configuration</span><span class=\"x\">,</span> <span class=\"o\">:</span><span class=\"n\">get_help_languages</span><span class=\"x\">,</span> <span class=\"o\">:</span><span class=\"n\">get_help_privacy</span><span class=\"x\">,</span> <span class=\"o\">:</span><span class=\"n\">get_help_tos</span><span class=\"x\">,</span> <span class=\"o\">:</span><span class=\"n\">get_application_rate_limit_status</span><span class=\"x\">)</span>\n<span class=\"n\">endpoint</span> <span class=\"o\">=</span> <span class=\"x\">(</span><span class=\"s\">\"help/configuration.json\"</span><span class=\"x\">,</span> <span class=\"s\">\"help/languages.json\"</span><span class=\"x\">,</span> <span class=\"s\">\"help/privacy.json\"</span><span class=\"x\">,</span>  <span class=\"s\">\"help/tos.json\"</span><span class=\"x\">,</span> <span class=\"s\">\"application/rate_limit_status.json\"</span><span class=\"x\">)</span>\n\n<span class=\"k\">for</span> <span class=\"x\">(</span><span class=\"n\">func</span><span class=\"x\">,</span> <span class=\"n\">endp</span><span class=\"x\">)</span> <span class=\"k\">in</span> <span class=\"n\">zip</span><span class=\"x\">(</span><span class=\"n\">funcname</span><span class=\"x\">,</span> <span class=\"n\">endpoint</span><span class=\"x\">)</span>\n\t<span class=\"nd\">@eval</span> <span class=\"k\">function</span><span class=\"nf\"> </span><span class=\"o\">($</span><span class=\"n\">func</span><span class=\"x\">)(;</span> <span class=\"n\">options</span><span class=\"o\">=</span><span class=\"kt\">Dict</span><span class=\"x\">{</span><span class=\"kt\">String</span><span class=\"x\">,</span> <span class=\"kt\">String</span><span class=\"x\">}())</span>\n\n\t        <span class=\"n\">r</span> <span class=\"o\">=</span> <span class=\"n\">get_oauth</span><span class=\"x\">(</span><span class=\"o\">$</span><span class=\"s\">\"https://api.twitter.com/1.1/</span><span class=\"si\">$</span><span class=\"s\">endp\"</span><span class=\"x\">,</span> <span class=\"n\">options</span><span class=\"x\">)</span>\n\n\t        <span class=\"k\">return</span> <span class=\"n\">r</span><span class=\"o\">.</span><span class=\"n\">status</span> <span class=\"o\">==</span> <span class=\"mi\">200</span> <span class=\"o\">?</span> <span class=\"n\">JSON</span><span class=\"o\">.</span><span class=\"n\">parse</span><span class=\"x\">(</span><span class=\"n\">r</span><span class=\"o\">.</span><span class=\"n\">data</span><span class=\"x\">)</span> <span class=\"o\">:</span> <span class=\"n\">r</span>\n\n    \t<span class=\"k\">end</span>\n<span class=\"k\">end</span>\n</pre></td></tr></tbody></table></code></pre></figure>\n\n<p>Whatâ€™s happening in this codeÂ is thatÂ IÂ define two tuples: one of function names (as symbols, denoted by <code class=\"language-plaintext highlighter-rouge\">:</code>) and one of the API endpoints. We can then iterate over the two tuples, substituting the function names and endpoints into the code. When the package is loaded, this code evaluates, defining the five functions for use in the Twitter package.</p>\n\n<h2 id=\"wha\">Wha?</h2>\n\n<p>Yeah, so metaprogramming can be simple, but it can also be mind-bending. Itâ€™s one thing to not repeat yourself, itâ€™s another to write something so complex that even YOU canâ€™t remember how the code works. But somewhere in between lies a sweet spot where you can re-factor whole swaths of code and streamline your codebase. Metaprogramming is used throughout the Julia codebase, so if youâ€™re interested in seeing more examples of metaprogramming, check out the Julia source code, the <a href=\"https://github.com/JuliaWeb/Requests.jl/blob/master/src/Requests.jl\" title=\"Requests.jl code\">Requests.jl</a> package (where I first saw this) or really anyone who actually knows what they are doing. Iâ€™m just a metaprogramming pretender at this point ðŸ™‚ Â </p>\n\n<p>To read additional discussion around this specific example, see the Julia-Users discussion at: <a href=\"https://groups.google.com/forum/#!topic/julia-users/zvJmqB2N0GQ\">https://groups.google.com/forum/#!topic/julia-users/zvJmqB2N0GQ</a></p>\n\n<p><strong>Edit, 11/22/2014:</strong> <a href=\"http://www.reddit.com/r/Julia/comments/2mvtnr/code_refactoring_using_metaprogramming_in_julia/cma5g25\">DarthToaster on Reddit</a> provided another fantastic way to approach refactoring, using macros:</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-julia\" data-lang=\"julia\"><table class=\"rouge-table\"><tbody><tr><td class=\"gutter gl\"><pre class=\"lineno\">1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n</pre></td><td class=\"code\"><pre><span class=\"k\">macro</span><span class=\"nf\"> endpoint</span><span class=\"x\">(</span><span class=\"n\">name</span><span class=\"x\">,</span> <span class=\"n\">path</span><span class=\"x\">)</span>\n    <span class=\"k\">quote</span>\n        <span class=\"k\">function</span><span class=\"nf\"> $</span><span class=\"x\">(</span><span class=\"n\">esc</span><span class=\"x\">(</span><span class=\"n\">name</span><span class=\"x\">))(;</span> <span class=\"n\">options</span><span class=\"o\">=</span><span class=\"kt\">Dict</span><span class=\"x\">{</span><span class=\"kt\">String</span><span class=\"x\">,</span> <span class=\"kt\">String</span><span class=\"x\">}())</span>\n            <span class=\"n\">r</span> <span class=\"o\">=</span> <span class=\"n\">get_oauth</span><span class=\"x\">(</span><span class=\"o\">$</span><span class=\"s\">\"https://api.twitter.com/1.1/</span><span class=\"si\">$</span><span class=\"s\">path\"</span><span class=\"x\">,</span> <span class=\"n\">options</span><span class=\"x\">)</span>\n            <span class=\"k\">return</span> <span class=\"n\">r</span><span class=\"o\">.</span><span class=\"n\">status</span> <span class=\"o\">==</span> <span class=\"mi\">200</span> <span class=\"o\">?</span> <span class=\"n\">JSON</span><span class=\"o\">.</span><span class=\"n\">parse</span><span class=\"x\">(</span><span class=\"n\">r</span><span class=\"o\">.</span><span class=\"n\">data</span><span class=\"x\">)</span> <span class=\"o\">:</span> <span class=\"n\">r</span>\n        <span class=\"k\">end</span>\n    <span class=\"k\">end</span>\n<span class=\"k\">end</span>\n\n<span class=\"nd\">@endpoint</span> <span class=\"n\">get_help_configuration</span> <span class=\"s\">\"help/configuration.json\"</span>\n<span class=\"nd\">@endpoint</span> <span class=\"n\">get_help_languages</span> <span class=\"s\">\"help/languages.json\"</span>\n</pre></td></tr></tbody></table></code></pre></figure>"
}