{
  "title": "Ensemble learning for time series forecasting in R",
  "description": "<p>Ensemble learning methods are widely used nowadays for its predictive performance improvement. Ensemble learning combines multiple predictions (forecasts) from one or multiple methods to overcome accuracy of simple prediction and to avoid possible overfit. In the domain of time series forecasting, we have somehow obstructed situation because of dynamic changes in coming data. However, when a single regression model is used for forecasting, time dependency is not the obstacle, we can tune it at current time of a sliding window. For this reason, in this post, I will describe you two simple ensemble learning methods - Bagging and Random Forest. Bagging will be used with combination of two simple regression trees methods used in the previous post (RPART and CTREE). I will not repeat most of the things mentioned there so check it first if you didn’t make it already: <a href=\"https://petolau.github.io/Regression-trees-for-forecasting-time-series-in-R/\">Using regression trees for forecasting double-seasonal time series with trend</a>.</p>\n\n<p>You will learn in this post how to:</p>\n\n<ul>\n  <li>tune simple regression trees methods by Bagging</li>\n  <li>set important hyperparameters of decision tree methods and randomized them in Bagging</li>\n  <li>use Random Forest method for forecasting time series</li>\n  <li>set hyperparameters of Random Forest and find it optimally by grid search method</li>\n</ul>\n\n<h2 id=\"time-series-data-of-electricity-consumption\">Time series data of electricity consumption</h2>\n\n<p>As in previous posts, I will use smart meter data of electricity consumption for demonstrating forecasting of seasonal time series. The dataset of aggregated electricity load of consumers from an anonymous area is used. Time series data have the length of 17 weeks.</p>\n\n<p>Firstly, let’s scan all of the needed packages for data analysis, modeling and visualizing.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">library</span><span class=\"p\">(</span><span class=\"n\">feather</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"c1\"># data import</span><span class=\"w\">\n</span><span class=\"n\">library</span><span class=\"p\">(</span><span class=\"n\">data.table</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"c1\"># data handle</span><span class=\"w\">\n</span><span class=\"n\">library</span><span class=\"p\">(</span><span class=\"n\">rpart</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"c1\"># decision tree method</span><span class=\"w\">\n</span><span class=\"n\">library</span><span class=\"p\">(</span><span class=\"n\">party</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"c1\"># decision tree method</span><span class=\"w\">\n</span><span class=\"n\">library</span><span class=\"p\">(</span><span class=\"n\">forecast</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"c1\"># forecasting methods</span><span class=\"w\">\n</span><span class=\"n\">library</span><span class=\"p\">(</span><span class=\"n\">randomForest</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"c1\"># ensemble learning method</span><span class=\"w\">\n</span><span class=\"n\">library</span><span class=\"p\">(</span><span class=\"n\">ggplot2</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"c1\"># visualizations</span></code></pre></figure>\n\n<p>Now read the mentioned time series data by <code class=\"language-plaintext highlighter-rouge\">read_feather</code> to one <code class=\"language-plaintext highlighter-rouge\">data.table</code>. The dataset can be found on <a href=\"https://github.com/PetoLau/petolau.github.io/tree/master/_rmd\">my github repo</a>, the name of the file is <em>DT_load_17weeks</em>.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">DT</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">as.data.table</span><span class=\"p\">(</span><span class=\"n\">read_feather</span><span class=\"p\">(</span><span class=\"s2\">\"DT_load_17weeks\"</span><span class=\"p\">))</span></code></pre></figure>\n\n<p>And store information of the date and period of time series that is 48.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">n_date</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">unique</span><span class=\"p\">(</span><span class=\"n\">DT</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">date</span><span class=\"p\">])</span><span class=\"w\">\n</span><span class=\"n\">period</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"m\">48</span></code></pre></figure>\n\n<p>For data visualization needs, store my favorite ggplot theme settings by function <code class=\"language-plaintext highlighter-rouge\">theme</code>.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">theme_ts</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">theme</span><span class=\"p\">(</span><span class=\"n\">panel.border</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">element_rect</span><span class=\"p\">(</span><span class=\"n\">fill</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">NA</span><span class=\"p\">,</span><span class=\"w\"> \n                                              </span><span class=\"n\">colour</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"grey10\"</span><span class=\"p\">),</span><span class=\"w\">\n                  </span><span class=\"n\">panel.background</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">element_blank</span><span class=\"p\">(),</span><span class=\"w\">\n                  </span><span class=\"n\">panel.grid.minor</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">element_line</span><span class=\"p\">(</span><span class=\"n\">colour</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"grey85\"</span><span class=\"p\">),</span><span class=\"w\">\n                  </span><span class=\"n\">panel.grid.major</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">element_line</span><span class=\"p\">(</span><span class=\"n\">colour</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"grey85\"</span><span class=\"p\">),</span><span class=\"w\">\n                  </span><span class=\"n\">panel.grid.major.x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">element_line</span><span class=\"p\">(</span><span class=\"n\">colour</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"grey85\"</span><span class=\"p\">),</span><span class=\"w\">\n                  </span><span class=\"n\">axis.text</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">element_text</span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">13</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">face</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"bold\"</span><span class=\"p\">),</span><span class=\"w\">\n                  </span><span class=\"n\">axis.title</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">element_text</span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">15</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">face</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"bold\"</span><span class=\"p\">),</span><span class=\"w\">\n                  </span><span class=\"n\">plot.title</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">element_text</span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">16</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">face</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"bold\"</span><span class=\"p\">),</span><span class=\"w\">\n                  </span><span class=\"n\">strip.text</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">element_text</span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">16</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">face</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"bold\"</span><span class=\"p\">),</span><span class=\"w\">\n                  </span><span class=\"n\">strip.background</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">element_rect</span><span class=\"p\">(</span><span class=\"n\">colour</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"black\"</span><span class=\"p\">),</span><span class=\"w\">\n                  </span><span class=\"n\">legend.text</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">element_text</span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">15</span><span class=\"p\">),</span><span class=\"w\">\n                  </span><span class=\"n\">legend.title</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">element_text</span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">16</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">face</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"bold\"</span><span class=\"p\">),</span><span class=\"w\">\n                  </span><span class=\"n\">legend.background</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">element_rect</span><span class=\"p\">(</span><span class=\"n\">fill</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"white\"</span><span class=\"p\">),</span><span class=\"w\">\n                  </span><span class=\"n\">legend.key</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">element_rect</span><span class=\"p\">(</span><span class=\"n\">fill</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"white\"</span><span class=\"p\">))</span></code></pre></figure>\n\n<p>I will use three weeks of data of electricity consumption for training regression trees methods. Forecasts will be performed to one day ahead. Let’s extract train and test set from the dataset.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">data_train</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">DT</span><span class=\"p\">[</span><span class=\"n\">date</span><span class=\"w\"> </span><span class=\"o\">%in%</span><span class=\"w\"> </span><span class=\"n\">n_date</span><span class=\"p\">[</span><span class=\"m\">1</span><span class=\"o\">:</span><span class=\"m\">21</span><span class=\"p\">]]</span><span class=\"w\">\n</span><span class=\"n\">data_test</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">DT</span><span class=\"p\">[</span><span class=\"n\">date</span><span class=\"w\"> </span><span class=\"o\">%in%</span><span class=\"w\"> </span><span class=\"n\">n_date</span><span class=\"p\">[</span><span class=\"m\">22</span><span class=\"p\">]]</span></code></pre></figure>\n\n<p>And visualize the train part:</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">ggplot</span><span class=\"p\">(</span><span class=\"n\">data_train</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">aes</span><span class=\"p\">(</span><span class=\"n\">date_time</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">geom_line</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">labs</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Date\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Load (kW)\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">theme_ts</span></code></pre></figure>\n\n<p><img src=\"/images/post_6/unnamed-chunk-7-1.png\" alt=\"plot of chunk unnamed-chunk-7\" /></p>\n\n<h2 id=\"bagging\">Bagging</h2>\n\n<p><a href=\"https://en.wikipedia.org/wiki/Bootstrap_aggregating\"><strong>Bagging</strong></a> or bootstrap aggregating, is ensemble learning meta-algorithm used to improve prediction accuracy and to overcome (avoid) overfitting. The algorithm is very simple. The first step is sampling a training dataset with replacement with some defined sample ratio (e.g. 0.7). Then a model is trained on a new train set. This procedure is repeated <em>N_boot</em> times (e.g. 100). Final ensemble prediction is just average of <em>N_boot</em> predictions. For aggregating predictions, the median can be also used and will be used in this post.</p>\n\n<h3 id=\"bagging--rpart\">Bagging + RPART</h3>\n\n<p>The first “bagged” method is RPART (CART) tree. Training set consists of lagged electricity load by one day and double-seasonal Fourier terms (daily and weekly seasonality). Electricity consumption is firstly detrended by STL decomposition and trend part is forecasted (modeled) by ARIMA (<code class=\"language-plaintext highlighter-rouge\">auto.arima</code> function). Seasonal and remainder part is then forecasted by regression tree model. More detailed description and explanations are in my <a href=\"https://petolau.github.io/Regression-trees-for-forecasting-time-series-in-R/\">previous post about regression trees methods</a>. Let’s define train and test data (by <code class=\"language-plaintext highlighter-rouge\">matrix_train</code> and <code class=\"language-plaintext highlighter-rouge\">matrix_test</code>).</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">data_ts</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">ts</span><span class=\"p\">(</span><span class=\"n\">data_train</span><span class=\"o\">$</span><span class=\"n\">value</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">freq</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">period</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"m\">7</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"n\">decomp_ts</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">stl</span><span class=\"p\">(</span><span class=\"n\">data_ts</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">s.window</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"periodic\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">robust</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">TRUE</span><span class=\"p\">)</span><span class=\"o\">$</span><span class=\"n\">time.series</span><span class=\"w\">\n \n</span><span class=\"n\">trend_part</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">ts</span><span class=\"p\">(</span><span class=\"n\">decomp_ts</span><span class=\"p\">[,</span><span class=\"m\">2</span><span class=\"p\">])</span><span class=\"w\">\n \n</span><span class=\"n\">trend_fit</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">auto.arima</span><span class=\"p\">(</span><span class=\"n\">trend_part</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"c1\"># ARIMA</span><span class=\"w\">\n</span><span class=\"n\">trend_for</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">as.vector</span><span class=\"p\">(</span><span class=\"n\">forecast</span><span class=\"p\">(</span><span class=\"n\">trend_fit</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">period</span><span class=\"p\">)</span><span class=\"o\">$</span><span class=\"n\">mean</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"c1\"># trend forecast</span><span class=\"w\">\n \n</span><span class=\"n\">data_msts</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">msts</span><span class=\"p\">(</span><span class=\"n\">data_train</span><span class=\"o\">$</span><span class=\"n\">value</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">seasonal.periods</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"n\">period</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">period</span><span class=\"o\">*</span><span class=\"m\">7</span><span class=\"p\">))</span><span class=\"w\">\n \n</span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"w\">\n</span><span class=\"n\">fuur</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">fourier</span><span class=\"p\">(</span><span class=\"n\">data_msts</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"n\">K</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"c1\"># Fourier features to model (Daily and Weekly)</span><span class=\"w\">\n \n</span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">nrow</span><span class=\"p\">(</span><span class=\"n\">data_train</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"n\">window</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"n\">period</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\">\n \n</span><span class=\"n\">new_load</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">rowSums</span><span class=\"p\">(</span><span class=\"n\">decomp_ts</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"m\">1</span><span class=\"p\">,</span><span class=\"m\">3</span><span class=\"p\">)])</span><span class=\"w\"> </span><span class=\"c1\"># detrended original time series</span><span class=\"w\">\n</span><span class=\"n\">lag_seas</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">decomp_ts</span><span class=\"p\">[</span><span class=\"m\">1</span><span class=\"o\">:</span><span class=\"p\">(</span><span class=\"n\">period</span><span class=\"o\">*</span><span class=\"n\">window</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"c1\"># lag feature to model</span><span class=\"w\">\n \n</span><span class=\"n\">matrix_train</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">data.table</span><span class=\"p\">(</span><span class=\"n\">Load</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tail</span><span class=\"p\">(</span><span class=\"n\">new_load</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">window</span><span class=\"o\">*</span><span class=\"n\">period</span><span class=\"p\">),</span><span class=\"w\">\n                           </span><span class=\"n\">fuur</span><span class=\"p\">[(</span><span class=\"n\">period</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"p\">)</span><span class=\"o\">:</span><span class=\"n\">N</span><span class=\"p\">,],</span><span class=\"w\">\n                           </span><span class=\"n\">Lag</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lag_seas</span><span class=\"p\">)</span><span class=\"w\">\n \n</span><span class=\"c1\"># create testing data matrix</span><span class=\"w\">\n</span><span class=\"n\">test_lag</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">decomp_ts</span><span class=\"p\">[((</span><span class=\"n\">period</span><span class=\"o\">*</span><span class=\"n\">window</span><span class=\"p\">)</span><span class=\"m\">+1</span><span class=\"p\">)</span><span class=\"o\">:</span><span class=\"n\">N</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"p\">]</span><span class=\"w\">\n</span><span class=\"n\">fuur_test</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">fourier</span><span class=\"p\">(</span><span class=\"n\">data_msts</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"n\">K</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">period</span><span class=\"p\">)</span><span class=\"w\">\n \n</span><span class=\"n\">matrix_test</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">data.table</span><span class=\"p\">(</span><span class=\"n\">fuur_test</span><span class=\"p\">,</span><span class=\"w\">\n                          </span><span class=\"n\">Lag</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">test_lag</span><span class=\"p\">)</span></code></pre></figure>\n\n<p>I will perform 100 bootstrapped forecasts by RPART, that will be stored in the matrix of size \\( 100\\times 48 \\) (<code class=\"language-plaintext highlighter-rouge\">pred_mat</code>). Additional four parameters will be also sampled (randomized) to avoid overfitting. Sample ratio for sampling train set is sampled in the range from 0.7 to 0.9. Three hyperparameters of RPART are sampled also: <code class=\"language-plaintext highlighter-rouge\">minsplit</code>, <code class=\"language-plaintext highlighter-rouge\">maxdepth</code> and complexity parameter <code class=\"language-plaintext highlighter-rouge\">cp</code>. Hyperparameters are sampled around values set on my previous post modeling.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">N_boot</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"m\">100</span><span class=\"w\"> </span><span class=\"c1\"># number of bootstraps</span><span class=\"w\">\n \n</span><span class=\"n\">pred_mat</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">matrix</span><span class=\"p\">(</span><span class=\"m\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nrow</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">N_boot</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ncol</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">period</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"k\">for</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"o\">:</span><span class=\"n\">N_boot</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n  \n  </span><span class=\"n\">matrixSam</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">matrix_train</span><span class=\"p\">[</span><span class=\"n\">sample</span><span class=\"p\">(</span><span class=\"m\">1</span><span class=\"o\">:</span><span class=\"p\">(</span><span class=\"n\">N</span><span class=\"o\">-</span><span class=\"n\">period</span><span class=\"p\">),</span><span class=\"w\">\n                                   </span><span class=\"nf\">floor</span><span class=\"p\">((</span><span class=\"n\">N</span><span class=\"o\">-</span><span class=\"n\">period</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">sample</span><span class=\"p\">(</span><span class=\"n\">seq</span><span class=\"p\">(</span><span class=\"m\">0.7</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"m\">0.9</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0.01</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"p\">)),</span><span class=\"w\">\n                                   </span><span class=\"n\">replace</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">TRUE</span><span class=\"p\">)]</span><span class=\"w\"> </span><span class=\"c1\"># sampling with sampled ratio from 0.7 to 0.9</span><span class=\"w\">\n  </span><span class=\"n\">tree_bag</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">rpart</span><span class=\"p\">(</span><span class=\"n\">Load</span><span class=\"w\"> </span><span class=\"o\">~</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">matrixSam</span><span class=\"p\">,</span><span class=\"w\">\n                    </span><span class=\"n\">control</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">rpart.control</span><span class=\"p\">(</span><span class=\"n\">minsplit</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">sample</span><span class=\"p\">(</span><span class=\"m\">2</span><span class=\"o\">:</span><span class=\"m\">3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"p\">),</span><span class=\"w\">\n                                            </span><span class=\"n\">maxdepth</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">sample</span><span class=\"p\">(</span><span class=\"m\">26</span><span class=\"o\">:</span><span class=\"m\">30</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"p\">),</span><span class=\"w\">\n                                            </span><span class=\"n\">cp</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">sample</span><span class=\"p\">(</span><span class=\"n\">seq</span><span class=\"p\">(</span><span class=\"m\">0.0000009</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"m\">0.00001</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0.0000001</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"p\">)))</span><span class=\"w\">\n  \n  </span><span class=\"c1\"># new data and prediction</span><span class=\"w\">\n  </span><span class=\"n\">pred_mat</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">,]</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">predict</span><span class=\"p\">(</span><span class=\"n\">tree_bag</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">matrix_test</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">mean</span><span class=\"p\">(</span><span class=\"n\">trend_for</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"p\">}</span></code></pre></figure>\n\n<p>Let’s compute median of forecasts and visualize all created forecasts. For <code class=\"language-plaintext highlighter-rouge\">ggplot</code> visualization needs we must use <code class=\"language-plaintext highlighter-rouge\">melt</code> function to the matrix of forecasts <code class=\"language-plaintext highlighter-rouge\">pred_mat</code>.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">pred_melt_rpart</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">data.table</span><span class=\"p\">(</span><span class=\"n\">melt</span><span class=\"p\">(</span><span class=\"n\">pred_mat</span><span class=\"p\">))</span><span class=\"w\">\n \n</span><span class=\"n\">pred_ave_rpart</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">pred_melt_rpart</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">median</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)),</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Var2</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">pred_ave_rpart</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Var1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"RPART_Bagg\"</span><span class=\"p\">]</span><span class=\"w\">\n \n</span><span class=\"n\">ggplot</span><span class=\"p\">(</span><span class=\"n\">pred_melt_rpart</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">aes</span><span class=\"p\">(</span><span class=\"n\">Var2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">group</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Var1</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">geom_line</span><span class=\"p\">(</span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0.75</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">geom_line</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">pred_ave_rpart</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">aes</span><span class=\"p\">(</span><span class=\"n\">Var2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">color</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"firebrick2\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0.9</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">labs</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Time\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Load (kW)\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">title</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Bagging with RPART\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">theme_ts</span></code></pre></figure>\n\n<p><img src=\"/images/post_6/unnamed-chunk-11-1.png\" alt=\"plot of chunk unnamed-chunk-11\" /></p>\n\n<p>The red line is median of forecasts. We can see that created forecasts by RPART have typical rectangular shape, but final ensemble forecasts has nice smooth behaviour. For comparison, compute forecast by RPART on whole train set and compare it with previous results. I am using function <code class=\"language-plaintext highlighter-rouge\">RpartTrend</code> from my previous post.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">simple_rpart</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">RpartTrend</span><span class=\"p\">(</span><span class=\"n\">DT</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">n_date</span><span class=\"p\">[</span><span class=\"m\">1</span><span class=\"o\">:</span><span class=\"m\">21</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"n\">pred_rpart</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">data.table</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">simple_rpart</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Var2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"o\">:</span><span class=\"m\">48</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Var1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"RPART\"</span><span class=\"p\">)</span><span class=\"w\">\n \n</span><span class=\"n\">ggplot</span><span class=\"p\">(</span><span class=\"n\">pred_melt_rpart</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">aes</span><span class=\"p\">(</span><span class=\"n\">Var2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">group</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Var1</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">geom_line</span><span class=\"p\">(</span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0.75</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">geom_line</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">pred_ave_rpart</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">aes</span><span class=\"p\">(</span><span class=\"n\">Var2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">color</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"firebrick2\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0.8</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">1.8</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">geom_line</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">pred_rpart</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">aes</span><span class=\"p\">(</span><span class=\"n\">Var2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">color</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"dodgerblue2\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0.8</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">1.8</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">labs</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Time\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Load (kW)\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">title</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Bagging with RPART and comparison with simple RPART\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">theme_ts</span></code></pre></figure>\n\n<p><img src=\"/images/post_6/unnamed-chunk-12-1.png\" alt=\"plot of chunk unnamed-chunk-12\" /></p>\n\n<p>The blue line is simple RPART forecast. The difference between ensemble forecast and simple one is not very evident in this scenario.</p>\n\n<h2 id=\"bagging-with-ctree\">Bagging with CTREE</h2>\n\n<p>The second “bagged” regression tree method is CTREE. I will randomize only <code class=\"language-plaintext highlighter-rouge\">mincriterion</code> hyperparameter of CTREE method that decisions about splitting a node. The sample ratio is of course sampled (randomized) as well as in the previous case with RPART.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">pred_mat</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">matrix</span><span class=\"p\">(</span><span class=\"m\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nrow</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">N_boot</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ncol</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">period</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"k\">for</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"o\">:</span><span class=\"n\">N_boot</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n  \n  </span><span class=\"n\">matrixSam</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">matrix_train</span><span class=\"p\">[</span><span class=\"n\">sample</span><span class=\"p\">(</span><span class=\"m\">1</span><span class=\"o\">:</span><span class=\"p\">(</span><span class=\"n\">N</span><span class=\"o\">-</span><span class=\"n\">period</span><span class=\"p\">),</span><span class=\"w\">\n                                   </span><span class=\"nf\">floor</span><span class=\"p\">((</span><span class=\"n\">N</span><span class=\"o\">-</span><span class=\"n\">period</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">sample</span><span class=\"p\">(</span><span class=\"n\">seq</span><span class=\"p\">(</span><span class=\"m\">0.7</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"m\">0.9</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0.01</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"p\">)),</span><span class=\"w\">\n                                   </span><span class=\"n\">replace</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">TRUE</span><span class=\"p\">)]</span><span class=\"w\"> </span><span class=\"c1\"># sampling with sampled ratio from 0.7 to 0.9</span><span class=\"w\">\n  </span><span class=\"n\">tree_bag</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">party</span><span class=\"o\">::</span><span class=\"n\">ctree</span><span class=\"p\">(</span><span class=\"n\">Load</span><span class=\"w\"> </span><span class=\"o\">~</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">matrixSam</span><span class=\"p\">,</span><span class=\"w\">\n                           </span><span class=\"n\">controls</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">party</span><span class=\"o\">::</span><span class=\"n\">ctree_control</span><span class=\"p\">(</span><span class=\"n\">teststat</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"s2\">\"quad\"</span><span class=\"p\">),</span><span class=\"w\">\n                                                           </span><span class=\"n\">testtype</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"s2\">\"Teststatistic\"</span><span class=\"p\">),</span><span class=\"w\">\n                                                           </span><span class=\"n\">mincriterion</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">sample</span><span class=\"p\">(</span><span class=\"n\">seq</span><span class=\"p\">(</span><span class=\"m\">0.88</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"m\">0.97</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0.005</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"p\">),</span><span class=\"w\">\n                                                           </span><span class=\"n\">minsplit</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"p\">,</span><span class=\"w\">\n                                                           </span><span class=\"n\">minbucket</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"p\">,</span><span class=\"w\">\n                                                           </span><span class=\"n\">mtry</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">maxdepth</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0</span><span class=\"p\">))</span><span class=\"w\">\n  \n  </span><span class=\"c1\"># new data and prediction</span><span class=\"w\">\n  </span><span class=\"n\">pred_mat</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">,]</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">predict</span><span class=\"p\">(</span><span class=\"n\">tree_bag</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">matrix_test</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">mean</span><span class=\"p\">(</span><span class=\"n\">trend_for</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"p\">}</span></code></pre></figure>\n\n<p>Let’s visualize results:</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">pred_melt_ctree</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">data.table</span><span class=\"p\">(</span><span class=\"n\">melt</span><span class=\"p\">(</span><span class=\"n\">pred_mat</span><span class=\"p\">))</span><span class=\"w\">\n \n</span><span class=\"n\">pred_ave_ctree</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">pred_melt_ctree</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">median</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)),</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Var2</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">pred_ave_ctree</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">Var1</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"s2\">\"CTREE_Bagg\"</span><span class=\"p\">]</span><span class=\"w\">\n \n</span><span class=\"n\">ggplot</span><span class=\"p\">(</span><span class=\"n\">pred_melt_ctree</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">aes</span><span class=\"p\">(</span><span class=\"n\">Var2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">group</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Var1</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">geom_line</span><span class=\"p\">(</span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0.75</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">geom_line</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">pred_ave_ctree</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">aes</span><span class=\"p\">(</span><span class=\"n\">Var2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">color</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"firebrick2\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0.9</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">labs</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Time\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Load (kW)\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">title</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Bagging with CTREE\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">theme_ts</span></code></pre></figure>\n\n<p><img src=\"/images/post_6/unnamed-chunk-14-1.png\" alt=\"plot of chunk unnamed-chunk-14\" /></p>\n\n<p>Again, behaviour of bootstrapped forecasts is very rectangular and the final ensemble forecast is much more smoother. Compare it also with forecast performed on whole train set. I am using function <code class=\"language-plaintext highlighter-rouge\">CtreeTrend</code> from my previous post.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">simple_ctree</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">CtreeTrend</span><span class=\"p\">(</span><span class=\"n\">DT</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">n_date</span><span class=\"p\">[</span><span class=\"m\">1</span><span class=\"o\">:</span><span class=\"m\">21</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"n\">pred_ctree</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">data.table</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">simple_ctree</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Var2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"o\">:</span><span class=\"m\">48</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Var1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"CTREE\"</span><span class=\"p\">)</span><span class=\"w\">\n \n</span><span class=\"n\">ggplot</span><span class=\"p\">(</span><span class=\"n\">pred_melt_ctree</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">aes</span><span class=\"p\">(</span><span class=\"n\">Var2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">group</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Var1</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">geom_line</span><span class=\"p\">(</span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0.75</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">geom_line</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">pred_ave_ctree</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">aes</span><span class=\"p\">(</span><span class=\"n\">Var2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">color</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"firebrick2\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0.8</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">1.8</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">geom_line</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">pred_ctree</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">aes</span><span class=\"p\">(</span><span class=\"n\">Var2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">color</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"dodgerblue2\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0.8</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">1.8</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">labs</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Time\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Load (kW)\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">title</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Bagging with CTREE and comparison with simple CTREE\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">theme_ts</span></code></pre></figure>\n\n<p><img src=\"/images/post_6/unnamed-chunk-15-1.png\" alt=\"plot of chunk unnamed-chunk-15\" /></p>\n\n<p>The simple forecast is a little bit more rectangular than ensemble one.</p>\n\n<h2 id=\"random-forest\">Random Forest</h2>\n\n<p><a href=\"https://en.wikipedia.org/wiki/Random_forest\"><strong>Random Forest</strong></a> is an improvement of Bagging ensemble learning method. It uses a modified tree learning algorithm that selects, at each candidate split in the learning process, a random subset of the features. This process is sometimes called “feature bagging”. The classical Bagging is also used in the method of course. Hyperparameters of Random Forest is similar to those in RPART method. Additional ones are: number of trees (<code class=\"language-plaintext highlighter-rouge\">ntree</code>); number of variables sampled in each candidate split (<code class=\"language-plaintext highlighter-rouge\">mtry</code>). Importance of variables can be also incorporated to learning process in order to enhance the performance. Random Forest is implemented in <strong>R</strong> by package <code class=\"language-plaintext highlighter-rouge\">randomForest</code> and same-named function. Default settings for hyperparameters are: <code class=\"language-plaintext highlighter-rouge\">mtry</code> = p/3 (where p is number of features), so 9/3 = 3 in our case, and <code class=\"language-plaintext highlighter-rouge\">nodesize</code> = 5. I will set a number of trees to 1000.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">rf_model</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">randomForest</span><span class=\"p\">(</span><span class=\"n\">Load</span><span class=\"w\"> </span><span class=\"o\">~</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">data.frame</span><span class=\"p\">(</span><span class=\"n\">matrix_train</span><span class=\"p\">),</span><span class=\"w\">\n                         </span><span class=\"n\">ntree</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">1000</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">mtry</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nodesize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">5</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">importance</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">TRUE</span><span class=\"p\">)</span></code></pre></figure>\n\n<p>Whereas we use ensemble of CART trees in Random Forest, we can compute variable importance. Checking variable importance can be important for extracting just most valuable features and to analyze dependencies and correlations in data. Let’s check variable importance by <code class=\"language-plaintext highlighter-rouge\">varImpPlot</code>.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">varImpPlot</span><span class=\"p\">(</span><span class=\"n\">rf_model</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Variable importance\"</span><span class=\"p\">)</span></code></pre></figure>\n\n<p><img src=\"/images/post_6/unnamed-chunk-17-1.png\" alt=\"plot of chunk unnamed-chunk-17\" /></p>\n\n<p>We can see that Lag and S1.336 (weekly seasonal feature in sinus form) features have best scores in both measures. It implies that weekly seasonality and and lagged values of load are most important for our training data.</p>\n\n<p>Let’s compute also forecast.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">pred_rf</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">predict</span><span class=\"p\">(</span><span class=\"n\">rf_model</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">data.frame</span><span class=\"p\">(</span><span class=\"n\">matrix_test</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">mean</span><span class=\"p\">(</span><span class=\"n\">trend_for</span><span class=\"p\">)</span></code></pre></figure>\n\n<p>And compare forecasts from all ensemble learning approaches so far and real electricity load.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">pred_rf</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">data.table</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">pred_rf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Var2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"o\">:</span><span class=\"m\">48</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Var1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"RF\"</span><span class=\"p\">)</span><span class=\"w\">\n \n</span><span class=\"n\">pred_true</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">data.table</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">data_test</span><span class=\"o\">$</span><span class=\"n\">value</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Var2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"o\">:</span><span class=\"m\">48</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Var1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Real\"</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"n\">preds_all</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">rbindlist</span><span class=\"p\">(</span><span class=\"nf\">list</span><span class=\"p\">(</span><span class=\"n\">pred_ave_rpart</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">pred_ave_ctree</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">pred_rf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">pred_true</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">use.names</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">T</span><span class=\"p\">)</span><span class=\"w\">\n \n</span><span class=\"n\">ggplot</span><span class=\"p\">(</span><span class=\"n\">preds_all</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">aes</span><span class=\"p\">(</span><span class=\"n\">Var2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">color</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">as.factor</span><span class=\"p\">(</span><span class=\"n\">Var1</span><span class=\"p\">)))</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">geom_line</span><span class=\"p\">(</span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0.7</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">1.2</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">labs</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Time\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Load (kW)\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">title</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Comparison of Ensemble Learning forecasts\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">guides</span><span class=\"p\">(</span><span class=\"n\">color</span><span class=\"o\">=</span><span class=\"n\">guide_legend</span><span class=\"p\">(</span><span class=\"n\">title</span><span class=\"o\">=</span><span class=\"s2\">\"Method\"</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">theme_ts</span></code></pre></figure>\n\n<p><img src=\"/images/post_6/unnamed-chunk-19-1.png\" alt=\"plot of chunk unnamed-chunk-19\" /></p>\n\n<p>There are just small differences.</p>\n\n<h2 id=\"hyperparameters-tuning---grid-search\">Hyperparameters tuning - grid search</h2>\n\n<p>It is always highly recommended to tune hyperparameters of our used method. By hyperparameters tuning, we can significantly improve predictive performance. I will try to tune two hyperparameters of <strong>Random Forest</strong>, <code class=\"language-plaintext highlighter-rouge\">mtry</code> and <code class=\"language-plaintext highlighter-rouge\">nodesize</code>, by <a href=\"https://en.wikipedia.org/wiki/Hyperparameter_(machine_learning)#Grid_search\"><strong>grid search</strong></a> method.\nFor specificity of time series forecasting, I proposed my own function of grid search (<code class=\"language-plaintext highlighter-rouge\">gridSearch</code>). The evaluation is based on sliding window forecasting, so forecasting error is average of errors in some range of time. I also created my own Random Forest function (<code class=\"language-plaintext highlighter-rouge\">RFgrid</code>) that is compatible with grid search function. The output of <code class=\"language-plaintext highlighter-rouge\">gridSearch</code> function is matrix of average MAPE (Mean Absolute Percentage Error) values corresponding to hyperparameters used.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">RFgrid</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"k\">function</span><span class=\"p\">(</span><span class=\"n\">data_train</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">param1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">param2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">period</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">48</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n  \n  </span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"nf\">length</span><span class=\"p\">(</span><span class=\"n\">data_train</span><span class=\"p\">)</span><span class=\"w\">\n  </span><span class=\"n\">window</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"n\">period</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"w\">\n  \n  </span><span class=\"n\">data_ts</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">msts</span><span class=\"p\">(</span><span class=\"n\">data_train</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">seasonal.periods</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"n\">period</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">period</span><span class=\"o\">*</span><span class=\"m\">7</span><span class=\"p\">))</span><span class=\"w\">\n  \n  </span><span class=\"n\">fuur</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">fourier</span><span class=\"p\">(</span><span class=\"n\">data_ts</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"n\">K</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"p\">))</span><span class=\"w\">\n  </span><span class=\"n\">fuur_test</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">as.data.frame</span><span class=\"p\">(</span><span class=\"n\">fourier</span><span class=\"p\">(</span><span class=\"n\">data_ts</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"n\">K</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">period</span><span class=\"p\">))</span><span class=\"w\">\n  \n  </span><span class=\"n\">data_ts</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">ts</span><span class=\"p\">(</span><span class=\"n\">data_train</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">freq</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">period</span><span class=\"o\">*</span><span class=\"m\">7</span><span class=\"p\">)</span><span class=\"w\">\n  </span><span class=\"n\">decomp_ts</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">stl</span><span class=\"p\">(</span><span class=\"n\">data_ts</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">s.window</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"periodic\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">robust</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">TRUE</span><span class=\"p\">)</span><span class=\"w\">\n  </span><span class=\"n\">new_load</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">rowSums</span><span class=\"p\">(</span><span class=\"n\">decomp_ts</span><span class=\"o\">$</span><span class=\"n\">time.series</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"m\">1</span><span class=\"p\">,</span><span class=\"m\">3</span><span class=\"p\">)])</span><span class=\"w\">\n  </span><span class=\"n\">trend_part</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">ts</span><span class=\"p\">(</span><span class=\"n\">decomp_ts</span><span class=\"o\">$</span><span class=\"n\">time.series</span><span class=\"p\">[,</span><span class=\"m\">2</span><span class=\"p\">])</span><span class=\"w\">\n  \n  </span><span class=\"n\">trend_fit</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">auto.arima</span><span class=\"p\">(</span><span class=\"n\">trend_part</span><span class=\"p\">)</span><span class=\"w\">\n  </span><span class=\"n\">trend_for</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">as.vector</span><span class=\"p\">(</span><span class=\"n\">forecast</span><span class=\"p\">(</span><span class=\"n\">trend_fit</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">period</span><span class=\"p\">)</span><span class=\"o\">$</span><span class=\"n\">mean</span><span class=\"p\">)</span><span class=\"w\">\n  \n  </span><span class=\"n\">lag_seas</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">decomp_ts</span><span class=\"o\">$</span><span class=\"n\">time.series</span><span class=\"p\">[</span><span class=\"m\">1</span><span class=\"o\">:</span><span class=\"p\">(</span><span class=\"n\">period</span><span class=\"o\">*</span><span class=\"n\">window</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"p\">]</span><span class=\"w\">\n  \n  </span><span class=\"n\">matrix_train</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">data.frame</span><span class=\"p\">(</span><span class=\"n\">Load</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tail</span><span class=\"p\">(</span><span class=\"n\">new_load</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">window</span><span class=\"o\">*</span><span class=\"n\">period</span><span class=\"p\">),</span><span class=\"w\">\n                             </span><span class=\"n\">fuur</span><span class=\"p\">[(</span><span class=\"n\">period</span><span class=\"m\">+1</span><span class=\"p\">)</span><span class=\"o\">:</span><span class=\"n\">N</span><span class=\"p\">,],</span><span class=\"w\">\n                             </span><span class=\"n\">Lag</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">lag_seas</span><span class=\"p\">)</span><span class=\"w\">\n  \n  </span><span class=\"n\">tree_2</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">randomForest</span><span class=\"p\">(</span><span class=\"n\">Load</span><span class=\"w\"> </span><span class=\"o\">~</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">matrix_train</span><span class=\"p\">,</span><span class=\"w\">\n                         </span><span class=\"n\">ntree</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">1000</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">mtry</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">param1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nodesize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">param2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">importance</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">TRUE</span><span class=\"p\">)</span><span class=\"w\">\n  \n  </span><span class=\"n\">test_lag</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">decomp_ts</span><span class=\"o\">$</span><span class=\"n\">time.series</span><span class=\"p\">[((</span><span class=\"n\">period</span><span class=\"o\">*</span><span class=\"p\">(</span><span class=\"n\">window</span><span class=\"p\">))</span><span class=\"m\">+1</span><span class=\"p\">)</span><span class=\"o\">:</span><span class=\"n\">N</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"p\">]</span><span class=\"w\">\n  \n  </span><span class=\"n\">matrix_test</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">data.frame</span><span class=\"p\">(</span><span class=\"n\">fuur_test</span><span class=\"p\">,</span><span class=\"w\">\n                            </span><span class=\"n\">Lag</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">test_lag</span><span class=\"p\">)</span><span class=\"w\">\n  \n  </span><span class=\"n\">pred_tree</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">predict</span><span class=\"p\">(</span><span class=\"n\">tree_2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">matrix_test</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">mean</span><span class=\"p\">(</span><span class=\"n\">trend_for</span><span class=\"p\">)</span><span class=\"w\">\n  \n  </span><span class=\"nf\">return</span><span class=\"p\">(</span><span class=\"n\">as.vector</span><span class=\"p\">(</span><span class=\"n\">pred_tree</span><span class=\"p\">))</span><span class=\"w\">\n</span><span class=\"p\">}</span><span class=\"w\">\n \n</span><span class=\"n\">mape</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"k\">function</span><span class=\"p\">(</span><span class=\"n\">real</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">pred</span><span class=\"p\">){</span><span class=\"w\">\n  </span><span class=\"nf\">return</span><span class=\"p\">(</span><span class=\"m\">100</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">mean</span><span class=\"p\">(</span><span class=\"nf\">abs</span><span class=\"p\">((</span><span class=\"n\">real</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">pred</span><span class=\"p\">)</span><span class=\"o\">/</span><span class=\"n\">real</span><span class=\"p\">)))</span><span class=\"w\"> </span><span class=\"c1\"># MAPE - Mean Absolute Percentage Error</span><span class=\"w\">\n</span><span class=\"p\">}</span><span class=\"w\">\n \n</span><span class=\"n\">gridSearch</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"k\">function</span><span class=\"p\">(</span><span class=\"n\">Y</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">train.win</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">21</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">FUN</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">param1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">param2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">period</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">48</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n  \n  </span><span class=\"n\">days</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"nf\">length</span><span class=\"p\">(</span><span class=\"n\">Y</span><span class=\"p\">)</span><span class=\"o\">/</span><span class=\"n\">period</span><span class=\"w\">\n  </span><span class=\"n\">test.days</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">days</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">train.win</span><span class=\"w\">\n  </span><span class=\"n\">mape.matrix</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">matrix</span><span class=\"p\">(</span><span class=\"m\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nrow</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nf\">length</span><span class=\"p\">(</span><span class=\"n\">param1</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">ncol</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nf\">length</span><span class=\"p\">(</span><span class=\"n\">param2</span><span class=\"p\">))</span><span class=\"w\">\n  </span><span class=\"n\">row.names</span><span class=\"p\">(</span><span class=\"n\">mape.matrix</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">param1</span><span class=\"w\">\n  </span><span class=\"n\">colnames</span><span class=\"p\">(</span><span class=\"n\">mape.matrix</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">param2</span><span class=\"w\">\n  </span><span class=\"n\">forecast.rf</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">vector</span><span class=\"p\">(</span><span class=\"n\">length</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">test.days</span><span class=\"o\">*</span><span class=\"n\">period</span><span class=\"p\">)</span><span class=\"w\">\n  \n  </span><span class=\"k\">for</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"nf\">seq_along</span><span class=\"p\">(</span><span class=\"n\">param1</span><span class=\"p\">)){</span><span class=\"w\">\n    </span><span class=\"k\">for</span><span class=\"p\">(</span><span class=\"n\">j</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"nf\">seq_along</span><span class=\"p\">(</span><span class=\"n\">param2</span><span class=\"p\">)){</span><span class=\"w\">\n      </span><span class=\"k\">for</span><span class=\"p\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"m\">0</span><span class=\"o\">:</span><span class=\"p\">(</span><span class=\"n\">test.days</span><span class=\"m\">-1</span><span class=\"p\">)){</span><span class=\"w\">\n        </span><span class=\"n\">train.set</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">Y</span><span class=\"p\">[((</span><span class=\"n\">k</span><span class=\"o\">*</span><span class=\"n\">period</span><span class=\"p\">)</span><span class=\"m\">+1</span><span class=\"p\">)</span><span class=\"o\">:</span><span class=\"p\">((</span><span class=\"n\">period</span><span class=\"o\">*</span><span class=\"n\">k</span><span class=\"p\">)</span><span class=\"o\">+</span><span class=\"p\">(</span><span class=\"n\">train.win</span><span class=\"o\">*</span><span class=\"n\">period</span><span class=\"p\">))]</span><span class=\"w\">\n        </span><span class=\"n\">forecast.rf</span><span class=\"p\">[((</span><span class=\"n\">k</span><span class=\"o\">*</span><span class=\"n\">period</span><span class=\"p\">)</span><span class=\"m\">+1</span><span class=\"p\">)</span><span class=\"o\">:</span><span class=\"p\">((</span><span class=\"n\">k</span><span class=\"m\">+1</span><span class=\"p\">)</span><span class=\"o\">*</span><span class=\"n\">period</span><span class=\"p\">)]</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">FUN</span><span class=\"p\">(</span><span class=\"n\">train.set</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">param1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">param1</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"n\">param2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">param2</span><span class=\"p\">[</span><span class=\"n\">j</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"n\">K</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"p\">)</span><span class=\"w\">\n      </span><span class=\"p\">}</span><span class=\"w\">\n      </span><span class=\"n\">mape.matrix</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">,</span><span class=\"n\">j</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">mape</span><span class=\"p\">(</span><span class=\"n\">Y</span><span class=\"p\">[</span><span class=\"o\">-</span><span class=\"p\">(</span><span class=\"m\">1</span><span class=\"o\">:</span><span class=\"p\">(</span><span class=\"n\">train.win</span><span class=\"o\">*</span><span class=\"n\">period</span><span class=\"p\">))],</span><span class=\"w\"> </span><span class=\"n\">forecast.rf</span><span class=\"p\">)</span><span class=\"w\">\n    </span><span class=\"p\">}</span><span class=\"w\">\n  </span><span class=\"p\">}</span><span class=\"w\">\n  </span><span class=\"nf\">return</span><span class=\"p\">(</span><span class=\"n\">mape.matrix</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"p\">}</span></code></pre></figure>\n\n<p>For our purpose, I will make 20 forecasts for each hyperparameter combination. I will test <code class=\"language-plaintext highlighter-rouge\">nodesize</code> and <code class=\"language-plaintext highlighter-rouge\">mtry</code> parameters for values \\( 2,3,4,5,6 \\). It is taking some time to compute, so be aware.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">all_data</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">DT</span><span class=\"o\">$</span><span class=\"n\">value</span><span class=\"p\">[</span><span class=\"m\">1</span><span class=\"o\">:</span><span class=\"p\">(</span><span class=\"n\">period</span><span class=\"o\">*</span><span class=\"m\">41</span><span class=\"p\">)]</span><span class=\"w\">\n</span><span class=\"n\">res_1</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">gridSearch</span><span class=\"p\">(</span><span class=\"n\">all_data</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">FUN</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">RFgrid</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">param1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"m\">2</span><span class=\"p\">,</span><span class=\"m\">3</span><span class=\"p\">,</span><span class=\"m\">4</span><span class=\"p\">,</span><span class=\"m\">5</span><span class=\"p\">,</span><span class=\"m\">6</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">param2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"m\">2</span><span class=\"p\">,</span><span class=\"m\">3</span><span class=\"p\">,</span><span class=\"m\">4</span><span class=\"p\">,</span><span class=\"m\">5</span><span class=\"p\">,</span><span class=\"m\">6</span><span class=\"p\">))</span></code></pre></figure>\n\n<p>Let’s check the results.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">res_1</span></code></pre></figure>\n\n<figure class=\"highlight\"><pre><code class=\"language-text\" data-lang=\"text\">##          2        3        4        5        6\n## 2 2.937151 2.931990 2.952967 2.970451 2.972355\n## 3 2.888450 2.896477 2.897801 2.912977 2.914294\n## 4 2.874241 2.878923 2.880959 2.882959 2.896501\n## 5 2.876503 2.872179 2.873983 2.875953 2.882657\n## 6 2.868838 2.872933 2.874093 2.867840 2.881881</code></pre></figure>\n\n<p>And find the minimum.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"n\">mtry</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">row.names</span><span class=\"p\">(</span><span class=\"n\">res_1</span><span class=\"p\">)[</span><span class=\"n\">which</span><span class=\"p\">(</span><span class=\"n\">res_1</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"nf\">min</span><span class=\"p\">(</span><span class=\"n\">res_1</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">arr.ind</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">TRUE</span><span class=\"p\">)[</span><span class=\"m\">1</span><span class=\"p\">]],</span><span class=\"w\">\n  </span><span class=\"n\">nodesize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">colnames</span><span class=\"p\">(</span><span class=\"n\">res_1</span><span class=\"p\">)[</span><span class=\"n\">which</span><span class=\"p\">(</span><span class=\"n\">res_1</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"nf\">min</span><span class=\"p\">(</span><span class=\"n\">res_1</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">arr.ind</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">TRUE</span><span class=\"p\">)[</span><span class=\"m\">2</span><span class=\"p\">]])</span></code></pre></figure>\n\n<figure class=\"highlight\"><pre><code class=\"language-text\" data-lang=\"text\">##     mtry nodesize \n##      \"6\"      \"5\"</code></pre></figure>\n\n<p>So best (optimal) setting is <code class=\"language-plaintext highlighter-rouge\">mtry</code> = 6 and <code class=\"language-plaintext highlighter-rouge\">nodesize</code> = 5.</p>\n\n<p>For better imagination and analysis of results, let’s visualize the computed grid of MAPE values.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">data_grid</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">data.table</span><span class=\"p\">(</span><span class=\"n\">melt</span><span class=\"p\">(</span><span class=\"n\">res_1</span><span class=\"p\">))</span><span class=\"w\">\n</span><span class=\"n\">colnames</span><span class=\"p\">(</span><span class=\"n\">data_grid</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"s2\">\"mtry\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"nodesize\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"MAPE\"</span><span class=\"p\">)</span><span class=\"w\">\n \n</span><span class=\"n\">ggplot</span><span class=\"p\">(</span><span class=\"n\">data_grid</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">aes</span><span class=\"p\">(</span><span class=\"n\">mtry</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nodesize</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">MAPE</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">color</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">MAPE</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">geom_point</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">scale_color_distiller</span><span class=\"p\">(</span><span class=\"n\">palette</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Reds\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n  </span><span class=\"n\">theme_ts</span></code></pre></figure>\n\n<p><img src=\"/images/post_6/unnamed-chunk-24-1.png\" alt=\"plot of chunk unnamed-chunk-24\" /></p>\n\n<p>We can see that lowest average MAPEs are for <code class=\"language-plaintext highlighter-rouge\">mtry</code> = 6 and <code class=\"language-plaintext highlighter-rouge\">nodesize</code> = 2 or 5.</p>\n\n<h2 id=\"comparison\">Comparison</h2>\n\n<p>For more exact evaluation, I made comparison of five methods - simple RPART, simple CTREE, Bagging + RPART, Bagging + CTREE and Random Forest on whole available dataset (so 98 forecasts were performed).\nI created <code class=\"language-plaintext highlighter-rouge\">plotly</code> boxplots graph of MAPE values from these 5 methods. Whole evaluation can be seen in the script that is stored in <a href=\"https://github.com/PetoLau/petolau.github.io/tree/master/_Rscripts\">my GitHub repository</a>.</p>\n\n<div class=\"wrapper\"> \n<iframe width=\"900\" height=\"620\" frameborder=\"0\" scrolling=\"no\" src=\"//plot.ly/~PetoLau2/68.embed\"></iframe>\n</div>\n\n<p>We can see that Bagging really helps decrease forecasting error for RPART and CTREE. The Random Forest has best results among all tested methods, so I proposed suitable approach for seasonal time series forecasting.</p>\n\n<h2 id=\"conclusion\">Conclusion</h2>\n\n<p>In this post, I showed you how to use basic ensemble learning methods to improve forecasting accuracy. I used classical Bagging in combination with regression tree methods - RPART and CTREE. The extension of Bagging, Random Forest, was also used and evaluated. I showed you how to set important hyperparameters and how to tune them by grid search method. The Random Forest method comes most accurate and I highly recommend it for time series forecasting. But, it must be said that feature engineering is very important part also of regression modeling of time series. So, I don’t generalize results for every possible task of time series forecasting.</p>\n\n<p>In the future post, I will write about other bootstrapping techniques for time series or Boosting.</p>",
  "pubDate": "Thu, 19 Oct 2017 00:00:00 +0000",
  "link": "https://petolau.github.io/Ensemble-of-trees-for-forecasting-time-series/",
  "guid": {
    "@isPermaLink": true,
    "#text": "https://petolau.github.io/Ensemble-of-trees-for-forecasting-time-series/"
  }
}