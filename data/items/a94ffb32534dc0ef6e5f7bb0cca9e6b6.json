{
  "title": "Manage Jupyter Notebook and JupyterLab with Systemd",
  "link": "",
  "published": "2020-11-10T00:00:00-06:00",
  "updated": "2020-11-10T00:00:00-06:00",
  "id": "http://janakiev.com/blog/jupyter-systemd",
  "content": "<p>In this article you will see how to easily manage <a href=\"https://jupyter.org/\">Jupyter</a> Notebook and <a href=\"https://jupyterlab.readthedocs.io/en/stable/\">JupyterLab</a> by using the <a href=\"systemd.io\">Systemd</a> tooling. This is useful when you want to have an instance running local or on your server that you can manage and monitor.</p>\n\n<p>What is Systemd and why do we need it? Systemd is an <a href=\"https://en.wikipedia.org/wiki/Init\">init</a> system in Linux used for system intialization and service management. This allows services configured for Systemd to manage and monitor them. This way, you can check if the service is still running, you can set it to automatically restart, you monitor the outputs of the service, and much more. To add Jupyter as a service we have to create a unit file. Let’s have a look how that works.</p>\n\n<h1 id=\"create-a-jupyter-unit-file\">Create a Jupyter Unit File</h1>\n\n<p>Systemd uses unit files as its primary way to manage and configure system resources. These files are in the <a href=\"https://en.wikipedia.org/wiki/INI_file\">INI</a> file format and are stored in <code class=\"language-plaintext highlighter-rouge\">/etc/systemd/system</code>.</p>\n\n<p>But before we start, we have to configure a password for Jupyter. Typically when running Jupyter, it would open a window in your browser with a generated token. In this case it will run in the background as a service and you would need to use a password. This can be done by generating hashed password and salt for use in notebook configuration with:</p>\n\n<div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>python <span class=\"nt\">-c</span> <span class=\"s2\">\"from IPython.lib.security import passwd; print(passwd('PASS'))\"</span>\n</code></pre></div></div>\n\n<p>Which should give you a hash like this one:</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>sha1:137775e93d29:ba64d3b78e089f0f779167242ddb080a05c42a84\n</code></pre></div></div>\n\n<p>For more information on security, have a read on <a href=\"https://jupyter-notebook.readthedocs.io/en/stable/security.html\">Security in the Jupyter notebook server</a>. Great, now let’s continue to create a file with the name <code class=\"language-plaintext highlighter-rouge\">jupyter.service</code> with the following contents:</p>\n\n<div class=\"language-ini highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nn\">[Unit]</span>\n<span class=\"py\">Description</span><span class=\"p\">=</span><span class=\"s\">Jupyter Notebook</span>\n\n<span class=\"nn\">[Service]</span>\n<span class=\"py\">Type</span><span class=\"p\">=</span><span class=\"s\">simple</span>\n<span class=\"py\">PIDFile</span><span class=\"p\">=</span><span class=\"s\">/run/jupyter.pid</span>\n<span class=\"py\">ExecStart</span><span class=\"p\">=</span><span class=\"s\">/home/user/anaconda3/bin/python -m jupyter-lab --notebook-dir=/home/user/notebooks --no-browser --NotebookApp.password='sha1:137775e93d29:ba64d3b78e089f0f779167242ddb080a05c42a84'</span>\n<span class=\"py\">User</span><span class=\"p\">=</span><span class=\"s\">user</span>\n<span class=\"py\">Group</span><span class=\"p\">=</span><span class=\"s\">user</span>\n<span class=\"py\">Restart</span><span class=\"p\">=</span><span class=\"s\">always</span>\n<span class=\"py\">RestartSec</span><span class=\"p\">=</span><span class=\"s\">10</span>\n\n<span class=\"nn\">[Install]</span>\n<span class=\"py\">WantedBy</span><span class=\"p\">=</span><span class=\"s\">multi-user.target</span>\n</code></pre></div></div>\n\n<p>Each file has a few sections and each section like <code class=\"language-plaintext highlighter-rouge\">[Unit]</code>, <code class=\"language-plaintext highlighter-rouge\">[Service]</code>, and <code class=\"language-plaintext highlighter-rouge\">[Install]</code> have various <a href=\"https://www.freedesktop.org/software/systemd/man/systemd.directives.html\">directives</a> that are used to configure a service. Most of them should already give a hint on what they are used for, but we will quickly go through some of them. To read more into detail how this works have a look at the tutorial <a href=\"https://www.digitalocean.com/community/tutorials/understanding-systemd-units-and-unit-files\">Understanding Systemd Units and Unit Files</a>.</p>\n\n<p>The most important one here is the <code class=\"language-plaintext highlighter-rouge\">ExecStart=</code> directive, which specifies the command to be run. It is important to note, that only absolute paths should be used and that the <code class=\"language-plaintext highlighter-rouge\">ExecStart=</code> directive has to be written in one line. In this case the unit files uses JupyterLab that is installed in the Anaconda base environment. If you use virtualenv instead, change the directive for <code class=\"language-plaintext highlighter-rouge\">ExecStart=</code> to:</p>\n\n<div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nv\">ExecStart</span><span class=\"o\">=</span>/bin/bash <span class=\"nt\">-f</span> <span class=\"s2\">\"source /home/user/notebooks/bin/activate; jupyter-lab --notebook-dir=/home/user/notebooks\"</span>\n</code></pre></div></div>\n\n<p>The <code class=\"language-plaintext highlighter-rouge\">PIDFile=</code> directive specifies where the process identification number is stored. Make sure to have your user and group in the <code class=\"language-plaintext highlighter-rouge\">User=</code> and <code class=\"language-plaintext highlighter-rouge\">Group=</code> directives. The <code class=\"language-plaintext highlighter-rouge\">Restart=</code> directive specifies if the service should be restarted when the service exits, is killed or a timeout is reached. <code class=\"language-plaintext highlighter-rouge\">RestartSec=</code> specifies how long it should wait until the service will be then restarted.  You can read more about the directives in the <a href=\"https://www.freedesktop.org/software/systemd/man/systemd.directives.html\">documentation</a>.</p>\n\n<p>If you use more configuration and want to have it in a bash script instead, you can create a script like the following:</p>\n\n<div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"c\">#!/bin/bash</span>\n/home/user/anaconda3/bin/jupyter-lab <span class=\"se\">\\</span>\n  <span class=\"nt\">--notebook-dir</span><span class=\"o\">=</span>/home/user/notebooks <span class=\"se\">\\</span>\n  <span class=\"nt\">--ip</span><span class=\"o\">=</span><span class=\"s1\">'*'</span> <span class=\"se\">\\</span>\n  <span class=\"nt\">--port</span><span class=\"o\">=</span>8888 <span class=\"se\">\\</span>\n  <span class=\"nt\">--NotebookApp</span>.token<span class=\"o\">=</span><span class=\"s1\">''</span> <span class=\"se\">\\</span>\n  <span class=\"nt\">--NotebookApp</span>.password<span class=\"o\">=</span><span class=\"s1\">'sha1:137...'</span> <span class=\"se\">\\</span>\n  <span class=\"nt\">--ContentsManager</span>.allow_hidden<span class=\"o\">=</span>True <span class=\"se\">\\</span>\n  <span class=\"nt\">--no-browser</span>\n</code></pre></div></div>\n\n<p>Then, replace the previous <code class=\"language-plaintext highlighter-rouge\">ExecStart</code> with <code class=\"language-plaintext highlighter-rouge\">ExecStart=/path/to/script.sh</code> in the unit file. Also, make sure to make it executable with <code class=\"language-plaintext highlighter-rouge\">chmod +x /path/to/script.sh</code>.</p>\n\n<p>Finally, instead of using the argument <code class=\"language-plaintext highlighter-rouge\">--notebook-dir</code>, you can specify the working directory by using the <code class=\"language-plaintext highlighter-rouge\">WorkingDirectory=</code> directive.</p>\n\n<h1 id=\"enable-and-start-the-jupyter-service\">Enable and Start the Jupyter Service</h1>\n\n<p>First, move the unit file to <code class=\"language-plaintext highlighter-rouge\">/etc/systemd/system/</code> with:</p>\n\n<div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nb\">sudo mv </span>jupyter.service /etc/systemd/system/\n</code></pre></div></div>\n\n<p>Then, reload the systemd manager configuration with:</p>\n\n<div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nb\">sudo </span>systemctl daemon-reload\n</code></pre></div></div>\n\n<p>Next, enable the service to start at boot with:</p>\n\n<div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nb\">sudo </span>systemctl <span class=\"nb\">enable </span>jupyter\n</code></pre></div></div>\n\n<p>To start the Jupyter service, you need to type:</p>\n\n<div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nb\">sudo </span>systemctl start jupyter\n</code></pre></div></div>\n\n<p>To check its status, you can type:</p>\n\n<div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nb\">sudo </span>systemctl status jupyter\n</code></pre></div></div>\n\n<p>Finally, you can monitor the outputs of the service with <code class=\"language-plaintext highlighter-rouge\">sudo journalctl -u jupyter -f</code>. To show the log messages since the last boot (<code class=\"language-plaintext highlighter-rouge\">-b</code>) and without additional fields like timestamp and hostname (<code class=\"language-plaintext highlighter-rouge\">-o cat</code>), type:</p>\n\n<div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nb\">sudo </span>journalctl <span class=\"nt\">-u</span> jupyter <span class=\"nt\">-b</span> <span class=\"nt\">-o</span> <span class=\"nb\">cat</span> <span class=\"nt\">-f</span>\n</code></pre></div></div>\n\n<p>This should show you a similar output to the following output:</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Started Jupyter Notebook.\n[I 18:54:36.878 LabApp] JupyterLab extension loaded from /home/user/anaconda3/lib/python3.7/site-packages/jupyterlab\n[I 18:54:36.879 LabApp] JupyterLab application directory is /home/user/anaconda3/share/jupyter/lab\n[I 18:54:36.880 LabApp] Serving notebooks from local directory: /home/user/notebooks\n[I 18:54:36.880 LabApp] The Jupyter Notebook is running at:\n[I 18:54:36.880 LabApp] http://0.0.0.0:8888/\n</code></pre></div></div>\n\n<p>This really useful if you need to have a look at what Jupyter logs out since some errors and logs are not visible within the notebooks. For more useful commands and arguments have a look at this <a href=\"https://janakiev.com/blog/systemd-cheatsheet/\">Systemd cheatsheet</a>.</p>\n\n<h1 id=\"conclusion\">Conclusion</h1>\n\n<p>Now, you should be able to manage and monitor your Jupyter service with Systemd. To learn how to install and configure Jupyter on a server including SSL/TLS, have a look at my previous guide on <a href=\"https://janakiev.com/blog/jupyter-notebook-server/\">Installing and Running Jupyter Notebooks on a Server</a>  Here are a few further resources when working with systemd:</p>\n\n<ul>\n  <li><a href=\"https://janakiev.com/blog/systemd-cheatsheet/\">Systemd Cheatsheet</a></li>\n  <li><a href=\"https://www.digitalocean.com/community/tutorials/understanding-systemd-units-and-unit-files\">Understanding Systemd Units and Unit Files</a></li>\n  <li><a href=\"https://www.digitalocean.com/community/tutorials/how-to-use-systemctl-to-manage-systemd-services-and-units\">How To Use Systemctl to Manage Systemd Services and Units</a></li>\n  <li><a href=\"https://www.digitalocean.com/community/tutorials/how-to-use-journalctl-to-view-and-manipulate-systemd-logs\">How To Use Journalctl to View and Manipulate Systemd Logs</a></li>\n</ul>",
  "author": {
    "name": "Nikolai Janakiev"
  },
  "category": [
    "",
    "",
    "",
    ""
  ],
  "summary": "In this article you will see how to easily manage Jupyter Notebook and JupyterLab by using the Systemd tooling. This is useful when you want to have an instance running local or on your server that you can manage and monitor.",
  "media:thumbnail": "",
  "media:content": ""
}