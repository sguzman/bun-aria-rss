{
  "id": "tag:drsimonj.svbtle.com,2014:Post/label-line-ends-in-time-series-with-ggplot2",
  "published": "2018-09-25T11:45:41-07:00",
  "updated": "2018-09-25T11:45:41-07:00",
  "link": "",
  "title": "Label line ends in time series with ggplot2",
  "content": "<p><a href=\"https://twitter.com/drsimonj\" rel=\"nofollow\">@drsimonj</a> here with a quick share on making great use of the secondary y axis with ggplot2 – super helpful if you’re plotting groups of time series!</p>\n\n<p>Here’s an example of what I want to show you how to create (pay attention to the numbers of the right):</p>\n\n<p><a href=\"https://svbtleusercontent.com/a3LT3yKxA29K3Vc1aXnDsA0xspap.png\" rel=\"nofollow\"><img src=\"https://svbtleusercontent.com/a3LT3yKxA29K3Vc1aXnDsA0xspap_small.png\" alt=\"init-example-1.png\"></a></p>\n<h2 id=\"setup_2\">Setup <a class=\"head_anchor\" href=\"#setup_2\" rel=\"nofollow\">#</a>\n</h2>\n<p>To setup we’ll need the tidyverse package and the <code class=\"prettyprint\">Orange</code> data set that comes with R. This tracks the circumference growth of five orange trees over time.</p>\n\n<pre><code class=\"prettyprint lang-r\">library(tidyverse)\n\nd &lt;- Orange\n\nhead(d)\n#&gt; Grouped Data: circumference ~ age | Tree\n#&gt;   Tree  age circumference\n#&gt; 1    1  118            30\n#&gt; 2    1  484            58\n#&gt; 3    1  664            87\n#&gt; 4    1 1004           115\n#&gt; 5    1 1231           120\n#&gt; 6    1 1372           142\n</code></pre>\n<h2 id=\"template-code_2\">Template code <a class=\"head_anchor\" href=\"#template-code_2\" rel=\"nofollow\">#</a>\n</h2>\n<p>To create the basic case where the numbers appear at the end of your time series lines, your code might look something like this:</p>\n\n<pre><code class=\"prettyprint lang-r\"># You have a data set with:\n# - GROUP colum\n# - X colum (say time)\n# - Y column (the values of interest)\nDATA_SET\n\n# Create a vector of the last (furthest right) y-axis values for each group\nDATA_SET_ENDS &lt;- DATA_SET %&gt;% \n  group_by(GROUP) %&gt;% \n  top_n(1, X) %&gt;% \n  pull(Y)\n\n# Create plot with `sec.axis`\nggplot(DATA_SET, aes(X, Y, color = GROUP)) +\n    geom_line() +\n    scale_x_continuous(expand = c(0, 0)) +\n    scale_y_continuous(sec.axis = sec_axis(~ ., breaks = DATA_SET_ENDS))\n</code></pre>\n<h2 id=\"let39s-see-it_2\">Let’s see it! <a class=\"head_anchor\" href=\"#let39s-see-it_2\" rel=\"nofollow\">#</a>\n</h2>\n<p>Let’s break it down a bit. We already have our data set where the group colum is <code class=\"prettyprint\">Tree</code>, the X value is <code class=\"prettyprint\">age</code>, and the Y value is <code class=\"prettyprint\">circumference</code>.</p>\n\n<p>So first get a vector of the last (furthest right) values for each group:</p>\n\n<pre><code class=\"prettyprint lang-r\">d_ends &lt;- d %&gt;% \n  group_by(Tree) %&gt;% \n  top_n(1, age) %&gt;% \n  pull(circumference)\n\nd_ends\n#&gt; [1] 145 203 140 214 177\n</code></pre>\n\n<p>Next, let’s set up the basic plot without the numbers to see how each layer adds up.</p>\n\n<pre><code class=\"prettyprint lang-r\">ggplot(d, aes(age, circumference, color = Tree)) +\n      geom_line()\n</code></pre>\n\n<p><a href=\"https://svbtleusercontent.com/4zKSnhW3JDUzwHbmKGBMAo0xspap.png\" rel=\"nofollow\"><img src=\"https://svbtleusercontent.com/4zKSnhW3JDUzwHbmKGBMAo0xspap_small.png\" alt=\"unnamed-chunk-5-1.png\"></a></p>\n\n<p>Now we can use <code class=\"prettyprint\">scale_y_*</code>, with the argument <code class=\"prettyprint\">sec.axis</code> to create a second axis on the right, with numbers to be displayed at <code class=\"prettyprint\">breaks</code>, defined by our vector of line ends:</p>\n\n<pre><code class=\"prettyprint lang-r\">ggplot(d, aes(age, circumference, color = Tree)) +\n      geom_line() +\n      scale_y_continuous(sec.axis = sec_axis(~ ., breaks = d_ends))\n</code></pre>\n\n<p><a href=\"https://svbtleusercontent.com/xfnR83uEfJP9nEz7ZToAkt0xspap.png\" rel=\"nofollow\"><img src=\"https://svbtleusercontent.com/xfnR83uEfJP9nEz7ZToAkt0xspap_small.png\" alt=\"unnamed-chunk-6-1.png\"></a></p>\n\n<p>This is a great start, The only major addition I suggest is expanding the margins of the x-axis so the gap disappears. You do this with <code class=\"prettyprint\">scale_x_*</code> and the <code class=\"prettyprint\">expand</code> argument:</p>\n\n<pre><code class=\"prettyprint lang-r\">ggplot(d, aes(age, circumference, color = Tree)) +\n      geom_line() +\n      scale_y_continuous(sec.axis = sec_axis(~ ., breaks = d_ends)) +\n      scale_x_continuous(expand = c(0, 0))\n</code></pre>\n\n<p><a href=\"https://svbtleusercontent.com/65yGdKt3cRfnBpJegdYRC0xspap.png\" rel=\"nofollow\"><img src=\"https://svbtleusercontent.com/65yGdKt3cRfnBpJegdYRC0xspap_small.png\" alt=\"unnamed-chunk-7-1.png\"></a></p>\n<h2 id=\"polishing-it-up_2\">Polishing it up <a class=\"head_anchor\" href=\"#polishing-it-up_2\" rel=\"nofollow\">#</a>\n</h2>\n<p>Like it? Here’s the code to recreate the first polished plot:</p>\n\n<pre><code class=\"prettyprint lang-r\">library(tidyverse)\n\nd &lt;- Orange %&gt;% \n  as_tibble()\n\nd_ends &lt;- d %&gt;% \n  group_by(Tree) %&gt;% \n  top_n(1, age) %&gt;% \n  pull(circumference)\n\nd %&gt;% \n  ggplot(aes(age, circumference, color = Tree)) +\n    geom_line(size = 2, alpha = .8) +\n    theme_minimal() +\n    scale_x_continuous(expand = c(0, 0)) +\n    scale_y_continuous(sec.axis = sec_axis(~ ., breaks = d_ends)) +\n    ggtitle(\"Orange trees getting bigger with age\",\n            subtitle = \"Based on the Orange data set in R\") +\n    labs(x = \"Days old\", y = \"Circumference (mm)\", caption = \"Plot by @drsimonj\")\n</code></pre>\n\n<p><a href=\"https://svbtleusercontent.com/a3LT3yKxA29K3Vc1aXnDsA0xspap.png\" rel=\"nofollow\"><img src=\"https://svbtleusercontent.com/a3LT3yKxA29K3Vc1aXnDsA0xspap_small.png\" alt=\"init-example-8.png\"></a></p>\n<h2 id=\"sign-off_2\">Sign off <a class=\"head_anchor\" href=\"#sign-off_2\" rel=\"nofollow\">#</a>\n</h2>\n<p>Thanks for reading and I hope this was useful for you.</p>\n\n<p>For updates of recent blog posts, follow <a href=\"https://twitter.com/drsimonj\" rel=\"nofollow\">@drsimonj</a> on Twitter, or email me at <a href=\"mailto:drsimonjackson@gmail.com\" rel=\"nofollow\">drsimonjackson@gmail.com</a> to get in touch.</p>\n\n<p>If you’d like the code that produced this blog, check out the <a href=\"https://github.com/drsimonj/blogR\" rel=\"nofollow\">blogR GitHub repository</a>.</p>"
}