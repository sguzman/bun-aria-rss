{
  "title": "(not provided): Using R and the Google Analytics API",
  "description": "<p><img src=\"/wp-content/uploads/2013/01/google-not-provided.png\" alt=\"(not provided) terms from Google average 35%-60% of all organic search terms\" /></p>",
  "pubDate": "Fri, 11 Jan 2013 16:27:33 +0000",
  "link": "http://randyzwitch.com/r-google-analytics-api/",
  "guid": "http://randyzwitch.com/r-google-analytics-api/",
  "content": "<p><img src=\"/wp-content/uploads/2013/01/google-not-provided.png\" alt=\"(not provided) terms from Google average 35%-60% of all organic search terms\" /></p>\n\n<p class=\"wp-caption-text\">\n(not provided) terms from Google average 35%-60% of all Google organic search terms\n</p>\n\n<p>For power users of Google Analytics, there is a heavy dose of spreadsheet work that accompanies any decent analysis.  But even with Excel in tow, it’s often difficult to get the data <em>just right</em> without resorting to formula hacks and manual table formatting.  This is where the Google Analytics API and R can come very much in handy.</p>\n\n<h2 id=\"connecting-to-the-google-analytics-api-using-r\">Connecting to the Google Analytics API using R</h2>\n\n<p>I’m not going to say that connecting to the Google Analytics API is easy <em>per se</em>, but with the <a href=\"http://skardhamar.github.com/rga/\" title=\"R Google Analytics API package\">rga package</a> written by “skardhamar” on GitHub, it’s easier than if you had to develop the connection code yourself!  However, before you can get started making calls to the Google Analytics API, you need to register within the <a href=\"https://code.google.com/apis/console/\" title=\"Google Analytics API console\">Google Analytics API console</a>.  There you can define a new project and then you’ll be able to make your API calls via R.</p>\n\n<p>After you have your API access straightened out, the <a href=\"http://skardhamar.github.com/rga/\" title=\"RGA package instructions\">GitHub page for the rga package</a> has all the details in how to authenticate using the <code class=\"language-plaintext highlighter-rouge\">rga.open</code> function.  I chose to use the <code class=\"language-plaintext highlighter-rouge\">where</code> argument so that I can continuously hit the API across many sessions without having to do browser authentication each time.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><table class=\"rouge-table\"><tbody><tr><td class=\"gutter gl\"><pre class=\"lineno\">1\n</pre></td><td class=\"code\"><pre><span class=\"n\">rga.open</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"ga\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">where</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"~/Documents/R/ga-api\"</span><span class=\"p\">)</span>\n</pre></td></tr></tbody></table></code></pre></figure>\n\n<h2 id=\"analyzing-not-provided-as-a-google-analytics-organic-search-term\">Analyzing (not provided) as a Google Analytics organic search term</h2>\n\n<p>Once connected to the Google Analytics API, now it’s time to submit our API calls.  I used two API calls to create the graph at the top of the post, which shows the percentage of all Google organic search terms that are listed as “(not provided)” for the entire history of this blog.  The two API calls were to download the number of total organic search term visits by date from Google and the number of “(not provided)” visits by date, also from Google.  Here’s the API call for the “(not provided)” data (replace XXXXXXXX with your profile ID):</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><table class=\"rouge-table\"><tbody><tr><td class=\"gutter gl\"><pre class=\"lineno\">1\n2\n3\n4\n5\n6\n7\n8\n</pre></td><td class=\"code\"><pre><span class=\"n\">visits_notprovided.df</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">ga</span><span class=\"o\">$</span><span class=\"n\">getData</span><span class=\"p\">(</span><span class=\"n\">XXXXXXXX</span><span class=\"p\">,</span><span class=\"w\">\n</span><span class=\"n\">start.date</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"2011-01-01\"</span><span class=\"p\">,</span><span class=\"w\">\n</span><span class=\"n\">end.date</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"2013-01-10\"</span><span class=\"p\">,</span><span class=\"w\">\n</span><span class=\"n\">metrics</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"ga:visits\"</span><span class=\"p\">,</span><span class=\"w\">\n</span><span class=\"n\">filters</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"ga:keyword==(not provided);ga:source==google;ga:medium==organic\"</span><span class=\"p\">,</span><span class=\"w\">\n</span><span class=\"n\">dimensions</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"ga:date\"</span><span class=\"p\">,</span><span class=\"w\">\n</span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">1500</span><span class=\"p\">,</span><span class=\"w\">\n</span><span class=\"n\">sort</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"ga:date\"</span><span class=\"p\">)</span>\n</pre></td></tr></tbody></table></code></pre></figure>\n\n<p>The result of this API call provides an R data frame containing two columns: date and number of visits where the search term was “(not provided)”.</p>\n\n<h2 id=\"munging-the-data-using-r\">Munging the data using R</h2>\n\n<p>After pulling the data into R, all that’s left is to merge the data frames, do a few calculations, then make the boxplot.  Because the default object returned by the rga package is a data frame, it’s trivial to use the <code class=\"language-plaintext highlighter-rouge\">merge</code> function in R to join the data frames, then use a few calculated columns to create the percentage of visits that are “(not provided)”</p>\n\n<h2 id=\"what-was-that-google-only-10-of-searches-are-supposed-to-be-not-provided\">What was that Google, only 10% of searches are supposed to be (not provided)?</h2>\n\n<p>By now, it’s beating a dead horse that the percentage of “(not provided)” search results from Google FAR exceeds what they said it would.  This blog gets about 5,000 visits a month, and due to the technical nature of the blog many of the users are using Chrome (which does secure search automatically) or from iOS (which also does secure search).  But at minimum, this graph illustrates the power of using the Google Analytics API via R; I can update this graph at my leisure by running my script, and I can create a graphic that’s not possible within Excel.</p>\n\n<p>Full code:</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><table class=\"rouge-table\"><tbody><tr><td class=\"gutter gl\"><pre class=\"lineno\">1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17\n18\n19\n20\n21\n22\n23\n24\n25\n26\n27\n28\n29\n30\n31\n32\n33\n34\n35\n36\n37\n38\n39\n40\n41\n42\n43\n44\n45\n46\n47\n48\n49\n50\n51\n52\n53\n54\n55\n56\n57\n58\n59\n60\n61\n62\n63\n64\n65\n66\n67\n68\n</pre></td><td class=\"code\"><pre><span class=\"c1\">#### Connecting to Google Analytics API via R</span><span class=\"w\">\n</span><span class=\"c1\">#### Uses OAuth 2.0</span><span class=\"w\">\n</span><span class=\"c1\">#### https://developers.google.com/analytics/devguides/reporting/core/v3/ for documentation</span><span class=\"w\">\n\n</span><span class=\"c1\"># Install devtools package &amp; rga - This is only done one time</span><span class=\"w\">\n</span><span class=\"n\">install.packages</span><span class=\"p\">(</span><span class=\"s2\">\"devtools\"</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"n\">library</span><span class=\"p\">(</span><span class=\"n\">devtools</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"n\">install_github</span><span class=\"p\">(</span><span class=\"s2\">\"rga\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"skardhamar\"</span><span class=\"p\">)</span><span class=\"w\">\n\n\n</span><span class=\"c1\"># Load rga package - requires bitops, RCurl, rjson</span><span class=\"w\">\n</span><span class=\"c1\"># Load lubridate to handle dates</span><span class=\"w\">\n</span><span class=\"n\">library</span><span class=\"p\">(</span><span class=\"n\">rga</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"n\">library</span><span class=\"p\">(</span><span class=\"n\">lubridate</span><span class=\"p\">)</span><span class=\"w\">\n\n</span><span class=\"c1\"># Authenticating to GA API. Go to https://code.google.com/apis/console/ and create</span><span class=\"w\">\n</span><span class=\"c1\"># an API application.  Don't need to worry about the client id and shared secret for</span><span class=\"w\">\n</span><span class=\"c1\"># this R code, it is not needed</span><span class=\"w\">\n\n</span><span class=\"c1\"># If file listed in \"where\" location doesn't exist, browser window will open.</span><span class=\"w\">\n</span><span class=\"c1\"># Allow access, copy code into R console where prompted</span><span class=\"w\">\n</span><span class=\"c1\"># Once file located in \"where\" directory created, you will have continous access to</span><span class=\"w\">\n</span><span class=\"c1\"># API without needing to do browser authentication</span><span class=\"w\">\n</span><span class=\"n\">rga.open</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"ga\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">where</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"~/Documents/R/ga-api\"</span><span class=\"p\">)</span><span class=\"w\">\n\n\n</span><span class=\"c1\"># Get (not provided) Search results.  Replace XXXXXXXX with your profile ID from GA</span><span class=\"w\">\n</span><span class=\"n\">visits_notprovided.df</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">ga</span><span class=\"o\">$</span><span class=\"n\">getData</span><span class=\"p\">(</span><span class=\"n\">XXXXXXXX</span><span class=\"p\">,</span><span class=\"w\">\n                                  </span><span class=\"n\">start.date</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"2011-01-01\"</span><span class=\"p\">,</span><span class=\"w\">\n                                  </span><span class=\"n\">end.date</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"2013-01-10\"</span><span class=\"p\">,</span><span class=\"w\">\n                                  </span><span class=\"n\">metrics</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"ga:visits\"</span><span class=\"p\">,</span><span class=\"w\">\n                                  </span><span class=\"n\">filters</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"ga:keyword==(not provided);ga:source==google;ga:medium==organic\"</span><span class=\"p\">,</span><span class=\"w\">\n                                  </span><span class=\"n\">dimensions</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"ga:date\"</span><span class=\"p\">,</span><span class=\"w\">\n                                  </span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">1500</span><span class=\"p\">,</span><span class=\"w\">\n                                  </span><span class=\"n\">sort</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"ga:date\"</span><span class=\"p\">)</span><span class=\"w\">\n\n</span><span class=\"nf\">names</span><span class=\"p\">(</span><span class=\"n\">visits_notprovided.df</span><span class=\"p\">)</span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"s2\">\"hit_date\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"np_visits\"</span><span class=\"p\">)</span><span class=\"w\">\n\n</span><span class=\"c1\"># Get sum of all Google Organic Search results.  Replace XXXXXXXX with your profile ID from GA</span><span class=\"w\">\n</span><span class=\"n\">visits_orgsearch.df</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">ga</span><span class=\"o\">$</span><span class=\"n\">getData</span><span class=\"p\">(</span><span class=\"n\">XXXXXXXX</span><span class=\"p\">,</span><span class=\"w\">\n                                    </span><span class=\"n\">start.date</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"2011-01-01\"</span><span class=\"p\">,</span><span class=\"w\">\n                                    </span><span class=\"n\">end.date</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"2013-01-10\"</span><span class=\"p\">,</span><span class=\"w\">\n                                    </span><span class=\"n\">metrics</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"ga:visits\"</span><span class=\"p\">,</span><span class=\"w\">\n                                    </span><span class=\"n\">filters</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"ga:source==google;ga:medium==organic\"</span><span class=\"p\">,</span><span class=\"w\">\n                                    </span><span class=\"n\">dimensions</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"ga:date\"</span><span class=\"p\">,</span><span class=\"w\">\n                                    </span><span class=\"n\">max</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">1500</span><span class=\"p\">,</span><span class=\"w\">\n                                    </span><span class=\"n\">sort</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"ga:date\"</span><span class=\"p\">)</span><span class=\"w\">\n\n</span><span class=\"nf\">names</span><span class=\"p\">(</span><span class=\"n\">visits_orgsearch.df</span><span class=\"p\">)</span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"s2\">\"hit_date\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"total_visits\"</span><span class=\"p\">)</span><span class=\"w\">\n\n</span><span class=\"c1\"># Merge files, create metrics, limit dataset to just days when tags firing</span><span class=\"w\">\n</span><span class=\"n\">merged.df</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">merge</span><span class=\"p\">(</span><span class=\"n\">visits_notprovided.df</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">visits_orgsearch.df</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">all</span><span class=\"o\">=</span><span class=\"kc\">TRUE</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"n\">merged.df</span><span class=\"o\">$</span><span class=\"n\">search_term_provided</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">merged.df</span><span class=\"o\">$</span><span class=\"n\">total_visits</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">merged.df</span><span class=\"o\">$</span><span class=\"n\">np_visits</span><span class=\"w\">\n</span><span class=\"n\">merged.df</span><span class=\"o\">$</span><span class=\"n\">pct_np</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">merged.df</span><span class=\"o\">$</span><span class=\"n\">np_visits</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"n\">merged.df</span><span class=\"o\">$</span><span class=\"n\">total_visits</span><span class=\"w\">\n</span><span class=\"n\">merged.df</span><span class=\"o\">$</span><span class=\"n\">yearmo</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">year</span><span class=\"p\">(</span><span class=\"n\">merged.df</span><span class=\"o\">$</span><span class=\"n\">hit_date</span><span class=\"p\">)</span><span class=\"o\">*</span><span class=\"m\">100</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">month</span><span class=\"p\">(</span><span class=\"n\">merged.df</span><span class=\"o\">$</span><span class=\"n\">hit_date</span><span class=\"p\">)</span><span class=\"w\">\n\n</span><span class=\"n\">final_dataset</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">subset</span><span class=\"p\">(</span><span class=\"n\">merged.df</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">total_visits</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"m\">0</span><span class=\"p\">)</span><span class=\"w\">\n\n\n</span><span class=\"c1\"># Visualization - boxplot by month</span><span class=\"w\">\n</span><span class=\"c1\"># Main plot, minus y axis tick labels</span><span class=\"w\">\n</span><span class=\"n\">boxplot</span><span class=\"p\">(</span><span class=\"n\">pct_np</span><span class=\"o\">~</span><span class=\"n\">yearmo</span><span class=\"p\">,</span><span class=\"n\">data</span><span class=\"o\">=</span><span class=\"n\">final_dataset</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"o\">=</span><span class=\"s2\">\"Google (not provided)\\nPercentage of Total Organic Searches\"</span><span class=\"p\">,</span><span class=\"w\">\n        </span><span class=\"n\">xlab</span><span class=\"o\">=</span><span class=\"s2\">\"Year-Month\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ylab</span><span class=\"o\">=</span><span class=\"s2\">\"Percent (not provided)\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">col</span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"orange\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ylim</span><span class=\"o\">=</span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"m\">0</span><span class=\"p\">,</span><span class=\"m\">.8</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">yaxt</span><span class=\"o\">=</span><span class=\"s2\">\"n\"</span><span class=\"p\">)</span><span class=\"w\">\n\n</span><span class=\"c1\">#Create tick sequence and format axis labels</span><span class=\"w\">\n</span><span class=\"n\">ticks</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">seq</span><span class=\"p\">(</span><span class=\"m\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"m\">.8</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"m\">.2</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"n\">label_ticks</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">sprintf</span><span class=\"p\">(</span><span class=\"s2\">\"%1.f%%\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"m\">100</span><span class=\"o\">*</span><span class=\"n\">ticks</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"n\">axis</span><span class=\"p\">(</span><span class=\"m\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"o\">=</span><span class=\"n\">ticks</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">labels</span><span class=\"o\">=</span><span class=\"n\">label_ticks</span><span class=\"p\">)</span>\n</pre></td></tr></tbody></table></code></pre></figure>"
}