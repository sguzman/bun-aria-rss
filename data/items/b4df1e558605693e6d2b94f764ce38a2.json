{
  "title": "CoronaDash app use case - Clustering countries' COVID-19 active cases trajectories",
  "description": "<p>COVID-19 disease spread hit the World really globally and also the field of mathematicians/ statisticians/ machine learning researchers and related.\nThese experts want to help to understand for example future trends (forecast) of the coronavirus spread.\nMy motivation, in this case, was to create <strong>interactive dashboard</strong> about COVID-19 to inform about various scenarios in every country and compare them through <strong>data mining methods</strong>.</p>\n\n<p>I created <strong>CoronaDash</strong> <code class=\"language-plaintext highlighter-rouge\">shinydashboard</code> application that is hosted on <a href=\"https://petolau.shinyapps.io/coronadash/\"><strong>petolau.shinyapps.io</strong> RStudio platform</a>.\nThe dashboard provides various data mining/ visualization techniques for <strong>comparing countries’ COVID-19 data statistics</strong> as:</p>\n\n<ul>\n  <li>extrapolating total confirmed cases by exponential smoothing model,</li>\n  <li>trajectories of cases/ deaths spread,</li>\n  <li>multidimensional clustering of countries’ data/ statistics - with dendrogram and table of clusters averages,</li>\n  <li>aggregated views for the whole World,</li>\n  <li>hierarchical clustering of countries’ trajectories based on DTW distance and preprocessing by SMA (+ normalization), for fast comparison of a large number of countries’ COVID-19 magnitudes and trends.</li>\n</ul>\n\n<p>The blog post will be about the last bullet of the above list - <strong>clustering of countries’ trajectories</strong>.\nThis use case is challenging because of the <strong>clustering time series with different lengths</strong>.</p>\n\n<h4 id=\"covidr-contest\">CovidR contest</h4>\n\n<p>I submitted my shiny application also to the interesting initiative of eRum 2020 organizers - <a href=\"https://milano-r.github.io/erum2020-covidr-contest/index.html\"><strong>CovidR Contest</strong></a>.</p>\n\n<h2 id=\"preprocessing-covid-19-open-data\">Preprocessing COVID-19 open-data</h2>\n\n<p>Firstly, load all the needed packages for an analysis.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">library</span><span class=\"p\">(</span><span class=\"n\">data.table</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"c1\"># data handling</span><span class=\"w\">\n</span><span class=\"n\">library</span><span class=\"p\">(</span><span class=\"n\">TSrepr</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"c1\"># ts representations, use dev version devtools::install_github(\"PetoLau/TSrepr\")</span><span class=\"w\">\n</span><span class=\"n\">library</span><span class=\"p\">(</span><span class=\"n\">ggplot2</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"c1\"># visualisations</span><span class=\"w\">\n</span><span class=\"n\">library</span><span class=\"p\">(</span><span class=\"n\">dtwclust</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"c1\"># clustering using DTW distance</span><span class=\"w\">\n</span><span class=\"n\">library</span><span class=\"p\">(</span><span class=\"n\">dygraphs</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"c1\"># interactive visualizations</span><span class=\"w\">\n</span><span class=\"n\">library</span><span class=\"p\">(</span><span class=\"n\">ggrepel</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"c1\"># nice labels in ggplot</span><span class=\"w\">\n</span><span class=\"n\">library</span><span class=\"p\">(</span><span class=\"n\">dendextend</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"c1\"># dendrograms</span><span class=\"w\">\n</span><span class=\"n\">library</span><span class=\"p\">(</span><span class=\"n\">DT</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"c1\"># nice datatable</span><span class=\"w\">\n</span><span class=\"n\">library</span><span class=\"p\">(</span><span class=\"n\">htmlwidgets</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"c1\"># save html objects</span></code></pre></figure>\n\n<p>I use data coming from <a href=\"https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data/csse_covid_19_time_series\">Johns Hopkins CSSE GitHub repository</a> - cases and deaths numbers, <a href=\"https://github.com/ulklc/covid19-timeseries\">GitHub repository by ulklc</a> - recovery cases number, tests data are coming from <a href=\"https://github.com/ChrisMichaelPerezSantiago/covid19\">COVID19 API</a>, and population sizes are from <a href=\"https://www.worldometers.info/coronavirus/\">worldometers</a>.</p>\n\n<p>I prepared time series data at <em>2020-05-24</em> snapshot with various statistics also computed <strong>per 1 million population</strong> (so much better comparable), so let’s read them.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">data_covid_ts</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">fread</span><span class=\"p\">(</span><span class=\"s2\">\"_rmd/data_covid_time_series_2020-05-24.csv\"</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"n\">data_covid_ts</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">DateRep</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">as.Date</span><span class=\"p\">(</span><span class=\"n\">DateRep</span><span class=\"p\">)]</span><span class=\"w\"> </span><span class=\"c1\"># transform character to Date class</span><span class=\"w\">\n \n</span><span class=\"c1\"># what we got</span><span class=\"w\">\n</span><span class=\"n\">str</span><span class=\"p\">(</span><span class=\"n\">data_covid_ts</span><span class=\"p\">)</span></code></pre></figure>\n\n<figure class=\"highlight\"><pre><code class=\"language-text\" data-lang=\"text\">## Classes 'data.table' and 'data.frame':\t19344 obs. of  17 variables:\n##  $ Country                                       : chr  \"Afghanistan\" \"Afghanistan\" \"Afghanistan\" \"Afghanistan\" ...\n##  $ DateRep                                       : Date, format: \"2020-01-22\" \"2020-01-23\" \"2020-01-24\" \"2020-01-25\" ...\n##  $ Cases_cumsum                                  : int  0 0 0 0 0 0 0 0 0 0 ...\n##  $ Cases                                         : int  0 0 0 0 0 0 0 0 0 0 ...\n##  $ Deaths_cumsum                                 : int  0 0 0 0 0 0 0 0 0 0 ...\n##  $ Deaths                                        : int  0 0 0 0 0 0 0 0 0 0 ...\n##  $ Recovered_cumsum                              : int  0 0 0 0 0 0 0 0 0 0 ...\n##  $ Recovered                                     : int  0 0 0 0 0 0 0 0 0 0 ...\n##  $ Active_cases_cumsum                           : int  0 0 0 0 0 0 0 0 0 0 ...\n##  $ New cases per 1 million population            : int  0 0 0 0 0 0 0 0 0 0 ...\n##  $ New deaths per 1 million population           : int  0 0 0 0 0 0 0 0 0 0 ...\n##  $ New recovered cases per 1 million population  : int  0 0 0 0 0 0 0 0 0 0 ...\n##  $ Death rate (%)                                : num  NA NA NA NA NA NA NA NA NA NA ...\n##  $ Total active cases per 1 million population   : int  0 0 0 0 0 0 0 0 0 0 ...\n##  $ Total deaths per 1 million population         : int  0 0 0 0 0 0 0 0 0 0 ...\n##  $ Total cases per 1 million population          : int  0 0 0 0 0 0 0 0 0 0 ...\n##  $ Total recovered cases per 1 million population: int  0 0 0 0 0 0 0 0 0 0 ...\n##  - attr(*, \".internal.selfref\")=&lt;externalptr&gt;</code></pre></figure>\n\n<p>Since I want to analyze (cluster) trajectories of countries’ active cases spread, I need to set <strong>starting position for every countries’ time series</strong> - in this case (and in other many analyses out there) <em>100-th</em> cumulative confirmed case is set as starting point.\nI will also use only top <em>82</em> affected countries (+ Slovakia as my home country) for the whole analysis.\nLet’s transform our data for ‘since first 100-th case’ countries’ trajectories (with the same lengths!).</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">n_cases</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"m\">100</span><span class=\"w\"> </span><span class=\"c1\"># you can vary</span><span class=\"w\">\n</span><span class=\"n\">statistic</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"s1\">'Total active cases per 1 million population'</span><span class=\"w\"> </span><span class=\"c1\"># you can also choose other stat</span><span class=\"w\">\n \n</span><span class=\"c1\"># Cases greater than threshold</span><span class=\"w\">\n</span><span class=\"n\">data_covid_100_cases</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">copy</span><span class=\"p\">(</span><span class=\"n\">data_covid_ts</span><span class=\"p\">[,</span><span class=\"w\">\n                                           </span><span class=\"n\">.SD</span><span class=\"p\">[</span><span class=\"n\">DateRep</span><span class=\"w\"> </span><span class=\"o\">&gt;=</span><span class=\"w\"> </span><span class=\"n\">.SD</span><span class=\"p\">[</span><span class=\"n\">Cases_cumsum</span><span class=\"w\"> </span><span class=\"o\">&gt;=</span><span class=\"w\"> </span><span class=\"n\">n_cases</span><span class=\"p\">,</span><span class=\"w\">\n                                                              </span><span class=\"nf\">min</span><span class=\"p\">(</span><span class=\"n\">DateRep</span><span class=\"p\">,</span><span class=\"w\">\n                                                                  </span><span class=\"n\">na.rm</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">T</span><span class=\"p\">)]],</span><span class=\"w\">\n                                            </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Country</span><span class=\"p\">)])</span><span class=\"w\">\n \n</span><span class=\"c1\"># Order data</span><span class=\"w\">\n</span><span class=\"n\">setorder</span><span class=\"p\">(</span><span class=\"n\">data_covid_100_cases</span><span class=\"p\">,</span><span class=\"w\">\n         </span><span class=\"n\">Country</span><span class=\"p\">,</span><span class=\"w\">\n         </span><span class=\"n\">DateRep</span><span class=\"p\">)</span><span class=\"w\">\n    \n</span><span class=\"c1\"># Create 'days since' column</span><span class=\"w\">\n</span><span class=\"n\">data_covid_100_cases</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">paste0</span><span class=\"p\">(</span><span class=\"s2\">\"Days_since_first_\"</span><span class=\"p\">,</span><span class=\"w\">\n                               </span><span class=\"n\">n_cases</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"_case\"</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"o\">:</span><span class=\"n\">.N</span><span class=\"p\">,</span><span class=\"w\">\n                     </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Country</span><span class=\"p\">)]</span><span class=\"w\">\n   \n</span><span class=\"c1\"># top N countries selection for an analysis</span><span class=\"w\">\n</span><span class=\"n\">data_cases_order</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">copy</span><span class=\"p\">(</span><span class=\"n\">data_covid_100_cases</span><span class=\"p\">[,</span><span class=\"w\">\n                                      </span><span class=\"n\">.SD</span><span class=\"p\">[</span><span class=\"n\">DateRep</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"nf\">max</span><span class=\"p\">(</span><span class=\"n\">DateRep</span><span class=\"p\">),</span><span class=\"w\">\n                                          </span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">statistic</span><span class=\"p\">)],</span><span class=\"w\">\n                                      </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Country</span><span class=\"p\">)</span><span class=\"w\">\n                                      </span><span class=\"p\">])</span><span class=\"w\">\n    \n</span><span class=\"n\">setnames</span><span class=\"p\">(</span><span class=\"n\">data_cases_order</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"V1\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">statistic</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"n\">setorderv</span><span class=\"p\">(</span><span class=\"n\">data_cases_order</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">statistic</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"m\">-1</span><span class=\"p\">)</span><span class=\"w\">\n    \n</span><span class=\"c1\"># subset data based on selected parameter -  top 82 countries and analyzed columns</span><span class=\"w\">\n</span><span class=\"n\">data_covid_cases_sub</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">copy</span><span class=\"p\">(</span><span class=\"n\">data_covid_100_cases</span><span class=\"p\">[</span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"n\">data_cases_order</span><span class=\"p\">[</span><span class=\"m\">1</span><span class=\"o\">:</span><span class=\"m\">82</span><span class=\"p\">][</span><span class=\"o\">!</span><span class=\"nf\">is.na</span><span class=\"p\">(</span><span class=\"n\">Country</span><span class=\"p\">),</span><span class=\"w\">\n                                                                             </span><span class=\"n\">Country</span><span class=\"p\">],</span><span class=\"w\">\n                                                      </span><span class=\"s2\">\"Slovakia\"</span><span class=\"p\">)),</span><span class=\"w\">\n                                                  </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Country</span><span class=\"p\">),</span><span class=\"w\">\n                                                 </span><span class=\"n\">.SD</span><span class=\"p\">,</span><span class=\"w\">\n                                                 </span><span class=\"n\">.SDcols</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"s2\">\"Country\"</span><span class=\"p\">,</span><span class=\"w\">\n                                                             </span><span class=\"n\">paste0</span><span class=\"p\">(</span><span class=\"s2\">\"Days_since_first_\"</span><span class=\"p\">,</span><span class=\"w\">\n                                                                    </span><span class=\"n\">n_cases</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"_case\"</span><span class=\"p\">),</span><span class=\"w\">\n                                                             </span><span class=\"n\">statistic</span><span class=\"p\">)</span><span class=\"w\">\n                                                 </span><span class=\"p\">])</span><span class=\"w\">\n \n</span><span class=\"c1\"># Make same length time series from countries data</span><span class=\"w\">\n</span><span class=\"n\">data_covid_trajectories</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">dcast</span><span class=\"p\">(</span><span class=\"n\">data_covid_cases_sub</span><span class=\"p\">,</span><span class=\"w\">\n                                 </span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">paste0</span><span class=\"p\">(</span><span class=\"s2\">\"Days_since_first_\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">n_cases</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"_case\"</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">~</span><span class=\"w\">\n                                   </span><span class=\"n\">Country</span><span class=\"p\">,</span><span class=\"w\">\n                                 </span><span class=\"n\">value.var</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">statistic</span><span class=\"p\">)</span><span class=\"w\">\n    \n</span><span class=\"n\">setnames</span><span class=\"p\">(</span><span class=\"n\">data_covid_trajectories</span><span class=\"p\">,</span><span class=\"w\">\n         </span><span class=\"n\">colnames</span><span class=\"p\">(</span><span class=\"n\">data_covid_trajectories</span><span class=\"p\">)[</span><span class=\"m\">1</span><span class=\"p\">],</span><span class=\"w\">\n         </span><span class=\"n\">paste0</span><span class=\"p\">(</span><span class=\"s2\">\"Days_since_first_\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">n_cases</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"_case\"</span><span class=\"p\">))</span><span class=\"w\">\n \n</span><span class=\"c1\"># see interactively what we got with DT package</span><span class=\"w\">\n</span><span class=\"n\">dt</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">DT</span><span class=\"o\">::</span><span class=\"n\">datatable</span><span class=\"p\">(</span><span class=\"n\">data_covid_trajectories</span><span class=\"p\">,</span><span class=\"w\">\n                    </span><span class=\"n\">class</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"compact\"</span><span class=\"p\">,</span><span class=\"w\">\n                    </span><span class=\"n\">extensions</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s1\">'Scroller'</span><span class=\"p\">,</span><span class=\"w\">\n                    </span><span class=\"n\">options</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nf\">list</span><span class=\"p\">(</span><span class=\"w\">\n                        </span><span class=\"n\">dom</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s1\">'t'</span><span class=\"p\">,</span><span class=\"w\">\n                </span><span class=\"n\">deferRender</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">TRUE</span><span class=\"p\">,</span><span class=\"w\">\n                    </span><span class=\"n\">scrollY</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">270</span><span class=\"p\">,</span><span class=\"w\">\n                   </span><span class=\"n\">scroller</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">TRUE</span><span class=\"p\">,</span><span class=\"w\">\n                    </span><span class=\"n\">scrollX</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">TRUE</span><span class=\"w\">\n                    </span><span class=\"p\">))</span><span class=\"w\">\n \n</span><span class=\"n\">htmlwidgets</span><span class=\"o\">::</span><span class=\"n\">saveWidget</span><span class=\"p\">(</span><span class=\"n\">dt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"dt_traj_1.html\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">selfcontained</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">T</span><span class=\"p\">)</span></code></pre></figure>\n\n<div class=\"wrapper\" align=\"left\"><iframe width=\"100%\" height=\"300\" frameborder=\"0\" src=\"/dt_traj_1.html\"></iframe></div>\n\n<p>You can see that we got nicely the same length time series for every country.</p>\n\n<p>Now, preparation of <strong>trajectories’ data for clustering</strong> is coming…\nWe have to remove missing rows/ columns if there are so + I will preprocess time series with <strong>Simple Moving Average</strong> (SMA) to little bit smooth our trajectories (removes noise) - the function <code class=\"language-plaintext highlighter-rouge\">repr_sma</code> is implemented in my <a href=\"https://github.com/PetoLau/TSrepr\"><strong>TSrepr package</strong></a>.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"c1\"># save stats of dt</span><span class=\"w\">\n</span><span class=\"n\">n_col</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">ncol</span><span class=\"p\">(</span><span class=\"n\">data_covid_trajectories</span><span class=\"p\">)</span><span class=\"w\">\n</span><span class=\"n\">n_row</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">nrow</span><span class=\"p\">(</span><span class=\"n\">data_covid_trajectories</span><span class=\"p\">)</span><span class=\"w\">\n    \n</span><span class=\"n\">n_row_na</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">rowSums</span><span class=\"p\">(</span><span class=\"n\">data_covid_trajectories</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">lapply</span><span class=\"p\">(</span><span class=\"n\">.SD</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">is.na</span><span class=\"p\">)])</span><span class=\"w\">\n</span><span class=\"n\">n_col_na</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">colSums</span><span class=\"p\">(</span><span class=\"n\">data_covid_trajectories</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">lapply</span><span class=\"p\">(</span><span class=\"n\">.SD</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">is.na</span><span class=\"p\">)])</span><span class=\"w\">\n    \n</span><span class=\"c1\"># remove all NA rows and cols - for sure</span><span class=\"w\">\n</span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nf\">length</span><span class=\"p\">(</span><span class=\"n\">which</span><span class=\"p\">(</span><span class=\"n\">n_row_na</span><span class=\"w\"> </span><span class=\"o\">%in%</span><span class=\"w\"> </span><span class=\"n\">n_col</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"m\">0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n \n  </span><span class=\"n\">data_covid_trajectories</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">copy</span><span class=\"p\">(</span><span class=\"n\">data_covid_trajectories</span><span class=\"p\">[</span><span class=\"o\">-</span><span class=\"n\">which</span><span class=\"p\">(</span><span class=\"n\">n_row_na</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">n_col</span><span class=\"p\">)])</span><span class=\"w\">\n      \n</span><span class=\"p\">}</span><span class=\"w\">\n    \n</span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nf\">length</span><span class=\"p\">(</span><span class=\"n\">which</span><span class=\"p\">(</span><span class=\"n\">n_col_na</span><span class=\"w\"> </span><span class=\"o\">%in%</span><span class=\"w\"> </span><span class=\"n\">n_row</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"m\">0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n      \n  </span><span class=\"n\">data_covid_trajectories</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">copy</span><span class=\"p\">(</span><span class=\"n\">data_covid_trajectories</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">which</span><span class=\"p\">(</span><span class=\"n\">n_col_na</span><span class=\"w\"> </span><span class=\"o\">%in%</span><span class=\"w\"> </span><span class=\"n\">n_row</span><span class=\"p\">),</span><span class=\"w\">\n                                                          </span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">FALSE</span><span class=\"p\">])</span><span class=\"w\">\n      \n</span><span class=\"p\">}</span><span class=\"w\">\n \n</span><span class=\"c1\"># use SMA for preprocessing time series</span><span class=\"w\">\n</span><span class=\"n\">q_sma</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"m\">3</span><span class=\"w\"> </span><span class=\"c1\"># order of moving average</span><span class=\"w\">\n \n</span><span class=\"n\">data_covid_trajectories</span><span class=\"p\">[,</span><span class=\"w\">\n                        </span><span class=\"p\">(</span><span class=\"n\">colnames</span><span class=\"p\">(</span><span class=\"n\">data_covid_trajectories</span><span class=\"p\">)[</span><span class=\"m\">-1</span><span class=\"p\">])</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\">\n                          </span><span class=\"n\">lapply</span><span class=\"p\">(</span><span class=\"n\">.SD</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">function</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">)</span><span class=\"w\">\n                            </span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"nf\">rep</span><span class=\"p\">(</span><span class=\"kc\">NA</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">q_sma</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"p\">),</span><span class=\"w\">\n                              </span><span class=\"nf\">ceiling</span><span class=\"p\">(</span><span class=\"n\">repr_sma</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">q_sma</span><span class=\"p\">))</span><span class=\"w\">\n                              </span><span class=\"p\">)),</span><span class=\"w\">\n                        </span><span class=\"n\">.SDcols</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">colnames</span><span class=\"p\">(</span><span class=\"n\">data_covid_trajectories</span><span class=\"p\">)[</span><span class=\"m\">-1</span><span class=\"p\">]]</span><span class=\"w\">\n \n</span><span class=\"c1\"># again see data interactively</span><span class=\"w\">\n</span><span class=\"n\">dt</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">DT</span><span class=\"o\">::</span><span class=\"n\">datatable</span><span class=\"p\">(</span><span class=\"n\">data_covid_trajectories</span><span class=\"p\">,</span><span class=\"w\">\n                    </span><span class=\"n\">class</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"compact\"</span><span class=\"p\">,</span><span class=\"w\">\n                    </span><span class=\"n\">extensions</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s1\">'Scroller'</span><span class=\"p\">,</span><span class=\"w\">\n                    </span><span class=\"n\">options</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nf\">list</span><span class=\"p\">(</span><span class=\"w\">\n                        </span><span class=\"n\">dom</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s1\">'t'</span><span class=\"p\">,</span><span class=\"w\">\n                        </span><span class=\"n\">deferRender</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">TRUE</span><span class=\"p\">,</span><span class=\"w\">\n                        </span><span class=\"n\">scrollY</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">270</span><span class=\"p\">,</span><span class=\"w\">\n                        </span><span class=\"n\">scroller</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">TRUE</span><span class=\"p\">,</span><span class=\"w\">\n                        </span><span class=\"n\">scrollX</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">TRUE</span><span class=\"w\">\n                    </span><span class=\"p\">))</span><span class=\"w\">\n \n</span><span class=\"n\">htmlwidgets</span><span class=\"o\">::</span><span class=\"n\">saveWidget</span><span class=\"p\">(</span><span class=\"n\">dt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"dt_traj_2.html\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">selfcontained</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">T</span><span class=\"p\">)</span></code></pre></figure>\n\n<div class=\"wrapper\" align=\"left\"><iframe width=\"100%\" height=\"320\" frameborder=\"0\" src=\"/dt_traj_2.html\"></iframe></div>\n\n<h2 id=\"clustering-trajectories-with-the-hierarchical-method-with-dtw-distance\">Clustering trajectories with the hierarchical method with DTW distance</h2>\n\n<p>Since we use data with different lengths, we have to use different distance measures than Euclidean (or Manhattan, etc.).\nHere comes very handy <a href=\"https://en.wikipedia.org/wiki/Dynamic_time_warping\"><strong>Dynamic Time Warping</strong></a> distance measure that can compute distances between time series with various lags and different lengths.</p>\n\n<p>As a clustering method, I picked <a href=\"https://en.wikipedia.org/wiki/Ward%27s_method\"><strong>hierarchical clustering with Ward criterion</strong></a> for its next nice post-analysis tools as <strong>dendrograms</strong>.</p>\n\n<p>Let’s define clustering function with DTW distance with additional data preprocessing steps necessary for <a href=\"https://cran.r-project.org/package=dtwclust\"><code class=\"language-plaintext highlighter-rouge\">dtwclust</code> package</a>. I allow user also vary number of clusters and normalization of time series before clustering.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">cluster_trajectories</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"k\">function</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">normalize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">FALSE</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n  \n  </span><span class=\"c1\"># transpose data for clustering</span><span class=\"w\">\n  </span><span class=\"n\">data_trajectories_trans</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"n\">.SD</span><span class=\"p\">,</span><span class=\"w\">\n                                    </span><span class=\"n\">.SDcols</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">colnames</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">)[</span><span class=\"m\">-1</span><span class=\"p\">]])</span><span class=\"w\">\n  \n  </span><span class=\"c1\"># create list of time series</span><span class=\"w\">\n  </span><span class=\"n\">data_trajectories_trans_list</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">lapply</span><span class=\"p\">(</span><span class=\"m\">1</span><span class=\"o\">:</span><span class=\"n\">nrow</span><span class=\"p\">(</span><span class=\"n\">data_trajectories_trans</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"k\">function</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">)</span><span class=\"w\">\n    </span><span class=\"n\">na.omit</span><span class=\"p\">(</span><span class=\"n\">data_trajectories_trans</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">,]))</span><span class=\"w\">\n  </span><span class=\"nf\">names</span><span class=\"p\">(</span><span class=\"n\">data_trajectories_trans_list</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">colnames</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">)[</span><span class=\"m\">-1</span><span class=\"p\">]</span><span class=\"w\">\n \n  </span><span class=\"c1\"># remove data with length &lt;= 1</span><span class=\"w\">\n  </span><span class=\"n\">n_list</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">sapply</span><span class=\"p\">(</span><span class=\"m\">1</span><span class=\"o\">:</span><span class=\"nf\">length</span><span class=\"p\">(</span><span class=\"n\">data_trajectories_trans_list</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"k\">function</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">)</span><span class=\"w\">\n    </span><span class=\"nf\">length</span><span class=\"p\">(</span><span class=\"n\">data_trajectories_trans_list</span><span class=\"p\">[[</span><span class=\"n\">i</span><span class=\"p\">]]))</span><span class=\"w\">\n  </span><span class=\"nf\">names</span><span class=\"p\">(</span><span class=\"n\">n_list</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"nf\">names</span><span class=\"p\">(</span><span class=\"n\">data_trajectories_trans_list</span><span class=\"p\">)</span><span class=\"w\">\n \n  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nf\">length</span><span class=\"p\">(</span><span class=\"n\">which</span><span class=\"p\">(</span><span class=\"n\">n_list</span><span class=\"w\"> </span><span class=\"o\">%in%</span><span class=\"w\"> </span><span class=\"m\">0</span><span class=\"o\">:</span><span class=\"m\">1</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"m\">0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n    \n   </span><span class=\"n\">data_trajectories_trans_list</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">data_trajectories_trans_list</span><span class=\"p\">[</span><span class=\"o\">-</span><span class=\"n\">which</span><span class=\"p\">(</span><span class=\"n\">n_list</span><span class=\"w\"> </span><span class=\"o\">%in%</span><span class=\"w\"> </span><span class=\"m\">0</span><span class=\"o\">:</span><span class=\"m\">1</span><span class=\"p\">)]</span><span class=\"w\">\n    \n  </span><span class=\"p\">}</span><span class=\"w\">\n  \n  </span><span class=\"n\">list_names</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"nf\">names</span><span class=\"p\">(</span><span class=\"n\">data_trajectories_trans_list</span><span class=\"p\">)</span><span class=\"w\">\n \n  </span><span class=\"c1\"># normalization</span><span class=\"w\">\n  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">normalize</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\">\n    \n    </span><span class=\"n\">data_trajectories_trans_list</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">lapply</span><span class=\"p\">(</span><span class=\"nf\">names</span><span class=\"p\">(</span><span class=\"n\">data_trajectories_trans_list</span><span class=\"p\">),</span><span class=\"w\">\n                                            </span><span class=\"k\">function</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">)</span><span class=\"w\">\n                                              </span><span class=\"n\">norm_z</span><span class=\"p\">(</span><span class=\"n\">data_trajectories_trans_list</span><span class=\"p\">[[</span><span class=\"n\">i</span><span class=\"p\">]])</span><span class=\"w\">\n                                                </span><span class=\"p\">)</span><span class=\"w\">\n    </span><span class=\"nf\">names</span><span class=\"p\">(</span><span class=\"n\">data_trajectories_trans_list</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">list_names</span><span class=\"w\">\n    \n  </span><span class=\"p\">}</span><span class=\"w\">\n \n  </span><span class=\"c1\"># clustering with dtwclust package function</span><span class=\"w\">\n  </span><span class=\"n\">hc_res</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">tsclust</span><span class=\"p\">(</span><span class=\"n\">data_trajectories_trans_list</span><span class=\"p\">,</span><span class=\"w\">\n                    </span><span class=\"n\">type</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"hierarchical\"</span><span class=\"p\">,</span><span class=\"w\">\n                    </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"p\">,</span><span class=\"w\">\n                    </span><span class=\"n\">distance</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"dtw_basic\"</span><span class=\"p\">,</span><span class=\"w\">\n                    </span><span class=\"n\">centroid</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">dba</span><span class=\"p\">,</span><span class=\"w\">\n                    </span><span class=\"n\">trace</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">FALSE</span><span class=\"p\">,</span><span class=\"w\">\n                    </span><span class=\"n\">seed</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">54321</span><span class=\"p\">,</span><span class=\"w\">\n                    </span><span class=\"n\">control</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">hierarchical_control</span><span class=\"p\">(</span><span class=\"n\">method</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"ward.D2\"</span><span class=\"p\">),</span><span class=\"w\">\n                    </span><span class=\"n\">args</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tsclust_args</span><span class=\"p\">(</span><span class=\"n\">dist</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nf\">list</span><span class=\"p\">(</span><span class=\"n\">norm</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"L2\"</span><span class=\"p\">))</span><span class=\"w\">\n                    </span><span class=\"p\">)</span><span class=\"w\">\n  \n  </span><span class=\"nf\">return</span><span class=\"p\">(</span><span class=\"n\">hc_res</span><span class=\"p\">)</span><span class=\"w\">\n  \n</span><span class=\"p\">}</span></code></pre></figure>\n\n<p>Let’s cluster data with <em>14</em> clusters and <strong>normalization of countries’ trajectories</strong> for extracting clusters with <strong>same trends (curves)</strong> - not magnitudes! It is very important thing before every clustering/ classification task.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">clust_res</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">cluster_trajectories</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">data_covid_trajectories</span><span class=\"p\">,</span><span class=\"w\">\n                                  </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">14</span><span class=\"p\">,</span><span class=\"w\">\n                                  </span><span class=\"n\">normalize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">TRUE</span><span class=\"p\">)</span><span class=\"w\">\n \n</span><span class=\"c1\"># results</span><span class=\"w\">\n</span><span class=\"n\">clust_res</span></code></pre></figure>\n\n<figure class=\"highlight\"><pre><code class=\"language-text\" data-lang=\"text\">## hierarchical clustering with 14 clusters\n## Using dtw_basic distance\n## Using dba centroids\n## Using method ward.D2 \n## \n## Time required for analysis:\n##    user  system elapsed \n##    0.71    0.05    0.14 \n## \n## Cluster sizes with average intra-cluster distance:\n## \n##    size   av_dist\n## 1    21 0.5011793\n## 2     6 0.5170467\n## 3     2 0.9447618\n## 4    10 0.4015355\n## 5    11 0.5774944\n## 6     5 0.6441501\n## 7     7 0.4719638\n## 8     2 0.5682452\n## 9     5 0.7722092\n## 10    2 0.8360796\n## 11    4 0.4361994\n## 12    5 0.5527005\n## 13    2 0.5363868\n## 14    1 0.0000000</code></pre></figure>\n\n<p>Let’s prepare clustered data for visualization:</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"c1\"># prepare time series</span><span class=\"w\">\n</span><span class=\"n\">data_clust_id</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">data.table</span><span class=\"p\">(</span><span class=\"n\">Cluster</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">clust_res</span><span class=\"o\">@</span><span class=\"n\">cluster</span><span class=\"p\">,</span><span class=\"w\">\n                            </span><span class=\"n\">Country</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nf\">names</span><span class=\"p\">(</span><span class=\"n\">clust_res</span><span class=\"o\">@</span><span class=\"n\">cluster</span><span class=\"p\">))</span><span class=\"w\">\n \n</span><span class=\"n\">data_plot</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">melt</span><span class=\"p\">(</span><span class=\"n\">data_covid_trajectories</span><span class=\"p\">,</span><span class=\"w\">\n                  </span><span class=\"n\">id.vars</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">colnames</span><span class=\"p\">(</span><span class=\"n\">data_covid_trajectories</span><span class=\"p\">)[</span><span class=\"m\">1</span><span class=\"p\">],</span><span class=\"w\">\n                  </span><span class=\"n\">variable.name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Country\"</span><span class=\"p\">,</span><span class=\"w\">\n                  </span><span class=\"n\">variable.factor</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">FALSE</span><span class=\"p\">,</span><span class=\"w\">\n                  </span><span class=\"n\">value.name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">statistic</span><span class=\"p\">,</span><span class=\"w\">\n                  </span><span class=\"n\">value.factor</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">FALSE</span><span class=\"p\">)</span><span class=\"w\">\n \n</span><span class=\"n\">data_plot</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">copy</span><span class=\"p\">(</span><span class=\"n\">data_plot</span><span class=\"p\">[</span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">data_clust_id</span><span class=\"o\">$</span><span class=\"n\">Country</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Country</span><span class=\"p\">)])</span><span class=\"w\">\n \n</span><span class=\"n\">data_plot</span><span class=\"p\">[</span><span class=\"n\">data_clust_id</span><span class=\"p\">,</span><span class=\"w\">\n          </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Country</span><span class=\"p\">),</span><span class=\"w\">\n          </span><span class=\"n\">Cluster</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"n\">i.Cluster</span><span class=\"p\">]</span><span class=\"w\">\n \n</span><span class=\"c1\"># again see what we got interactively</span><span class=\"w\">\n</span><span class=\"n\">dt</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">DT</span><span class=\"o\">::</span><span class=\"n\">datatable</span><span class=\"p\">(</span><span class=\"n\">data_plot</span><span class=\"p\">,</span><span class=\"w\">\n              </span><span class=\"n\">class</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"compact\"</span><span class=\"p\">,</span><span class=\"w\">\n              </span><span class=\"n\">extensions</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s1\">'Scroller'</span><span class=\"p\">,</span><span class=\"w\">\n              </span><span class=\"n\">filter</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"top\"</span><span class=\"p\">,</span><span class=\"w\">\n              </span><span class=\"n\">options</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nf\">list</span><span class=\"p\">(</span><span class=\"w\">\n                </span><span class=\"n\">dom</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s1\">'t'</span><span class=\"p\">,</span><span class=\"w\">\n                </span><span class=\"n\">deferRender</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">TRUE</span><span class=\"p\">,</span><span class=\"w\">\n                </span><span class=\"n\">scrollY</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">270</span><span class=\"p\">,</span><span class=\"w\">\n                </span><span class=\"n\">scroller</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">TRUE</span><span class=\"p\">,</span><span class=\"w\">\n                </span><span class=\"n\">scrollX</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">TRUE</span><span class=\"w\">\n              </span><span class=\"p\">))</span><span class=\"w\">\n \n</span><span class=\"n\">htmlwidgets</span><span class=\"o\">::</span><span class=\"n\">saveWidget</span><span class=\"p\">(</span><span class=\"n\">dt</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"dt_data_plot.html\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">selfcontained</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">T</span><span class=\"p\">)</span></code></pre></figure>\n\n<p>You can also search for your preferred country in the <code class=\"language-plaintext highlighter-rouge\">datatable</code>.</p>\n\n<div class=\"wrapper\" align=\"left\"><iframe width=\"100%\" height=\"380\" frameborder=\"0\" src=\"/dt_data_plot.html\"></iframe></div>\n\n<p>Here comes finally <strong>plot of cluster members</strong> with <code class=\"language-plaintext highlighter-rouge\">ggplot2</code> package (log scale is used for better comparison of trends):</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">theme_my</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">theme</span><span class=\"p\">(</span><span class=\"n\">panel.border</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">element_rect</span><span class=\"p\">(</span><span class=\"n\">fill</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">NA</span><span class=\"p\">,</span><span class=\"w\">\n                                                  </span><span class=\"n\">colour</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"grey10\"</span><span class=\"p\">),</span><span class=\"w\">\n                      </span><span class=\"n\">panel.background</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">element_blank</span><span class=\"p\">(),</span><span class=\"w\">\n                      </span><span class=\"n\">panel.grid.minor</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">element_line</span><span class=\"p\">(</span><span class=\"n\">colour</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"grey85\"</span><span class=\"p\">),</span><span class=\"w\">\n                      </span><span class=\"n\">panel.grid.major</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">element_line</span><span class=\"p\">(</span><span class=\"n\">colour</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"grey85\"</span><span class=\"p\">),</span><span class=\"w\">\n                      </span><span class=\"n\">panel.grid.major.x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">element_line</span><span class=\"p\">(</span><span class=\"n\">colour</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"grey85\"</span><span class=\"p\">),</span><span class=\"w\">\n                      </span><span class=\"n\">axis.text</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">element_text</span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">12</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">face</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"bold\"</span><span class=\"p\">),</span><span class=\"w\">\n                      </span><span class=\"n\">axis.title</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">element_text</span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">13</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">face</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"bold\"</span><span class=\"p\">),</span><span class=\"w\">\n                      </span><span class=\"n\">plot.title</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">element_text</span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">16</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">face</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"bold\"</span><span class=\"p\">),</span><span class=\"w\">\n                      </span><span class=\"n\">strip.text</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">element_text</span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">12</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">face</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"bold\"</span><span class=\"p\">),</span><span class=\"w\">\n                      </span><span class=\"n\">strip.background</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">element_rect</span><span class=\"p\">(</span><span class=\"n\">colour</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"black\"</span><span class=\"p\">))</span><span class=\"w\">\n \n</span><span class=\"n\">ggplot</span><span class=\"p\">(</span><span class=\"n\">data_plot</span><span class=\"p\">,</span><span class=\"w\">\n       </span><span class=\"n\">aes</span><span class=\"p\">(</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">colnames</span><span class=\"p\">(</span><span class=\"n\">data_plot</span><span class=\"p\">)[</span><span class=\"m\">1</span><span class=\"p\">]),</span><span class=\"w\">\n           </span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">statistic</span><span class=\"p\">),</span><span class=\"w\">\n           </span><span class=\"n\">group</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Country</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n      </span><span class=\"n\">facet_wrap</span><span class=\"p\">(</span><span class=\"o\">~</span><span class=\"n\">Cluster</span><span class=\"p\">,</span><span class=\"w\">\n                 </span><span class=\"n\">ncol</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nf\">ceiling</span><span class=\"p\">(</span><span class=\"n\">data_plot</span><span class=\"p\">[,</span><span class=\"w\"> </span><span class=\"nf\">sqrt</span><span class=\"p\">(</span><span class=\"n\">uniqueN</span><span class=\"p\">(</span><span class=\"n\">Cluster</span><span class=\"p\">))]),</span><span class=\"w\">\n                 </span><span class=\"n\">scales</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"free_y\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n      </span><span class=\"n\">geom_line</span><span class=\"p\">(</span><span class=\"n\">color</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"grey10\"</span><span class=\"p\">,</span><span class=\"w\">\n                </span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0.75</span><span class=\"p\">,</span><span class=\"w\">\n                </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0.8</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n      </span><span class=\"n\">scale_y_continuous</span><span class=\"p\">(</span><span class=\"n\">trans</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s1\">'log10'</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n      </span><span class=\"n\">labs</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">colnames</span><span class=\"p\">(</span><span class=\"n\">data_plot</span><span class=\"p\">)[</span><span class=\"m\">1</span><span class=\"p\">],</span><span class=\"w\">\n           </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">statistic</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n      </span><span class=\"n\">theme_my</span></code></pre></figure>\n\n<p><img src=\"/images/post_13/unnamed-chunk-8-1.png\" alt=\"plot of chunk unnamed-chunk-8\" /></p>\n\n<p>We can see nicely distinguishable clusters with various active cases trends (settled, rapid/ steady increase/ decrease).</p>\n\n<p>Let’s check some clusters interactively with <a href=\"https://rstudio.github.io/dygraphs/index.html\"><code class=\"language-plaintext highlighter-rouge\">dygraphs</code> package</a>:</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">data_clust_focus</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">dcast</span><span class=\"p\">(</span><span class=\"n\">data_plot</span><span class=\"p\">[</span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"nf\">c</span><span class=\"p\">(</span><span class=\"m\">2</span><span class=\"p\">,</span><span class=\"m\">6</span><span class=\"p\">)),</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Cluster</span><span class=\"p\">)],</span><span class=\"w\">\n                          </span><span class=\"n\">Days_since_first_100_case</span><span class=\"w\"> </span><span class=\"o\">~</span><span class=\"w\"> </span><span class=\"n\">Country</span><span class=\"p\">,</span><span class=\"w\">\n                          </span><span class=\"n\">value.var</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">statistic</span><span class=\"p\">)</span><span class=\"w\">\n \n</span><span class=\"n\">dyg</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">dygraph</span><span class=\"p\">(</span><span class=\"n\">data_clust_focus</span><span class=\"p\">,</span><span class=\"w\">\n        </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Clusters n. 2 and 6\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">%&gt;%</span><span class=\"w\">\n      </span><span class=\"n\">dyAxis</span><span class=\"p\">(</span><span class=\"s2\">\"x\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">label</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">colnames</span><span class=\"p\">(</span><span class=\"n\">data_clust_focus</span><span class=\"p\">)[</span><span class=\"m\">1</span><span class=\"p\">])</span><span class=\"w\"> </span><span class=\"o\">%&gt;%</span><span class=\"w\">\n      </span><span class=\"n\">dyAxis</span><span class=\"p\">(</span><span class=\"s2\">\"y\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">label</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">statistic</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">%&gt;%</span><span class=\"w\">\n      </span><span class=\"n\">dyOptions</span><span class=\"p\">(</span><span class=\"n\">strokeWidth</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"p\">,</span><span class=\"w\">\n                </span><span class=\"n\">drawPoints</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">F</span><span class=\"p\">,</span><span class=\"w\">\n                </span><span class=\"n\">pointSize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">3</span><span class=\"p\">,</span><span class=\"w\">\n                </span><span class=\"n\">pointShape</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"circle\"</span><span class=\"p\">,</span><span class=\"w\">\n                </span><span class=\"n\">logscale</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">TRUE</span><span class=\"p\">,</span><span class=\"w\">\n                </span><span class=\"n\">colors</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">RColorBrewer</span><span class=\"o\">::</span><span class=\"n\">brewer.pal</span><span class=\"p\">(</span><span class=\"n\">ncol</span><span class=\"p\">(</span><span class=\"n\">data_clust_focus</span><span class=\"p\">)</span><span class=\"m\">-1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"Set2\"</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">%&gt;%</span><span class=\"w\">\n      </span><span class=\"n\">dyHighlight</span><span class=\"p\">(</span><span class=\"n\">highlightSeriesOpts</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nf\">list</span><span class=\"p\">(</span><span class=\"n\">strokeWidth</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">2.5</span><span class=\"p\">,</span><span class=\"w\">\n                                             </span><span class=\"n\">pointSize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">4</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">%&gt;%</span><span class=\"w\">\n      </span><span class=\"n\">dyLegend</span><span class=\"p\">(</span><span class=\"n\">width</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">150</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">show</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"follow\"</span><span class=\"p\">,</span><span class=\"w\">\n               </span><span class=\"n\">hideOnMouseOut</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">TRUE</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">labelsSeparateLines</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">TRUE</span><span class=\"p\">)</span><span class=\"w\">\n \n</span><span class=\"n\">saveWidget</span><span class=\"p\">(</span><span class=\"n\">dyg</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"dyg_focus_clust_2_6.html\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">selfcontained</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">T</span><span class=\"p\">)</span></code></pre></figure>\n\n<div class=\"wrapper\" align=\"left\"><iframe width=\"100%\" height=\"450\" frameborder=\"0\" src=\"/dyg_focus_clust_2_6.html\"></iframe></div>\n\n<p>Here, I picked two clusters (2 and 6) with nice decreasing trends - there are countries mostly from Central/ West Europe.</p>\n\n<p>Let’s see also clusters with increasing trends of active cases per 1 mil. population:</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">data_clust_focus</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">dcast</span><span class=\"p\">(</span><span class=\"n\">data_plot</span><span class=\"p\">[</span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"m\">7</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Cluster</span><span class=\"p\">)],</span><span class=\"w\">\n                          </span><span class=\"n\">Days_since_first_100_case</span><span class=\"w\"> </span><span class=\"o\">~</span><span class=\"w\"> </span><span class=\"n\">Country</span><span class=\"p\">,</span><span class=\"w\">\n                          </span><span class=\"n\">value.var</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">statistic</span><span class=\"p\">)</span><span class=\"w\">\n \n</span><span class=\"n\">dyg</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">dygraph</span><span class=\"p\">(</span><span class=\"n\">data_clust_focus</span><span class=\"p\">,</span><span class=\"w\">\n               </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Cluster n. 7\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">%&gt;%</span><span class=\"w\">\n      </span><span class=\"n\">dyAxis</span><span class=\"p\">(</span><span class=\"s2\">\"x\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">label</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">colnames</span><span class=\"p\">(</span><span class=\"n\">data_clust_focus</span><span class=\"p\">)[</span><span class=\"m\">1</span><span class=\"p\">])</span><span class=\"w\"> </span><span class=\"o\">%&gt;%</span><span class=\"w\">\n      </span><span class=\"n\">dyAxis</span><span class=\"p\">(</span><span class=\"s2\">\"y\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">label</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">statistic</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">%&gt;%</span><span class=\"w\">\n      </span><span class=\"n\">dyOptions</span><span class=\"p\">(</span><span class=\"n\">strokeWidth</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"p\">,</span><span class=\"w\">\n                </span><span class=\"n\">drawPoints</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">F</span><span class=\"p\">,</span><span class=\"w\">\n                </span><span class=\"n\">pointSize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">3</span><span class=\"p\">,</span><span class=\"w\">\n                </span><span class=\"n\">pointShape</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"circle\"</span><span class=\"p\">,</span><span class=\"w\">\n                </span><span class=\"n\">logscale</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">TRUE</span><span class=\"p\">,</span><span class=\"w\">\n                </span><span class=\"n\">colors</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">RColorBrewer</span><span class=\"o\">::</span><span class=\"n\">brewer.pal</span><span class=\"p\">(</span><span class=\"n\">ncol</span><span class=\"p\">(</span><span class=\"n\">data_clust_focus</span><span class=\"p\">)</span><span class=\"m\">-1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"Set2\"</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">%&gt;%</span><span class=\"w\">\n      </span><span class=\"n\">dyHighlight</span><span class=\"p\">(</span><span class=\"n\">highlightSeriesOpts</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nf\">list</span><span class=\"p\">(</span><span class=\"n\">strokeWidth</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">2.5</span><span class=\"p\">,</span><span class=\"w\">\n                                             </span><span class=\"n\">pointSize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">4</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">%&gt;%</span><span class=\"w\">\n      </span><span class=\"n\">dyLegend</span><span class=\"p\">(</span><span class=\"n\">width</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">150</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">show</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"follow\"</span><span class=\"p\">,</span><span class=\"w\">\n               </span><span class=\"n\">hideOnMouseOut</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">TRUE</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">labelsSeparateLines</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">TRUE</span><span class=\"p\">)</span><span class=\"w\">\n \n</span><span class=\"n\">saveWidget</span><span class=\"p\">(</span><span class=\"n\">dyg</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"dyg_focus_clust_7.html\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">selfcontained</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">T</span><span class=\"p\">)</span></code></pre></figure>\n\n<div class=\"wrapper\" align=\"left\"><iframe width=\"100%\" height=\"450\" frameborder=\"0\" src=\"/dyg_focus_clust_7.html\"></iframe></div>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">data_clust_focus</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">dcast</span><span class=\"p\">(</span><span class=\"n\">data_plot</span><span class=\"p\">[</span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"m\">1</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">.</span><span class=\"p\">(</span><span class=\"n\">Cluster</span><span class=\"p\">)],</span><span class=\"w\">\n                          </span><span class=\"n\">Days_since_first_100_case</span><span class=\"w\"> </span><span class=\"o\">~</span><span class=\"w\"> </span><span class=\"n\">Country</span><span class=\"p\">,</span><span class=\"w\">\n                          </span><span class=\"n\">value.var</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">statistic</span><span class=\"p\">)</span><span class=\"w\">\n \n</span><span class=\"n\">dyg</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">dygraph</span><span class=\"p\">(</span><span class=\"n\">data_clust_focus</span><span class=\"p\">,</span><span class=\"w\">\n               </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"Cluster n. 1\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">%&gt;%</span><span class=\"w\">\n      </span><span class=\"n\">dyAxis</span><span class=\"p\">(</span><span class=\"s2\">\"x\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">label</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">colnames</span><span class=\"p\">(</span><span class=\"n\">data_clust_focus</span><span class=\"p\">)[</span><span class=\"m\">1</span><span class=\"p\">])</span><span class=\"w\"> </span><span class=\"o\">%&gt;%</span><span class=\"w\">\n      </span><span class=\"n\">dyAxis</span><span class=\"p\">(</span><span class=\"s2\">\"y\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">label</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">statistic</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">%&gt;%</span><span class=\"w\">\n      </span><span class=\"n\">dyOptions</span><span class=\"p\">(</span><span class=\"n\">strokeWidth</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"p\">,</span><span class=\"w\">\n                </span><span class=\"n\">drawPoints</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">F</span><span class=\"p\">,</span><span class=\"w\">\n                </span><span class=\"n\">pointSize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">3</span><span class=\"p\">,</span><span class=\"w\">\n                </span><span class=\"n\">pointShape</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"circle\"</span><span class=\"p\">,</span><span class=\"w\">\n                </span><span class=\"n\">logscale</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">TRUE</span><span class=\"p\">,</span><span class=\"w\">\n                </span><span class=\"n\">colors</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">RColorBrewer</span><span class=\"o\">::</span><span class=\"n\">brewer.pal</span><span class=\"p\">(</span><span class=\"n\">ncol</span><span class=\"p\">(</span><span class=\"n\">data_clust_focus</span><span class=\"p\">)</span><span class=\"m\">-1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"Set2\"</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">%&gt;%</span><span class=\"w\">\n      </span><span class=\"n\">dyHighlight</span><span class=\"p\">(</span><span class=\"n\">highlightSeriesOpts</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nf\">list</span><span class=\"p\">(</span><span class=\"n\">strokeWidth</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">2.5</span><span class=\"p\">,</span><span class=\"w\">\n                                             </span><span class=\"n\">pointSize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">4</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">%&gt;%</span><span class=\"w\">\n      </span><span class=\"n\">dyLegend</span><span class=\"p\">(</span><span class=\"n\">width</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">150</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">show</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"follow\"</span><span class=\"p\">,</span><span class=\"w\">\n               </span><span class=\"n\">hideOnMouseOut</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">TRUE</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">labelsSeparateLines</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">TRUE</span><span class=\"p\">)</span><span class=\"w\">\n \n</span><span class=\"n\">saveWidget</span><span class=\"p\">(</span><span class=\"n\">dyg</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s2\">\"dyg_focus_clust_1.html\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">selfcontained</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">T</span><span class=\"p\">)</span></code></pre></figure>\n\n<div class=\"wrapper\" align=\"left\"><iframe width=\"100%\" height=\"490\" frameborder=\"0\" src=\"/dyg_focus_clust_1.html\"></iframe></div>\n\n<p>We can see that on this day, the increasing trend of active cases has countries mostly in Western Asia, South America, and Africa.</p>\n\n<h2 id=\"post-analysis-visualizations-with-dendrograms-and-mds\">Post-analysis visualizations with dendrograms and MDS</h2>\n\n<p>In order to see whole connectivity between countries’ clusters as a tree, we can use for example <strong>dendrogram</strong>.\nHere, we can simply use object of clustering result to generate the tree:</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">dend</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">as.dendrogram</span><span class=\"p\">(</span><span class=\"n\">clust_res</span><span class=\"p\">)</span><span class=\"w\">\n \n</span><span class=\"n\">dend</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">dend</span><span class=\"w\"> </span><span class=\"o\">%&gt;%</span><span class=\"w\">\n  </span><span class=\"n\">color_branches</span><span class=\"p\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">14</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">%&gt;%</span><span class=\"w\">\n  </span><span class=\"n\">color_labels</span><span class=\"p\">(</span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">14</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">%&gt;%</span><span class=\"w\">\n  </span><span class=\"n\">set</span><span class=\"p\">(</span><span class=\"s2\">\"branches_lwd\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">%&gt;%</span><span class=\"w\">\n  </span><span class=\"n\">set</span><span class=\"p\">(</span><span class=\"s2\">\"labels_cex\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"m\">0.8</span><span class=\"p\">)</span><span class=\"w\">\n \n</span><span class=\"n\">ggd1</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">as.ggdend</span><span class=\"p\">(</span><span class=\"n\">dend</span><span class=\"p\">)</span><span class=\"w\">\n \n</span><span class=\"n\">ggplot</span><span class=\"p\">(</span><span class=\"n\">ggd1</span><span class=\"p\">,</span><span class=\"w\">\n       </span><span class=\"n\">horiz</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">T</span><span class=\"p\">)</span></code></pre></figure>\n\n<p><img src=\"/images/post_13/unnamed-chunk-12-1.png\" alt=\"plot of chunk unnamed-chunk-12\" /></p>\n\n<p>In order to see for example connections between countries in 2D scatter plot, we can use <a href=\"https://en.wikipedia.org/wiki/Multidimensional_scaling\"><strong>dimensionality reduction method Multidimensional scaling (MDS)</strong></a>. It uses (stored) distance matrix between objects - and we have it in our clustering result object (Yey <code class=\"language-plaintext highlighter-rouge\">clust_res@distmat</code>!). For countries labels, I use great package <a href=\"https://cran.r-project.org/package=ggrepel\"><code class=\"language-plaintext highlighter-rouge\">ggrepel</code></a>.</p>\n\n<figure class=\"highlight\"><pre><code class=\"language-r\" data-lang=\"r\"><span class=\"n\">mds_classical</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">cmdscale</span><span class=\"p\">(</span><span class=\"n\">clust_res</span><span class=\"o\">@</span><span class=\"n\">distmat</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">eig</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">FALSE</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">k</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"p\">)</span><span class=\"w\">\n \n</span><span class=\"n\">data_plot</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"n\">data.table</span><span class=\"p\">(</span><span class=\"n\">mds_classical</span><span class=\"p\">,</span><span class=\"w\">\n                        </span><span class=\"n\">Country</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">row.names</span><span class=\"p\">(</span><span class=\"n\">mds_classical</span><span class=\"p\">),</span><span class=\"w\">\n                        </span><span class=\"n\">Cluster</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">clust_res</span><span class=\"o\">@</span><span class=\"n\">cluster</span><span class=\"p\">)</span><span class=\"w\">\n \n</span><span class=\"n\">ggplot</span><span class=\"p\">(</span><span class=\"n\">data_plot</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">aes</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">\"V1\"</span><span class=\"p\">),</span><span class=\"w\">\n                      </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">\"V2\"</span><span class=\"p\">),</span><span class=\"w\">\n                      </span><span class=\"n\">label</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Country</span><span class=\"p\">,</span><span class=\"w\">\n                      </span><span class=\"n\">color</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">as.factor</span><span class=\"p\">(</span><span class=\"n\">Cluster</span><span class=\"p\">)))</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n      </span><span class=\"n\">geom_label_repel</span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">4.2</span><span class=\"p\">,</span><span class=\"w\">\n                       </span><span class=\"n\">alpha</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0.95</span><span class=\"p\">,</span><span class=\"w\">\n                       </span><span class=\"n\">segment.alpha</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0.35</span><span class=\"p\">,</span><span class=\"w\">\n                       </span><span class=\"n\">label.r</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0.1</span><span class=\"p\">,</span><span class=\"w\">\n                       </span><span class=\"n\">box.padding</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0.25</span><span class=\"p\">,</span><span class=\"w\">\n                       </span><span class=\"n\">label.padding</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0.3</span><span class=\"p\">,</span><span class=\"w\">\n                       </span><span class=\"n\">label.size</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">0.35</span><span class=\"p\">,</span><span class=\"w\">\n                       </span><span class=\"n\">max.iter</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">2500</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n      </span><span class=\"n\">scale_color_manual</span><span class=\"p\">(</span><span class=\"n\">values</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">colorspace</span><span class=\"o\">::</span><span class=\"n\">rainbow_hcl</span><span class=\"p\">(</span><span class=\"m\">14</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">90</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"m\">50</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n      </span><span class=\"n\">labs</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">NULL</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">NULL</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">color</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">NULL</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n      </span><span class=\"n\">guides</span><span class=\"p\">(</span><span class=\"n\">color</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">FALSE</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\">\n      </span><span class=\"n\">theme_my</span></code></pre></figure>\n\n<p><img src=\"/images/post_13/unnamed-chunk-13-1.png\" alt=\"plot of chunk unnamed-chunk-13\" /></p>\n\n<p>In both graphs (dendrogram and MDS scatter plot), we can see clearly how far (or close) are countries from each other based on <strong>DTW distance</strong>.</p>\n\n<h2 id=\"summary\">Summary</h2>\n\n<p>In this blog post, I showed you how to <strong>cluster time series with different lengths</strong> with DTW distance and hierarchical method, and how to visualize the results of such an analysis.\nAs a use case, I picked data of <strong>countries’ COVID-19 active cases trajectories computed per 1 mil. population</strong> to see trends of the disease spread.</p>\n\n<h3 id=\"sources\">Sources</h3>\n\n<p>Application is running on <a href=\"https://petolau.shinyapps.io/coronadash/\"><strong>petolau.shinyapps.io</strong></a> platform, the source code of the whole app is on <a href=\"https://github.com/PetoLau/CoronaDash\"><strong>CoronaDash GitHub</strong> repository</a>.</p>\n\n<p><em>Take care of yourself!</em></p>",
  "pubDate": "Wed, 27 May 2020 00:00:00 +0000",
  "link": "https://petolau.github.io/CoronaDash-hierarchical-clustering-countries-trajectories/",
  "guid": {
    "@isPermaLink": true,
    "#text": "https://petolau.github.io/CoronaDash-hierarchical-clustering-countries-trajectories/"
  }
}