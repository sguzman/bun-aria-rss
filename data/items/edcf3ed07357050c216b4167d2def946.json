{
  "title": "Setup Amazon AWS GPU instance with MXnet",
  "link": "https://no2147483647.wordpress.com/2016/01/16/setup-amazon-aws-gpu-instance-with-mxnet/",
  "comments": "https://no2147483647.wordpress.com/2016/01/16/setup-amazon-aws-gpu-instance-with-mxnet/#comments",
  "dc:creator": "phunterlau",
  "pubDate": "Sat, 16 Jan 2016 09:32:50 +0000",
  "category": "Machine Learning",
  "guid": "http://no2147483647.wordpress.com/?p=216",
  "description": "(every blog should have a cat, right? This cat is &#8220;Niba&#8221;, and she is Pogo&#8217;s younger sister. The neural art style is &#8220;Girl with a Pearl Earring&#8220;. More about Neural Art with MXnet, please refer to my last blog.) With popular requests, I wrote this blog for starting an Amazon AWS GPU instance and install MXnet for [&#8230;]",
  "content:encoded": "<p><img data-attachment-id=\"253\" data-permalink=\"https://no2147483647.wordpress.com/2016/01/16/setup-amazon-aws-gpu-instance-with-mxnet/niba-meisje-met-de-parel/#main\" data-orig-file=\"https://no2147483647.files.wordpress.com/2016/01/niba-meisje-met-de-parel.png\" data-orig-size=\"384,512\" data-comments-opened=\"1\" data-image-meta=\"{\"aperture\":\"0\",\"credit\":\"\",\"camera\":\"\",\"caption\":\"\",\"created_timestamp\":\"0\",\"copyright\":\"\",\"focal_length\":\"0\",\"iso\":\"0\",\"shutter_speed\":\"0\",\"title\":\"\",\"orientation\":\"0\"}\" data-image-title=\"Niba Meisje met de parel\" data-image-description=\"\" data-image-caption=\"\" data-medium-file=\"https://no2147483647.files.wordpress.com/2016/01/niba-meisje-met-de-parel.png?w=225\" data-large-file=\"https://no2147483647.files.wordpress.com/2016/01/niba-meisje-met-de-parel.png?w=384\" class=\"alignnone size-full wp-image-253\" src=\"https://no2147483647.files.wordpress.com/2016/01/niba-meisje-met-de-parel.png?w=1008\" alt=\"Niba Meisje met de parel\" srcset=\"https://no2147483647.files.wordpress.com/2016/01/niba-meisje-met-de-parel.png 384w, https://no2147483647.files.wordpress.com/2016/01/niba-meisje-met-de-parel.png?w=113 113w, https://no2147483647.files.wordpress.com/2016/01/niba-meisje-met-de-parel.png?w=225 225w\" sizes=\"(max-width: 384px) 100vw, 384px\"   /></p>\n<p>(every blog should have a cat, right? This cat is &#8220;Niba&#8221;, and she is Pogo&#8217;s younger sister. The neural art style is &#8220;<a href=\"https://www.wikiwand.com/en/Girl_with_a_Pearl_Earring\">Girl with a Pearl Earring</a>&#8220;. More about Neural Art with MXnet, please refer to <a href=\"https://no2147483647.wordpress.com/2015/12/21/deep-learning-for-hackers-with-mxnet-2/\">my last blog</a>.)</p>\n<p>With popular requests, I wrote this blog for starting an Amazon AWS GPU instance and install <a href=\"https://github.com/dmlc/mxnet\">MXnet</a> for kaggle competitions, like <a href=\"https://www.kaggle.com/c/second-annual-data-science-bowl/\">Second Annual Data Science Bowl</a>. Installing CUDA on AWS is kind of tricky: one needs to update kernels and solve some conflicts. I want to have special thanks to Caffe EC2 installation guide <a href=\"https://github.com/BVLC/caffe/wiki/Install-Caffe-on-EC2-from-scratch-(Ubuntu,-CUDA-7,-cuDNN)\">https://github.com/BVLC/caffe/wiki/Install-Caffe-on-EC2-from-scratch-(Ubuntu,-CUDA-7,-cuDNN)</a></p>\n<p>Have you clicked &#8220;star&#8221; on MXnet&#8217;s github repo? If not yet, do it now: <a href=\"https://github.com/dmlc/mxnet\">https://github.com/dmlc/mxnet</a></p>\n<h1>Create AWS GPU instance</h1>\n<p>For creating an AWS instance, please follow <a href=\"http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EC2_GetStarted.html\">http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EC2_GetStarted.html</a>. AWS spot instance can be an inexpensive solution for competing on Kaggle, and one can request a <code>g2.2xlarge</code> (single GPU) or a <code>g2.8xlarge</code> (4x GPUs) instance from the AWS console. The price when I wrote this blog is about 0.08$/h for g2.2xlarge and 0.34$/h for g2.8xlarge. Once approved, one can start an <strong>official Ubuntu 14.04</strong> instance and start installing MXnet. One can save this AMI image for future reference.</p>\n<h1>Install dependencies</h1>\n<h2>Preparation</h2>\n<pre><code>sudo apt-get update && sudo apt-get upgrade\nsudo apt-get install -y build-essential git libcurl4-openssl-dev libatlas-base-dev libopencv-dev python-numpy unzip\n</code></pre>\n<p>Reference: <a href=\"http://mxnt.ml/en/latest/build.html\">http://mxnt.ml/en/latest/build.html</a></p>\n<h2>Update Linux kernel on AWS</h2>\n<pre><code>sudo apt-get install linux-image-extra-virtual\n</code></pre>\n<p><strong>&#8220;Important</strong>: While installing the linux-image-extra-virtual, you may be prompted &#8220;What would you like to do about menu.lst?&#8221; I selected &#8220;keep the local version currently installed&#8221; &#8221; as on Caffe reference.</p>\n<h2>Disable nouveau</h2>\n<p><code>nouveau</code> conflicts with NVIDIA&#8217;s kernel module on AWS. One needs to edit <code>/etc/modprobe.d/blacklist-nouveau.conf</code> and disable <code>nouveau</code>.</p>\n<pre><code>sudo vi /etc/modprobe.d/blacklist-nouveau.conf\n\n    blacklist nouveau\n    blacklist lbm-nouveau\n    options nouveau modeset=0\n    alias nouveau off\n    alias lbm-nouveau off\n\necho options nouveau modeset=0 | sudo tee -a /etc/modprobe.d/nouveau-kms.conf\nsudo update-initramfs -u\nsudo reboot\n</code></pre>\n<p>Wait before finish rebooting, usually 1 min, and login back to the instance to continue installation:</p>\n<pre><code>sudo apt-get install -y linux-source linux-headers-`uname -r`\n</code></pre>\n<p>Reference: <a href=\"https://github.com/BVLC/caffe/wiki/Install-Caffe-on-EC2-from-scratch-(Ubuntu,-CUDA-7,-cuDNN)\">https://github.com/BVLC/caffe/wiki/Install-Caffe-on-EC2-from-scratch-(Ubuntu,-CUDA-7,-cuDNN)</a></p>\n<h1>Install CUDA</h1>\n<pre><code>wget http://developer.download.nvidia.com/compute/cuda/repos/ubuntu1404/x86_64/cuda-repo-ubuntu1404_7.5-18_amd64.deb\nsudo dpkg -i cuda-repo-ubuntu1404_7.5-18_amd64.deb\nsudo apt-get update\nsudo apt-get install -y cuda\n</code></pre>\n<p><strong>Important</strong>: Please reboot the instance for loading the driver</p>\n<p><code>sudo reboot<br />\n</code></p>\n<p>If everything is fine, nvidia-smi should look like this (4 GPU instance) for example:</p>\n<p><img data-attachment-id=\"249\" data-permalink=\"https://no2147483647.wordpress.com/2016/01/16/setup-amazon-aws-gpu-instance-with-mxnet/screen-shot-2016-01-15-at-11-58-02-pm/#main\" data-orig-file=\"https://no2147483647.files.wordpress.com/2016/01/screen-shot-2016-01-15-at-11-58-02-pm.png\" data-orig-size=\"1276,936\" data-comments-opened=\"1\" data-image-meta=\"{\"aperture\":\"0\",\"credit\":\"\",\"camera\":\"\",\"caption\":\"\",\"created_timestamp\":\"0\",\"copyright\":\"\",\"focal_length\":\"0\",\"iso\":\"0\",\"shutter_speed\":\"0\",\"title\":\"\",\"orientation\":\"0\"}\" data-image-title=\"Screen Shot 2016-01-15 at 11.58.02 PM\" data-image-description=\"\" data-image-caption=\"\" data-medium-file=\"https://no2147483647.files.wordpress.com/2016/01/screen-shot-2016-01-15-at-11-58-02-pm.png?w=300\" data-large-file=\"https://no2147483647.files.wordpress.com/2016/01/screen-shot-2016-01-15-at-11-58-02-pm.png?w=1008\" class=\"alignnone size-full wp-image-249\" src=\"https://no2147483647.files.wordpress.com/2016/01/screen-shot-2016-01-15-at-11-58-02-pm.png?w=1008\" alt=\"Screen Shot 2016-01-15 at 11.58.02 PM\" srcset=\"https://no2147483647.files.wordpress.com/2016/01/screen-shot-2016-01-15-at-11-58-02-pm.png?w=1008 1008w, https://no2147483647.files.wordpress.com/2016/01/screen-shot-2016-01-15-at-11-58-02-pm.png?w=150 150w, https://no2147483647.files.wordpress.com/2016/01/screen-shot-2016-01-15-at-11-58-02-pm.png?w=300 300w, https://no2147483647.files.wordpress.com/2016/01/screen-shot-2016-01-15-at-11-58-02-pm.png?w=768 768w, https://no2147483647.files.wordpress.com/2016/01/screen-shot-2016-01-15-at-11-58-02-pm.png?w=1024 1024w, https://no2147483647.files.wordpress.com/2016/01/screen-shot-2016-01-15-at-11-58-02-pm.png 1276w\" sizes=\"(max-width: 1008px) 100vw, 1008px\"   /></p>\n<h2>Optional: cuDNN</h2>\n<p>One can apply for the developer program here <a href=\"https://developer.nvidia.com/cudnn\">https://developer.nvidia.com/cudnn</a>. When approved, download cuDNN for Linux (either v4 RC or v3 is fine), upload the cuDNN package from the local computer to the instance, and install cuDNN:</p>\n<pre><code>tar -zxf cudnn-7.0-linux-x64-v4.0-rc.tgz #or cudnn-7.0-linux-x64-v3.0-prod.tgz\ncd cuda\nsudo cp lib64/* /usr/local/cuda/lib64/\nsudo cp include/cudnn.h /usr/local/cuda/include/\n</code></pre>\n<p>Reference: <a href=\"https://no2147483647.wordpress.com/2015/12/07/deep-learning-for-hackers-with-mxnet-1/\">https://no2147483647.wordpress.com/2015/12/07/deep-learning-for-hackers-with-mxnet-1/</a></p>\n<h1>Install MXnet</h1>\n<pre><code>git clone --recursive https://github.com/dmlc/mxnet\ncd mxnet; cp make/config.mk .\n\n#add CUDA options\necho \"USE_CUDA=1\" >>config.mk\necho \"USE_CUDA_PATH=/usr/local/cuda\" >>config.mk\n#<strong>if you have cuDNN, uncomment the following line</strong>\n#<strong>echo \"USE_CUDNN=1\" >>config.mk</strong>\necho \"USE_BLAS=atlas\" >> config.mk\necho \"USE_DIST_KVSTORE = 1\" >>config.mk\necho \"USE_S3=1\" >>config.mk\nmake -j8\n</code></pre>\n<p>Reference: <a href=\"http://mxnt.ml/en/latest/build.html\">http://mxnt.ml/en/latest/build.html</a></p>\n<h2>Add some link lib path</h2>\n<pre><code>echo \"export LD_LIBRARY_PATH=/home/ubuntu/mxnet/lib/:/usr/local/cuda-7.5/targets/x86_64-linux/lib/\" >>> ~/.bashrc\n</code></pre>\n<h2>Install python package</h2>\n<p>One can either use the system&#8217;s python or Miniconda/Anaconda python as mentioned in my <a href=\"https://no2147483647.wordpress.com/2015/12/07/deep-learning-for-hackers-with-mxnet-1/\">previous blog</a>. If use system&#8217;s python, do:</p>\n<pre><code>sudo apt-get install -y python-pip\ncd python\npython setup.py install --user\n</code></pre>\n<h2>Test it</h2>\n<pre><code>python example/image-classification/train_mnist.py --network lenet --gpus 0\n</code></pre>\n<p>One can also give <code>--gpus 0,1,2,3</code> for using all 4 GPUs, if runs on a <code>g2.8xlarge</code> (4x GPUs) instance. Enjoy Kaggle competitions with MXnet!</p>\n<h1>Some trouble shooting</h1>\n<p>One may see some annoying message when starting training with GPU</p>\n<pre><code>libdc1394 error: Failed to initialize libdc1394\n</code></pre>\n<p>It is OpenCV problem on AWS. One can simply disable it by:</p>\n<pre><code>sudo ln /dev/null /dev/raw1394\n</code></pre>\n<p>Reference: <a href=\"http://stackoverflow.com/questions/12689304/ctypes-error-libdc1394-error-failed-to-initialize-libdc1394\">http://stackoverflow.com/questions/12689304/ctypes-error-libdc1394-error-failed-to-initialize-libdc1394</a></p>\n",
  "wfw:commentRss": "https://no2147483647.wordpress.com/2016/01/16/setup-amazon-aws-gpu-instance-with-mxnet/feed/",
  "slash:comments": 10,
  "media:content": [
    {
      "media:title": "phunterlau"
    },
    {
      "media:title": "Niba Meisje met de parel"
    },
    {
      "media:title": "Screen Shot 2016-01-15 at 11.58.02 PM"
    }
  ]
}