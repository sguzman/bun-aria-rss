{
  "title": "How to Setup Theano to Run on GPU on Ubuntu 14.04 with Nvidia Geforce GTX 780",
  "description": "<p>Documenting the steps how to setup Theano to run on GPU on Ubuntu 14.04 so I can refer to this in the future.Â With this successfully installed, you can run Keras, convnet, Theano, etc properly.</p>\n\n<h1 id=\"whythis-article\">WhyÂ This Article?</h1>\n\n<p>Have you ever met those painful issues just trying to setup your GPU for scientific programming:</p>\n\n<ul>\n  <li>Getting aÂ blinking cursor after installing the â€œlatestâ€Â Nvidia drivers?</li>\n  <li>Getting aÂ blinking cursor after installing the â€œlatestâ€ CUDA toolkit?</li>\n  <li>Login loop in Ubuntu login screen?</li>\n  <li>NVRM: rm_init_adapter(0) failed?</li>\n  <li>NVIDIA: could not open the device file /dev/nvidia0 (input/output error)</li>\n  <li>â€¦</li>\n</ul>\n\n<p>If yes, then read on.</p>\n\n<p><span style=\"color: #ff0000;\"><strong>I cannot guarantee yourÂ OS does not break after running the steps below, so please backup everything, run as your own risk.</strong></span></p>\n\n<p>You may want to read the <em>Things That Does Not Work For Me</em> partÂ below first before followingÂ the <em>instructions</em>.</p>\n\n<h1 id=\"specifications\">Specifications</h1>\n\n<p>MyÂ server hasÂ the following specifications:</p>\n\n<ul>\n  <li>OS: Ubuntu 14.04 LTS, X64</li>\n  <li>GPU:Â NvidiaÂ Geforce GTX 780</li>\n  <li>Fresh install of Ubuntu 14.04 LTS</li>\n</ul>\n\n<h1 id=\"instructions\">Instructions</h1>\n\n<p>If you fail in the middle of any of this steps, you areÂ advised to restart andÂ follow the steps carefully again. Use common sense. and if you donâ€™t know how to fix it, too bad,</p>\n\n<ol>\n  <li>Download latest (or very recent) NvidiaÂ display driver for Linux:</li>\n</ol>\n\n<pre>wget http://us.download.nvidia.com/XFree86/Linux-x86_64/352.63/NVIDIA-Linux-x86_64-352.63.run</pre>\n\n<p>2.Â Download latest (or very recent) CUDA Installation Run file for Ubuntu 14.04:</p>\n\n<pre>wget http://developer.download.nvidia.com/compute/cuda/7.5/Prod/local_installers/cuda_7.5.18_linux.run</pre>\n\n<p>3.Â Get into recovery modeÂ to install the files, becauseÂ you cannot install your displayÂ driver with X server on.</p>\n\n<pre>reboot</pre>\n\n<ol>\n  <li>\n    <p>Once you are in GRUB, selectÂ â€œAdvanced Options for Ubuntuâ€.</p>\n  </li>\n  <li>\n    <p>InÂ the recovery mode, select â€œnetworkâ€, press yes.Â Once the networking has been enabled, this will also set your drive to read/write mode.</p>\n  </li>\n</ol>\n\n<p>6.Â In the recovery mode, select â€œrootâ€ to get a root prompt.</p>\n\n<ol>\n  <li>Go to whereÂ you downloaded the previous files at, and <strong>run NVIDIA-Linux-x86_64-352.63.runÂ </strong>.</li>\n</ol>\n\n<pre>chmod +x NVIDIA-Linux-x86_64-352.63.run # Make it executable\n\n./NVIDIA-Linux-x86_64-352.63.run # Install Nvidia display driver</pre>\n\n<p>For yes/no questions, take â€œyesâ€. For locations, press â€œenterâ€ to take default values.</p>\n\n<ol>\n  <li>Setup your environment variables.</li>\n</ol>\n\n<p>Make sure your LD_LIBRARY_PATH, LIBRARY_PATH andÂ PATH includes the places it needs to include:</p>\n\n<pre># ~/.bashrc\nexport LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/cuda-7.5/lib64:\nexport LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/cuda-7.5/lib64:\nexport PATH=$PATH:/usr/local/cuda-7.5/bin</pre>\n\n<p>Donâ€™t forget to:</p>\n\n<pre>$ source ~./.bashrc</pre>\n\n<ol>\n  <li><strong>Run nvidia-smi</strong> to confirm that yourÂ setup is correct.</li>\n</ol>\n\n<pre>nvidia-smi</pre>\n\n<p>nvidia-smi should be on your path already, so this should work. If it doesnâ€™t:</p>\n\n<ul>\n  <li>You must have done something wrong, better go back to step 1. and do it all over again.</li>\n  <li>You can see if itâ€™s at /usr/bin/nvidia-smi .</li>\n</ul>\n\n<p>You should then see something similar to this:</p>\n\n<pre>Mon Nov 23 21:01:17 2015 \n+------------------------------------------------------+ \n| NVIDIA-SMI 352.39 Driver Version: 352.39 | \n|-------------------------------+----------------------+----------------------+\n| GPU Name Persistence-M| Bus-Id Disp.A | Volatile Uncorr. ECC |\n| Fan Temp Perf Pwr:Usage/Cap| Memory-Usage | GPU-Util Compute M. |\n|===============================+======================+======================|\n| 0 GeForce GTX 780 Off | 0000:01:00.0 N/A | N/A |\n| 34% 33C P0 N/A / N/A | 137MiB / 3068MiB | N/A Default |\n+-------------------------------+----------------------+----------------------+\n \n+-----------------------------------------------------------------------------+\n| Processes: GPU Memory |\n| GPU PID Type Process name Usage |\n|=============================================================================|\n| 0 Not Supported |\n+-----------------------------------------------------------------------------+</pre>\n\n<ol>\n  <li>Go to where you downloaded the previous files at, and <strong>run cuda_7.5.18_linux.run</strong> .</li>\n</ol>\n\n<pre>chmod +x cuda_7.5.18_linux.run # Make it executable\n\n./cuda_7.5.18_linux.run # Install Nvidia display driver</pre>\n\n<p>For yes/no questions, take â€œyesâ€. For locations, press â€œenterâ€ to take default values.</p>\n\n<ol>\n  <li><strong>Re-run nvidia-smi</strong> just to be sure everything is still working well.</li>\n</ol>\n\n<pre>nvidia-smi</pre>\n\n<p>You should then (again) see something similar to this:</p>\n\n<pre>Mon Nov 23 21:08:56 2015 \n+------------------------------------------------------+ \n| NVIDIA-SMI 352.39 Driver Version: 352.39 | \n|-------------------------------+----------------------+----------------------+\n| GPU Name Persistence-M| Bus-Id Disp.A | Volatile Uncorr. ECC |\n| Fan Temp Perf Pwr:Usage/Cap| Memory-Usage | GPU-Util Compute M. |\n|===============================+======================+======================|\n| 0 GeForce GTX 780 Off | 0000:01:00.0 N/A | N/A |\n| 34% 28C P8 N/A / N/A | 271MiB / 3068MiB | N/A Default |\n+-------------------------------+----------------------+----------------------+\n \n+-----------------------------------------------------------------------------+\n| Processes: GPU Memory |\n| GPU PID Type Process name Usage |\n|=============================================================================|\n| 0 Not Supported |\n+-----------------------------------------------------------------------------+</pre>\n\n<p>11.Â Reboot now back to desktop.</p>\n\n<pre>reboot</pre>\n\n<ol>\n  <li>Time to install Theano and python, basically the first part of <a href=\"http://deeplearning.net/software/theano/install_ubuntu.html\" target=\"_blank\">this guide</a>. Run the following commands:</li>\n</ol>\n\n<pre>sudo apt-get install python-numpy python-scipy python-dev python-pip python-nose g++ libopenblas-dev git\nsudo pip install Theano</pre>\n\n<ol>\n  <li><strong>Copy and paste the below code into check1.py</strong>.Â Now we need toÂ make sure GPU is indeed working. I am copying the instructions fromÂ <a href=\"http://deeplearning.net/software/theano/tutorial/using_gpu.html\" target=\"_blank\">deeplearning.net</a>.</li>\n</ol>\n\n<pre><span class=\"kn\">from</span> <span class=\"nn\">theano</span> <span class=\"kn\">import</span> <span class=\"n\">function</span><span class=\"p\">,</span> <span class=\"n\">config</span><span class=\"p\">,</span> <span class=\"n\">shared</span><span class=\"p\">,</span> <span class=\"n\">sandbox</span>\n<span class=\"kn\">import</span> <span class=\"nn\">theano.tensor</span> <span class=\"kn\">as</span> <span class=\"nn\">T</span>\n<span class=\"kn\">import</span> <span class=\"nn\">numpy</span>\n<span class=\"kn\">import</span> <span class=\"nn\">time</span>\n\n<span class=\"n\">vlen</span> <span class=\"o\">=</span> <span class=\"mi\">10</span> <span class=\"o\">*</span> <span class=\"mi\">30</span> <span class=\"o\">*</span> <span class=\"mi\">768</span>  <span class=\"c\"># 10 x #cores x # threads per core</span>\n<span class=\"n\">iters</span> <span class=\"o\">=</span> <span class=\"mi\">1000</span>\n\n<span class=\"n\">rng</span> <span class=\"o\">=</span> <span class=\"n\">numpy</span><span class=\"o\">.</span><span class=\"n\">random</span><span class=\"o\">.</span><span class=\"n\">RandomState</span><span class=\"p\">(</span><span class=\"mi\">22</span><span class=\"p\">)</span>\n<span class=\"n\">x</span> <span class=\"o\">=</span> <span class=\"n\">shared</span><span class=\"p\">(</span><span class=\"n\">numpy</span><span class=\"o\">.</span><span class=\"n\">asarray</span><span class=\"p\">(</span><span class=\"n\">rng</span><span class=\"o\">.</span><span class=\"n\">rand</span><span class=\"p\">(</span><span class=\"n\">vlen</span><span class=\"p\">),</span> <span class=\"n\">config</span><span class=\"o\">.</span><span class=\"n\">floatX</span><span class=\"p\">))</span>\n<span class=\"n\">f</span> <span class=\"o\">=</span> <span class=\"n\">function</span><span class=\"p\">([],</span> <span class=\"n\">T</span><span class=\"o\">.</span><span class=\"n\">exp</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"p\">))</span>\n<span class=\"k\">print</span><span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">maker</span><span class=\"o\">.</span><span class=\"n\">fgraph</span><span class=\"o\">.</span><span class=\"n\">toposort</span><span class=\"p\">())</span>\n<span class=\"n\">t0</span> <span class=\"o\">=</span> <span class=\"n\">time</span><span class=\"o\">.</span><span class=\"n\">time</span><span class=\"p\">()</span>\n<span class=\"k\">for</span> <span class=\"n\">i</span> <span class=\"ow\">in</span> <span class=\"nb\">xrange</span><span class=\"p\">(</span><span class=\"n\">iters</span><span class=\"p\">):</span>\n    <span class=\"n\">r</span> <span class=\"o\">=</span> <span class=\"n\">f</span><span class=\"p\">()</span>\n<span class=\"n\">t1</span> <span class=\"o\">=</span> <span class=\"n\">time</span><span class=\"o\">.</span><span class=\"n\">time</span><span class=\"p\">()</span>\n<span class=\"k\">print</span><span class=\"p\">(</span><span class=\"s\">\"Looping </span><span class=\"si\">%d</span><span class=\"s\"> times took </span><span class=\"si\">%f</span><span class=\"s\"> seconds\"</span> <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">iters</span><span class=\"p\">,</span> <span class=\"n\">t1</span> <span class=\"o\">-</span> <span class=\"n\">t0</span><span class=\"p\">))</span>\n<span class=\"k\">print</span><span class=\"p\">(</span><span class=\"s\">\"Result is </span><span class=\"si\">%s</span><span class=\"s\">\"</span> <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">r</span><span class=\"p\">,))</span>\n<span class=\"k\">if</span> <span class=\"n\">numpy</span><span class=\"o\">.</span><span class=\"n\">any</span><span class=\"p\">([</span><span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"o\">.</span><span class=\"n\">op</span><span class=\"p\">,</span> <span class=\"n\">T</span><span class=\"o\">.</span><span class=\"n\">Elemwise</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">x</span> <span class=\"ow\">in</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">maker</span><span class=\"o\">.</span><span class=\"n\">fgraph</span><span class=\"o\">.</span><span class=\"n\">toposort</span><span class=\"p\">()]):</span>\n    <span class=\"k\">print</span><span class=\"p\">(</span><span class=\"s\">'Used the cpu'</span><span class=\"p\">)</span>\n<span class=\"k\">else</span><span class=\"p\">:</span>\n    <span class=\"k\">print</span><span class=\"p\">(</span><span class=\"s\">'Used the gpu'</span><span class=\"p\">)</span></pre>\n\n<ol>\n  <li><strong>RunÂ the check1.py to confirm thatÂ Theano is working correctly with CPU</strong>.</li>\n</ol>\n\n<pre>THEANO_FLAGS=mode=FAST_RUN,device=cpu,floatX=float32 python check1.py</pre>\n\n<p>This should give:</p>\n\n<pre>[Elemwise{exp,no_inplace}(&lt;TensorType(float32, vector)&gt;)]\nLooping 1000 times took 1.999963 seconds\nResult is [ 1.23178029 1.61879337 1.52278066 ..., 2.20771813 2.29967761\n 1.62323284]\n<strong>Used the cpu</strong></pre>\n\n<ol>\n  <li><strong>Run the check.py to confirm that Theano is working correctly with GPU</strong>.</li>\n</ol>\n\n<pre>THEANO_FLAGS=mode=FAST_RUN,device=gpu,floatX=float32 python check1.py</pre>\n\n<p>ThisÂ should give:</p>\n\n<pre>Using gpu device 0: GeForce GTX 780\n[GpuElemwise{exp,no_inplace}(&lt;CudaNdarrayType(float32, vector)&gt;), HostFromGpu(GpuElemwise{exp,no_inplace}.0)]\nLooping 1000 times took 0.583838 seconds\nResult is [ 1.23178029 1.61879349 1.52278066 ..., 2.20771813 2.29967761\n 1.62323296]\n<strong>Used the gpu</strong></pre>\n\n<p>Note that: computation time has decreased, and it is indeed using GPU now.</p>\n\n<ol>\n  <li>Done! If you reached here and did notÂ meet any issues, I hope you can comment and confirm that this does help you, so others canÂ trust this guide.Â If you have still spent hours/days, <strong>blame Linux.</strong> =]</li>\n</ol>\n\n<h1 id=\"things-that-does-not-work-for-me\">Things That Does Not Work For Me</h1>\n\n<ol>\n  <li>InstallingÂ currentÂ nvidia drivers from apt-get.</li>\n</ol>\n\n<pre>$ apt-get install nvidia-current</pre>\n\n<p>NormallyÂ you would think apt-get install the latest nvidia drivers would be the best to go. Nope,Â after the installation 1) nvidia-smi does not work 2) I cannot get back into desktop 3) get error messages like RmInitAdapter failed in dmesg 4) no monitor found in /var/log/Xorg.0.log</p>\n\n<ol>\n  <li>Install CUDAÂ from apt-get.</li>\n</ol>\n\n<pre>$ apt-get install nvidia-cuda-toolkit</pre>\n\n<p>The same as 1., equally disastrous:Â 1) nvidia-smi does not work 2) I cannot get back into desktop 3) get error messages like RmInitAdapter failed in dmesg 4) no monitor found in /var/log/Xorg.0.log</p>\n\n<p>3.Â Installing current nvidia from another â€œdefactoâ€ repository.</p>\n\n<pre>sudo apt-add-repository ppa:ubuntu-x-swat/x-updates\nsudo apt-get update\nsudo apt-get install nvidia-current</pre>\n\n<p>The same as 1., equally disastrous:Â 1) nvidia-smi does not work 2) I cannot get back into desktop 3) get error messages like RmInitAdapter failed in dmesg 4) no monitor found in /var/log/Xorg.0.log</p>\n\n<p>4.Â Anything about Bumblebee.</p>\n\n<p>Not sure what this is, just not related.Â Forget about it.</p>\n\n<p>5.Â Also,Â I donâ€™t have advice trying to repair a broken Ubuntu if you did anything of the above. But maybe you can try removing nvidia drivers and reinstallingÂ the desktop, but doesnâ€™t work for me either.</p>\n\n<pre>apt-get remove --purge nvidia*\napt-get install --reinstall ubuntu-desktop unity\napt-get install nvidia-current</pre>\n\n<ol>\n  <li>Using any nvidia driverÂ like 340 or 304 version.Â They do not work.</li>\n</ol>\n\n<p><em><strong>The only thing that works for me is a fresh reinstall of Ubuntu 14.04. Nothing else.</strong></em></p>\n\n<h1 id=\"final-words\">Final Words</h1>\n\n<p>The <a href=\"http://deeplearning.net/software/theano/install_ubuntu.html\" target=\"_blank\">installation guide</a> from DeepLearning.net is very helpful, but it contains poison advice that messed up my display of my OS completely.</p>\n\n<p>BTW, ever heard of <strong>â€œLinuxÂ is user-friendly butÂ it is very selective of its friends.â€</strong>?Â I knowÂ I am certainly not its friendâ€¦Â ğŸ˜‰</p>",
  "pubDate": "Tue, 24 Nov 2015 13:32:19 +0000",
  "link": "http://www.chioka.in/how-to-setup-theano-to-run-on-gpu-on-ubuntu-14-04-with-nvidia-geforce-gtx-780/",
  "guid": "http://www.chioka.in/how-to-setup-theano-to-run-on-gpu-on-ubuntu-14-04-with-nvidia-geforce-gtx-780/",
  "category": [
    "Advice",
    "GPU",
    "I Hate Linux",
    "Linux",
    "Nvidia",
    "Tutorial",
    "Ubuntu",
    "Ubuntu 14.04",
    "In Practice"
  ]
}