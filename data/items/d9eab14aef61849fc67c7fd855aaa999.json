{
  "title": "Denoising Dirty Documents: Part 9",
  "link": "https://colinpriest.com/2015/10/15/denoising-dirty-documents-part-9/",
  "comments": "https://colinpriest.com/2015/10/15/denoising-dirty-documents-part-9/#comments",
  "dc:creator": "Colin Priest",
  "pubDate": "Thu, 15 Oct 2015 10:12:58 +0000",
  "category": [
    "Background Removal",
    "Image Processing",
    "Kaggle",
    "R"
  ],
  "guid": "http://colinpriest.com/?p=546",
  "description": "Now that Kaggle&#8217;s Denoising Dirty Documents Competition has closed, it&#8217;s time to start posting the secrets to getting a very &#8230;<p><a href=\"https://colinpriest.com/2015/10/15/denoising-dirty-documents-part-9/\">Continue reading <span class=\"meta-nav\">&#8594;</span></a></p>",
  "content:encoded": "<p>Now that Kaggle&#8217;s Denoising Dirty Documents Competition has closed, it&#8217;s time to start posting the secrets to getting a very good score in this competition. In this blog, I describe how to take advantage of the first of two information leakages that I used.</p>\n<p><a href=\"https://colinpriestdotcom.files.wordpress.com/2015/10/512px-broken-water-pipe-clip-art-380417.gif\"><img loading=\"lazy\" data-attachment-id=\"548\" data-permalink=\"https://colinpriest.com/2015/10/15/denoising-dirty-documents-part-9/512px-broken-water-pipe-clip-art-380417/\" data-orig-file=\"https://colinpriestdotcom.files.wordpress.com/2015/10/512px-broken-water-pipe-clip-art-380417.gif\" data-orig-size=\"512,673\" data-comments-opened=\"1\" data-image-meta=\"{\"aperture\":\"0\",\"credit\":\"\",\"camera\":\"\",\"caption\":\"\",\"created_timestamp\":\"0\",\"copyright\":\"\",\"focal_length\":\"0\",\"iso\":\"0\",\"shutter_speed\":\"0\",\"title\":\"\",\"orientation\":\"0\"}\" data-image-title=\"512px-broken-water-pipe-clip-art-380417\" data-image-description=\"\" data-image-caption=\"\" data-medium-file=\"https://colinpriestdotcom.files.wordpress.com/2015/10/512px-broken-water-pipe-clip-art-380417.gif?w=228\" data-large-file=\"https://colinpriestdotcom.files.wordpress.com/2015/10/512px-broken-water-pipe-clip-art-380417.gif?w=512\" class=\"alignnone size-medium wp-image-548\" src=\"https://colinpriestdotcom.files.wordpress.com/2015/10/512px-broken-water-pipe-clip-art-380417.gif?w=228\" alt=\"512px-broken-water-pipe-clip-art-380417\" width=\"228\" height=\"300\" /></a></p>\n<p>Information leakage occurs in predictive modelling when the training and test data includes values that would not be known at the time a prediction was being made. For example, I once worked on a direct marketing sales propensity modelling project where our predictive model fitted the training data far too well, making us suspicious. We eventually tracked it down to an incorrectly designed data extract that used status values as at the data extraction date, instead of as at the date at which a prediction would have been run. The sale of the product to the customer changed the value of that data field, so the data needed to be the value of the data field before the sale occurred. In real life projects, information leakage is a bad thing because it overstates the model accuracy. Therefore you need to ensure that it does not occur; otherwise your predictive model will not perform well. In data science competitions, information leakage is something to be taken advantage of. It enables you to obtain a higher score.</p>\n<p>The first information leakage in this competition comes from how the training data was created. There are only 8 different page backgrounds. There are 2 coffee cup stains, 2 folded pages, 2 watermarks and 2 crumpled pages.</p>\n<p><a href=\"https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-output-1.png\"><img loading=\"lazy\" data-attachment-id=\"550\" data-permalink=\"https://colinpriest.com/2015/10/15/denoising-dirty-documents-part-9/20151015-output-1/\" data-orig-file=\"https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-output-1.png\" data-orig-size=\"855,663\" data-comments-opened=\"1\" data-image-meta=\"{\"aperture\":\"0\",\"credit\":\"\",\"camera\":\"\",\"caption\":\"\",\"created_timestamp\":\"0\",\"copyright\":\"\",\"focal_length\":\"0\",\"iso\":\"0\",\"shutter_speed\":\"0\",\"title\":\"\",\"orientation\":\"0\"}\" data-image-title=\"20151015 output 1\" data-image-description=\"\" data-image-caption=\"\" data-medium-file=\"https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-output-1.png?w=300\" data-large-file=\"https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-output-1.png?w=529\" class=\"alignnone size-medium wp-image-550\" src=\"https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-output-1.png?w=300\" alt=\"20151015 output 1\" width=\"300\" height=\"233\" srcset=\"https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-output-1.png?w=300 300w, https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-output-1.png?w=600 600w, https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-output-1.png?w=150 150w\" sizes=\"(max-width: 300px) 100vw, 300px\" /></a></p>\n<p>This gives us a huge advantage in removing the background and the stains. Instead of using an uncertain estimate based upon only a single image, we can group together the images so that each group has the same background. Then, for each pixel location, calculate the brightest pixel across all of the images in that group, and use the brightest value as the pixel brightness in the background. You can find a couple of scripts on Kaggle that do this.</p>\n<p>The problem is that you can&#8217;t do the same for the test images because they have different backgrounds, and they have only four different backgrounds. You can&#8217;t have known this without manually looking at the test images, and that break the rules prohibiting manual processing of the test images.</p>\n<p><a href=\"https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-output-2.png\"><img loading=\"lazy\" data-attachment-id=\"551\" data-permalink=\"https://colinpriest.com/2015/10/15/denoising-dirty-documents-part-9/20151015-output-2/\" data-orig-file=\"https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-output-2.png\" data-orig-size=\"856,666\" data-comments-opened=\"1\" data-image-meta=\"{\"aperture\":\"0\",\"credit\":\"\",\"camera\":\"\",\"caption\":\"\",\"created_timestamp\":\"0\",\"copyright\":\"\",\"focal_length\":\"0\",\"iso\":\"0\",\"shutter_speed\":\"0\",\"title\":\"\",\"orientation\":\"0\"}\" data-image-title=\"20151015 output 2\" data-image-description=\"\" data-image-caption=\"\" data-medium-file=\"https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-output-2.png?w=300\" data-large-file=\"https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-output-2.png?w=529\" class=\"alignnone size-medium wp-image-551\" src=\"https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-output-2.png?w=300\" alt=\"20151015 output 2\" width=\"300\" height=\"233\" srcset=\"https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-output-2.png?w=300 300w, https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-output-2.png?w=600 600w, https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-output-2.png?w=150 150w\" sizes=\"(max-width: 300px) 100vw, 300px\" /></a></p>\n<p>You can also run into troubles if your model just assumes that the test images are arranged so that there are 8 different background images that repeat every 8 images.</p>\n<p>A better solution is to let your model decide which images can be grouped together, and let your model decide which background belongs with each image. The way to do this is to apply a median filter to each image, to obtain an estimate of the background of each image, and then group the median images together according to similarity.</p>\n<pre class=\"brush: r; title: ; notranslate\">\n\nlibrary(png)\nlibrary(raster)\nlibrary(data.table)\n\nmedian_Filter = function(img, filterWidth)\n{\npad = floor(filterWidth / 2)\npadded = matrix(NA, nrow(img) + 2 * pad, ncol(img) + 2 * pad)\npadded[pad + seq_len(nrow(img)), pad + seq_len(ncol(img))] = img\n\ntab = matrix(0, nrow(img) * ncol(img), filterWidth * filterWidth)\nk = 1\nfor (i in seq_len(filterWidth))\n{\nfor (j in seq_len(filterWidth))\n{\ntab[,k] = img2vec(padded[i - 1 + seq_len(nrow(img)), j - 1 + seq_len(ncol(img))])\nk = k + 1\n}\n}\n\nfiltered = unlist(apply(tab, 1, function(x) median(x[!is.na(x)])))\nreturn (matrix(filtered, nrow(img), ncol(img)))\n}\n\n# a function to turn a matrix image into a vector\nimg2vec = function(img)\n{\nreturn (matrix(img, nrow(img) * ncol(img), 1))\n}\n\n# training data\ndirtyFolder = \"C:/Users/Colin/dropbox/Kaggle/Denoising Dirty Documents/data/train\"\noutPath = \"D:/CNN with background removal/train median25\"\nfilenames = list.files(dirtyFolder)\n# use a 25x25 median filter to get the background\nfor (f in filenames)\n{\nprint(f)\nimgX = readPNG(file.path(dirtyFolder, f))\n\nmedian25 = median_Filter(imgX, 25)\n\noutFile = file.path(outPath, f)\nwritePNG(median25, outFile)\n}\n\n</pre>\n<p>The script above calculates the median filter for each image and stores it in a folder. I have used a filter size of 25 pixels because I want broad patterns of the background, and I want the text removed.</p>\n<p>Now that I have the median images, I can iterate through each training image and link it to other images that have similar median images. I have used RMSE as a measure of similarity. The cutoff RMSE of 2.5% was determined by looking at the range of RMSE values and looking for a natural break.</p>\n<p><a href=\"https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-output-3.png\"><img loading=\"lazy\" data-attachment-id=\"554\" data-permalink=\"https://colinpriest.com/2015/10/15/denoising-dirty-documents-part-9/20151015-output-3/\" data-orig-file=\"https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-output-3.png\" data-orig-size=\"619,200\" data-comments-opened=\"1\" data-image-meta=\"{\"aperture\":\"0\",\"credit\":\"\",\"camera\":\"\",\"caption\":\"\",\"created_timestamp\":\"0\",\"copyright\":\"\",\"focal_length\":\"0\",\"iso\":\"0\",\"shutter_speed\":\"0\",\"title\":\"\",\"orientation\":\"0\"}\" data-image-title=\"20151015 output 3\" data-image-description=\"\" data-image-caption=\"\" data-medium-file=\"https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-output-3.png?w=300\" data-large-file=\"https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-output-3.png?w=529\" class=\"alignnone size-medium wp-image-554\" src=\"https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-output-3.png?w=300\" alt=\"20151015 output 3\" width=\"300\" height=\"97\" srcset=\"https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-output-3.png?w=300 300w, https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-output-3.png?w=600 600w, https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-output-3.png?w=150 150w\" sizes=\"(max-width: 300px) 100vw, 300px\" /></a></p>\n<pre class=\"brush: r; title: ; notranslate\">\n\n# find the images with matching background\noutPath2 = \"D:/CNN with background removal/train background\"\noutPath3 = \"D:/CNN with background removal/train foreground\"\nfor (i in 1:length(filenames))\n{\nf = filenames[i]\nprint(f)\n\nimgX = readPNG(file.path(outPath, f))\n\nscores = matrix(1, length(filenames))\nfor (j in 1:length(filenames))\n{\nimgY = readPNG(file.path(outPath, filenames[j]))\nrmse = 1\nif (nrow(imgY) >= nrow(imgX) & ncol(imgY) >= ncol(imgX)) rmse = sqrt(mean((imgX - imgY[1:nrow(imgX), 1:ncol(imgX)]) ^ 2))\nscores[j] = rmse\n}\n\nsameStains = filenames[scores <= 0.025]\nnImages = length(sameStains)\n\nrawData = matrix(0, ncol(imgX) * nrow(imgX), nImages)\nfor (j in 1:nImages)\n{\nimgY = readPNG(file.path(dirtyFolder, sameStains[j]))\nrawData[,j] = img2vec(imgY[1:nrow(imgX), 1:ncol(imgX)])\n}\n\nbackground = matrix(unlist(apply(rawData,1,max)), nrow(imgX), ncol(imgX)) # background is defined as the lightest pixel of images with similar median transformations\nplot(raster(background))\nwritePNG(background, file.path(outPath2, f))\n\nimgX = readPNG(file.path(dirtyFolder, f))\nforeground = (imgX - background) / background\nr = range(foreground)\nforeground = (foreground - r[1]) * (r[2] - r[1])\n#plot(raster(foreground))\nwritePNG(foreground, file.path(outPath3, f))\n}\n\n</pre>\n<p>One of the tricks in the script above was that I didn&#8217;t simply subtract the background from the image. If I had done that, then the result would not be consistent in areas where the stains occur:</p>\n<p><a href=\"https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-output-4.png\"><img loading=\"lazy\" data-attachment-id=\"557\" data-permalink=\"https://colinpriest.com/2015/10/15/denoising-dirty-documents-part-9/20151015-output-4/\" data-orig-file=\"https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-output-4.png\" data-orig-size=\"540,420\" data-comments-opened=\"1\" data-image-meta=\"{\"aperture\":\"0\",\"credit\":\"\",\"camera\":\"\",\"caption\":\"\",\"created_timestamp\":\"0\",\"copyright\":\"\",\"focal_length\":\"0\",\"iso\":\"0\",\"shutter_speed\":\"0\",\"title\":\"\",\"orientation\":\"0\"}\" data-image-title=\"20151015 output 4\" data-image-description=\"\" data-image-caption=\"\" data-medium-file=\"https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-output-4.png?w=300\" data-large-file=\"https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-output-4.png?w=529\" class=\"alignnone size-medium wp-image-557\" src=\"https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-output-4.png?w=300\" alt=\"20151015 output 4\" width=\"300\" height=\"233\" srcset=\"https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-output-4.png?w=300 300w, https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-output-4.png?w=150 150w, https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-output-4.png 540w\" sizes=\"(max-width: 300px) 100vw, 300px\" /></a></p>\n<p><a href=\"https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-foreground-bad.png\"><img loading=\"lazy\" data-attachment-id=\"556\" data-permalink=\"https://colinpriest.com/2015/10/15/denoising-dirty-documents-part-9/20151015-foreground-bad/\" data-orig-file=\"https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-foreground-bad.png\" data-orig-size=\"540,420\" data-comments-opened=\"1\" data-image-meta=\"{\"aperture\":\"0\",\"credit\":\"\",\"camera\":\"\",\"caption\":\"\",\"created_timestamp\":\"0\",\"copyright\":\"\",\"focal_length\":\"0\",\"iso\":\"0\",\"shutter_speed\":\"0\",\"title\":\"\",\"orientation\":\"0\"}\" data-image-title=\"20151015 foreground-bad\" data-image-description=\"\" data-image-caption=\"\" data-medium-file=\"https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-foreground-bad.png?w=300\" data-large-file=\"https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-foreground-bad.png?w=529\" class=\"alignnone size-medium wp-image-556\" src=\"https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-foreground-bad.png?w=300\" alt=\"20151015 foreground-bad\" width=\"300\" height=\"233\" srcset=\"https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-foreground-bad.png?w=300 300w, https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-foreground-bad.png?w=150 150w, https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-foreground-bad.png 540w\" sizes=\"(max-width: 300px) 100vw, 300px\" /></a></p>\n<p>Notice that in the image above, the writing is faded where the stain was dark. That&#8217;s because it was created with the code:</p>\n<pre class=\"brush: r; title: ; notranslate\">\n\nforeground = (imgX - background)\nr = range(foreground)\nforeground = (foreground - r[1]) * (r[2] - r[1])\n\n</pre>\n<p>Where the background is dark, there is less opportunity for the writing to contrast against the background. To fix this, I changed the above script to be:</p>\n<pre class=\"brush: r; title: ; notranslate\">\n\nforeground = (imgX - background) / background\nr = range(foreground)\nforeground = (foreground - r[1]) * (r[2] - r[1])\n\n</pre>\n<p>By dividing the difference by the background brightness, I have rescaled the contrast to allow for the limitation on the maximum contrast at this location. The result is shown below:<br />\n<a href=\"https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-foreground-good.png\"><img loading=\"lazy\" data-attachment-id=\"558\" data-permalink=\"https://colinpriest.com/2015/10/15/denoising-dirty-documents-part-9/20151015-foreground-good/\" data-orig-file=\"https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-foreground-good.png\" data-orig-size=\"540,420\" data-comments-opened=\"1\" data-image-meta=\"{\"aperture\":\"0\",\"credit\":\"\",\"camera\":\"\",\"caption\":\"\",\"created_timestamp\":\"0\",\"copyright\":\"\",\"focal_length\":\"0\",\"iso\":\"0\",\"shutter_speed\":\"0\",\"title\":\"\",\"orientation\":\"0\"}\" data-image-title=\"20151015 foreground-good\" data-image-description=\"\" data-image-caption=\"\" data-medium-file=\"https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-foreground-good.png?w=300\" data-large-file=\"https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-foreground-good.png?w=529\" class=\"alignnone size-medium wp-image-558\" src=\"https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-foreground-good.png?w=300\" alt=\"20151015 foreground-good\" width=\"300\" height=\"233\" srcset=\"https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-foreground-good.png?w=300 300w, https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-foreground-good.png?w=150 150w, https://colinpriestdotcom.files.wordpress.com/2015/10/20151015-foreground-good.png 540w\" sizes=\"(max-width: 300px) 100vw, 300px\" /></a><br />\nThis time the writing has consistent darkness across the entire image, regardless of the brightness of the background pixels.</p>\n<p>My competition submission consisted of 4 stages, and this leakage-based background removal was the first stage. The final stage also took advantage of an information leakage. But you will have to wait for a couple of blogs to see what that was&#8230;</p>\n",
  "wfw:commentRss": "https://colinpriest.com/2015/10/15/denoising-dirty-documents-part-9/feed/",
  "slash:comments": 3,
  "media:thumbnail": "",
  "media:content": [
    {
      "media:title": "512px-broken-water-pipe-clip-art-380417"
    },
    {
      "media:title": "colinpriest1966"
    },
    {
      "media:title": "512px-broken-water-pipe-clip-art-380417"
    },
    {
      "media:title": "20151015 output 1"
    },
    {
      "media:title": "20151015 output 2"
    },
    {
      "media:title": "20151015 output 3"
    },
    {
      "media:title": "20151015 output 4"
    },
    {
      "media:title": "20151015 foreground-bad"
    },
    {
      "media:title": "20151015 foreground-good"
    }
  ]
}